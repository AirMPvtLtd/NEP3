# ─────────────────────────────────────────────────────────────────────────────
# conf.d/nep.conf
#
# Domain: tryspyral.com
# After running certbot, reload nginx: docker compose exec nginx nginx -s reload
# ─────────────────────────────────────────────────────────────────────────────

# ── 1. HTTP → HTTPS redirect + Let's Encrypt ACME challenge ───────────────────
server {
    listen 80;
    listen [::]:80;
    server_name tryspyral.com www.tryspyral.com;

    # Let's Encrypt webroot challenge (certbot writes here)
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Redirect everything else to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# ── 2. HTTPS main server ──────────────────────────────────────────────────────
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name tryspyral.com www.tryspyral.com;

    # ── TLS ───────────────────────────────────────────────────────────────────
    ssl_certificate     /etc/letsencrypt/live/tryspyral.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/tryspyral.com/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/tryspyral.com/chain.pem;

    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;

    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;

    ssl_stapling        on;
    ssl_stapling_verify on;
    resolver            8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout    5s;

    # ── Security headers ──────────────────────────────────────────────────────
    # HSTS — 2 years, include subdomains, preload
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Frame-Options           "SAMEORIGIN"                                   always;
    add_header X-Content-Type-Options    "nosniff"                                       always;
    add_header X-XSS-Protection          "1; mode=block"                                 always;
    add_header Referrer-Policy           "strict-origin-when-cross-origin"               always;
    add_header Permissions-Policy        "camera=(), microphone=(), geolocation=()"      always;

    # ── Rate limiting ─────────────────────────────────────────────────────────
    limit_req  zone=global burst=50 nodelay;
    limit_conn conn_limit 50;

    # ── Logging ───────────────────────────────────────────────────────────────
    access_log /var/log/nginx/nep-access.log main;
    error_log  /var/log/nginx/nep-error.log  warn;

    # ── Static asset caching ──────────────────────────────────────────────────
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$ {
        proxy_pass         http://nep_app;
        proxy_cache_bypass $http_pragma;
        expires            1y;
        add_header         Cache-Control "public, immutable";
        add_header         Vary "Accept-Encoding";
        access_log         off;
    }

    # HTML — never cache (so deploys take effect immediately)
    location ~* \.html$ {
        proxy_pass         http://nep_app;
        add_header         Cache-Control "no-cache, no-store, must-revalidate";
        add_header         Pragma "no-cache";
        expires            0;
    }

    # ── Auth routes — tighter rate limit ─────────────────────────────────────
    location /api/auth/login {
        limit_req  zone=auth burst=3 nodelay;
        proxy_pass http://nep_app;
        include    /etc/nginx/conf.d/proxy_params.conf;
    }

    location /api/auth/signup {
        limit_req  zone=auth burst=3 nodelay;
        proxy_pass http://nep_app;
        include    /etc/nginx/conf.d/proxy_params.conf;
    }

    location /api/auth/forgot-password {
        limit_req  zone=auth burst=2 nodelay;
        proxy_pass http://nep_app;
        include    /etc/nginx/conf.d/proxy_params.conf;
    }

    # ── API routes ────────────────────────────────────────────────────────────
    location /api/ {
        limit_req  zone=api burst=30 nodelay;
        proxy_pass http://nep_app;
        include    /etc/nginx/conf.d/proxy_params.conf;
    }

    # ── Health check (no rate limit, no auth) ────────────────────────────────
    location /health {
        proxy_pass http://nep_app;
        access_log off;
    }

    # ── Everything else → Node.js ─────────────────────────────────────────────
    location / {
        proxy_pass http://nep_app;
        include    /etc/nginx/conf.d/proxy_params.conf;
    }
}
