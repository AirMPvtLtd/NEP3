<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Email | SPYRAL NEP Workbench</title>
    <meta name="robots" content="noindex, nofollow">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        body {
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d30 100%);
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .card {
            background: #2d2d30;
            border: 1px solid #464647;
            border-radius: 16px;
            padding: 48px 40px;
            max-width: 480px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            text-align: center;
        }

        .logo {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #7877c6, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .logo-sub {
            color: #888;
            font-size: 12px;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 36px;
        }

        .icon {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin: 0 auto 24px;
        }

        .icon.loading { background: rgba(120,119,198,0.15); animation: pulse 1.5s infinite; }
        .icon.success { background: rgba(34,197,94,0.15); }
        .icon.error   { background: rgba(239,68,68,0.15); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid rgba(120,119,198,0.3);
            border-top-color: #7877c6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        h2 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #ffffff;
        }

        p {
            color: #aaaaaa;
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .btn {
            display: inline-block;
            margin-top: 28px;
            padding: 13px 32px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            border: none;
            transition: opacity 0.2s;
        }

        .btn:hover { opacity: 0.85; }

        .btn-primary {
            background: linear-gradient(135deg, #7877c6, #5b5aa0);
            color: #ffffff;
        }

        .btn-secondary {
            background: transparent;
            color: #888;
            border: 1px solid #464647;
            margin-left: 10px;
        }
    </style>
</head>
<body>
<div class="card">
    <div class="logo">SPYRAL</div>
    <div class="logo-sub">NEP 2020 Learning Platform</div>

    <!-- Loading state -->
    <div id="stateLoading">
        <div class="icon loading">
            <div class="spinner"></div>
        </div>
        <h2>Verifying your email…</h2>
        <p>Please wait a moment.</p>
    </div>

    <!-- Success state -->
    <div id="stateSuccess" style="display:none">
        <div class="icon success">✅</div>
        <h2>Email Verified!</h2>
        <p>Your account is now active. You can log in and start learning.</p>
        <a href="/login" class="btn btn-primary">Go to Login</a>
    </div>

    <!-- Error state -->
    <div id="stateError" style="display:none">
        <div class="icon error">❌</div>
        <h2 id="errTitle">Verification Failed</h2>
        <p id="errMsg">This link may have expired or already been used.</p>
        <a href="/login" class="btn btn-primary">Go to Login</a>
        <a href="#" id="resendBtn" class="btn btn-secondary">Resend Email</a>
    </div>
</div>

<script>
(async () => {
    // Extract token from URL: /verify-email/:token
    const token = location.pathname.split('/verify-email/')[1];

    if (!token) {
        showError('Invalid Link', 'No verification token found in this URL.');
        return;
    }

    try {
        const res = await fetch(`/api/auth/verify-email/${encodeURIComponent(token)}`);
        const data = await res.json().catch(() => ({}));

        if (res.ok && data.success !== false) {
            show('stateSuccess');
        } else {
            const msg = data.message || 'Verification failed. The link may have expired.';
            showError('Verification Failed', msg);
        }
    } catch (err) {
        showError('Connection Error', 'Could not reach the server. Please check your connection and try again.');
    }
})();

function show(id) {
    ['stateLoading','stateSuccess','stateError'].forEach(s => {
        document.getElementById(s).style.display = s === id ? '' : 'none';
    });
}

function showError(title, msg) {
    document.getElementById('errTitle').textContent = title;
    document.getElementById('errMsg').textContent   = msg;
    show('stateError');
}

// Resend verification — prompt for email then call API
document.getElementById('resendBtn').addEventListener('click', async (e) => {
    e.preventDefault();
    const email = prompt('Enter your email address to resend the verification link:');
    if (!email) return;

    try {
        const res  = await fetch('/api/auth/resend-verification', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
        });
        const data = await res.json().catch(() => ({}));
        alert(data.message || (res.ok ? 'Verification email sent!' : 'Failed to resend.'));
    } catch {
        alert('Could not reach the server. Please try again.');
    }
});
</script>
</body>
</html>
