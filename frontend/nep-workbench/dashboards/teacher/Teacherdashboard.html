<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <title>Teacher Dashboard - NEP Workbench</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        
        :root {
            --bg-dark: #1e1e1e;
            --panel-dark: #252526;
            --border-color: #464647;
            --accent-blue: #007acc;
            --accent-cyan: #00d4ff;
            --success-green: #27ae60;
            --warning-yellow: #f39c12;
            --danger-red: #e74c3c;
            --text-primary: #ffffff;
            --text-secondary: #888888;
        }
        
        body { 
            background: var(--bg-dark); 
            color: var(--text-primary); 
            overflow-x: hidden; 
        }
        
        /* DASHBOARD LAYOUT */
        .dashboard {
            display: grid;
            grid-template-rows: 60px 1fr;
            grid-template-columns: 250px 1fr;
            height: 100vh;
        }
        
        /* HEADER */
        .header {
            grid-column: 1 / -1;
            background: #333337;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 30px;
            gap: 20px;
            z-index: 100;
        }
        
        .logo {
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-left: auto;
        }
        
        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .notification-bell:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--danger-red);
            color: white;
            font-size: 0.65rem;
            padding: 2px 5px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 8px;
            transition: background 0.3s;
        }
        
        .user-info:hover { 
            background: #3e3e42; 
        }
        
        .avatar {
            width: 38px;
            height: 38px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
        }
        
        .user-name {
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .user-role {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        /* SIDEBAR */
        .sidebar {
            background: var(--panel-dark);
            border-right: 1px solid var(--border-color);
            padding: 20px 0;
            overflow-y: auto;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 14px 25px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-secondary);
            font-size: 0.95rem;
            position: relative;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }
        
        .nav-item.active {
            background: rgba(0, 122, 204, 0.15);
            color: var(--accent-cyan);
            border-left: 3px solid var(--accent-cyan);
        }
        
        .nav-item i {
            width: 20px;
            text-align: center;
        }
        
        .badge-notification {
            position: absolute;
            right: 20px;
            background: var(--danger-red);
            color: white;
            font-size: 0.7rem;
            padding: 2px 7px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        /* MAIN CONTENT */
        .main-content {
            background: var(--bg-dark);
            overflow-y: auto;
            padding: 30px;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* HEADER SECTION */
        .page-header {
            margin-bottom: 25px;
        }
        
        .page-header h1 {
            font-size: 2rem;
            margin-bottom: 8px;
        }
        
        .page-header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }
        
        /* STATISTICS CARDS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--panel-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--accent-blue), var(--accent-cyan));
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 212, 255, 0.1);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, rgba(0, 122, 204, 0.2), rgba(0, 212, 255, 0.2));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--accent-cyan);
        }
        
        .stat-details {
            flex: 1;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .stat-change {
            font-size: 0.75rem;
            margin-top: 5px;
        }
        
        .stat-change.positive {
            color: var(--success-green);
        }
        
        .stat-change.negative {
            color: var(--danger-red);
        }
        
        /* PANELS */
        .panel {
            background: var(--panel-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .panel-header h2 {
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-actions {
            display: flex;
            gap: 10px;
        }
        
        /* CUSTOM CSS CHARTS */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .chart-container {
            background: var(--panel-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            height: 350px;
        }
        
        .chart-container.full-width {
            grid-column: 1 / -1;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .chart-filters {
            display: flex;
            gap: 8px;
        }
        
        .filter-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }
        
        .filter-btn:hover,
        .filter-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }
        
        /* SIMPLE BAR CHART */
        .simple-bar-chart {
            display: flex;
            align-items: flex-end;
            height: 260px;
            gap: 10px;
            margin-top: 20px;
            padding: 0 10px;
            position: relative;
        }

        .simple-bar-chart::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 1px;
            background: var(--border-color);
        }

        .simple-bar-chart::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 1px;
            background: var(--border-color);
        }

        .chart-bar {
            flex: 1;
            background: linear-gradient(to top, var(--accent-blue), var(--accent-cyan));
            border-radius: 4px 4px 0 0;
            position: relative;
            min-height: 10px;
            transition: all 0.3s ease;
        }

        .chart-bar:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .bar-value {
            position: absolute;
            top: -25px;
            left: 0;
            right: 0;
            text-align: center;
            color: var(--accent-cyan);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .bar-label {
            position: absolute;
            bottom: -25px;
            left: 0;
            right: 0;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .chart-grid-lines {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .grid-line {
            position: absolute;
            left: 0;
            right: 0;
            border-top: 1px dashed rgba(255, 255, 255, 0.1);
        }

        .grid-label {
            position: absolute;
            left: -30px;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 0.7rem;
        }

        /* DONUT CHART */
        .donut-chart-container {
            width: 250px;
            height: 250px;
            margin: 0 auto;
            position: relative;
        }

        .donut-chart {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            background: conic-gradient(
                #27ae60 0% var(--donut-segment-1),
                #f39c12 var(--donut-segment-1) var(--donut-segment-2),
                var(--accent-cyan) var(--donut-segment-2) var(--donut-segment-3),
                #888888 var(--donut-segment-3) 100%
            );
        }

        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 130px;
            height: 130px;
            background: var(--panel-dark);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .donut-total {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-cyan);
        }

        .donut-label {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .donut-legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .donut-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
        }

        .donut-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* RADAR CHART */
        .radar-chart {
            width: 250px;
            height: 250px;
            margin: 0 auto;
            position: relative;
        }

        .radar-grid {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: rotate(-90deg);
        }

        .radar-grid:nth-child(1) { transform: rotate(-90deg) scale(0.2); }
        .radar-grid:nth-child(2) { transform: rotate(-90deg) scale(0.4); }
        .radar-grid:nth-child(3) { transform: rotate(-90deg) scale(0.6); }
        .radar-grid:nth-child(4) { transform: rotate(-90deg) scale(0.8); }
        .radar-grid:nth-child(5) { transform: rotate(-90deg) scale(1); }

        .radar-axis {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 1px;
            height: 125px;
            background: rgba(255, 255, 255, 0.1);
            transform-origin: 0 0;
        }

        .radar-point {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--accent-blue);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
        }

        .radar-polygon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            fill: rgba(0, 122, 204, 0.2);
            stroke: var(--accent-blue);
            stroke-width: 2;
        }

        .radar-label {
            position: absolute;
            color: var(--text-secondary);
            font-size: 0.7rem;
            transform: translate(-50%, -50%);
        }

        /* HORIZONTAL BAR CHART */
        .horizontal-bar-chart {
            height: 260px;
            margin-top: 20px;
            position: relative;
            overflow-y: auto;
            padding-right: 10px;
        }

        .horizontal-bar {
            margin-bottom: 15px;
        }

        .bar-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.85rem;
        }

        .bar-name {
            color: var(--text-primary);
        }

        .bar-count {
            color: var(--accent-cyan);
            font-weight: 600;
        }

        .bar-track {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* TABLES */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: rgba(255, 255, 255, 0.02);
        }
        
        th {
            text-align: left;
            padding: 15px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border-color);
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        tbody tr {
            transition: background 0.2s;
        }
        
        tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        
        /* BUTTONS */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.3);
        }
        
        .btn-secondary {
            background: var(--panel-dark);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .btn-success {
            background: var(--success-green);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning-yellow);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger-red);
            color: white;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }
        
        /* BADGES */
        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .badge-success {
            background: rgba(39, 174, 96, 0.2);
            color: var(--success-green);
        }
        
        .badge-warning {
            background: rgba(243, 156, 18, 0.2);
            color: var(--warning-yellow);
        }
        
        .badge-danger {
            background: rgba(231, 76, 60, 0.2);
            color: var(--danger-red);
        }
        
        .badge-info {
            background: rgba(0, 122, 204, 0.2);
            color: var(--accent-cyan);
        }
        
        /* PROGRESS BAR */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
            border-radius: 10px;
            transition: width 0.3s;
        }
        
        /* STUDENT CARDS */
        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .student-card {
            background: var(--panel-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .student-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .student-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .student-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        .student-info h3 {
            font-size: 1rem;
            margin-bottom: 3px;
        }
        
        .student-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .student-stats {
            margin-top: 15px;
        }
        
        .student-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.85rem;
        }
        
        .student-stat label {
            color: var(--text-secondary);
        }
        
        .student-stat value {
            font-weight: 600;
        }
        
        /* ALERT CARDS */
        .alert-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .alert-card {
            background: var(--panel-dark);
            border-left: 4px solid var(--danger-red);
            border-radius: 8px;
            padding: 20px;
        }
        
        .alert-card.warning {
            border-left-color: var(--warning-yellow);
        }
        
        .alert-card.info {
            border-left-color: var(--accent-cyan);
        }
        
        .alert-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }
        
        .alert-icon {
            width: 40px;
            height: 40px;
            background: rgba(231, 76, 60, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--danger-red);
        }
        
        .alert-card.warning .alert-icon {
            background: rgba(243, 156, 18, 0.2);
            color: var(--warning-yellow);
        }
        
        /* MODAL */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: var(--panel-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            transition: color 0.3s;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: 25px;
        }
        
        /* SEARCH & FILTERS */
        .filters-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        
        /* DARK THEME DROPDOWN STYLES */
        select, .select-style {
            padding: 12px 15px;
            background: var(--panel-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
            padding-right: 40px;
        }
        
        select:hover, .select-style:hover {
            border-color: var(--accent-blue);
        }
        
        select:focus, .select-style:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
        }
        
        select option, .select-style option {
            background: var(--panel-dark);
            color: var(--text-primary);
            padding: 10px;
        }
        
        /* FORM CONTROLS */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        
        /* SWITCH TOGGLE */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--accent-blue);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* PROFILE PAGE */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 2.5rem;
        }
        
        .profile-info h2 {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .profile-meta {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }
        
        .profile-card {
            background: var(--panel-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
        }
        
        .profile-card h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }
        
        /* LOADING STATE */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* RESPONSIVE */
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 200px 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .simple-bar-chart {
                height: 200px;
            }
            
            .radar-chart {
                width: 200px;
                height: 200px;
            }
        }
        
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; }
            .profile-header { flex-direction: column; text-align: center; }
            .simple-bar-chart { height: 180px; }
            .donut-chart-container { width: 200px; height: 200px; }
            .donut-center { width: 100px; height: 100px; }
        }
        /* ============================================ */
        /* NEP TEACHING STUDIO STYLES */
        /* ============================================ */

        .teaching-studio-layout {
            display: grid;
            grid-template-columns: 320px 1fr 280px;
            gap: 20px;
            height: calc(100vh - 150px);
            margin-top: 20px;
        }

        .studio-left-panel,
        .studio-center-panel,
        .studio-right-panel {
            display: flex;
            flex-direction: column;
        }

        .studio-left-panel .panel,
        .studio-center-panel .panel,
        .studio-right-panel .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* LEFT PANEL - INPUT FORMS */
        .input-form-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
        }

        .form-section {
            margin-bottom: 25px;
        }

        .form-section h4 {
            color: var(--accent-cyan);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .form-actions {
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }

        /* RIGHT PANEL - TOOLS */
        .tools-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .tool-btn {
            background: var(--panel-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-primary);
        }

        .tool-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--accent-blue);
        }

        .tool-btn.active {
            background: rgba(0, 122, 204, 0.15);
            border-color: var(--accent-cyan);
            border-left: 3px solid var(--accent-cyan);
        }

        .tool-btn i {
            font-size: 1.2rem;
            color: var(--accent-cyan);
            margin-bottom: 8px;
        }

        .tool-btn span {
            display: block;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .tool-btn small {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        /* WORKFLOW PROGRESS */
        .workflow-progress {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .progress-steps {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .step-number {
            width: 30px;
            height: 30px;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .progress-step.active .step-number {
            background: var(--accent-blue);
            border-color: var(--accent-cyan);
            color: white;
        }

        .step-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .progress-step.active .step-label {
            color: var(--accent-cyan);
        }

        .progress-line {
            flex: 1;
            height: 2px;
            background: var(--border-color);
            margin: 0 5px;
        }

        .progress-step.active ~ .progress-step .step-number {
            background: var(--panel-dark);
        }

        /* AI SUGGESTIONS */
        .suggestions-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .suggestion-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            border: 1px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
        }

        .suggestion-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--border-color);
        }

        .suggestion-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, rgba(0, 122, 204, 0.2), rgba(0, 212, 255, 0.2));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-cyan);
            flex-shrink: 0;
        }

        .suggestion-content strong {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 3px;
        }

        .suggestion-content p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin: 0;
        }

        /* HISTORY */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .history-item {
            padding: 12px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--border-color);
        }

        .history-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 3px;
            color: var(--text-primary);
        }

        .history-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* CENTER PANEL - WORKSPACE */
        .workspace-container {
            flex: 1;
            overflow-y: auto;
            background: var(--panel-dark);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .empty-workspace {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* CONTENT WORKSPACE STYLES */
        .content-preview {
            padding: 30px;
        }

        .lesson-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .lesson-title {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: var(--accent-cyan);
        }

        .lesson-meta {
            display: flex;
            gap: 15px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .lesson-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            color: var(--accent-cyan);
        }

        /* NOTES CONTENT */
        .notes-content {
            line-height: 1.6;
        }

        .notes-content h3 {
            color: var(--text-primary);
            margin: 20px 0 10px 0;
            font-size: 1.1rem;
        }

        .notes-content p {
            margin-bottom: 15px;
            color: var(--text-secondary);
        }

        .notes-content ul, .notes-content ol {
            margin-left: 20px;
            margin-bottom: 15px;
            color: var(--text-secondary);
        }

        .notes-content li {
            margin-bottom: 8px;
        }

        /* QUESTIONS STYLES */
        .question-item {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-type {
            font-size: 0.85rem;
            padding: 4px 10px;
            background: rgba(0, 122, 204, 0.2);
            color: var(--accent-cyan);
            border-radius: 12px;
            font-weight: 600;
        }

        .question-difficulty {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .question-text {
            font-size: 1rem;
            margin-bottom: 15px;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .question-options {
            margin-bottom: 15px;
        }

        .question-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
        }

        .option-letter {
            width: 24px;
            height: 24px;
            background: var(--panel-dark);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .option-correct .option-letter {
            background: var(--success-green);
            color: white;
            border-color: var(--success-green);
        }

        .question-answer {
            padding: 12px;
            background: rgba(39, 174, 96, 0.1);
            border-left: 3px solid var(--success-green);
            border-radius: 4px;
            margin-top: 10px;
        }

        /* SIMULATOR PREVIEW */
        .simulator-preview {
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .simulator-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        /* RESPONSIVE DESIGN */
        @media (max-width: 1200px) {
            .teaching-studio-layout {
                grid-template-columns: 280px 1fr 250px;
            }
        }

        @media (max-width: 992px) {
            .teaching-studio-layout {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .studio-left-panel,
            .studio-right-panel {
                order: 2;
            }
            
            .studio-center-panel {
                order: 1;
                margin-bottom: 20px;
            }
        }

/* ============================================ */
/* CLASS PERFORMANCE - CARD LAYOUT FIXES        */
/* ============================================ */

/* Ensure stat cards never overlap */
.stats-grid {
    display: grid !important;
    grid-template-columns: repeat(4, 1fr) !important;
    gap: 20px !important;
    margin-bottom: 25px !important;
}

/* Fix stat card internal spacing */
.stat-card {
    display: flex !important;
    align-items: center !important;
    gap: 15px !important;
    padding: 20px !important;
    margin: 0 !important;
    width: 100% !important;
    min-width: 200px !important;
}

/* Fix icon size and position */
.stat-icon {
    width: 50px !important;
    height: 50px !important;
    min-width: 50px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

/* Fix chart container sizing */
.chart-container {
    height: 380px !important;
    overflow: hidden !important;
    padding: 20px !important;
    display: flex !important;
    flex-direction: column !important;
}

.chart-container .chart-header {
    flex-shrink: 0;
}

.chart-canvas-wrapper {
    position: relative;
    flex: 1;
    min-height: 0;
    width: 100%;
}

/* Fix donut chart container */
#performanceDistributionChart {
    max-width: 250px !important;
    max-height: 250px !important;
    margin: 0 auto !important;
}

/* Fix table layout */
table {
    table-layout: fixed !important;
    width: 100% !important;
}

th, td {
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    white-space: nowrap !important;
}

/* Fix progress bar width */
.progress-bar {
    width: 80px !important;
    height: 8px !important;
    flex-shrink: 0 !important;
}

/* Fix badge alignment */
.badge {
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 4px 10px !important;
}

/* Fix intervention cards */
#interventionStudents > div {
    width: 100% !important;
    min-width: 280px !important;
}

/* Responsive fixes */
@media (max-width: 1200px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr) !important;
    }
    
    [style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
    }
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr !important;
    }
}

        /* ============================================================ */
        /* RESPONSIVE DESIGN                                             */
        /* ============================================================ */

        /* Hamburger button */
        .hamburger-btn {
            display: none;
            background: none;
            border: none;
            color: #ccc;
            font-size: 1.4rem;
            cursor: pointer;
            padding: 8px 10px;
            border-radius: 4px;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        .hamburger-btn:hover { background: #3e3e42; color: #00d4ff; }

        /* Sidebar dark overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.55);
            z-index: 99;
        }
        .sidebar-overlay.active { display: block; }

        /* Sidebar open state */
        .sidebar.open { transform: translateX(0) !important; }

        @media (max-width: 992px) {
            body { overflow: auto; height: auto; }
            .dashboard {
                grid-template-columns: 1fr;
                grid-template-rows: 60px 1fr;
                height: auto;
                min-height: 100vh;
            }
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                width: 260px;
                z-index: 100;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                padding-top: 70px;
            }
            .hamburger-btn { display: flex; align-items: center; justify-content: center; }
        }

        @media (max-width: 768px) {
            .main-content { padding: 15px; overflow-y: auto; }
            .panel { padding: 15px; }
        }

        @media (max-width: 576px) {
            .header { padding: 0 10px; gap: 8px; }
            .logo { font-size: 1.15rem; }
            .panel { padding: 12px; }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- HEADER -->
        <div class="header">
            <button class="hamburger-btn" id="sidebarToggle" aria-label="Toggle menu">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo">
                <i class="fas fa-graduation-cap"></i>
                NEP Workbench
            </div>

            <div class="header-actions">
                <div class="notification-bell">
                    <i class="fas fa-bell" style="font-size: 1.2rem;"></i>
                    <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
                </div>
                
                <div class="user-info" onclick="toggleUserMenu()">
                    <div class="avatar" id="userAvatar">T</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Teacher Name</div>
                        <div class="user-role">Teacher</div>
                    </div>
                    <i class="fas fa-chevron-down" style="font-size: 0.8rem;"></i>
                </div>
            </div>
        </div>
        
        <!-- Sidebar overlay (mobile) -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- SIDEBAR -->
        <div class="sidebar" id="sidebar">
            <div class="nav-item active" onclick="showPage('overview')">
                <i class="fas fa-home"></i>
                <span>Overview</span>
            </div>
            <div class="nav-item" onclick="showPage('students')">
                <i class="fas fa-users"></i>
                <span>My Students</span>
            </div>
            <div class="nav-item" onclick="showPage('classes')">
                <i class="fas fa-chalkboard"></i>
                <span>Classes</span>
            </div>
            <div class="nav-item" onclick="showPage('analytics')">
                <i class="fas fa-chart-line"></i>
                <span>Analytics</span>
            </div>
            <div class="nav-item" onclick="showPage('reports')">
                <i class="fas fa-file-alt"></i>
                <span>Reports</span>
            </div>
            <div class="nav-item" onclick="showPage('profile')">
                <i class="fas fa-user"></i>
                <span>My Profile</span>
            </div>
            <div class="nav-item" onclick="showPage('teaching-studio')">
                <i class="fas fa-chalkboard-teacher"></i>
                <span>NEP Teaching Studio</span>
            </div>

            <div class="nav-item" onclick="showPage('validations')">
                <i class="fas fa-check-circle"></i>
                <span>Class Performance</span>
                <span class="badge-notification" id="pendingCount" style="display:none;">0</span>
            </div>
            <div class="nav-item" onclick="showPage('help')">
                <i class="fas fa-question-circle"></i>
                <span>Help</span>
            </div>
            <div class="nav-item" style="margin-top: auto; border-top: 1px solid var(--border-color); padding-top: 20px;" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </div>
        </div>
        
        <!-- MAIN CONTENT -->
        <div class="main-content">
            
            <!-- OVERVIEW PAGE -->
            <div class="page active" id="overview">
                <div class="page-header">
                    <h1>Welcome back, <span id="teacherNameDisplay">Teacher</span>! </h1>
                    <p>Here's your classroom overview for today</p>
                </div>
                
                <!-- STATISTICS CARDS -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="totalStudents">0</div>
                            <div class="stat-label">Total Students</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i> Active
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="avgPerformance">0%</div>
                            <div class="stat-label">Average Performance</div>
                            <div class="stat-change" id="performanceChange">
                                <i class="fas fa-minus"></i> No change
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="totalChallenges">0</div>
                            <div class="stat-label">Total Challenges</div>
                            <div class="stat-change positive">
                                <i class="fas fa-check"></i> Evaluated
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="pendingReviews">0</div>
                            <div class="stat-label">Pending Reviews</div>
                            <div class="stat-change warning">
                                <i class="fas fa-hourglass-half"></i> Awaiting
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="totalClasses">0</div>
                            <div class="stat-label">Active Classes</div>
                            <div class="stat-change positive">
                                <i class="fas fa-check"></i> Running
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-life-ring"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="openTickets">0</div>
                            <div class="stat-label">Open Tickets</div>
                            <div class="stat-change" id="ticketChange">
                                <i class="fas fa-minus"></i> Support
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- CHARTS SECTION -->
                <div class="charts-grid">
                    <!-- PERFORMANCE TREND CHART -->
                    <div class="chart-container full-width">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-line"></i> Student Performance Trend</h3>
                            <div class="chart-filters">
                                <button class="filter-btn active" onclick="changeChartPeriod(7)">7 Days</button>
                                <button class="filter-btn" onclick="changeChartPeriod(30)">30 Days</button>
                                <button class="filter-btn" onclick="changeChartPeriod(90)">3 Months</button>
                            </div>
                        </div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="trendChartCanvas"></canvas>
                        </div>
                    </div>

                    <!-- COMPETENCY RADAR CHART -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3><i class="fas fa-brain"></i> NEP Competencies</h3>
                        </div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="competencyBarChart"></canvas>
                        </div>
                    </div>

                    <!-- CHALLENGE STATUS DONUT CHART -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3><i class="fas fa-tasks"></i> Challenge Status</h3>
                        </div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="donutChartCanvas"></canvas>
                        </div>
                    </div>

                    <!-- PERFORMANCE DISTRIBUTION -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-bar"></i> Performance Distribution</h3>
                        </div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="distributionChartCanvas"></canvas>
                        </div>
                    </div>

                    <!-- SIMULATION USAGE -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3><i class="fas fa-flask"></i> Top Simulations</h3>
                        </div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="usageChartCanvas"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- STUDENTS NEEDING ATTENTION -->
                <div class="panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-exclamation-triangle"></i> Students Needing Attention</h2>
                        <button class="btn btn-secondary btn-sm">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                    </div>
                    
                    <div class="alert-grid" id="studentsNeedingAttention">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading students...</p>
                        </div>
                    </div>
                </div>
                
                <!-- TOP PERFORMERS -->
                <div class="panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-trophy"></i> Top Performers</h2>
                        <button class="btn btn-secondary btn-sm">
                            <i class="fas fa-crown"></i> View All
                        </button>
                    </div>
                    
                    <div class="student-grid" id="topPerformers">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading students...</p>
                        </div>
                    </div>
                </div>
                
                <!-- RECENT CHALLENGES -->
                <div class="panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-history"></i> Recent Challenges</h2>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Challenge ID</th>
                                <th>Student</th>
                                <th>Simulation</th>
                                <th>Difficulty</th>
                                <th>Status</th>
                                <th>Score</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentChallenges">
                            <tr>
                                <td colspan="8" style="text-align: center; color: var(--text-secondary);">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                        <p>Loading challenges...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- STUDENTS PAGE -->
            <div class="page" id="students">
                <div class="page-header">
                    <h1>My Students</h1>
                    <p>Manage and track your students' progress</p>
                </div>
                
                <div class="filters-bar">
                    <input type="text" class="search-input" placeholder="Search students by name or ID..." id="studentSearch">
                    <select id="classFilter">
                        <option value="">All Classes</option>
                        <option value="6">Class 6</option>
                        <option value="7">Class 7</option>
                        <option value="8">Class 8</option>
                        <option value="9">Class 9</option>
                        <option value="10">Class 10</option>
                        <option value="11">Class 11</option>
                        <option value="12">Class 12</option>
                    </select>
                    <select id="sectionFilter">
                        <option value="">All Sections</option>
                        <option value="A">Section A</option>
                        <option value="B">Section B</option>
                        <option value="C">Section C</option>
                    </select>
                    <button class="btn btn-primary" onclick="openAddStudentModal()">
                        <i class="fas fa-plus"></i> Add Student
                    </button>
                </div>
                
                <div class="panel">
                    <table>
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Name</th>
                                <th>Class</th>
                                <th>Section</th>
                                <th>Performance Index</th>
                                <th>Grade</th>
                                <th>Total Challenges</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentsList">
                            <tr>
                                <td colspan="8">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                        <p>Loading students...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- CLASS PERFORMANCE PAGE -->
            <div class="page" id="validations">
                <div class="page-header">
                    <h1><i class="fas fa-chart-bar"></i> Class Performance Dashboard</h1>
                    <p>Real-time performance analytics with class and section selector</p>
                </div>
                
                <!-- CLASS & SECTION SELECTOR CARD -->
                <div class="panel" style="margin-bottom: 25px; padding: 20px;">
                    <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <i class="fas fa-filter" style="color: var(--accent-cyan); font-size: 1.2rem;"></i>
                            <span style="color: var(--text-primary); font-weight: 600;">Select Class:</span>
                        </div>
                        
                        <!-- Class Selector -->
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; flex: 1;">
                            <select id="classSelector" class="form-control" style="width: 120px; background: var(--bg-dark);">
                                <option value="6">Class 6</option>
                                <option value="7">Class 7</option>
                                <option value="8">Class 8</option>
                                <option value="9">Class 9</option>
                                <option value="10" selected>Class 10</option>
                                <option value="11">Class 11</option>
                                <option value="12">Class 12</option>
                            </select>
                            
                            <!-- Section Selector -->
                            <select id="sectionSelector" class="form-control" style="width: 120px; background: var(--bg-dark);">
                                <option value="A" selected>Section A</option>
                                <option value="B">Section B</option>
                                <option value="C">Section C</option>
                                <option value="D">Section D</option>
                            </select>
                            
                            <!-- Load Button -->
                            <button class="btn btn-primary" onclick="loadClassPerformance()" style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-search"></i>
                                <span>Load Performance</span>
                            </button>
                            
                            <!-- Export Button -->
                            <button class="btn btn-secondary" onclick="exportClassReport()" style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-download"></i>
                                <span>Export Report</span>
                            </button>
                        </div>
                        
                        <!-- Last Updated -->
                        <div id="lastUpdated" style="color: var(--text-secondary); font-size: 0.85rem;">
                            <i class="fas fa-clock"></i> Last updated: Just now
                        </div>
                    </div>
                </div>
                
                <!-- KEY METRICS CARDS - 4 COLUMN GRID -->
                <div class="stats-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px;">
                    <!-- Card 1: Total Students -->
                    <div class="stat-card" style="padding: 20px;">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="classTotalStudents">0</div>
                            <div class="stat-label">Total Students</div>
                            <div class="stat-change" id="classInfo" style="color: var(--accent-cyan);">
                                <i class="fas fa-school"></i> Class 10-A
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card 2: Average Performance -->
                    <div class="stat-card" style="padding: 20px;">
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="avgPerformance">0%</div>
                            <div class="stat-label">Class Average</div>
                            <div class="stat-change" id="avgPerformanceLabel">
                                <i class="fas fa-minus-circle"></i> Loading...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card 3: Top Performer -->
                    <div class="stat-card" style="padding: 20px;">
                        <div class="stat-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="topPerformer">0%</div>
                            <div class="stat-label">Top Performer</div>
                            <div class="stat-change positive" id="topPerformerName">
                                <i class="fas fa-arrow-up"></i> -
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card 4: Need Intervention -->
                    <div class="stat-card" style="padding: 20px;">
                        <div class="stat-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="needsHelp">0</div>
                            <div class="stat-label">Need Intervention</div>
                            <div class="stat-change negative">
                                <i class="fas fa-arrow-down"></i> Below 50%
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- CHARTS ROW - 2 COLUMN GRID -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <!-- Chart 1: Performance Distribution Donut -->
                    <div class="chart-container" style="height: 380px; padding: 20px;">
                        <div class="chart-header" style="margin-bottom: 15px;">
                            <h3><i class="fas fa-chart-pie"></i> Performance Distribution</h3>
                            <span class="badge badge-info" id="studentCountBadge">Total: 0 Students</span>
                        </div>
                        <div style="height: 250px; position: relative; display: flex; justify-content: center;">
                            <canvas id="performanceDistributionChart" style="max-width: 250px; max-height: 250px;"></canvas>
                        </div>
                        <div class="donut-legend" id="distributionLegend" style="display: flex; justify-content: center; gap: 20px; margin-top: 15px; flex-wrap: wrap;">
                            <!-- Legend will be inserted here -->
                        </div>
                    </div>
                    
                    <!-- Chart 2: Grade Distribution Meters -->
                    <div class="chart-container" style="height: 380px; padding: 20px;">
                        <div class="chart-header" style="margin-bottom: 15px;">
                            <h3><i class="fas fa-graduation-cap"></i> Grade Distribution</h3>
                            <span class="badge badge-info" id="gradeDistributionBadge">By Performance</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 10px;">
                            <!-- A Grade -->
                            <div style="background: rgba(39, 174, 96, 0.1); padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2.2rem; font-weight: 700; color: #27ae60;" id="excellentCount">0</div>
                                <div style="font-size: 0.9rem; color: var(--text-primary); margin-top: 5px;">A Grade</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">(90-100%)</div>
                            </div>
                            <!-- B Grade -->
                            <div style="background: rgba(46, 204, 113, 0.1); padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2.2rem; font-weight: 700; color: #2ecc71;" id="goodCount">0</div>
                                <div style="font-size: 0.9rem; color: var(--text-primary); margin-top: 5px;">B Grade</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">(70-89%)</div>
                            </div>
                            <!-- C Grade -->
                            <div style="background: rgba(243, 156, 18, 0.1); padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2.2rem; font-weight: 700; color: #f39c12;" id="averageCount">0</div>
                                <div style="font-size: 0.9rem; color: var(--text-primary); margin-top: 5px;">C Grade</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">(50-69%)</div>
                            </div>
                            <!-- F Grade -->
                            <div style="background: rgba(231, 76, 60, 0.1); padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2.2rem; font-weight: 700; color: #e74c3c;" id="needsCount">0</div>
                                <div style="font-size: 0.9rem; color: var(--text-primary); margin-top: 5px;">F Grade</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">(Below 50%)</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- CLASS STATISTICS & QUICK ACTIONS ROW -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <!-- Statistics Card -->
                    <div class="panel" style="margin: 0; padding: 20px;">
                        <div class="panel-header" style="margin-bottom: 15px;">
                            <h3><i class="fas fa-calculator"></i> Class Statistics</h3>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; justify-content: space-between; padding-bottom: 8px; border-bottom: 1px solid var(--border-color);">
                                <span style="color: var(--text-secondary);">Class & Section:</span>
                                <span style="font-weight: 700; color: var(--accent-cyan);" id="className">10-A</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Mean Score:</span>
                                <span style="font-weight: 600; color: var(--text-primary);" id="meanScore">0%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Median Score:</span>
                                <span style="font-weight: 600; color: var(--text-primary);" id="medianScore">0%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Score Range:</span>
                                <span style="font-weight: 600; color: var(--text-primary);" id="scoreRange">0% - 0%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Standard Deviation:</span>
                                <span style="font-weight: 600; color: var(--text-primary);" id="stdDev">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions Card -->
                    <div class="panel" style="margin: 0; padding: 20px;">
                        <div class="panel-header" style="margin-bottom: 15px;">
                            <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <button class="btn btn-primary" onclick="exportClassReport()" style="width: 100%; justify-content: center; padding: 12px;">
                                <i class="fas fa-file-pdf"></i> Export as PDF
                            </button>
                            <button class="btn btn-secondary" onclick="exportClassReport('excel')" style="width: 100%; justify-content: center; padding: 12px;">
                                <i class="fas fa-file-excel"></i> Export as Excel
                            </button>
                            <button class="btn btn-secondary" onclick="refreshClassPerformance()" style="width: 100%; justify-content: center; padding: 12px;">
                                <i class="fas fa-sync-alt"></i> Refresh Data
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- STUDENT PERFORMANCE TABLE -->
                <div class="panel" style="margin-bottom: 25px; padding: 20px;">
                    <div class="panel-header" style="margin-bottom: 20px;">
                        <h2><i class="fas fa-users"></i> Student Performance Details</h2>
                        <div class="panel-actions" style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary btn-sm" onclick="sortStudents('name')">
                                <i class="fas fa-sort-alpha-down"></i> Sort by Name
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="sortStudents('performance')">
                                <i class="fas fa-sort-numeric-down"></i> Sort by Score
                            </button>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto; max-height: 400px; overflow-y: auto;">
                        <table style="width: 100%;">
                            <thead style="position: sticky; top: 0; background: var(--panel-dark);">
                                <tr>
                                    <th style="width: 60px;">Rank</th>
                                    <th>Student ID</th>
                                    <th>Student Name</th>
                                    <th style="width: 150px;">Performance</th>
                                    <th style="width: 100px;">Grade</th>
                                    <th style="width: 120px;">Status</th>
                                    <th style="width: 120px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentPerformanceTable">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px;">
                                        <div class="loading">
                                            <div class="spinner"></div>
                                            <p>Select class and section to load performance data...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- INTERVENTION SECTION - DYNAMICALLY SHOWN -->
                <div class="panel" id="interventionSection" style="margin-top: 0; border-left: 4px solid #e74c3c; padding: 20px; display: none;">
                    <div class="panel-header" style="margin-bottom: 15px;">
                        <h2 style="color: #e74c3c;"><i class="fas fa-exclamation-triangle"></i> Students Needing Immediate Intervention</h2>
                        <span class="badge badge-danger" id="interventionCount">0</span>
                    </div>
                    <div id="interventionStudents" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                        <!-- Intervention cards will be inserted here -->
                    </div>
                </div>
            </div>
            
            <!-- CLASSES PAGE -->
            <div class="page" id="classes">
                <div class="page-header">
                    <h1>My Classes</h1>
                    <p>View and manage your class sections</p>
                </div>
                
                <div class="student-grid" id="classesList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading classes...</p>
                    </div>
                </div>
            </div>
            
            <!-- ANALYTICS PAGE -->
            <div class="page" id="analytics">
                <div class="page-header">
                    <h1>Analytics & Insights</h1>
                    <p>Detailed performance analytics and trends</p>
                </div>
                
                <div class="charts-grid">
                    <div class="chart-container full-width">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-area"></i> Weekly Engagement Trend</h3>
                        </div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="engagementChartCanvas"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-header">
                            <h3><i class="fas fa-graduation-cap"></i> Subject-wise Performance</h3>
                        </div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="subjectChartCanvas"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-header">
                            <h3><i class="fas fa-tasks"></i> Challenge Difficulty vs Success</h3>
                        </div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="difficultyChartCanvas"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- REPORTS PAGE -->
            <div class="page" id="reports">
                <div class="page-header">
                    <h1>Reports</h1>
                    <p>Generate and download NEP 2020 performance reports</p>
                </div>

                <!-- Class Report -->
                <div class="panel">
                    <h3><i class="fas fa-users" style="margin-right:8px;color:#00d4ff;"></i>Class Performance Report</h3>
                    <div class="filters-bar" style="flex-wrap:wrap;gap:10px;align-items:center;">
                        <select id="reportClass" onchange="onReportClassChange()" style="min-width:140px;">
                            <option value="">Select Class</option>
                        </select>
                        <select id="reportSection" style="min-width:140px;">
                            <option value="">Select Section</option>
                        </select>
                        <select id="reportPeriod" style="min-width:150px;">
                            <option value="">All Time</option>
                            <option value="monthly">This Month</option>
                            <option value="weekly">This Week</option>
                        </select>
                        <button class="btn btn-primary" onclick="generateClassReport()">
                            <i class="fas fa-chart-bar"></i> Generate Report
                        </button>
                        <button class="btn btn-secondary" id="downloadClassReportBtn" onclick="downloadClassReportPDF()" style="display:none;">
                            <i class="fas fa-download"></i> Download PDF
                        </button>
                    </div>
                    <div id="classReportResult" style="margin-top:16px;"></div>
                </div>

                <!-- Student Individual Report -->
                <div class="panel">
                    <h3><i class="fas fa-user-graduate" style="margin-right:8px;color:#00d4ff;"></i>Student Individual Report</h3>
                    <div class="filters-bar" style="gap:10px;align-items:center;">
                        <input type="text" class="search-input" placeholder="Enter Student ID (e.g. STU-XXXXX)" id="reportStudentId" style="min-width:240px;" onkeydown="if(event.key==='Enter')generateStudentReport()">
                        <button class="btn btn-primary" onclick="generateStudentReport()">
                            <i class="fas fa-file-alt"></i> Generate Report
                        </button>
                        <button class="btn btn-secondary" id="downloadStudentReportBtn" onclick="downloadStudentReportPDF()" style="display:none;">
                            <i class="fas fa-download"></i> Download PDF
                        </button>
                    </div>
                    <div id="studentReportResult" style="margin-top:16px;"></div>
                </div>
            </div>

            <!-- NEP TEACHING STUDIO PAGE -->
            <div class="page" id="teaching-studio">
                <div class="page-header">
                    <h1><i class="fas fa-chalkboard-teacher"></i> NEP Teaching Studio</h1>
                    <p>Create structured lessons with notes, questions, simulators in one guided flow</p>
                </div>
                
                <!-- TEACHING STUDIO LAYOUT -->
                <div class="teaching-studio-layout">
                    <!-- LEFT PANEL - DYNAMIC INPUT FORM -->
                    <div class="studio-left-panel">
                        <div class="panel">
                            <div class="panel-header">
                                <h2 id="input-panel-title">Configure Lesson</h2>
                                <div id="tool-status" class="badge badge-info">Notes-Builder</div>
                            </div>
                            
                            <div class="input-form-container" id="input-form-container">
                                <!-- Dynamic forms will load here based on selected tool -->
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <p>Loading configuration...</p>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button class="btn btn-primary" id="generate-btn">
                                    <i class="fas fa-magic"></i> Generate Content
                                </button>
                                <button class="btn btn-secondary" id="clear-btn">
                                    <i class="fas fa-trash"></i> Clear
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CENTER PANEL - MAIN WORKSPACE -->
                    <div class="studio-center-panel">
                        <div class="panel">
                            <div class="panel-header">
                                <h2><i class="fas fa-file-alt"></i> Generated Content</h2>
                                <div class="panel-actions">
                                    <button class="btn btn-secondary btn-sm" id="edit-toggle">
                                        <i class="fas fa-edit"></i> Edit Mode
                                    </button>
                                </div>
                            </div>
                            
                            <div class="workspace-container" id="workspace-container">
                                <!-- Empty State -->
                                <div class="empty-workspace" id="empty-workspace">
                                    <div style="text-align: center; padding: 60px 20px;">
                                        <i class="fas fa-chalkboard" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 20px;"></i>
                                        <h3 style="color: var(--text-secondary); margin-bottom: 10px;">No Content Generated Yet</h3>
                                        <p style="color: var(--text-secondary); max-width: 400px; margin: 0 auto;">
                                            Configure your settings on the left panel and click "Generate Content"
                                        </p>
                                    </div>
                                </div>
                                
                                <!-- Generated content will be inserted here -->
                                <div id="content-workspace" style="display: none;">
                                    <!-- Dynamic content loads here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- RIGHT PANEL - TOOLS & GUIDANCE -->
                    <div class="studio-right-panel">
                        <!-- TOOLS SECTION -->
                        <div class="panel">
                            <div class="panel-header">
                                <h3><i class="fas fa-tools"></i> Tools</h3>
                            </div>
                            <div class="tools-list">
                                <button class="tool-btn active" data-tool="notes-builder" onclick="selectTool('notes-builder')">
                                    <i class="fas fa-file-alt"></i>
                                    <span>Notes-Builder</span>
                                    <small>Step 1: Create foundation</small>
                                </button>
                                
                                <button class="tool-btn" data-tool="question-builder" onclick="selectTool('question-builder')">
                                    <i class="fas fa-question-circle"></i>
                                    <span>Question-Builder</span>
                                    <small>Step 2: Create assessments</small>
                                </button>
                                
                                <button class="tool-btn" data-tool="simulator-builder" onclick="selectTool('simulator-builder')">
                                    <i class="fas fa-flask"></i>
                                    <span>Simulator-Builder</span>
                                    <small>Step 3: Create experiences</small>
                                </button>
                                
                                <button class="tool-btn" data-tool="export-pdf" onclick="selectTool('export-pdf')">
                                    <i class="fas fa-file-pdf"></i>
                                    <span>Export as PDF</span>
                                    <small>Step 4: Final document</small>
                                </button>
                            </div>
                            
                            <div class="workflow-progress">
                                <div class="progress-steps">
                                    <div class="progress-step active">
                                        <div class="step-number">1</div>
                                        <div class="step-label">Notes</div>
                                    </div>
                                    <div class="progress-line"></div>
                                    <div class="progress-step">
                                        <div class="step-number">2</div>
                                        <div class="step-label">Questions</div>
                                    </div>
                                    <div class="progress-line"></div>
                                    <div class="progress-step">
                                        <div class="step-number">3</div>
                                        <div class="step-label">Simulator</div>
                                    </div>
                                    <div class="progress-line"></div>
                                    <div class="progress-step">
                                        <div class="step-number">4</div>
                                        <div class="step-label">Export</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AI SUGGESTIONS SECTION -->
                        <div class="panel">
                            <div class="panel-header">
                                <h3><i class="fas fa-lightbulb"></i> AI Enhancements</h3>
                            </div>
                            <div class="suggestions-container">
                                <div class="suggestion-item">
                                    <div class="suggestion-icon">
                                        <i class="fas fa-briefcase"></i>
                                    </div>
                                    <div class="suggestion-content">
                                        <strong>Case Study</strong>
                                        <p>Add real-world industry example</p>
                                    </div>
                                </div>
                                
                                <div class="suggestion-item">
                                    <div class="suggestion-icon">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                    <div class="suggestion-content">
                                        <strong>Common Misconceptions</strong>
                                        <p>Address typical student mistakes</p>
                                    </div>
                                </div>
                                
                                <div class="suggestion-item">
                                    <div class="suggestion-icon">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <div class="suggestion-content">
                                        <strong>Real-world Application</strong>
                                        <p>Show practical uses of this concept</p>
                                    </div>
                                </div>
                                
                                <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="addAIEnhancements()">
                                    <i class="fas fa-plus"></i> Add AI Enhancements
                                </button>
                            </div>
                        </div>
                        
                        <!-- HISTORY SECTION -->
                        <div class="panel">
                            <div class="panel-header">
                                <h3><i class="fas fa-history"></i> Recent Lessons</h3>
                            </div>
                            <div class="history-list" id="history-list">
                                <div style="color:var(--text-secondary);font-size:0.85rem;padding:10px;">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- PROFILE PAGE -->
            <div class="page" id="profile">
                <div class="page-header">
                    <h1>My Profile</h1>
                    <p>Manage your account settings and preferences</p>
                </div>
                
                <div class="profile-header">
                    <div class="profile-avatar" id="profileAvatar">T</div>
                    <div class="profile-info">
                        <h2 id="profileName">Teacher Name</h2>
                        <div class="profile-meta">
                            <div><i class="fas fa-id-card"></i> Teacher ID: <span id="profileTeacherId">TCH-XXXXX</span></div>
                            <div><i class="fas fa-school"></i> School: <span id="profileSchool">School Name</span></div>
                            <div><i class="fas fa-envelope"></i> Email: <span id="profileEmail">teacher@email.com</span></div>
                            <div><i class="fas fa-phone"></i> Phone: <span id="profilePhone">+91 00000 00000</span></div>
                        </div>
                    </div>
                </div>
                
                <div class="profile-grid">
                    <!-- PERSONAL INFORMATION -->
                    <div class="profile-card">
                        <h3><i class="fas fa-user-edit"></i> Personal Information</h3>
                        <form id="profileForm">
                            <div class="form-group">
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="editName" placeholder="Enter your full name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="editPhone" placeholder="Enter phone number">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Subjects</label>
                                <select class="form-control" id="editSubjects" multiple style="height: 100px;">
                                    <option value="Physics">Physics</option>
                                    <option value="Chemistry">Chemistry</option>
                                    <option value="Mathematics">Mathematics</option>
                                    <option value="Biology">Biology</option>
                                    <option value="Computer Science">Computer Science</option>
                                    <option value="English">English</option>
                                    <option value="Hindi">Hindi</option>
                                    <option value="Social Studies">Social Studies</option>
                                </select>
                                <small style="color: #888; font-size: 0.8rem;">Hold Ctrl/Cmd to select multiple subjects</small>
                            </div>
                            <button type="submit" class="btn btn-primary" style="margin-top: 10px;">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </form>
                    </div>
                    
                    <!-- NOTIFICATION PREFERENCES -->
                    <div class="profile-card">
                        <h3><i class="fas fa-bell"></i> Notification Preferences</h3>
                        <form id="preferencesForm">
                            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <label class="form-label" style="margin-bottom: 0;">Email Notifications</label>
                                    <small style="display: block; color: #888; font-size: 0.8rem;">Receive updates via email</small>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="emailNotifications" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            
                            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <label class="form-label" style="margin-bottom: 0;">Challenge Notifications</label>
                                    <small style="display: block; color: #888; font-size: 0.8rem;">Get notified about new challenges</small>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="challengeNotifications" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            
                            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <label class="form-label" style="margin-bottom: 0;">Weekly Reports</label>
                                    <small style="display: block; color: #888; font-size: 0.8rem;">Receive weekly performance reports</small>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="weeklyReport" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            
                            <button type="button" class="btn btn-primary" onclick="savePreferences()" style="margin-top: 10px;">
                                <i class="fas fa-save"></i> Save Preferences
                            </button>
                        </form>
                    </div>
                    
                    <!-- ACCOUNT STATISTICS -->
                    <div class="profile-card">
                        <h3><i class="fas fa-chart-bar"></i> Account Statistics</h3>
                        <div id="profileStats">
                            <div class="student-stat">
                                <label>Total Students</label>
                                <value id="statTotalStudents">0</value>
                            </div>
                            <div class="student-stat">
                                <label>Total Classes</label>
                                <value id="statTotalClasses">0</value>
                            </div>
                            <div class="student-stat">
                                <label>Challenges Created</label>
                                <value id="statChallengesCreated">0</value>
                            </div>
                            <div class="student-stat">
                                <label>Challenges Evaluated</label>
                                <value id="statChallengesEvaluated">0</value>
                            </div>
                            <div class="student-stat">
                                <label>Account Status</label>
                                <value><span class="badge badge-success" id="statStatus">Active</span></value>
                            </div>
                            <div class="student-stat">
                                <label>Member Since</label>
                                <value id="statCreatedAt">-</value>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PASSWORD CHANGE -->
                    <div class="profile-card">
                        <h3><i class="fas fa-key"></i> Change Password</h3>
                        <form id="passwordForm">
                            <div class="form-group">
                                <label class="form-label">Current Password</label>
                                <input type="password" class="form-control" id="currentPassword" placeholder="Enter current password">
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Password</label>
                                <input type="password" class="form-control" id="newPassword" placeholder="Enter new password">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Confirm New Password</label>
                                <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm new password">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-key"></i> Change Password
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- HELP TICKETS PAGE -->
            <div class="page" id="help">
                <div class="page-header">
                    <h1>Help Tickets</h1>
                    <p>Manage student help requests</p>
                </div>
                
                <div class="panel">
                    <table>
                        <thead>
                            <tr>
                                <th>Ticket ID</th>
                                <th>Student</th>
                                <th>Subject</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ticketsList">
                            <tr>
                                <td colspan="6">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                        <p>Loading tickets...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- MODALS -->
    <div id="studentDetailsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-graduate"></i> Student Details</h2>
                <button class="modal-close" onclick="closeModal('studentDetailsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="studentDetailsBody">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
    
    <div id="addStudentModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> Add New Student</h2>
                <button class="modal-close" onclick="closeModal('addStudentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="addStudentForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" placeholder="Student Name" id="studentName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" placeholder="student@email.com" id="studentEmail" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" placeholder="Password" id="studentPassword" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" placeholder="Confirm Password" id="studentConfirmPassword" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Class</label>
                            <select id="studentClass" class="form-control" required>
                                <option value="6">Class 6</option>
                                <option value="7">Class 7</option>
                                <option value="8">Class 8</option>
                                <option value="9">Class 9</option>
                                <option value="10" selected>Class 10</option>
                                <option value="11">Class 11</option>
                                <option value="12">Class 12</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Section</label>
                            <select id="studentSection" class="form-control" required>
                                <option value="A" selected>Section A</option>
                                <option value="B">Section B</option>
                                <option value="C">Section C</option>
                                <option value="D">Section D</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Roll Number</label>
                            <input type="number" class="form-control" placeholder="Roll Number" id="studentRollNumber" required>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addStudentModal')">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add Student
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        // TeacherDashboard.js with CSS Charts
        const API_BASE_URL = '/api';

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            initializeDashboard();
        });

        function checkAuth() {
            const token = localStorage.getItem('authToken');
            const userType = localStorage.getItem('userType');
            
            if (!token || userType !== 'teacher') {
                window.location.href = '/login';
                return;
            }
        }

        async function initializeDashboard() {
            console.log(' Initializing Teacher Dashboard...');
            
            try {
                await loadTeacherProfile();
                console.log(' Profile loaded');
                
                await loadDashboardData();
                console.log(' Dashboard data loaded');
                
                initializeOverviewCharts();
                initializeFilterListeners();
                
                setInterval(() => {
                    console.log(' Auto-refreshing dashboard...');
                    loadDashboardData();
                }, 300000);
                
                console.log(' Dashboard initialization complete');
                
            } catch (error) {
                console.error(' Dashboard initialization error:', error);
                showError('Failed to load dashboard: ' + error.message);
            }
        }

        async function apiCall(endpoint, options = {}) {
            const token = localStorage.getItem('authToken');
            
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    ...defaultOptions,
                    ...options,
                    headers: { ...defaultOptions.headers, ...options.headers }
                });
                
                if (response.status === 401) {
                    localStorage.clear();
                    window.location.href = '/login';
                    return;
                }
                
                if (response.status === 404) {
                    return { success: false, data: null, message: 'Endpoint not found' };
                }
                
                const data = await response.json();
                return data;
                
            } catch (error) {
                console.error(` API Call failed: ${endpoint}`, error);
                return { success: false, data: null, message: error.message };
            }
        }

        async function loadTeacherProfile() {
            try {
                const data = await apiCall('/teacher/profile');
                if (data && data.success && data.data) {
                    const teacher = data.data.teacher;
                    
                    document.getElementById('userName').textContent = teacher.name;
                    document.getElementById('teacherNameDisplay').textContent = teacher.name;
                    document.getElementById('userAvatar').textContent = teacher.name.charAt(0).toUpperCase();
                    
                    document.getElementById('profileName').textContent = teacher.name;
                    document.getElementById('profileAvatar').textContent = teacher.name.charAt(0).toUpperCase();
                    document.getElementById('profileTeacherId').textContent = teacher.teacherId;
                    document.getElementById('profileEmail').textContent = teacher.email;
                    document.getElementById('profilePhone').textContent = teacher.phone;
                    document.getElementById('profileSchool').textContent = data.data.school?.schoolName || 'Unknown School';
                    
                    document.getElementById('editName').value = teacher.name;
                    document.getElementById('editPhone').value = teacher.phone;
                    
                    const subjectSelect = document.getElementById('editSubjects');
                    Array.from(subjectSelect.options).forEach(option => {
                        if (teacher.subjects && teacher.subjects.includes(option.value)) {
                            option.selected = true;
                        }
                    });
                    
                    document.getElementById('emailNotifications').checked = teacher.preferences?.emailNotifications || true;
                    document.getElementById('challengeNotifications').checked = teacher.preferences?.challengeNotifications || true;
                    document.getElementById('weeklyReport').checked = teacher.preferences?.weeklyReport || true;
                    
                    if (teacher.stats) {
                        document.getElementById('statTotalStudents').textContent = teacher.stats.totalStudents || 0;
                        document.getElementById('statTotalClasses').textContent = teacher.stats.totalClasses || 0;
                        document.getElementById('statChallengesCreated').textContent = teacher.stats.totalChallengesCreated || 0;
                        document.getElementById('statChallengesEvaluated').textContent = teacher.stats.totalChallengesEvaluated || 0;
                    }
                    
                    document.getElementById('statStatus').textContent = teacher.status || 'Active';
                    document.getElementById('statCreatedAt').textContent = formatDate(teacher.createdAt, true);
                    
                    window.teacherData = teacher;
                }
            } catch (error) {
                console.error('Load profile error:', error);
            }
        }

        async function updateProfile(profileData) {
            try {
                const response = await apiCall('/teacher/profile', {
                    method: 'PUT',
                    body: JSON.stringify(profileData)
                });
                
                if (response && response.success) {
                    await loadTeacherProfile();
                    return true;
                }
            } catch (error) {
                console.error('Update profile error:', error);
                throw error;
            }
        }

        async function loadDashboardData() {
            try {
                console.log(' Loading dashboard data...');
                const data = await apiCall('/teacher/dashboard');
                
                if (data && data.success && data.data) {
                    document.getElementById('totalStudents').textContent = data.data.statistics?.totalStudents || 0;
                    document.getElementById('totalChallenges').textContent = data.data.statistics?.totalChallenges || 0;
                    document.getElementById('pendingReviews').textContent = data.data.statistics?.pendingReviews || 0;
                    document.getElementById('totalClasses').textContent = data.data.statistics?.totalClasses || 0;
                    document.getElementById('openTickets').textContent = data.data.statistics?.openTickets || 0;
                    
                    if (data.data.statistics?.pendingReviews > 0) {
                        document.getElementById('pendingCount').textContent = data.data.statistics.pendingReviews;
                        document.getElementById('pendingCount').style.display = 'inline-block';
                        document.getElementById('notificationCount').textContent = data.data.statistics.pendingReviews;
                        document.getElementById('notificationCount').style.display = 'inline-block';
                    } else {
                        document.getElementById('pendingCount').style.display = 'none';
                        document.getElementById('notificationCount').style.display = 'none';
                    }

                    if (data.data.recentChallenges && data.data.recentChallenges.length > 0) {
                        displayRecentChallengesWithData(data.data.recentChallenges);
                    } else {
                        await displayRecentChallenges();
                    }
                    
                    if (data.data.statistics?.totalStudents > 0) {
                        const avgPerf = await calculateAveragePerformance();
                        document.getElementById('avgPerformance').textContent = avgPerf.toFixed(1) + '%';
                    }
                    
                    displayStudentsNeedingAttention(data.data.studentsNeedingAttention || []);
                    displayTopPerformers(data.data.topPerformers || []);
                    
                    console.log(' Dashboard loaded successfully');
                }
                
            } catch (error) {
                console.error(' Load dashboard error:', error);
                showError('Failed to load dashboard data: ' + error.message);
                
                try {
                    await displayRecentChallenges();
                } catch (challengeError) {
                    console.error(' Also failed to load challenges:', challengeError);
                }
            }
        }

        async function calculateAveragePerformance() {
            try {
                const data = await apiCall('/teacher/analytics/overview');
                return data.data.overview.averagePerformance || 0;
            } catch (error) {
                return 0;
            }
        }

        async function displayRecentChallenges() {
            const tbody = document.getElementById('recentChallenges');
            
            try {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: var(--text-secondary);">
                            <div class="loading">
                                <div class="spinner"></div>
                                <p>Loading recent challenges...</p>
                            </div>
                        </td>
                    </tr>
                `;
                
                const data = await apiCall('/teacher/challenges?limit=10&sort=-generatedAt');
                const challenges = data.data?.challenges || [];
                
                if (challenges.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #888;">No recent challenges found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = challenges.map(challenge => {
                    let studentDisplay = challenge.studentId || 'Unknown';
                    if (challenge.student?.name) {
                        studentDisplay = challenge.student.name;
                    }
                    
                    let scoreDisplay = '-';
                    if (challenge.results?.totalScore) {
                        scoreDisplay = challenge.results.totalScore.toFixed(1) + '%';
                    } else if (challenge.score) {
                        scoreDisplay = challenge.score.toFixed(1) + '%';
                    }
                    
                    const dateValue = challenge.submittedAt || challenge.generatedAt || challenge.createdAt;
                    
                    return `
                        <tr>
                            <td><strong>${challenge.challengeId || 'N/A'}</strong></td>
                            <td>${studentDisplay}</td>
                            <td>
                                <span class="badge badge-info">
                                    ${formatSimulationType(challenge.simulationType || 'General')}
                                </span>
                            </td>
                            <td>
                                <span class="badge ${getDifficultyBadgeClass(challenge.difficulty)}">
                                    ${challenge.difficulty || 'medium'}
                                </span>
                            </td>
                            <td>
                                <span class="badge ${getStatusBadgeClass(challenge.status)}">
                                    ${formatStatus(challenge.status || 'generated')}
                                </span>
                            </td>
                            <td style="font-weight: 600; color: ${getScoreColor(scoreDisplay)}">
                                ${scoreDisplay}
                            </td>
                            <td>${formatDate(dateValue)}</td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="viewChallengeDetails('${challenge.challengeId}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error(' Error loading recent challenges:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: #e74c3c; padding: 30px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem; margin-bottom: 10px;"></i>
                            <p>Failed to load recent challenges</p>
                        </td>
                    </tr>
                `;
            }
        }

        function displayRecentChallengesWithData(challenges) {
            const tbody = document.getElementById('recentChallenges');
            
            if (!challenges || challenges.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #888; padding: 30px;"> No challenges found</td></tr>';
                return;
            }
            
            tbody.innerHTML = challenges.map(challenge => {
                const studentDisplay = challenge.student?.name || challenge.studentId || 'Unknown';
                const scoreDisplay = challenge.results?.totalScore ? 
                    challenge.results.totalScore.toFixed(1) + '%' : 
                    (challenge.score ? challenge.score.toFixed(1) + '%' : '-');
                const dateValue = challenge.submittedAt || challenge.generatedAt || challenge.createdAt;
                
                return `
                    <tr>
                        <td><strong>${challenge.challengeId || 'N/A'}</strong></td>
                        <td>${studentDisplay}</td>
                        <td>
                            <span class="badge badge-info">
                                ${formatSimulationType(challenge.simulationType || 'General')}
                            </span>
                        </td>
                        <td>
                            <span class="badge ${getDifficultyBadgeClass(challenge.difficulty)}">
                                ${challenge.difficulty || 'medium'}
                            </span>
                        </td>
                        <td>
                            <span class="badge ${getStatusBadgeClass(challenge.status)}">
                                ${formatStatus(challenge.status || 'generated')}
                            </span>
                        </td>
                        <td style="font-weight: 600; color: ${getScoreColor(scoreDisplay)}">
                            ${scoreDisplay}
                        </td>
                        <td>${formatDate(dateValue)}</td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="viewChallengeDetails('${challenge.challengeId}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function formatSimulationType(type) {
            if (!type) return 'General';
            if (type.includes('-')) {
                return type.split('-')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
            }
            return type.charAt(0).toUpperCase() + type.slice(1);
        }

        function formatStatus(status) {
            if (!status) return 'Unknown';
            const statusMap = {
                'in-progress': ' In Progress',
                'generated': ' Generated',
                'submitted': ' Submitted',
                'evaluated': ' Evaluated',
                'pending': ' Pending Review',
                'reviewed': ' Reviewed'
            };
            return statusMap[status.toLowerCase()] || status.charAt(0).toUpperCase() + status.slice(1).replace('-', ' ');
        }

        function getScoreColor(score) {
            if (score === '-' || !score) return 'var(--text-secondary)';
            const numScore = parseFloat(score);
            if (numScore >= 80) return '#27ae60';
            if (numScore >= 60) return '#f39c12';
            if (numScore >= 40) return '#e67e22';
            return '#e74c3c';
        }

        function displayStudentsNeedingAttention(students) {
            const container = document.getElementById('studentsNeedingAttention');
            
            if (!students || students.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888;">No students need attention at this time</p>';
                return;
            }
            
            container.innerHTML = students.map(student => `
                <div class="alert-card">
                    <div class="alert-header">
                        <div class="alert-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div>
                            <h4>${student.name}</h4>
                            <p style="font-size: 0.85rem; color: #888; margin-top: 3px;">
                                ${student.studentId} | Class ${student.class}-${student.section}
                            </p>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #888;">Performance Index:</span>
                            <strong style="color: #e74c3c;">${student.performanceIndex.toFixed(1)}%</strong>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${student.performanceIndex}%; background: #e74c3c;"></div>
                        </div>
                        <button class="btn btn-secondary btn-sm" style="margin-top: 12px; width: 100%;" 
                                onclick="viewStudentDetails('${student.studentId}')">
                            <i class="fas fa-eye"></i> View Details
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function displayTopPerformers(students) {
            const container = document.getElementById('topPerformers');
            
            if (!students || students.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888;">No performance data available</p>';
                return;
            }
            
            container.innerHTML = students.map((student, index) => `
                <div class="student-card">
                    <div class="student-header">
                        <div class="student-avatar">${student.name.charAt(0).toUpperCase()}</div>
                        <div class="student-info">
                            <h3>${student.name}</h3>
                            <div class="student-meta">
                                ${student.studentId} | Class ${student.class}-${student.section}
                            </div>
                        </div>
                        ${index === 0 ? '<i class="fas fa-crown" style="color: #f39c12; font-size: 1.2rem;"></i>' : ''}
                    </div>
                    <div class="student-stats">
                        <div class="student-stat">
                            <label>Performance Index:</label>
                            <value style="color: #27ae60;">${student.performanceIndex.toFixed(1)}%</value>
                        </div>
                        <div class="progress-bar" style="margin-bottom: 10px;">
                            <div class="progress-fill" style="width: ${student.performanceIndex}%;"></div>
                        </div>
                        <div class="student-stat">
                            <label>Grade:</label>
                            <value>${student.grade || 'N/A'}</value>
                        </div>
                        <button class="btn btn-primary btn-sm" style="margin-top: 12px; width: 100%;" 
                                onclick="viewStudentDetails('${student.studentId}')">
                            <i class="fas fa-eye"></i> View Profile
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function getDifficultyBadgeClass(difficulty) {
            const classes = {
                'easy': 'badge-success',
                'medium': 'badge-warning',
                'hard': 'badge-danger'
            };
            return classes[difficulty?.toLowerCase()] || 'badge-info';
        }

        function getStatusBadgeClass(status) {
            const classes = {
                'evaluated': 'badge-success',
                'submitted': 'badge-warning',
                'generated': 'badge-info',
                'inProgress': 'badge-info'
            };
            return classes[status] || 'badge-info';
        }

        function formatDate(dateString, dateOnly = false) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (dateOnly) {
                return date.toLocaleDateString();
            }
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function showError(message) {
            alert('Error: ' + message);
        }

        function showSuccess(message) {
            alert('Success: ' + message);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.clear();
                window.location.href = '/login';
            }
        }

        // PROFILE PAGE FUNCTIONS
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const profileData = {
                name: document.getElementById('editName').value,
                phone: document.getElementById('editPhone').value,
                subjects: Array.from(document.getElementById('editSubjects').selectedOptions).map(opt => opt.value)
            };
            
            try {
                await updateProfile(profileData);
                showSuccess('Profile updated successfully!');
            } catch (error) {
                showError('Failed to update profile: ' + error.message);
            }
        });

        async function savePreferences() {
            const preferences = {
                emailNotifications: document.getElementById('emailNotifications').checked,
                challengeNotifications: document.getElementById('challengeNotifications').checked,
                weeklyReport: document.getElementById('weeklyReport').checked
            };
            
            try {
                await updateProfile({ preferences });
                showSuccess('Preferences saved successfully!');
            } catch (error) {
                showError('Failed to save preferences: ' + error.message);
            }
        }

        document.getElementById('passwordForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!currentPassword) {
                showError('Please enter your current password');
                return;
            }

            if (newPassword !== confirmPassword) {
                showError('New passwords do not match!');
                return;
            }

            if (newPassword.length < 8) {
                showError('New password must be at least 8 characters long');
                return;
            }

            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing...';

            try {
                const result = await apiCall('/auth/change-password', {
                    method: 'POST',
                    body: JSON.stringify({ currentPassword, newPassword })
                });

                if (result && result.success) {
                    showSuccess('Password changed successfully!');
                    document.getElementById('passwordForm').reset();
                } else {
                    showError(result?.message || 'Failed to change password');
                }
            } catch (error) {
                showError('Failed to change password: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        function initializeFilterListeners() {
            document.getElementById('studentSearch')?.addEventListener('input', (e) => {
                loadStudents({ search: e.target.value });
            });
            
            document.getElementById('classFilter')?.addEventListener('change', (e) => {
                loadStudents({ class: e.target.value });
            });
            
            document.getElementById('sectionFilter')?.addEventListener('change', (e) => {
                loadStudents({ section: e.target.value });
            });
        }

        async function loadStudents(filters = {}) {
            try {
                const queryParams = new URLSearchParams();
                
                if (filters.search) queryParams.append('search', filters.search);
                if (filters.class) queryParams.append('class', filters.class);
                if (filters.section) queryParams.append('section', filters.section);
                
                const endpoint = `/teacher/students?${queryParams.toString()}`;
                const data = await apiCall(endpoint);
                
                displayStudentsList(data.data.students);
            } catch (error) {
                console.error('Load students error:', error);
                showError('Failed to load students');
            }
        }

        function displayStudentsList(students) {
            const tbody = document.getElementById('studentsList');
            
            if (!students || students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #888;">No students found</td></tr>';
                return;
            }
            
            tbody.innerHTML = students.map(student => `
                <tr>
                    <td>${student.studentId}</td>
                    <td>${student.name}</td>
                    <td>${student.class}</td>
                    <td>${student.section}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span>${student.performanceIndex.toFixed(1)}%</span>
                            <div class="progress-bar" style="width: 100px;">
                                <div class="progress-fill" style="width: ${student.performanceIndex}%;"></div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge ${getGradeBadgeClass(student.grade)}">
                            ${student.grade || 'N/A'}
                        </span>
                    </td>
                    <td>${student.stats?.totalChallengesCompleted || 0}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="viewStudentDetails('${student.studentId}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="editStudent('${student.studentId}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getGradeBadgeClass(grade) {
            if (!grade) return 'badge-info';
            if (grade.startsWith('A')) return 'badge-success';
            if (grade.startsWith('B')) return 'badge-info';
            if (grade.startsWith('C')) return 'badge-warning';
            return 'badge-danger';
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById(pageId).classList.add('active');
            
            if (event && event.target) {
                event.target.closest('.nav-item').classList.add('active');
            }
            
            switch(pageId) {
                case 'students':
                    loadStudents();
                    break;
                case 'validations':
                    console.log(' Class Performance page opened');
                    setTimeout(() => {
                        if (typeof initClassPerformance === 'function') {
                            initClassPerformance();
                            loadClassPerformance();
                        }
                    }, 150);
                    break;
                case 'classes':
                    loadClasses();
                    break;
                case 'analytics':
                    setTimeout(() => {
                        createAdvancedAnalyticsCharts();
                    }, 100);
                    break;
                case 'teaching-studio':
                    if (typeof selectTool === 'function') {
                        selectTool('notes-builder');
                    }
                    break;
                case 'help':
                    loadHelpTickets();
                    break;
                case 'reports':
                    initReports();
                    break;
            }
        }

        async function viewStudentDetails(studentId) {
            try {
                const data = await apiCall(`/teacher/students/${studentId}`);
                showStudentModal(data.data.student, data.data.recentChallenges);
            } catch (error) {
                console.error('View student error:', error);
                showError('Failed to load student details');
            }
        }

        function showStudentModal(student, challenges) {
            const modal = document.getElementById('studentDetailsModal');
            const body = document.getElementById('studentDetailsBody');
            
            body.innerHTML = `
                <h3>${student.name}</h3>
                <p><strong>Student ID:</strong> ${student.studentId}</p>
                <p><strong>Class:</strong> ${student.class}-${student.section}</p>
                <p><strong>Performance Index:</strong> ${student.performanceIndex.toFixed(1)}%</p>
                <p><strong>Grade:</strong> ${student.grade || 'N/A'}</p>
                
                <h4 style="margin-top: 20px;">Recent Challenges</h4>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${challenges.map(ch => `
                        <div style="padding: 10px; background: rgba(255,255,255,0.03); margin-bottom: 10px; border-radius: 6px;">
                            <strong>${ch.challengeId}</strong> - ${ch.simulationType}<br>
                            <small>Score: ${ch.results?.totalScore || 'N/A'} | Status: ${ch.status}</small>
                        </div>
                    `).join('')}
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function toggleUserMenu() {
            // User menu toggle function
            console.log('User menu toggled');
        }

        function openAddStudentModal() {
            const modal = document.getElementById('addStudentModal');
            document.getElementById('addStudentForm').reset();
            document.getElementById('studentClass').value = '10';
            document.getElementById('studentSection').value = 'A';
            modal.style.display = 'flex';
        }

        document.getElementById('addStudentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const studentData = {
                name: document.getElementById('studentName').value,
                email: document.getElementById('studentEmail').value,
                password: document.getElementById('studentPassword').value,
                class: parseInt(document.getElementById('studentClass').value),
                section: document.getElementById('studentSection').value,
                rollNumber: parseInt(document.getElementById('studentRollNumber').value)
            };
            
            if (studentData.password !== document.getElementById('studentConfirmPassword').value) {
                showError('Passwords do not match!');
                return;
            }
            
            try {
                await apiCall('/teacher/students', {
                    method: 'POST',
                    body: JSON.stringify(studentData)
                });
                
                showSuccess('Student added successfully!');
                closeModal('addStudentModal');
                await loadStudents();
                await loadDashboardData();
                
            } catch (error) {
                console.error('Add student error:', error);
                showError('Failed to add student: ' + (error.message || 'Unknown error'));
            }
        });

        async function loadClasses() {
            try {
                const data = await apiCall('/teacher/classes');
                displayClassesList(data.data.classes);
            } catch (error) {
                console.error('Load classes error:', error);
            }
        }

        function displayClassesList(classes) {
            const container = document.getElementById('classesList');
            
            if (!classes || classes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888;">No classes assigned</p>';
                return;
            }
            
            container.innerHTML = classes.map(cls => `
                <div class="student-card">
                    <div class="student-header">
                        <div class="student-avatar">
                            <i class="fas fa-chalkboard"></i>
                        </div>
                        <div class="student-info">
                            <h3>Class ${cls.class}-${cls.section}</h3>
                            <div class="student-meta">${cls.subject}</div>
                        </div>
                    </div>
                    <div class="student-stats">
                        <div class="student-stat">
                            <label>Total Students:</label>
                            <value>${cls.studentCount || 0}</value>
                        </div>
                        <div class="student-stat">
                            <label>Class Section ID:</label>
                            <value style="font-size: 0.75rem;">${cls.classSectionId}</value>
                        </div>
                        <button class="btn btn-primary btn-sm" style="margin-top: 12px; width: 100%;" 
                                onclick="viewClassDetails('${cls.classSectionId}')">
                            <i class="fas fa-eye"></i> View Details
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function loadHelpTickets() {
            try {
                const data = await apiCall('/teacher/help-tickets');
                displayTicketsList(data.data.tickets);
            } catch (error) {
                console.error('Load tickets error:', error);
            }
        }

        function displayTicketsList(tickets) {
            const tbody = document.getElementById('ticketsList');
            
            if (!tickets || tickets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #888;">No help tickets</td></tr>';
                return;
            }
            
            tbody.innerHTML = tickets.map(ticket => `
                <tr>
                    <td>${ticket.ticketId}</td>
                    <td>${ticket.studentId}</td>
                    <td>${ticket.subject || 'General Help'}</td>
                    <td>
                        <span class="badge ${ticket.status === 'open' ? 'badge-warning' : 'badge-success'}">
                            ${ticket.status}
                        </span>
                    </td>
                    <td>${formatDate(ticket.createdAt)}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="viewTicket('${ticket.ticketId}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${ticket.status === 'open' ? `
                            <button class="btn btn-success btn-sm" onclick="resolveTicket('${ticket.ticketId}')">
                                <i class="fas fa-check"></i>
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        // ============================================ //
        // OVERVIEW CHARTS - CHART.JS INITIALIZATION    //
        // ============================================ //

        // Cached analytics data for chart period switching
        window._teacherAnalyticsData = null;

        async function initializeOverviewCharts() {
            if (!document.getElementById('overview').classList.contains('active')) {
                console.log(' Overview page not active, skipping chart initialization');
                return;
            }

            // Fetch real analytics data
            let analyticsData = null;
            let competencyData = null;
            try {
                const [overviewResp, competencyResp] = await Promise.all([
                    apiCall('/teacher/analytics/overview'),
                    apiCall('/teacher/analytics/competencies')
                ]);
                if (overviewResp?.success) analyticsData = overviewResp.data;
                if (competencyResp?.success) competencyData = competencyResp.data;
                window._teacherAnalyticsData = analyticsData;
            } catch (e) {
                console.warn(' Could not load analytics data for charts:', e);
            }

            setTimeout(() => {
                createPerformanceTrendChart(analyticsData);
                createCompetencyRadarChart(competencyData);
                createChallengeStatusDonutChart(analyticsData);
                createPerformanceDistributionBarChart(analyticsData);
                createSimulationUsageChart(analyticsData);
            }, 200);
        }

        function createPerformanceTrendChart(analyticsData) {
            const canvas = document.getElementById('trendChartCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            let labels, data;
            const recent = (analyticsData?.recentActivity || []).slice(-7);
            if (recent.length > 0) {
                labels = recent.map(r => {
                    const d = new Date(r._id);
                    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });
                data = recent.map(r => r.count);
            } else {
                labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                data = [0, 0, 0, 0, 0, 0, 0];
            }

            window.trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Daily Challenges',
                        data,
                        borderColor: '#00d4ff',
                        backgroundColor: 'rgba(0, 212, 255, 0.1)',
                        borderWidth: 2,
                        pointBackgroundColor: '#007acc',
                        pointBorderColor: '#fff',
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { backgroundColor: '#252526' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#888', precision: 0 }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#888' }
                        }
                    }
                }
            });
        }

        function createCompetencyRadarChart(competencyData) {
            const canvas = document.getElementById('competencyBarChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            let labels, data;
            const comps = competencyData?.competencies || {};
            const compEntries = Object.entries(comps).slice(0, 6);
            if (compEntries.length > 0) {
                labels = compEntries.map(([name]) => name);
                data = compEntries.map(([, v]) => v.average || 0);
            } else {
                labels = ['Critical Thinking', 'Problem Solving', 'Creativity', 'Collaboration', 'Communication', 'Digital Literacy'];
                data = [0, 0, 0, 0, 0, 0];
            }

            const bgColors = labels.map((_, i) =>
                i % 2 === 0 ? 'rgba(0, 122, 204, 0.8)' : 'rgba(0, 212, 255, 0.8)'
            );

            window.competencyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'NEP Competency Score (%)',
                        data,
                        backgroundColor: bgColors,
                        borderColor: '#00d4ff',
                        borderWidth: 1,
                        borderRadius: 8,
                        barPercentage: 0.7,
                        categoryPercentage: 0.8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#252526',
                            titleColor: '#fff',
                            bodyColor: '#ddd',
                            borderColor: '#00d4ff',
                            borderWidth: 2,
                            callbacks: {
                                label: function(context) {
                                    return `Score: ${context.raw}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: {
                                color: '#888',
                                callback: function(value) { return value + '%'; }
                            },
                            title: {
                                display: true,
                                text: 'Competency Score (%)',
                                color: '#888',
                                font: { size: 12 }
                            }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: '#fff', font: { size: 12, weight: '600' } }
                        }
                    }
                }
            });
        }

        function createChallengeStatusDonutChart(analyticsData) {
            const canvas = document.getElementById('donutChartCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            const statusMap = analyticsData?.challengesByStatus || {};
            const labels = Object.keys(statusMap).length > 0
                ? Object.keys(statusMap).map(k => k.charAt(0).toUpperCase() + k.slice(1))
                : ['Evaluated', 'Pending', 'Generated', 'Failed'];
            const data = Object.keys(statusMap).length > 0
                ? Object.values(statusMap)
                : [0, 0, 0, 0];

            window.donutChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: ['#27ae60', '#f39c12', '#00d4ff', '#e74c3c', '#888888'],
                        borderColor: '#252526',
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#fff' } }
                    }
                }
            });
        }

        function createPerformanceDistributionBarChart(analyticsData) {
            const canvas = document.getElementById('distributionChartCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            const dist = analyticsData?.performanceDistribution || [];
            const labels = dist.length > 0
                ? dist.map(d => d.range)
                : ['Excellent (90-100)', 'Good (70-89)', 'Average (50-69)', 'Needs Help (0-49)'];
            const data = dist.length > 0
                ? dist.map(d => d.count)
                : [0, 0, 0, 0];

            window.distributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Number of Students',
                        data,
                        backgroundColor: ['#27ae60', '#2ecc71', '#f39c12', '#e74c3c'],
                        borderColor: '#252526',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#888', precision: 0 }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#888' }
                        }
                    }
                }
            });
        }

        function createSimulationUsageChart(analyticsData) {
            const canvas = document.getElementById('usageChartCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            const sims = analyticsData?.simulationUsage || [];
            const labels = sims.length > 0 ? sims.map(s => s.name) : ['No data yet'];
            const data = sims.length > 0 ? sims.map(s => s.count) : [0];

            window.usageChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Challenges Created',
                        data,
                        backgroundColor: '#00d4ff',
                        borderColor: '#007acc',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#888', precision: 0 }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: '#888' }
                        }
                    }
                }
            });
        }

        function changeChartPeriod(days) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.textContent) === days) {
                    btn.classList.add('active');
                }
            });

            if (window.trendChart) {
                const allActivity = window._teacherAnalyticsData?.recentActivity || [];
                let sliced, labels, data;
                if (days === 7) {
                    sliced = allActivity.slice(-7);
                    labels = sliced.map(r => new Date(r._id).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    data = sliced.map(r => r.count);
                } else if (days === 30) {
                    // Aggregate into weeks
                    const weeks = [0, 0, 0, 0];
                    allActivity.slice(-28).forEach((r, i) => { weeks[Math.floor(i / 7)] += r.count; });
                    labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
                    data = weeks;
                } else {
                    // 90-day: show monthly
                    const months = [0, 0, 0];
                    allActivity.slice(-30).forEach((r, i) => { months[Math.floor(i / 10)] += r.count; });
                    labels = ['Month 1', 'Month 2', 'Month 3'];
                    data = months;
                }
                window.trendChart.data.labels = labels.length ? labels : ['No data'];
                window.trendChart.data.datasets[0].data = data.length ? data : [0];
                window.trendChart.update();
            }
        }

        // ============================================ //
        // ANALYTICS CHARTS - CHART.JS                 //
        // ============================================ //

        async function createAdvancedAnalyticsCharts() {
            if (!document.getElementById('analytics').classList.contains('active')) {
                return;
            }

            // Reuse cached data or fetch fresh
            let analyticsData = window._teacherAnalyticsData;
            if (!analyticsData) {
                try {
                    const resp = await apiCall('/teacher/analytics/overview');
                    if (resp?.success) {
                        analyticsData = resp.data;
                        window._teacherAnalyticsData = analyticsData;
                    }
                } catch (e) {
                    console.warn(' Could not load analytics data for advanced charts:', e);
                }
            }

            setTimeout(() => {
                createEngagementTrendChart(analyticsData);
                createSubjectPerformanceChart(analyticsData);
                createDifficultySuccessChart(analyticsData);
            }, 100);
        }

        function createEngagementTrendChart(analyticsData) {
            const canvas = document.getElementById('engagementChartCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            // Aggregate daily activity into weekly totals
            const allActivity = (analyticsData?.recentActivity || []);
            let labels, data;
            if (allActivity.length > 0) {
                // Group into chunks of 7 days for weekly view
                const chunks = [];
                for (let i = 0; i < allActivity.length; i += 7) {
                    const chunk = allActivity.slice(i, i + 7);
                    chunks.push({
                        label: `Week ${chunks.length + 1}`,
                        count: chunk.reduce((sum, r) => sum + r.count, 0)
                    });
                }
                labels = chunks.map(c => c.label);
                data = chunks.map(c => c.count);
            } else {
                labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
                data = [0, 0, 0, 0];
            }

            window.engagementChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Challenges per Week',
                        data,
                        borderColor: '#00d4ff',
                        backgroundColor: 'rgba(0, 212, 255, 0.1)',
                        borderWidth: 3,
                        pointBackgroundColor: '#007acc',
                        pointBorderColor: '#fff',
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBorderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, labels: { color: '#fff', font: { size: 12 } } },
                        tooltip: {
                            backgroundColor: '#252526',
                            titleColor: '#fff',
                            bodyColor: '#ddd',
                            borderColor: '#464647',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: {
                                color: '#888',
                                precision: 0,
                                callback: function(value) { return value; }
                            },
                            title: {
                                display: true,
                                text: 'Engagement Rate',
                                color: '#888',
                                font: { size: 11 }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#888', font: { size: 11 } }
                        }
                    }
                }
            });
        }

        function createSubjectPerformanceChart(analyticsData) {
            const canvas = document.getElementById('subjectChartCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            const sims = analyticsData?.simulationUsage || [];
            const colors = ['#007accCC', '#28a745CC', '#ff6b6bCC', '#20c997CC', '#6f42c1CC', '#fd7e14CC'];
            const borderColors = ['#007acc', '#28a745', '#ff6b6b', '#20c997', '#6f42c1', '#fd7e14'];
            const labels = sims.length > 0 ? sims.map(s => s.name) : ['No data yet'];
            const data = sims.length > 0 ? sims.map(s => s.count) : [0];

            window.subjectChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Challenges Created',
                        data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: borderColors.slice(0, labels.length),
                        borderWidth: 1,
                        borderRadius: 6,
                        barPercentage: 0.7,
                        categoryPercentage: 0.8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, labels: { color: '#fff', font: { size: 12 } } },
                        tooltip: {
                            backgroundColor: '#252526',
                            titleColor: '#fff',
                            bodyColor: '#ddd',
                            borderColor: '#464647',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `Challenges: ${context.raw}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: {
                                color: '#888',
                                precision: 0
                            },
                            title: {
                                display: true,
                                text: 'Challenges Created',
                                color: '#888',
                                font: { size: 11 }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: '#888',
                                font: { size: 11 },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function createDifficultySuccessChart(analyticsData) {
            const canvas = document.getElementById('difficultyChartCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            const diffStats = analyticsData?.difficultyStats || [];
            const diffColors = { easy: '#28a745CC', medium: '#f39c12CC', hard: '#e74c3cCC', advanced: '#9b59b6CC' };
            const diffBorders = { easy: '#28a745', medium: '#f39c12', hard: '#e74c3c', advanced: '#9b59b6' };

            let labels, data, bgColors, bdColors;
            if (diffStats.length > 0) {
                labels = diffStats.map(d => d.difficulty.charAt(0).toUpperCase() + d.difficulty.slice(1));
                data = diffStats.map(d => d.successRate);
                bgColors = diffStats.map(d => diffColors[d.difficulty] || '#888888CC');
                bdColors = diffStats.map(d => diffBorders[d.difficulty] || '#888888');
            } else {
                labels = ['Easy', 'Medium', 'Hard', 'Advanced'];
                data = [0, 0, 0, 0];
                bgColors = ['#28a745CC', '#f39c12CC', '#e74c3cCC', '#9b59b6CC'];
                bdColors = ['#28a745', '#f39c12', '#e74c3c', '#9b59b6'];
            }

            window.difficultyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Success Rate %',
                        data,
                        backgroundColor: bgColors,
                        borderColor: bdColors,
                        borderWidth: 1,
                        borderRadius: 6,
                        barPercentage: 0.6,
                        categoryPercentage: 0.7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, labels: { color: '#fff', font: { size: 12 } } },
                        tooltip: {
                            backgroundColor: '#252526',
                            titleColor: '#fff',
                            bodyColor: '#ddd',
                            borderColor: '#464647',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const idx = context.dataIndex;
                                    const stat = diffStats[idx] || {};
                                    return [`Success Rate: ${context.raw}%`, `Passed: ${stat.passed || 0}/${stat.total || 0}`];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: {
                                color: '#888',
                                stepSize: 20,
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            title: {
                                display: true,
                                text: 'Success Rate',
                                color: '#888',
                                font: { size: 11 }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#888', font: { size: 11 } }
                        }
                    }
                }
            });
        }

        // ============================================ //
        // NEP TEACHING STUDIO JAVASCRIPT              //
        // ============================================ //

        let currentLesson = {
            id: null,
            notes: null,
            questions: [],
            simulator: null,
            exportConfig: null
        };

        let currentTool = 'notes-builder';

        document.addEventListener('DOMContentLoaded', function() {
            selectTool('notes-builder');
            
            document.getElementById('generate-btn')?.addEventListener('click', generateContent);
            document.getElementById('clear-btn')?.addEventListener('click', clearWorkspace);
            document.getElementById('edit-toggle')?.addEventListener('click', toggleEditMode);
            
            loadLessonState();
        });

        function selectTool(tool) {
            currentTool = tool;
            
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.tool-btn[data-tool="${tool}"]`)?.classList.add('active');
            
            updateWorkflowProgress(tool);
            loadToolForm(tool);
            updateWorkspace(tool);
        }

        function loadToolForm(tool) {
            const formContainer = document.getElementById('input-form-container');
            const titleElement = document.getElementById('input-panel-title');
            
            switch(tool) {
                case 'notes-builder':
                    titleElement.textContent = 'Create Teaching Notes';
                    formContainer.innerHTML = getNotesBuilderForm();
                    break;
                case 'question-builder':
                    titleElement.textContent = 'Create Assessment Questions';
                    formContainer.innerHTML = getQuestionBuilderForm();
                    break;
                case 'simulator-builder':
                    titleElement.textContent = 'Create Learning Simulator';
                    formContainer.innerHTML = getSimulatorBuilderForm();
                    break;
                case 'export-pdf':
                    titleElement.textContent = 'Export Lesson as PDF';
                    formContainer.innerHTML = getExportPDFForm();
                    break;
            }
        }

        function getNotesBuilderForm() {
            return `
                <div class="form-section">
                    <h4>Basic Information</h4>
                    <div class="form-group">
                        <label class="form-label">Subject</label>
                        <select class="form-control" id="notes-subject">
                            <option value="">Select Subject</option>
                            <option value="physics">Physics</option>
                            <option value="chemistry">Chemistry</option>
                            <option value="mathematics">Mathematics</option>
                            <option value="biology">Biology</option>
                            <option value="computer">Computer Science</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Class / Grade</label>
                        <select class="form-control" id="notes-class">
                            <option value="6">Class 6</option>
                            <option value="7">Class 7</option>
                            <option value="8">Class 8</option>
                            <option value="9">Class 9</option>
                            <option value="10" selected>Class 10</option>
                            <option value="11">Class 11</option>
                            <option value="12">Class 12</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Topic / Chapter</label>
                        <input type="text" class="form-control" id="notes-topic" placeholder="e.g., Newton's Laws of Motion">
                    </div>
                </div>
                
                <div class="form-section">
                    <h4>Notes Configuration</h4>
                    <div class="form-group">
                        <label class="form-label">Notes Format</label>
                        <select class="form-control" id="notes-format">
                            <option value="detailed">Detailed Notes</option>
                            <option value="summary">Summary Points</option>
                            <option value="vocational">Vocational Exposure</option>
                            <option value="mindmap">Mind Map</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Learning Objectives (Optional)</label>
                        <textarea class="form-control" id="learning-objectives" rows="3" 
                                  placeholder="What students should learn from this lesson..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="include-diagrams" checked>
                            <span>Include Diagrams & Visuals</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4>Additional Options</h4>
                    <div class="form-group">
                        <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="include-examples" checked>
                            <span>Include Real-world Examples</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="include-misconceptions">
                            <span>Address Common Misconceptions</span>
                        </label>
                    </div>
                </div>
            `;
        }

        function getQuestionBuilderForm() {
            return `
                <div class="form-section">
                    <h4>Question Generation</h4>
                    <div class="form-group">
                        <label class="form-label">Question Types</label>
                        <select class="form-control" id="question-types" multiple style="height: 180px;">
                            <option value="all" selected>All Types (Auto-generate all)</option>
                            <option value="mcq">Multiple Choice Question (MCQ)</option>
                            <option value="truefalse">True/False</option>
                            <option value="fillblank">Fill in the Blanks</option>
                            <option value="match">Match the Following</option>
                            <option value="short">Short Answer</option>
                            <option value="long">Long Answer</option>
                            <option value="diagram">Diagram Labeling</option>
                            <option value="sequence">Sequence / Ordering</option>
                            <option value="casestudy">Case Study</option>
                            <option value="numerical">Numerical Problem</option>
                            <option value="essay">Essay</option>
                            <option value="problemsolving">Problem-Solving Scenario</option>
                            <option value="code">Code Writing / Debugging</option>
                            <option value="experiment">Experimental Design</option>
                            <option value="data">Data Interpretation</option>
                            <option value="definition">Terminology Definition</option>
                            <option value="comparative">Comparative Analysis</option>
                            <option value="critical">Critical Thinking</option>
                            <option value="reflection">Reflection Question</option>
                            <option value="crosscurricular">Cross-curricular Question</option>
                        </select>
                        <small style="color: var(--text-secondary); font-size: 0.8rem;">
                            Hold Ctrl/Cmd to select multiple types, or select "All Types" for auto-generation
                        </small>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4>Question Settings</h4>
                    <div class="form-group">
                        <label class="form-label">Difficulty Level</label>
                        <select class="form-control" id="question-difficulty">
                            <option value="mixed">Mixed (Auto-adjust)</option>
                            <option value="easy">Easy</option>
                            <option value="medium" selected>Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Bloom's Taxonomy Level</label>
                        <select class="form-control" id="blooms-level">
                            <option value="mixed">Mixed Levels</option>
                            <option value="remember">Remember</option>
                            <option value="understand" selected>Understand</option>
                            <option value="apply">Apply</option>
                            <option value="analyze">Analyze</option>
                            <option value="evaluate">Evaluate</option>
                            <option value="create">Create</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Total Questions</label>
                        <input type="range" class="form-control" id="total-questions" min="5" max="50" value="15">
                        <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                            <small>5</small>
                            <small id="questions-value">15 questions</small>
                            <small>50</small>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4>Additional Options</h4>
                    <div class="form-group">
                        <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="include-answers" checked>
                            <span>Include Answer Key</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="include-hints">
                            <span>Include Hints for Students</span>
                        </label>
                    </div>
                </div>
            `;
        }

        function getSimulatorBuilderForm() {
            return `
                <div class="form-section">
                    <h4>Simulation Type</h4>
                    <div class="form-group">
                        <select class="form-control" id="simulation-type">
                            <option value="interactive">Interactive Diagram</option>
                            <option value="virtuallab">Virtual Lab</option>
                            <option value="stepprocess">Step-by-Step Process</option>
                            <option value="realscenario">Real-world Scenario</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Concept to Simulate</label>
                        <input type="text" class="form-control" id="simulation-concept" 
                               placeholder="e.g., Force, Velocity, Chemical Reaction">
                    </div>
                </div>
                
                <div class="form-section">
                    <h4>Visual Configuration</h4>
                    <div class="form-group">
                        <label class="form-label">Visual Style</label>
                        <select class="form-control" id="visual-style">
                            <option value="minimal">Minimal</option>
                            <option value="detailed" selected>Detailed</option>
                            <option value="animated">Animated</option>
                            <option value="diagrammatic">Diagrammatic</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Interaction Type</label>
                        <select class="form-control" id="interaction-type">
                            <option value="dragdrop">Drag & Drop</option>
                            <option value="clickreveal">Click to Reveal</option>
                            <option value="sliders" selected>Adjust Sliders</option>
                            <option value="stepnav">Step Navigation</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4>Parameters & Duration</h4>
                    <div class="form-group">
                        <label class="form-label">Variables / Parameters</label>
                        <input type="text" class="form-control" id="simulation-variables" 
                               placeholder="e.g., mass, velocity, time (comma separated)">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Duration (minutes)</label>
                        <input type="range" class="form-control" id="simulation-duration" min="5" max="30" value="15">
                        <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                            <small>5 min</small>
                            <small id="duration-value">15 minutes</small>
                            <small>30 min</small>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4>Learning Objectives</h4>
                    <div class="form-group">
                        <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="sim-show-objectives" checked>
                            <span>Show Learning Objectives</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="sim-include-guide">
                            <span>Include Teacher's Guide</span>
                        </label>
                    </div>
                </div>
            `;
        }

        function getExportPDFForm() {
            return `
                <div class="form-section">
                    <h4>Document Configuration</h4>
                    <div class="form-group">
                        <label class="form-label">Document Title</label>
                        <input type="text" class="form-control" id="pdf-title" 
                               placeholder="e.g., Class 10 Physics - Newton's Laws">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Sections to Include</label>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="include-notes" checked>
                                <span>Notes Content</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="include-questions" checked>
                                <span>Questions & Answers</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="include-simulator" checked>
                                <span>Simulation Instructions</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="include-objectives" checked>
                                <span>Learning Objectives</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="include-guide" checked>
                                <span>Teacher's Guide</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4>Formatting Options</h4>
                    <div class="form-group">
                        <label class="form-label">Page Layout</label>
                        <select class="form-control" id="page-layout">
                            <option value="portrait" selected>Portrait</option>
                            <option value="landscape">Landscape</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Font Size</label>
                        <select class="form-control" id="font-size">
                            <option value="small">Small</option>
                            <option value="medium" selected>Medium</option>
                            <option value="large">Large</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Include in Header</label>
                        <input type="text" class="form-control" id="header-text" 
                               placeholder="e.g., NEP Teaching Studio - Class 10 Physics">
                    </div>
                </div>
                
                <div class="form-section">
                    <h4>Final Options</h4>
                    <div class="form-group">
                        <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="include-answerkey" checked>
                            <span>Include Answer Key (Separate Section)</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="include-watermark">
                            <span>Add "NEP Teaching Studio" Watermark</span>
                        </label>
                    </div>
                </div>
            `;
        }

        function updateWorkflowProgress(tool) {
            document.querySelectorAll('.progress-step').forEach(step => {
                step.classList.remove('active');
            });
            
            const stepMap = {
                'notes-builder': 0,
                'question-builder': 1,
                'simulator-builder': 2,
                'export-pdf': 3
            };
            
            const currentStep = stepMap[tool];
            document.querySelectorAll('.progress-step')[currentStep]?.classList.add('active');
            
            for (let i = 0; i < currentStep; i++) {
                document.querySelectorAll('.progress-step')[i]?.classList.add('active');
            }
        }

        function updateWorkspace(tool) {
            const emptyWorkspace = document.getElementById('empty-workspace');
            const contentWorkspace = document.getElementById('content-workspace');
            
            if (currentLesson[tool] || (tool === 'export-pdf' && hasContentToExport())) {
                emptyWorkspace.style.display = 'none';
                contentWorkspace.style.display = 'block';
                contentWorkspace.innerHTML = getWorkspaceContent(tool);
            } else {
                emptyWorkspace.style.display = 'block';
                contentWorkspace.style.display = 'none';
            }
        }

        function hasContentToExport() {
            return currentLesson.notes || currentLesson.questions.length > 0 || currentLesson.simulator;
        }

        function getWorkspaceContent(tool) {
            switch(tool) {
                case 'notes-builder':
                    return getNotesWorkspaceContent();
                case 'question-builder':
                    return getQuestionsWorkspaceContent();
                case 'simulator-builder':
                    return getSimulatorWorkspaceContent();
                case 'export-pdf':
                    return getExportWorkspaceContent();
                default:
                    return '<div class="empty-workspace">No content available</div>';
            }
        }

        function getNotesWorkspaceContent() {
            if (!currentLesson.notes) return getEmptyWorkspaceMessage();

            const ai = currentLesson.notes.aiNotes;

            // If we have real AI notes, render them
            if (ai) {
                let html = `
                    <div class="content-preview">
                        <div class="lesson-header">
                            <h1 class="lesson-title">${ai.title || currentLesson.notes.topic || 'Teaching Notes'}</h1>
                            <div class="lesson-meta">
                                <span><i class="fas fa-book"></i> ${currentLesson.notes.subject || 'Subject'}</span>
                                <span><i class="fas fa-users"></i> Class ${currentLesson.notes.class || ''}</span>
                                <span><i class="fas fa-file-alt"></i> ${currentLesson.notes.format || 'Detailed Notes'}</span>
                            </div>
                        </div>`;

                if (ai.objectives && ai.objectives.length) {
                    html += `<div class="lesson-section"><h2 class="section-title">Learning Objectives</h2><div class="notes-content"><ul>`;
                    ai.objectives.forEach(o => { html += `<li>${o}</li>`; });
                    html += `</ul></div></div>`;
                }

                if (ai.sections && ai.sections.length) {
                    ai.sections.forEach(s => {
                        html += `<div class="lesson-section"><h2 class="section-title">${s.heading}</h2>
                            <div class="notes-content"><p>${s.content}</p></div></div>`;
                    });
                }

                if (ai.formulas && ai.formulas.length) {
                    html += `<div class="lesson-section"><h2 class="section-title">Key Formulas</h2>
                        <div class="notes-content" style="font-family:monospace;background:rgba(39,174,96,0.08);padding:15px;border-radius:8px;">`;
                    ai.formulas.forEach(f => { html += `<div>${f}</div>`; });
                    html += `</div></div>`;
                }

                if (ai.applications && ai.applications.length) {
                    html += `<div class="lesson-section"><h2 class="section-title">Real-world Applications</h2><div class="notes-content"><ul>`;
                    ai.applications.forEach(a => { html += `<li>${a}</li>`; });
                    html += `</ul></div></div>`;
                }

                if (ai.misconceptions && ai.misconceptions.length) {
                    html += `<div class="lesson-section"><h2 class="section-title">Common Misconceptions</h2>
                        <div class="notes-content" style="background:rgba(231,76,60,0.08);padding:15px;border-radius:8px;">`;
                    ai.misconceptions.forEach(m => { html += `<p> ${m}</p>`; });
                    html += `</div></div>`;
                }

                html += `<div style="margin-top:20px;padding-top:15px;border-top:1px solid var(--border-color);">
                    <button class="btn btn-secondary btn-sm" onclick="window.print()">
                        <i class="fas fa-print"></i> Print / Export PDF
                    </button>
                </div></div>`;
                return html;
            }

            // Fallback static template (old behaviour)
            return `
                <div class="content-preview">
                    <div class="lesson-header">
                        <h1 class="lesson-title">${currentLesson.notes.topic || 'Teaching Notes'}</h1>
                        <div class="lesson-meta">
                            <span><i class="fas fa-book"></i> ${currentLesson.notes.subject || 'Subject'}</span>
                            <span><i class="fas fa-users"></i> Class ${currentLesson.notes.class}</span>
                            <span><i class="fas fa-file-alt"></i> ${currentLesson.notes.format || 'Detailed Notes'}</span>
                        </div>
                    </div>
                    <div class="lesson-section">
                        <h2 class="section-title">Content</h2>
                        <div class="notes-content">
                            <p>Content will be generated based on the topic and format selected.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function getQuestionsWorkspaceContent() {
            if (currentLesson.questions.length === 0) return getEmptyWorkspaceMessage();
            
            return `
                <div class="content-preview">
                    <div class="lesson-header">
                        <h1 class="lesson-title">Assessment Questions</h1>
                        <div class="lesson-meta">
                            <span><i class="fas fa-question-circle"></i> ${currentLesson.questions.length} Questions</span>
                            <span><i class="fas fa-layer-group"></i> ${currentLesson.questionsConfig?.difficulty || 'Mixed'} Difficulty</span>
                            <span><i class="fas fa-graduation-cap"></i> ${currentLesson.questionsConfig?.bloomsLevel || 'Mixed'} Level</span>
                        </div>
                    </div>
                    
                    <div class="lesson-section">
                        <h2 class="section-title">Generated Questions</h2>
                        
                        ${currentLesson.questions.map((question, index) => `
                            <div class="question-item">
                                <div class="question-header">
                                    <div class="question-type">${question.type || 'MCQ'}</div>
                                    <div class="question-difficulty">${question.difficulty || 'Medium'}</div>
                                </div>
                                
                                <div class="question-text">
                                    <strong>Q${index + 1}:</strong> ${question.text || 'Sample question text will appear here'}
                                </div>
                                
                                ${question.options ? `
                                    <div class="question-options">
                                        ${question.options.map((option, optIndex) => `
                                            <div class="question-option ${option.correct ? 'option-correct' : ''}">
                                                <div class="option-letter">${String.fromCharCode(65 + optIndex)}</div>
                                                <div class="option-text">${option.text}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                                
                                ${question.answer ? `
                                    <div class="question-answer">
                                        <strong>Answer:</strong> ${question.answer}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                    
                    ${currentLesson.questionsConfig?.includeAnswers ? `
                        <div class="lesson-section">
                            <h2 class="section-title">Answer Key</h2>
                            <div style="background:rgba(39,174,96,0.05);padding:20px;border-radius:8px;">
                                ${currentLesson.questions.map((q, i) => `
                                    <div style="margin-bottom:10px;">
                                        <strong>Q${i+1}:</strong> ${q.answer || ''}
                                        ${q.explanation ? `<br><small style="color:var(--text-secondary);">${q.explanation}</small>` : ''}
                                    </div>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                    <div style="margin-top:20px;padding-top:15px;border-top:1px solid var(--border-color);">
                        <button class="btn btn-secondary btn-sm" onclick="window.print()">
                            <i class="fas fa-print"></i> Print / Export PDF
                        </button>
                    </div>
                </div>
            `;
        }

        function getSimulatorWorkspaceContent() {
            if (!currentLesson.simulator) return getEmptyWorkspaceMessage();

            const sim = currentLesson.simulator;

            // If we have AI-generated HTML, render it in an iframe
            if (sim.htmlContent) {
                const escaped = sim.htmlContent.replace(/"/g, '&quot;');
                return `
                    <div class="content-preview">
                        <div class="lesson-header">
                            <h1 class="lesson-title">${sim.concept || 'Concept'} Simulator</h1>
                            <div class="lesson-meta">
                                <span><i class="fas fa-flask"></i> ${sim.type || 'Interactive'}</span>
                                <span><i class="fas fa-clock"></i> ${sim.duration || 15} min</span>
                                <span><i class="fas fa-mouse-pointer"></i> ${sim.interaction || 'Sliders'}</span>
                            </div>
                        </div>
                        <div class="lesson-section">
                            <h2 class="section-title">Live Interactive Simulator</h2>
                            <iframe
                                srcdoc="${escaped}"
                                style="width:100%;height:80vh;min-height:500px;border:none;border-radius:8px;background:#1e1e1e;"
                                sandbox="allow-scripts allow-forms"
                                onload="this.style.height=(this.contentDocument.body?.scrollHeight || 600)+'px'">
                            </iframe>
                        </div>
                        ${sim.includeGuide ? `
                        <div class="lesson-section">
                            <h2 class="section-title">Teacher's Guide</h2>
                            <div style="background:rgba(0,122,204,0.05);padding:20px;border-radius:8px;">
                                <p><strong>Setup:</strong> Share this page with students or project it on screen.</p>
                                <p><strong>Discussion:</strong> Ask students to vary the parameters and note the effects.</p>
                                <p><strong>Assessment:</strong> Ask students to predict outcomes before adjusting controls.</p>
                            </div>
                        </div>` : ''}
                    </div>
                `;
            }

            // Fallback placeholder
            return `
                <div class="content-preview">
                    <div class="lesson-header">
                        <h1 class="lesson-title">Learning Simulator</h1>
                        <div class="lesson-meta">
                            <span><i class="fas fa-flask"></i> ${sim.type || 'Interactive Diagram'}</span>
                            <span><i class="fas fa-clock"></i> ${sim.duration || 15} minutes</span>
                        </div>
                    </div>
                    <div class="lesson-section">
                        <div style="text-align:center;padding:40px;">
                            <i class="fas fa-flask" style="font-size:3rem;color:var(--accent-cyan);"></i>
                            <h3 style="margin-top:15px;">${sim.concept || 'Concept'} Simulator</h3>
                            <p style="color:var(--text-secondary);">Simulator configuration saved. Click Generate Content to create the interactive simulation.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function getExportWorkspaceContent() {
            return `
                <div class="content-preview">
                    <div class="lesson-header">
                        <h1 class="lesson-title">NEP Lesson Document</h1>
                        <div class="lesson-meta">
                            <span><i class="fas fa-file-pdf"></i> PDF Export Preview</span>
                            <span><i class="fas fa-calendar"></i> Generated: ${new Date().toLocaleDateString()}</span>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border-color); border-radius: 8px; padding: 30px; margin-top: 20px;">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h2 style="color: var(--accent-cyan);">${currentLesson.exportConfig?.title || 'Class 10 Physics - Newton\'s Laws'}</h2>
                            <p style="color: var(--text-secondary);">NEP Teaching Studio Generated Lesson Document</p>
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <h3 style="color: var(--text-primary); margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">
                                <i class="fas fa-check-circle" style="color: #27ae60;"></i> Document Summary
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 6px;">
                                    <div style="font-size: 0.9rem; color: var(--text-secondary);">Subject</div>
                                    <div style="font-weight: 600;">${currentLesson.notes?.subject || 'Physics'}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 6px;">
                                    <div style="font-size: 0.9rem; color: var(--text-secondary);">Class</div>
                                    <div style="font-weight: 600;">Class ${currentLesson.notes?.class || '10'}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 6px;">
                                    <div style="font-size: 0.9rem; color: var(--text-secondary);">Total Pages</div>
                                    <div style="font-weight: 600;">8-12 pages (estimated)</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 6px;">
                                    <div style="font-size: 0.9rem; color: var(--text-secondary);">File Size</div>
                                    <div style="font-weight: 600;">~2-3 MB</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <h3 style="color: var(--text-primary); margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">
                                <i class="fas fa-list-check"></i> Included Sections
                            </h3>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                ${currentLesson.exportConfig?.includeNotes ? `
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="fas fa-check" style="color: #27ae60;"></i>
                                        <span>Teaching Notes (${currentLesson.notes?.format || 'Detailed Format'})</span>
                                    </div>
                                ` : ''}
                                
                                ${currentLesson.exportConfig?.includeQuestions ? `
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="fas fa-check" style="color: #27ae60;"></i>
                                        <span>Assessment Questions (${currentLesson.questions.length} questions)</span>
                                    </div>
                                ` : ''}
                                
                                ${currentLesson.exportConfig?.includeSimulator ? `
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="fas fa-check" style="color: #27ae60;"></i>
                                        <span>Simulation Instructions (${currentLesson.simulator?.type || 'Interactive'})</span>
                                    </div>
                                ` : ''}
                                
                                ${currentLesson.exportConfig?.includeObjectives ? `
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="fas fa-check" style="color: #27ae60;"></i>
                                        <span>Learning Objectives</span>
                                    </div>
                                ` : ''}
                                
                                ${currentLesson.exportConfig?.includeGuide ? `
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="fas fa-check" style="color: #27ae60;"></i>
                                        <span>Teacher's Guide</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div style="background: rgba(0, 122, 204, 0.1); border-left: 3px solid var(--accent-blue); padding: 20px; border-radius: 4px; margin-top: 30px;">
                            <p style="margin: 0; color: var(--text-primary);">
                                <i class="fas fa-info-circle" style="color: var(--accent-cyan);"></i>
                                This PDF will be generated with professional formatting, proper headers, and pagination suitable for classroom use and school records.
                            </p>
                        </div>
                        <div style="margin-top:20px;">
                            <button class="btn btn-primary" onclick="window.print()">
                                <i class="fas fa-file-pdf"></i> Print / Save as PDF
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function getEmptyWorkspaceMessage() {
            return `
                <div class="empty-workspace">
                    <div style="text-align: center; padding: 60px 20px;">
                        <i class="fas fa-chalkboard" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 20px;"></i>
                        <h3 style="color: var(--text-secondary); margin-bottom: 10px;">No Content Generated Yet</h3>
                        <p style="color: var(--text-secondary); max-width: 400px; margin: 0 auto;">
                            Configure your settings on the left panel and click "Generate Content"
                        </p>
                    </div>
                </div>
            `;
        }

        async function generateContent() {
            const generateBtn = document.getElementById('generate-btn');
            const originalText = generateBtn.innerHTML;

            try {
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                generateBtn.disabled = true;

                const token = localStorage.getItem('authToken');

                switch (currentTool) {
                    case 'notes-builder': {
                        const subject = document.getElementById('notes-subject')?.value;
                        const grade   = document.getElementById('notes-class')?.value;
                        const topic   = document.getElementById('notes-topic')?.value;
                        if (!topic) { showNotification('Please enter a topic', 'error'); return; }

                        const format = document.getElementById('notes-format')?.value || 'detailed';
                        const res  = await fetch(`${API_BASE_URL}/teacher/studio/notes`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({ subject, grade, topic, format })
                        });
                        const data = await res.json();
                        if (!data.success) throw new Error(data.message || 'Notes generation failed');

                        const notes = data.notes;
                        currentLesson['notes-builder'] = {
                            subject, class: grade, topic,
                            format: document.getElementById('notes-format')?.value,
                            objectives: document.getElementById('learning-objectives')?.value,
                            includeDiagrams: document.getElementById('include-diagrams')?.checked,
                            includeExamples: document.getElementById('include-examples')?.checked,
                            aiNotes: notes,
                            timestamp: new Date().toISOString()
                        };
                        // Also store in currentLesson.notes for export
                        currentLesson.notes = currentLesson['notes-builder'];

                        updateWorkspace('notes-builder');
                        showNotification('Smart Notes generated!', 'success');
                        setTimeout(() => {
                            selectTool('question-builder');
                            showNotification('Now create questions based on these notes', 'info');
                        }, 1200);
                        break;
                    }

                    case 'question-builder': {
                        const subject = currentLesson.notes?.subject || '';
                        const grade   = currentLesson.notes?.class  || '10';
                        const topic   = currentLesson.notes?.topic  || '';
                        const questionTypesSelect = document.getElementById('question-types');
                        const selectedTypes = Array.from(questionTypesSelect.selectedOptions).map(o => o.value);
                        const questionType = selectedTypes.includes('all') ? 'mcq' : (selectedTypes[0] || 'mcq');
                        const difficulty  = document.getElementById('question-difficulty')?.value || 'medium';
                        const count       = Math.min(parseInt(document.getElementById('total-questions')?.value) || 5, 5);

                        const res  = await fetch(`${API_BASE_URL}/teacher/studio/questions/generate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({ subject, grade, topic, questionType, difficulty, count })
                        });
                        const data = await res.json();
                        if (!data.success) throw new Error(data.message || 'Question generation failed');

                        currentLesson.questions = (data.questions || []).map(q => ({
                            type: questionType,
                            text: q.questionText,
                            difficulty: q.difficulty || difficulty,
                            answer: q.correctAnswer,
                            explanation: q.explanation,
                            bloomsLevel: q.bloomsLevel,
                            options: (q.options || []).map((opt, i) => ({
                                text: opt,
                                correct: opt === q.correctAnswer
                            }))
                        }));
                        currentLesson.questionsConfig = {
                            difficulty,
                            bloomsLevel: document.getElementById('blooms-level')?.value,
                            includeAnswers: document.getElementById('include-answers')?.checked
                        };
                        currentLesson['question-builder'] = { ...currentLesson.questionsConfig, timestamp: new Date().toISOString() };

                        updateWorkspace('question-builder');
                        showNotification(`${currentLesson.questions.length} questions generated!`, 'success');
                        break;
                    }

                    case 'simulator-builder': {
                        const topic   = document.getElementById('simulation-concept')?.value
                                     || currentLesson.notes?.topic || '';
                        const subject = currentLesson.notes?.subject || '';
                        const grade   = currentLesson.notes?.class  || '10';
                        if (!topic) { showNotification('Please enter a concept to simulate', 'error'); return; }

                        const simulationType  = document.getElementById('simulation-type')?.value || 'interactive';
                        const interactionType = document.getElementById('interaction-type')?.value || 'sliders';
                        const visualStyle     = document.getElementById('visual-style')?.value || 'detailed';
                        const variables       = document.getElementById('simulation-variables')?.value || '';

                        const res  = await fetch(`${API_BASE_URL}/teacher/studio/simulator`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({ topic, subject, grade, simulationType, interactionType, visualStyle, variables })
                        });
                        const data = await res.json();
                        if (!data.success) throw new Error(data.message || 'Simulator generation failed');

                        currentLesson.simulator = {
                            concept: topic,
                            type: document.getElementById('simulation-type')?.value,
                            interaction: document.getElementById('interaction-type')?.value,
                            duration: document.getElementById('simulation-duration')?.value,
                            includeGuide: document.getElementById('sim-include-guide')?.checked,
                            htmlContent: data.htmlContent
                        };
                        currentLesson['simulator-builder'] = { ...currentLesson.simulator, timestamp: new Date().toISOString() };

                        updateWorkspace('simulator-builder');
                        showNotification('Interactive simulator generated!', 'success');
                        break;
                    }

                    case 'export-pdf': {
                        currentLesson.exportConfig = {
                            title: document.getElementById('pdf-title')?.value,
                            includeNotes: document.getElementById('include-notes')?.checked,
                            includeQuestions: document.getElementById('include-questions')?.checked,
                            includeSimulator: document.getElementById('include-simulator')?.checked,
                            includeObjectives: document.getElementById('include-objectives')?.checked,
                            includeGuide: document.getElementById('include-guide')?.checked,
                            pageLayout: document.getElementById('page-layout')?.value,
                            fontSize: document.getElementById('font-size')?.value,
                            headerText: document.getElementById('header-text')?.value,
                            includeAnswerKey: document.getElementById('include-answerkey')?.checked,
                            includeWatermark: document.getElementById('include-watermark')?.checked,
                            timestamp: new Date().toISOString()
                        };
                        currentLesson['export-pdf'] = currentLesson.exportConfig;
                        updateWorkspace('export-pdf');
                        showNotification('PDF preview ready. Use print/save to export.', 'success');
                        break;
                    }

                    default:
                        break;
                }

                saveLessonState();

            } catch (error) {
                console.error('Generate content error:', error);
                showNotification('Failed: ' + error.message, 'error');
            } finally {
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        }

        function collectFormData() {
            // Kept for compatibility  generateContent() now handles everything directly
            return {};
        }

        function clearWorkspace() {
            if (confirm('Are you sure you want to clear all generated content? This cannot be undone.')) {
                currentLesson = {
                    id: null,
                    notes: null,
                    questions: [],
                    simulator: null,
                    exportConfig: null
                };
                
                selectTool('notes-builder');
                document.getElementById('input-form-container').innerHTML = getNotesBuilderForm();
                
                showNotification('Workspace cleared', 'info');
            }
        }

        function toggleEditMode() {
            const editBtn = document.getElementById('edit-toggle');
            const isEditing = editBtn.innerHTML.includes('Edit Mode');
            
            if (isEditing) {
                editBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                enableEditing();
                showNotification('Edit mode enabled. Make your changes and save.', 'info');
            } else {
                editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit Mode';
                disableEditing();
                showNotification('Changes saved successfully.', 'success');
            }
        }

        function enableEditing() {
            console.log('Edit mode enabled');
        }

        function disableEditing() {
            console.log('Edit mode disabled');
        }

        function addAIEnhancements() {
            showNotification('AI enhancements added to your lesson', 'success');
        }

        function loadLesson(index) {
            const history = getLessonHistory();
            const lesson = history[index];
            if (!lesson) return;

            currentLesson = lesson;
            selectTool('notes-builder');
            updateWorkspace('notes-builder');
            showNotification(`Loaded: ${lesson.notes?.topic || lesson.notes?.aiNotes?.title || 'Lesson'}`, 'success');
        }

        function getLessonHistory() {
            try {
                return JSON.parse(localStorage.getItem('nep_lesson_history') || '[]');
            } catch (e) {
                return [];
            }
        }

        function pushToHistory(lesson) {
            if (!lesson.notes) return;
            const history = getLessonHistory();
            // Avoid exact duplicate (same topic + subject + timestamp prefix)
            const isDup = history.some(h =>
                h.notes?.topic === lesson.notes?.topic &&
                h.notes?.subject === lesson.notes?.subject
            );
            if (!isDup) {
                history.unshift({ ...lesson, savedAt: new Date().toISOString() });
                if (history.length > 10) history.pop(); // keep last 10
                localStorage.setItem('nep_lesson_history', JSON.stringify(history));
            }
            renderHistoryList();
        }

        function renderHistoryList() {
            const history = getLessonHistory();
            const container = document.getElementById('history-list');
            if (!container) return;

            if (history.length === 0) {
                container.innerHTML = `<div style="color:var(--text-secondary);font-size:0.85rem;padding:10px;">No lessons yet. Generate your first lesson!</div>`;
                return;
            }

            container.innerHTML = history.map((lesson, i) => {
                const topic   = lesson.notes?.aiNotes?.title || lesson.notes?.topic || 'Untitled';
                const subject = lesson.notes?.subject ? lesson.notes.subject.charAt(0).toUpperCase() + lesson.notes.subject.slice(1) : '';
                const grade   = lesson.notes?.class ? `Class ${lesson.notes.class}` : '';
                const when    = lesson.savedAt ? timeAgo(new Date(lesson.savedAt)) : '';
                return `<div class="history-item" onclick="loadLesson(${i})">
                    <div class="history-title">${topic}</div>
                    <div class="history-meta">${subject}${grade ? '  ' + grade : ''}${when ? '  ' + when : ''}</div>
                </div>`;
            }).join('');
        }

        function timeAgo(date) {
            const diff = Math.floor((Date.now() - date) / 1000);
            if (diff < 60) return 'just now';
            if (diff < 3600) return Math.floor(diff / 60) + ' min ago';
            if (diff < 86400) return Math.floor(diff / 3600) + ' hr ago';
            return Math.floor(diff / 86400) + ' day(s) ago';
        }

        function loadLessonState() {
            const savedLesson = localStorage.getItem('nep_teaching_studio_lesson');
            if (savedLesson) {
                try {
                    currentLesson = JSON.parse(savedLesson);
                } catch (e) {
                    console.error('Error loading saved lesson:', e);
                }
            }
            renderHistoryList();
        }

        function saveLessonState() {
            localStorage.setItem('nep_teaching_studio_lesson', JSON.stringify(currentLesson));
            pushToHistory(currentLesson);
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        const notificationStyles = `
            <style>
                .notification {
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: var(--panel-dark);
                    border: 1px solid var(--border-color);
                    border-left: 4px solid var(--accent-blue);
                    padding: 15px 20px;
                    border-radius: 8px;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    z-index: 10000;
                    animation: slideInRight 0.3s ease;
                    max-width: 350px;
                }
                
                .notification.success {
                    border-left-color: var(--success-green);
                }
                
                .notification.error {
                    border-left-color: var(--danger-red);
                }
                
                .notification.info {
                    border-left-color: var(--accent-cyan);
                }
                
                .notification i {
                    font-size: 1.2rem;
                }
                
                .notification.success i {
                    color: var(--success-green);
                }
                
                .notification.error i {
                    color: var(--danger-red);
                }
                
                .notification.info i {
                    color: var(--accent-cyan);
                }
                
                @keyframes slideInRight {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            </style>
        `;

        document.head.insertAdjacentHTML('beforeend', notificationStyles);

        // ============================================ //
        // CLASS PERFORMANCE - COMPLETE IMPLEMENTATION  //
        // ============================================ //

        let currentClassData = null;
        let currentClass = 10;
        let currentSection = 'A';
        let performanceSortAscending = true;

        async function loadClassPerformance() {
            const classSelector = document.getElementById('classSelector');
            const sectionSelector = document.getElementById('sectionSelector');
            
            if (classSelector) currentClass = classSelector.value;
            if (sectionSelector) currentSection = sectionSelector.value;
            
            console.log(` Loading class performance for Class ${currentClass}-${currentSection}...`);
            
            try {
                showPerformanceLoading();
                
                const lastUpdated = document.getElementById('lastUpdated');
                if (lastUpdated) {
                    lastUpdated.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Loading...`;
                }
                
                const response = await fetch(`${API_BASE_URL}/teacher/reports/class-performance?class=${currentClass}&section=${currentSection}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.status === 404) {
                    console.log(` No data for Class ${currentClass}-${currentSection}`);
                    showEmptyClassState(currentClass, currentSection);
                    resetAllCardsToZero(currentClass, currentSection);
                    
                    if (lastUpdated) {
                        lastUpdated.innerHTML = `<i class="fas fa-info-circle" style="color: #f39c12;"></i> No students in this class`;
                    }
                    hidePerformanceLoading();
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result && result.success === true && result.data) {
                    console.log(' API Response received:', result.data);
                    
                    currentClassData = result.data;
                    
                    mapClassInfoToCards(result.data);
                    mapStatisticsToCards(result.data);
                    mapDistributionToCards(result.data);
                    mapStudentTable(result.data.students || []);
                    mapInterventionSection(result.data.students || []);
                    
                    const distribution = result.data.statistics?.distribution || {
                        excellent: 0, good: 0, average: 0, needsImprovement: 0
                    };
                    createPerformanceDistributionChart(distribution);
                    
                    const now = new Date();
                    if (lastUpdated) {
                        lastUpdated.innerHTML = `<i class="fas fa-clock"></i> Last updated: ${formatTime(now)}`;
                    }
                    
                    showNotification(`Class ${currentClass}-${currentSection} data loaded successfully`, 'success');
                } else {
                    throw new Error('Invalid data format received');
                }
                
            } catch (error) {
                console.error(' API Error:', error);
                
                showEmptyClassState(currentClass, currentSection);
                resetAllCardsToZero(currentClass, currentSection);
                
                const lastUpdated = document.getElementById('lastUpdated');
                if (lastUpdated) {
                    lastUpdated.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i> Failed to load data`;
                }
                
                showNotification(`Could not load data for Class ${currentClass}-${currentSection}`, 'error');
            } finally {
                hidePerformanceLoading();
            }
        }

        function resetAllCardsToZero(classVal, sectionVal) {
            updateElementText('classTotalStudents', '0');
            updateElementHtml('studentCountBadge', 'Total: 0 Students');
            updateElementHtml('classInfo', `<i class="fas fa-school"></i> Class ${classVal}-${sectionVal}`);
            updateElementText('className', `${classVal}-${sectionVal}`);
            
            updateElementText('avgPerformance', '0%');
            updateElementText('meanScore', '0%');
            
            const avgLabel = document.getElementById('avgPerformanceLabel');
            if (avgLabel) {
                avgLabel.className = 'stat-change';
                avgLabel.innerHTML = '<i class="fas fa-minus-circle"></i> No Data';
            }
            
            updateElementText('topPerformer', '0%');
            updateElementHtml('topPerformerName', '<i class="fas fa-minus"></i> No students');
            
            updateElementText('needsHelp', '0');
            updateElementText('interventionCount', '0');
            
            updateElementText('excellentCount', '0');
            updateElementText('goodCount', '0');
            updateElementText('averageCount', '0');
            updateElementText('needsCount', '0');
            
            updateElementText('medianScore', '0%');
            updateElementText('scoreRange', '0% - 0%');
            updateElementText('stdDev', '0%');
        }

        function mapClassInfoToCards(data) {
            const totalStudents = data.class?.totalStudents || data.students?.length || 0;
            updateElementText('classTotalStudents', totalStudents);
            updateElementHtml('studentCountBadge', `Total: ${totalStudents} Students`);
            
            const className = data.class?.class || currentClass;
            const sectionName = data.class?.section || currentSection;
            updateElementHtml('classInfo', `<i class="fas fa-school"></i> Class ${className}-${sectionName}`);
            updateElementText('className', `${className}-${sectionName}`);
        }

        function mapStatisticsToCards(data) {
            const students = data.students || [];
            const avgPerformance = data.statistics?.averagePerformance || 0;
            
            updateElementText('avgPerformance', `${avgPerformance}%`);
            updateElementText('meanScore', `${avgPerformance}%`);
            
            const avgLabel = document.getElementById('avgPerformanceLabel');
            if (avgLabel) {
                if (avgPerformance >= 75) {
                    avgLabel.className = 'stat-change positive';
                    avgLabel.innerHTML = '<i class="fas fa-arrow-up"></i> Excellent';
                } else if (avgPerformance >= 60) {
                    avgLabel.className = 'stat-change';
                    avgLabel.innerHTML = '<i class="fas fa-minus-circle"></i> Satisfactory';
                } else if (avgPerformance > 0) {
                    avgLabel.className = 'stat-change negative';
                    avgLabel.innerHTML = '<i class="fas fa-arrow-down"></i> Needs Improvement';
                } else {
                    avgLabel.className = 'stat-change';
                    avgLabel.innerHTML = '<i class="fas fa-minus-circle"></i> No Data';
                }
            }
            
            if (students.length > 0) {
                const sorted = [...students].sort((a, b) => b.performanceIndex - a.performanceIndex);
                const topPerformer = sorted[0];
                updateElementText('topPerformer', `${topPerformer.performanceIndex}%`);
                updateElementHtml('topPerformerName', `<i class="fas fa-arrow-up"></i> ${escapeHtml(topPerformer.name)}`);
            } else {
                updateElementText('topPerformer', '0%');
                updateElementHtml('topPerformerName', '<i class="fas fa-minus"></i> No students');
            }
            
            const needsHelpCount = students.filter(s => s.performanceIndex < 50).length;
            updateElementText('needsHelp', needsHelpCount);
            updateElementText('interventionCount', needsHelpCount);
        }

        function mapDistributionToCards(data) {
            const distribution = data.statistics?.distribution || {};
            const students = data.students || [];
            
            updateElementText('excellentCount', distribution.excellent || 0);
            updateElementText('goodCount', distribution.good || 0);
            updateElementText('averageCount', distribution.average || 0);
            updateElementText('needsCount', distribution.needsImprovement || 0);
            
            if (students.length > 0) {
                const performances = students.map(s => s.performanceIndex).sort((a, b) => a - b);
                
                let median;
                if (performances.length % 2 === 0) {
                    median = (performances[performances.length/2 - 1] + performances[performances.length/2]) / 2;
                } else {
                    median = performances[Math.floor(performances.length/2)];
                }
                updateElementText('medianScore', `${median.toFixed(1)}%`);
                
                const min = performances[0];
                const max = performances[performances.length - 1];
                updateElementText('scoreRange', `${min}% - ${max}%`);
                
                const mean = data.statistics?.averagePerformance || 0;
                if (performances.length > 1) {
                    const squareDiffs = performances.map(value => Math.pow(value - mean, 2));
                    const avgSquareDiff = squareDiffs.reduce((a, b) => a + b, 0) / squareDiffs.length;
                    const stdDev = Math.sqrt(avgSquareDiff).toFixed(1);
                    updateElementText('stdDev', `${stdDev}%`);
                } else {
                    updateElementText('stdDev', '0%');
                }
            } else {
                updateElementText('medianScore', '0%');
                updateElementText('scoreRange', '0% - 0%');
                updateElementText('stdDev', '0%');
            }
        }

        function mapStudentTable(students) {
            const tbody = document.getElementById('studentPerformanceTable');
            if (!tbody) return;
            
            if (!students || students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            <i class="fas fa-user-graduate" style="font-size: 2.5rem; color: var(--text-secondary); margin-bottom: 10px;"></i>
                            <h3 style="color: var(--text-secondary); margin-bottom: 5px;">No Students Found</h3>
                            <p style="color: var(--text-secondary);">This class section has no enrolled students</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const sorted = [...students].sort((a, b) => b.performanceIndex - a.performanceIndex);
            
            tbody.innerHTML = sorted.map((student, index) => {
                const studentId = student.studentId || 'N/A';
                const studentName = escapeHtml(student.name || 'Unknown Student');
                const performanceIndex = student.performanceIndex || 0;
                const grade = student.grade || 'N/A';
                
                let statusBadge, statusClass;
                if (performanceIndex >= 75) {
                    statusBadge = 'Excellent';
                    statusClass = 'badge-success';
                } else if (performanceIndex >= 60) {
                    statusBadge = 'Good';
                    statusClass = 'badge-info';
                } else if (performanceIndex >= 50) {
                    statusBadge = 'Average';
                    statusClass = 'badge-warning';
                } else {
                    statusBadge = 'Needs Help';
                    statusClass = 'badge-danger';
                }
                
                let gradeClass = 'badge-info';
                if (grade === 'A' || grade === 'A+') gradeClass = 'badge-success';
                else if (grade === 'B' || grade === 'B+') gradeClass = 'badge-info';
                else if (grade === 'C') gradeClass = 'badge-warning';
                else if (grade === 'F') gradeClass = 'badge-danger';
                
                const rankDisplay = index === 0 
                    ? '<i class="fas fa-crown" style="color: #f39c12;"></i>' 
                    : `#${index + 1}`;
                
                return `
                    <tr>
                        <td style="font-weight: 600; ${index === 0 ? 'color: #f39c12;' : ''}">${rankDisplay}</td>
                        <td><span style="font-family: monospace; font-size: 0.85rem;">${studentId}</span></td>
                        <td><strong>${studentName}</strong></td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-weight: 700; color: ${getScoreColor(performanceIndex)}; min-width: 45px;">
                                    ${performanceIndex}%
                                </span>
                                <div class="progress-bar" style="width: 80px; height: 8px; background: rgba(255,255,255,0.1);">
                                    <div class="progress-fill" style="width: ${performanceIndex}%; background: ${getScoreGradient(performanceIndex)}; height: 100%; border-radius: 4px;"></div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge ${gradeClass}" style="min-width: 70px;">Grade ${grade}</span>
                        </td>
                        <td>
                            <span class="badge ${statusClass}" style="min-width: 90px;">${statusBadge}</span>
                        </td>
                        <td>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn btn-secondary btn-sm" onclick="viewStudentDetails('${studentId}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="generateStudentReport('${studentId}')" title="Generate Report">
                                    <i class="fas fa-file-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function mapInterventionSection(students) {
            const interventionSection = document.getElementById('interventionSection');
            const interventionContainer = document.getElementById('interventionStudents');
            
            if (!interventionSection || !interventionContainer) return;
            
            const needsHelpStudents = students.filter(s => s.performanceIndex < 50);
            
            if (needsHelpStudents.length > 0) {
                interventionSection.style.display = 'block';
                
                interventionContainer.innerHTML = needsHelpStudents.map(student => {
                    const studentId = student.studentId || 'N/A';
                    const studentName = escapeHtml(student.name || 'Unknown Student');
                    const performanceIndex = student.performanceIndex || 0;
                    
                    return `
                        <div style="background: rgba(231, 76, 60, 0.05); border-left: 4px solid #e74c3c; padding: 18px; border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <div style="width: 40px; height: 40px; background: rgba(231,76,60,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-exclamation-triangle" style="color: #e74c3c; font-size: 1.1rem;"></i>
                                </div>
                                <div>
                                    <strong style="color: #e74c3c; font-size: 1rem;">${studentName}</strong>
                                    <div style="font-size: 0.75rem; color: #888; margin-top: 3px;">${studentId}</div>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: var(--text-secondary);">Current Score:</span>
                                <span style="font-weight: 700; color: #e74c3c;">${performanceIndex}%</span>
                            </div>
                            <div class="progress-bar" style="margin-bottom: 15px; height: 8px; background: rgba(255,255,255,0.1);">
                                <div class="progress-fill" style="width: ${performanceIndex}%; background: #e74c3c; height: 100%; border-radius: 4px;"></div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-danger btn-sm" onclick="createInterventionPlan('${studentId}')" style="flex: 1;">
                                    <i class="fas fa-plus-circle"></i> Intervention
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="viewStudentDetails('${studentId}')" style="flex: 1;">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                interventionSection.style.display = 'none';
            }
        }

        function createPerformanceDistributionChart(distribution) {
            const canvas = document.getElementById('performanceDistributionChart');
            if (!canvas) {
                console.log(' Performance distribution chart canvas not found - skipping');
                return;
            }
            
            if (!(canvas instanceof HTMLCanvasElement)) {
                console.error(' Element is not a canvas:', canvas);
                return;
            }
            
            try {
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error(' Could not get canvas context');
                    return;
                }
                
                if (window.performanceDistChart) {
                    window.performanceDistChart.destroy();
                    window.performanceDistChart = null;
                }
                
                const chartData = [
                    distribution.excellent || 0,
                    distribution.good || 0,
                    distribution.average || 0,
                    distribution.needsImprovement || 0
                ];
                
                const total = chartData.reduce((a, b) => a + b, 0);
                
                window.performanceDistChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Excellent (90-100%)', 'Good (70-89%)', 'Average (50-69%)', 'Needs Help (0-49%)'],
                        datasets: [{
                            data: chartData,
                            backgroundColor: ['#27ae60', '#2ecc71', '#f39c12', '#e74c3c'],
                            borderColor: '#252526',
                            borderWidth: 3,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        cutout: '65%',
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#252526',
                                titleColor: '#fff',
                                bodyColor: '#ddd',
                                borderColor: '#464647',
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw || 0;
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${context.label}: ${value} student${value !== 1 ? 's' : ''} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                
                updateDistributionLegend(chartData, total);
                
            } catch (error) {
                console.error(' Error creating performance distribution chart:', error);
            }
        }

        function updateDistributionLegend(data, total) {
            const legend = document.getElementById('distributionLegend');
            if (!legend) return;
            
            const items = [
                { label: 'Excellent', count: data[0], color: '#27ae60' },
                { label: 'Good', count: data[1], color: '#2ecc71' },
                { label: 'Average', count: data[2], color: '#f39c12' },
                { label: 'Needs Help', count: data[3], color: '#e74c3c' }
            ];
            
            legend.innerHTML = items.map(item => {
                const percentage = total > 0 ? ((item.count / total) * 100).toFixed(1) : 0;
                return `
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 12px; height: 12px; border-radius: 50%; background: ${item.color};"></div>
                        <span style="font-size: 0.85rem; color: var(--text-secondary);">
                            ${item.label}: <strong style="color: ${item.color};">${item.count}</strong> (${percentage}%)
                        </span>
                    </div>
                `;
            }).join('');
        }

        function updateElementText(id, value) {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        }

        function updateElementHtml(id, html) {
            const el = document.getElementById(id);
            if (el) el.innerHTML = html;
        }

        function showPerformanceLoading() {
            const loadingElements = [
                'classTotalStudents', 'avgPerformance', 'topPerformer', 'needsHelp',
                'excellentCount', 'goodCount', 'averageCount', 'needsCount',
                'meanScore', 'medianScore', 'scoreRange', 'stdDev'
            ];
            
            loadingElements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            });
        }

        function hidePerformanceLoading() {
            // Loading is removed when data is populated
        }

        function showEmptyClassState(classVal, sectionVal) {
            const tbody = document.getElementById('studentPerformanceTable');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 50px;">
                            <i class="fas fa-users" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 15px;"></i>
                            <h3 style="color: var(--text-secondary); margin-bottom: 10px;">No Students Found</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 5px;">Class ${classVal}-${sectionVal} has no enrolled students</p>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">Add students to this class to see performance data</p>
                        </td>
                    </tr>
                `;
            }
        }

        function getScoreColor(score) {
            if (score >= 80) return '#27ae60';
            if (score >= 60) return '#2ecc71';
            if (score >= 40) return '#f39c12';
            return '#e74c3c';
        }

        function getScoreGradient(score) {
            if (score >= 80) return 'linear-gradient(90deg, #27ae60, #2ecc71)';
            if (score >= 60) return 'linear-gradient(90deg, #2ecc71, #f39c12)';
            if (score >= 40) return 'linear-gradient(90deg, #f39c12, #e74c3c)';
            return 'linear-gradient(90deg, #e74c3c, #c0392b)';
        }

        function formatTime(date) {
            const hours = date.getHours();
            const minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const formattedHours = hours % 12 || 12;
            const formattedMinutes = minutes < 10 ? '0' + minutes : minutes;
            return `${formattedHours}:${formattedMinutes} ${ampm}`;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function sortStudents(criteria) {
            if (!currentClassData || !currentClassData.students) {
                showNotification('No data to sort', 'info');
                return;
            }
            
            const students = [...currentClassData.students];
            
            if (criteria === 'name') {
                students.sort((a, b) => {
                    return performanceSortAscending 
                        ? a.name.localeCompare(b.name) 
                        : b.name.localeCompare(a.name);
                });
                showNotification(`Sorted by name ${performanceSortAscending ? 'A-Z' : 'Z-A'}`, 'info');
            } else {
                students.sort((a, b) => {
                    return performanceSortAscending 
                        ? a.performanceIndex - b.performanceIndex 
                        : b.performanceIndex - a.performanceIndex;
                });
                showNotification(`Sorted by score ${performanceSortAscending ? 'low to high' : 'high to low'}`, 'info');
            }
            
            mapStudentTable(students);
            performanceSortAscending = !performanceSortAscending;
        }

        function exportClassReport(format = 'pdf') {
            const classVal = document.getElementById('classSelector')?.value || currentClass;
            const sectionVal = document.getElementById('sectionSelector')?.value || currentSection;
            
            if (!currentClassData || !currentClassData.students || currentClassData.students.length === 0) {
                showNotification(`No data to export for Class ${classVal}-${sectionVal}`, 'warning');
                return;
            }
            
            showNotification(`Generating ${format.toUpperCase()} report for Class ${classVal}-${sectionVal}...`, 'info');
            
            setTimeout(() => {
                showNotification(`${format.toUpperCase()} report generated successfully!`, 'success');
            }, 1500);
        }

        function refreshClassPerformance() {
            showNotification('Refreshing class performance data...', 'info');
            loadClassPerformance();
        }

        function createInterventionPlan(studentId) {
            showNotification(`Creating intervention plan for student ${studentId}`, 'info');
        }

        // ============================================================================
        // REPORTS PAGE
        // ============================================================================
        let _classReportData = null;
        let _studentReportData = null;
        let _studentNepReportId = null;

        // Format hyphenated competency key  "Title Case" label
        function formatCompLabel(key) {
            return key.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        }

        async function initReports() {
            const classSelect = document.getElementById('reportClass');
            const sectionSelect = document.getElementById('reportSection');
            if (!classSelect || classSelect._loaded) return;

            try {
                const data = await apiCall('/teacher/classes');
                const classes = data.data?.classes || [];
                classSelect._allClasses = classes;

                const uniqueClasses = [...new Set(classes.map(c => c.class))].sort((a, b) => a - b);
                classSelect.innerHTML = '<option value="">Select Class</option>' +
                    uniqueClasses.map(c => `<option value="${c}">Class ${c}</option>`).join('');
                classSelect._loaded = true;

                if (uniqueClasses.length === 1) {
                    classSelect.value = uniqueClasses[0];
                    onReportClassChange();
                }
            } catch (e) {
                // Fallback: standard Indian school classes
                classSelect.innerHTML = '<option value="">Select Class</option>' +
                    Array.from({ length: 12 }, (_, i) =>
                        `<option value="${i + 1}">Class ${i + 1}</option>`).join('');
                sectionSelect.innerHTML = '<option value="">Select Section</option>' +
                    ['A', 'B', 'C', 'D'].map(s => `<option value="${s}">${s}</option>`).join('');
                classSelect._loaded = true;
            }
        }

        function onReportClassChange() {
            const classSelect = document.getElementById('reportClass');
            const sectionSelect = document.getElementById('reportSection');
            const selectedClass = parseInt(classSelect.value);
            const allClasses = classSelect._allClasses || [];

            sectionSelect.innerHTML = '<option value="">Select Section</option>';
            if (!selectedClass) return;

            const sections = allClasses
                .filter(c => c.class === selectedClass)
                .map(c => c.section)
                .sort();

            if (sections.length) {
                sections.forEach(s => {
                    sectionSelect.innerHTML += `<option value="${s}">${s}</option>`;
                });
                if (sections.length === 1) sectionSelect.value = sections[0];
            } else {
                // Fallback sections
                ['A', 'B', 'C', 'D'].forEach(s => {
                    sectionSelect.innerHTML += `<option value="${s}">${s}</option>`;
                });
            }
        }

        async function generateClassReport() {
            const classVal = document.getElementById('reportClass').value;
            const sectionVal = document.getElementById('reportSection').value;
            const periodVal = document.getElementById('reportPeriod').value;
            const resultEl = document.getElementById('classReportResult');
            const downloadBtn = document.getElementById('downloadClassReportBtn');

            if (!classVal || !sectionVal) {
                showNotification('Please select both Class and Section', 'warning');
                return;
            }

            resultEl.innerHTML = '<div style="text-align:center;padding:32px;color:#888;"><i class="fas fa-spinner fa-spin" style="font-size:1.6rem;display:block;margin-bottom:10px;"></i>Generating report...</div>';
            downloadBtn.style.display = 'none';
            _classReportData = null;

            try {
                let url = `/teacher/reports/class-performance?class=${classVal}&section=${sectionVal}`;
                if (periodVal) url += `&period=${periodVal}`;
                const data = await apiCall(url);
                _classReportData = data.data;
                renderClassReport(data.data, resultEl);
                downloadBtn.style.display = '';
            } catch (e) {
                resultEl.innerHTML = `<div style="color:#e74c3c;padding:16px;background:rgba(231,76,60,0.08);border-radius:8px;border:1px solid rgba(231,76,60,0.2);"><i class="fas fa-exclamation-triangle" style="margin-right:8px;"></i>${e.message || 'Failed to generate report'}</div>`;
            }
        }

        function renderClassReport(data, container) {
            const cls = data.class || {};
            const stats = data.statistics || {};
            const dist = stats.distribution || {};
            const students = data.students || [];
            const comps = data.competencies || {};
            const gradeColor = { A: '#00d47f', B: '#00d4ff', C: '#ffa500', D: '#ff6b35', F: '#e74c3c' };

            container.innerHTML = `
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;margin-bottom:16px;">
                    <div style="background:#1e1e1e;border-radius:10px;padding:16px;text-align:center;">
                        <div style="font-size:1.8rem;font-weight:700;color:#00d4ff;">${cls.totalStudents || 0}</div>
                        <div style="font-size:0.78rem;color:#888;margin-top:4px;">Total Students</div>
                    </div>
                    <div style="background:#1e1e1e;border-radius:10px;padding:16px;text-align:center;">
                        <div style="font-size:1.8rem;font-weight:700;color:#00d47f;">${stats.averagePerformance || 0}</div>
                        <div style="font-size:0.78rem;color:#888;margin-top:4px;">Avg SPI Score</div>
                    </div>
                    <div style="background:#1e1e1e;border-radius:10px;padding:16px;text-align:center;">
                        <div style="font-size:1.8rem;font-weight:700;color:#00d47f;">${dist.excellent || 0}</div>
                        <div style="font-size:0.78rem;color:#888;margin-top:4px;">Excellent 90</div>
                    </div>
                    <div style="background:#1e1e1e;border-radius:10px;padding:16px;text-align:center;">
                        <div style="font-size:1.8rem;font-weight:700;color:#3498db;">${dist.good || 0}</div>
                        <div style="font-size:0.78rem;color:#888;margin-top:4px;">Good 7089</div>
                    </div>
                    <div style="background:#1e1e1e;border-radius:10px;padding:16px;text-align:center;">
                        <div style="font-size:1.8rem;font-weight:700;color:#e74c3c;">${dist.needsImprovement || 0}</div>
                        <div style="font-size:0.78rem;color:#888;margin-top:4px;">Needs Support</div>
                    </div>
                </div>
                ${Object.keys(comps).length ? `
                <div style="background:#1e1e1e;border-radius:10px;padding:16px;margin-bottom:16px;">
                    <h4 style="color:#ccc;margin:0 0 12px;font-size:0.88rem;text-transform:uppercase;letter-spacing:0.5px;">Competency Averages</h4>
                    <div style="display:flex;flex-wrap:wrap;gap:8px;">
                        ${Object.entries(comps).map(([comp, score]) => `
                        <div style="background:#2d2d30;border-radius:6px;padding:8px 14px;font-size:0.82rem;">
                            <span style="color:#888;">${formatCompLabel(comp)}:</span>
                            <span style="color:${score>=70?'#00d47f':score>=50?'#ffa500':'#e74c3c'};font-weight:600;margin-left:6px;">${score}%</span>
                        </div>`).join('')}
                    </div>
                </div>` : ''}
                <div style="background:#1e1e1e;border-radius:10px;padding:16px;">
                    <h4 style="color:#ccc;margin:0 0 12px;font-size:0.88rem;text-transform:uppercase;letter-spacing:0.5px;">Student Rankings  Class ${cls.class}${cls.section}</h4>
                    <div style="overflow-x:auto;">
                        <table style="width:100%;border-collapse:collapse;font-size:0.85rem;">
                            <thead>
                                <tr style="border-bottom:1px solid #464647;">
                                    <th style="text-align:left;padding:8px 12px;color:#888;font-weight:600;">#</th>
                                    <th style="text-align:left;padding:8px 12px;color:#888;font-weight:600;">Name</th>
                                    <th style="text-align:left;padding:8px 12px;color:#888;font-weight:600;">ID</th>
                                    <th style="text-align:center;padding:8px 12px;color:#888;font-weight:600;">SPI</th>
                                    <th style="text-align:center;padding:8px 12px;color:#888;font-weight:600;">Grade</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${students.map((s, i) => `
                                <tr style="border-bottom:1px solid #2a2a2c;">
                                    <td style="padding:8px 12px;color:#555;">${i + 1}</td>
                                    <td style="padding:8px 12px;color:#e0e0e0;font-weight:500;">${s.name}</td>
                                    <td style="padding:8px 12px;color:#888;font-size:0.78rem;">${s.studentId}</td>
                                    <td style="padding:8px 12px;text-align:center;color:#00d4ff;font-weight:700;">${s.performanceIndex}</td>
                                    <td style="padding:8px 12px;text-align:center;">
                                        <span style="background:${(gradeColor[s.grade]||'#888')}22;color:${gradeColor[s.grade]||'#888'};padding:2px 10px;border-radius:12px;font-weight:600;font-size:0.8rem;">${s.grade}</span>
                                    </td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
        }

        async function generateStudentReport(directStudentId) {
            // Called either from the Reports page input or directly from students list with an ID
            if (directStudentId) {
                // Navigate to Reports page and pre-fill the student ID
                showPage('reports');
                await new Promise(r => setTimeout(r, 100)); // wait for page render
                const inputEl = document.getElementById('reportStudentId');
                if (inputEl) inputEl.value = directStudentId;
            }

            const studentId = directStudentId || document.getElementById('reportStudentId')?.value.trim();
            const resultEl = document.getElementById('studentReportResult');
            const downloadBtn = document.getElementById('downloadStudentReportBtn');

            if (!studentId) {
                showNotification('Please enter a Student ID', 'warning');
                return;
            }

            resultEl.innerHTML = '<div style="text-align:center;padding:32px;color:#888;"><i class="fas fa-spinner fa-spin" style="font-size:1.6rem;display:block;margin-bottom:10px;"></i>Generating report...</div>';
            downloadBtn.style.display = 'none';
            _studentReportData = null;
            _studentNepReportId = null;

            try {
                const data = await apiCall(`/teacher/reports/student/${studentId}`);
                _studentReportData = data.data;
                renderStudentReport(data.data, resultEl);
                downloadBtn.style.display = '';

                // Ensure NEP report exists; generate one if student has none
                let nepReports = data.data?.nepReports || [];
                const _tk = localStorage.getItem('authToken');
                if (nepReports.length === 0 && data.data?.student?.studentId) {
                    try {
                        const genRes = await fetch(`${API_BASE_URL}/reports/nep/generate`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${_tk}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ studentId: data.data.student.studentId, reportType: 'monthly' })
                        });
                        const genData = await genRes.json();
                        if (genData.success && genData.data?.report?.reportId) {
                            nepReports = [{ reportId: genData.data.report.reportId }];
                        }
                    } catch (_) {}
                }

                if (nepReports.length > 0) {
                    _studentNepReportId = nepReports[0].reportId;
                    const narrateStatus = document.createElement('div');
                    narrateStatus.style.cssText = 'margin-top:12px;padding:10px 14px;background:rgba(0,212,255,0.08);border:1px solid rgba(0,212,255,0.2);border-radius:6px;font-size:0.82rem;color:#888;';
                    narrateStatus.textContent = 'Generating NEP narration';
                    resultEl.appendChild(narrateStatus);
                    try {
                        const nRes = await fetch(`${API_BASE_URL}/reports/nep/${_studentNepReportId}/narration`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${_tk}`, 'Content-Type': 'application/json' }
                        });
                        const nData = await nRes.json();
                        const narrationText = nData.narration || nData.data?.narration;
                        const blockchain = nData.blockchainVerification;
                        if (nData.success && narrationText) {
                            const blockchainBadge = blockchain ? `
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;padding:8px 12px;background:rgba(0,166,90,0.1);border:1px solid rgba(0,166,90,0.3);border-radius:6px;">
                                <span></span>
                                <div style="font-size:0.75rem;">
                                    <span style="color:#00d47f;font-weight:600;">Blockchain Verified</span>
                                    <span style="color:#888;margin-left:8px;">Merkle: ${(blockchain.merkleRoot||'').substring(0,14)} &nbsp;|&nbsp; ${blockchain.verificationStatus||'VERIFIED'}</span>
                                </div>
                            </div>` : '';
                            narrateStatus.style.cssText = 'margin-top:12px;padding:14px 16px;background:rgba(0,212,255,0.06);border:1px solid rgba(0,212,255,0.15);border-radius:6px;';
                            narrateStatus.innerHTML = blockchainBadge + `<div style="font-size:0.78rem;color:#00d4ff;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">NEP 2020 Official Narration</div><div style="font-size:0.83rem;color:#ccc;line-height:1.7;white-space:pre-line;">${narrationText}</div>`;
                        } else {
                            narrateStatus.remove();
                        }
                    } catch (ne) {
                        narrateStatus.remove();
                    }
                }
            } catch (e) {
                resultEl.innerHTML = `<div style="color:#e74c3c;padding:16px;background:rgba(231,76,60,0.08);border-radius:8px;border:1px solid rgba(231,76,60,0.2);"><i class="fas fa-exclamation-triangle" style="margin-right:8px;"></i>${e.message || 'Student not found or access denied'}</div>`;
            }
        }

        function renderStudentReport(data, container) {
            const stu = data.student || {};
            const perf = data.performance || {};
            const comps = data.competencies || {};
            const gradeColor = { A: '#00d47f', B: '#00d4ff', C: '#ffa500', D: '#ff6b35', F: '#e74c3c' };

            // Filter out zero-score competencies to detect if student has done challenges
            const activeComps = Object.entries(comps).filter(([, v]) => v > 0);
            const hasCompData = activeComps.length > 0;

            container.innerHTML = `
                <div style="background:#1e1e1e;border-radius:10px;padding:16px;margin-bottom:14px;">
                    <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:center;margin-bottom:12px;">
                        <div>
                            <div style="font-size:1.1rem;font-weight:700;color:#e0e0e0;">${stu.name || '-'}</div>
                            <div style="font-size:0.82rem;color:#888;margin-top:2px;">${stu.studentId || '-'} &nbsp;|&nbsp; Class ${stu.class || '-'}-${stu.section || '-'}</div>
                        </div>
                    </div>
                    <div style="display:flex;gap:16px;flex-wrap:wrap;">
                        <div style="text-align:center;background:#252526;border-radius:8px;padding:12px 16px;">
                            <div style="font-size:1.5rem;font-weight:700;color:#00d4ff;">${stu.performanceIndex || 0}</div>
                            <div style="font-size:0.75rem;color:#888;margin-top:2px;">SPI Score</div>
                        </div>
                        <div style="text-align:center;background:#252526;border-radius:8px;padding:12px 16px;">
                            <div style="font-size:1.5rem;font-weight:700;color:${gradeColor[stu.grade]||'#888'};">${stu.grade || 'N/A'}</div>
                            <div style="font-size:0.75rem;color:#888;margin-top:2px;">Grade</div>
                        </div>
                        <div style="text-align:center;background:#252526;border-radius:8px;padding:12px 16px;">
                            <div style="font-size:1.5rem;font-weight:700;color:#00d47f;">${perf.passedChallenges || 0}/${perf.totalChallenges || 0}</div>
                            <div style="font-size:0.75rem;color:#888;margin-top:2px;">Challenges Passed</div>
                        </div>
                        <div style="text-align:center;background:#252526;border-radius:8px;padding:12px 16px;">
                            <div style="font-size:1.5rem;font-weight:700;color:#ffa500;">${perf.passRate || 0}%</div>
                            <div style="font-size:0.75rem;color:#888;margin-top:2px;">Pass Rate</div>
                        </div>
                        <div style="text-align:center;background:#252526;border-radius:8px;padding:12px 16px;">
                            <div style="font-size:1.5rem;font-weight:700;color:#9b59b6;"> ${perf.currentStreak || 0}</div>
                            <div style="font-size:0.75rem;color:#888;margin-top:2px;">Day Streak</div>
                        </div>
                        <div style="text-align:center;background:#252526;border-radius:8px;padding:12px 16px;">
                            <div style="font-size:1.5rem;font-weight:700;color:#3498db;">${perf.weeklyActivity || 0}</div>
                            <div style="font-size:0.75rem;color:#888;margin-top:2px;">Days Active (Week)</div>
                        </div>
                        <div style="text-align:center;background:#252526;border-radius:8px;padding:12px 16px;">
                            <div style="font-size:1.5rem;font-weight:700;color:#e67e22;">${perf.averageScore || 0}</div>
                            <div style="font-size:0.75rem;color:#888;margin-top:2px;">Avg Challenge Score</div>
                        </div>
                    </div>
                </div>
                <div style="background:#1e1e1e;border-radius:10px;padding:16px;">
                    <h4 style="color:#ccc;margin:0 0 14px;font-size:0.88rem;text-transform:uppercase;letter-spacing:0.5px;">
                        NEP 2020 Competency Assessment
                        ${!hasCompData ? '<span style="font-size:0.78rem;color:#666;font-weight:400;text-transform:none;margin-left:8px;">(No challenges completed yet)</span>' : ''}
                    </h4>
                    ${Object.entries(comps).map(([comp, score]) => {
                        const pct = Math.min(Math.round(score), 100);
                        const col = pct >= 70 ? '#00d47f' : pct >= 50 ? '#ffa500' : pct > 0 ? '#e74c3c' : '#464647';
                        return `<div style="margin-bottom:12px;">
                            <div style="display:flex;justify-content:space-between;font-size:0.82rem;margin-bottom:4px;">
                                <span style="color:#ccc;">${formatCompLabel(comp)}</span>
                                <span style="color:${col};font-weight:600;">${pct > 0 ? pct + '%' : ''}</span>
                            </div>
                            <div style="height:6px;background:#2d2d30;border-radius:3px;">
                                <div style="height:100%;width:${pct}%;background:${col};border-radius:3px;transition:width 0.6s ease;"></div>
                            </div>
                        </div>`;
                    }).join('')}
                </div>`;
        }

        function downloadClassReportPDF() {
            if (!_classReportData) return;
            const cls = _classReportData.class || {};
            const stats = _classReportData.statistics || {};
            const dist = stats.distribution || {};
            const students = _classReportData.students || [];
            const comps = _classReportData.competencies || {};
            const gradeColor = { A: '#00a65a', B: '#3498db', C: '#f39c12', D: '#e67e22', F: '#e74c3c' };
            const dateStr = new Date().toLocaleDateString('en-IN', { day: '2-digit', month: 'long', year: 'numeric' });

            // Chart data
            const distData   = [dist.excellent||0, dist.good||0, dist.average||0, dist.needsImprovement||0];
            const distLabels = ['Excellent (>=90)', 'Good (70-89)', 'Average (50-69)', 'Needs Support (<50)'];
            const distColors = ['#00a65a','#3498db','#f39c12','#e74c3c'];
            const compKeys   = Object.keys(comps);
            const compVals   = compKeys.map(k => comps[k] || 0);
            const compLabels = compKeys.map(c => c.replace(/-/g, ' ').replace(/\b\w/g, x => x.toUpperCase()));
            const compColors = compVals.map(v => v >= 70 ? '#00a65a' : v >= 50 ? '#f39c12' : '#e74c3c');

            const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>NEP 2020 Class Report</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"><\/script>
<style>
  body{font-family:'Segoe UI',sans-serif;color:#1a1a2e;margin:0;padding:36px;background:#fff;}
  h1{color:#007acc;border-bottom:3px solid #007acc;padding-bottom:12px;margin-bottom:6px;font-size:1.5rem;}
  .sub{color:#555;font-size:0.88rem;margin-bottom:24px;}
  .tiles{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:24px;}
  .tile{border:1px solid #dde;border-radius:8px;padding:14px 18px;text-align:center;min-width:100px;}
  .tv{font-size:1.9rem;font-weight:700;color:#007acc;}
  .tl{font-size:0.75rem;color:#666;margin-top:3px;}
  h2{color:#333;font-size:1rem;margin:22px 0 8px;border-left:4px solid #007acc;padding-left:10px;}
  table{width:100%;border-collapse:collapse;font-size:0.86rem;}
  th{background:#007acc;color:#fff;padding:9px 12px;text-align:left;font-weight:600;}
  td{padding:7px 12px;border-bottom:1px solid #eee;}
  tr:nth-child(even) td{background:#f8faff;}
  .gr{display:inline-block;padding:2px 9px;border-radius:12px;font-weight:700;font-size:0.8rem;}
  .charts-row{display:flex;gap:24px;margin:24px 0;align-items:flex-start;flex-wrap:wrap;}
  .chart-box{background:#f8faff;border:1px solid #dde;border-radius:8px;padding:16px;flex:1;min-width:250px;}
  .chart-box h3{font-size:0.85rem;color:#555;margin-bottom:12px;text-align:center;font-weight:600;}
  .no-print{text-align:right;margin-bottom:20px;}
  .footer{margin-top:32px;padding-top:14px;border-top:1px solid #ddd;font-size:0.76rem;color:#999;text-align:center;}
  @media print{body{padding:20px;}.no-print{display:none;}}
</style></head><body>
<div class="no-print">
  <button onclick="window.print()" style="background:#007acc;color:#fff;border:none;padding:10px 22px;border-radius:5px;font-size:13px;cursor:pointer;">Download / Print as PDF</button>
</div>
<h1>NEP 2020 Class Performance Report</h1>
<div class="sub">Class ${cls.class}-${cls.section} &nbsp;&bull;&nbsp; Generated: ${dateStr} &nbsp;&bull;&nbsp; Total Students: ${cls.totalStudents || 0}</div>
<div class="tiles">
  <div class="tile"><div class="tv">${stats.averagePerformance || 0}</div><div class="tl">Avg SPI</div></div>
  <div class="tile"><div class="tv" style="color:#00a65a;">${dist.excellent || 0}</div><div class="tl">Excellent >=90</div></div>
  <div class="tile"><div class="tv" style="color:#3498db;">${dist.good || 0}</div><div class="tl">Good 70-89</div></div>
  <div class="tile"><div class="tv" style="color:#f39c12;">${dist.average || 0}</div><div class="tl">Average 50-69</div></div>
  <div class="tile"><div class="tv" style="color:#e74c3c;">${dist.needsImprovement || 0}</div><div class="tl">Needs Support</div></div>
</div>
<div class="charts-row">
  <div class="chart-box" style="max-width:280px;">
    <h3>Grade Distribution</h3>
    <canvas id="distChart" width="240" height="240"></canvas>
  </div>
  ${compKeys.length ? `<div class="chart-box" style="flex:2;min-width:300px;">
    <h3>NEP Competency Performance</h3>
    <canvas id="compChart" height="${Math.max(120, compKeys.length * 28)}"></canvas>
  </div>` : ''}
</div>
${students.length ? `<h2>Student Rankings</h2>
<table><thead><tr><th>#</th><th>Name</th><th>Student ID</th><th>SPI Score</th><th>Grade</th></tr></thead><tbody>
${students.map((s, i) => `<tr>
  <td>${i + 1}</td><td>${s.name}</td>
  <td style="font-size:0.8rem;color:#777;">${s.studentId}</td>
  <td style="font-weight:700;color:#007acc;">${s.performanceIndex}</td>
  <td><span class="gr" style="background:${gradeColor[s.grade] || '#888'}22;color:${gradeColor[s.grade] || '#888'};">${s.grade}</span></td>
</tr>`).join('')}
</tbody></table>` : ''}
<div class="footer">Generated per NEP 2020  National Education Policy 2020, Government of India. Confidential  For educational use only.</div>
<script>
window.onload = function() {
  var dCtx = document.getElementById('distChart');
  if (dCtx) {
    new Chart(dCtx, {
      type: 'doughnut',
      data: { labels: ${JSON.stringify(distLabels)}, datasets: [{ data: ${JSON.stringify(distData)}, backgroundColor: ${JSON.stringify(distColors)}, borderWidth: 2 }] },
      options: { responsive: false, plugins: { legend: { position: 'bottom', labels: { font: { size: 11 } } } } }
    });
  }
  ${compKeys.length ? `var cCtx = document.getElementById('compChart');
  if (cCtx) {
    new Chart(cCtx, {
      type: 'bar',
      data: { labels: ${JSON.stringify(compLabels)}, datasets: [{ label: 'Score %', data: ${JSON.stringify(compVals)}, backgroundColor: ${JSON.stringify(compColors)}, borderRadius: 4 }] },
      options: { indexAxis: 'y', responsive: true, scales: { x: { min: 0, max: 100, ticks: { callback: function(v){ return v + '%'; } } } }, plugins: { legend: { display: false } } }
    });
  }` : ''}
};
<\/script>
</body></html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
            setTimeout(() => URL.revokeObjectURL(url), 60000);
        }

        async function downloadStudentReportPDF() {
            if (!_studentReportData) return;

            // If a NEP report exists for this student, download the narrate report (PDF with narration)
            if (_studentNepReportId) {
                try {
                    showNotification('Downloading NEP narrate report', 'info');
                    const token = localStorage.getItem('authToken');
                    const res = await fetch(`${API_BASE_URL}/reports/nep/${_studentNepReportId}/download`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!res.ok) throw new Error('Download failed');
                    const blob = await res.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `NEP-Report-${_studentNepReportId}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    setTimeout(() => URL.revokeObjectURL(url), 60000);
                    return;
                } catch (e) {
                    showNotification('NEP download failed, falling back to local PDF', 'warning');
                }
            }

            // Fallback: build local HTML with Chart.js
            const stu = _studentReportData.student || {};
            const perf = _studentReportData.performance || {};
            const comps = _studentReportData.competencies || {};
            const gradeColor = { A: '#00a65a', B: '#3498db', C: '#f39c12', D: '#e67e22', F: '#e74c3c' };
            const dateStr = new Date().toLocaleDateString('en-IN', { day: '2-digit', month: 'long', year: 'numeric' });

            const stuCompKeys   = Object.keys(comps);
            const stuCompVals   = stuCompKeys.map(k => Math.min(Math.round(comps[k]||0), 100));
            const stuCompLabels = stuCompKeys.map(c => c.replace(/-/g, ' ').replace(/\b\w/g, x => x.toUpperCase()));
            const stuCompColors = stuCompVals.map(v => v >= 70 ? '#00a65a' : v >= 50 ? '#f39c12' : v > 0 ? '#e74c3c' : '#bbb');
            const stuPassed = perf.passedChallenges || 0;
            const stuFailed = Math.max(0, (perf.totalChallenges || 0) - stuPassed);

            const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>NEP 2020 Student Report</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"><\/script>
<style>
  body{font-family:'Segoe UI',sans-serif;color:#1a1a2e;margin:0;padding:36px;background:#fff;}
  h1{color:#007acc;border-bottom:3px solid #007acc;padding-bottom:12px;margin-bottom:6px;font-size:1.5rem;}
  .sub{color:#555;font-size:0.88rem;margin-bottom:24px;}
  .tiles{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:24px;}
  .tile{border:1px solid #dde;border-radius:8px;padding:14px 18px;text-align:center;min-width:100px;}
  .tv{font-size:1.9rem;font-weight:700;color:#007acc;}
  .tl{font-size:0.75rem;color:#666;margin-top:3px;}
  h2{color:#333;font-size:1rem;margin:22px 0 8px;border-left:4px solid #007acc;padding-left:10px;}
  .charts-row{display:flex;gap:24px;margin:24px 0;align-items:flex-start;flex-wrap:wrap;}
  .chart-box{background:#f8faff;border:1px solid #dde;border-radius:8px;padding:16px;flex:1;min-width:250px;}
  .chart-box h3{font-size:0.85rem;color:#555;margin-bottom:12px;text-align:center;font-weight:600;}
  .no-print{text-align:right;margin-bottom:20px;}
  .footer{margin-top:32px;padding-top:14px;border-top:1px solid #ddd;font-size:0.76rem;color:#999;text-align:center;}
  @media print{body{padding:20px;}.no-print{display:none;}}
</style></head><body>
<div class="no-print">
  <button onclick="window.print()" style="background:#007acc;color:#fff;border:none;padding:10px 22px;border-radius:5px;font-size:13px;cursor:pointer;">Download / Print as PDF</button>
</div>
<h1>NEP 2020 Student Performance Report</h1>
<div class="sub"><strong>${stu.name || '-'}</strong> &nbsp;&bull;&nbsp; ${stu.studentId || '-'} &nbsp;&bull;&nbsp; Class ${stu.class || '-'}-${stu.section || '-'} &nbsp;&bull;&nbsp; Generated: ${dateStr}</div>
<div class="tiles">
  <div class="tile"><div class="tv">${stu.performanceIndex || 0}</div><div class="tl">SPI Score</div></div>
  <div class="tile"><div class="tv" style="color:${gradeColor[stu.grade]||'#888'};">${stu.grade || 'N/A'}</div><div class="tl">Grade</div></div>
  <div class="tile"><div class="tv" style="color:#00a65a;">${perf.passedChallenges || 0}/${perf.totalChallenges || 0}</div><div class="tl">Challenges Passed</div></div>
  <div class="tile"><div class="tv" style="color:#f39c12;">${perf.passRate || 0}%</div><div class="tl">Pass Rate</div></div>
  <div class="tile"><div class="tv"> ${perf.currentStreak || 0}</div><div class="tl">Day Streak</div></div>
  <div class="tile"><div class="tv" style="color:#e67e22;">${perf.averageScore || 0}</div><div class="tl">Avg Score</div></div>
</div>
<div class="charts-row">
  <div class="chart-box" style="max-width:260px;">
    <h3>Challenge Completion</h3>
    <canvas id="perfChart" width="220" height="220"></canvas>
  </div>
  ${stuCompKeys.length ? `<div class="chart-box" style="flex:2;min-width:300px;">
    <h3>NEP 2020 Competency Scores</h3>
    <canvas id="compChart2" height="${Math.max(120, stuCompKeys.length * 28)}"></canvas>
  </div>` : ''}
</div>
<div class="footer">Generated per NEP 2020  National Education Policy 2020, Government of India. Confidential  For educational use only.</div>
<script>
window.onload = function() {
  var pCtx = document.getElementById('perfChart');
  if (pCtx) {
    new Chart(pCtx, {
      type: 'doughnut',
      data: { labels: ['Passed', 'Failed'], datasets: [{ data: [${stuPassed}, ${stuFailed}], backgroundColor: ['#00a65a','#e74c3c'], borderWidth: 2 }] },
      options: { responsive: false, plugins: { legend: { position: 'bottom', labels: { font: { size: 11 } } } } }
    });
  }
  ${stuCompKeys.length ? `var cCtx = document.getElementById('compChart2');
  if (cCtx) {
    new Chart(cCtx, {
      type: 'bar',
      data: { labels: ${JSON.stringify(stuCompLabels)}, datasets: [{ label: 'Score %', data: ${JSON.stringify(stuCompVals)}, backgroundColor: ${JSON.stringify(stuCompColors)}, borderRadius: 4 }] },
      options: { indexAxis: 'y', responsive: true, scales: { x: { min: 0, max: 100, ticks: { callback: function(v){ return v + '%'; } } } }, plugins: { legend: { display: false } } }
    });
  }` : ''}
};
<\/script>
</body></html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
            setTimeout(() => URL.revokeObjectURL(url), 60000);
        }

        function viewStudentDetails(studentId) {
            showNotification(`Loading details for student ${studentId}`, 'info');
        }

        function initClassPerformance() {
            console.log(' Initializing Class Performance Dashboard...');
            
            const classSelector = document.getElementById('classSelector');
            const sectionSelector = document.getElementById('sectionSelector');
            
            if (classSelector) {
                classSelector.addEventListener('change', function() {
                    console.log(`Class changed to: ${this.value}`);
                    loadClassPerformance();
                });
            }
            
            if (sectionSelector) {
                sectionSelector.addEventListener('change', function() {
                    console.log(`Section changed to: ${this.value}`);
                    loadClassPerformance();
                });
            }
        }

        // Override showPage to handle class performance initialization
        const originalShowPage = window.showPage;
        window.showPage = function(pageId) {
            if (originalShowPage) {
                originalShowPage(pageId);
            }
            
            if (pageId === 'validations') {
                console.log(' Class Performance Dashboard opened');
                setTimeout(() => {
                    initClassPerformance();
                    loadClassPerformance();
                }, 150);
            }
            
            if (pageId === 'analytics') {
                setTimeout(() => {
                    createAdvancedAnalyticsCharts();
                }, 100);
            }

            if (pageId === 'reports') {
                initReports();
            }
            
            if (pageId === 'overview') {
                setTimeout(() => {
                    initializeOverviewCharts();
                }, 100);
            }
        };

        // Auto-initialize if page is already active
        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('validations')?.classList.contains('active')) {
                setTimeout(() => {
                    initClassPerformance();
                    loadClassPerformance();
                }, 200);
            }
            
            if (document.getElementById('overview')?.classList.contains('active')) {
                setTimeout(() => {
                    initializeOverviewCharts();
                }, 200);
            }
        });
    </script>

    <script>
        // RESPONSIVE SIDEBAR TOGGLE
        (function() {
            const sidebar  = document.getElementById('sidebar');
            const toggle   = document.getElementById('sidebarToggle');
            const overlay  = document.getElementById('sidebarOverlay');
            if (!sidebar || !toggle) return;
            function openSidebar()  { sidebar.classList.add('open');    overlay.classList.add('active'); }
            function closeSidebar() { sidebar.classList.remove('open'); overlay.classList.remove('active'); }
            toggle.addEventListener('click', () => sidebar.classList.contains('open') ? closeSidebar() : openSidebar());
            overlay.addEventListener('click', closeSidebar);
            sidebar.querySelectorAll('.nav-item').forEach(el => {
                el.addEventListener('click', () => { if (window.innerWidth <= 992) closeSidebar(); });
            });
        })();
    </script>
</body>
</html>