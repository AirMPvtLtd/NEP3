<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inquiry & Hypothesis Lab - NEP Workbench</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        :root { --bg: #1e1e1e; --panel: #252526; --accent: #007acc; --success: #00b894; }
        body { background: var(--bg); color: #fff; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: #333; border-radius: 8px; padding: 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { font-size: 24px; color: var(--accent); }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; background: var(--accent); color: white; }
        .workflow { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 20px; }
        .workflow-step { background: #2d2d30; padding: 15px; border-radius: 6px; text-align: center; border: 2px solid #464647; cursor: pointer; transition: all 0.3s; }
        .workflow-step.active { background: var(--accent); border-color: var(--accent); }
        .workflow-step.completed { border-color: var(--success); }
        .panel { background: var(--panel); border-radius: 8px; padding: 20px; border: 1px solid #464647; margin-bottom: 20px; }
        textarea { width: 100%; padding: 15px; background: #2d2d30; border: 1px solid #464647; border-radius: 4px; color: #fff; min-height: 120px; font-size: 14px; line-height: 1.6; resize: vertical; }
        textarea:focus { outline: none; border-color: var(--accent); }
        .variable-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .variable-item { background: #2d2d30; padding: 12px; border-radius: 6px; border: 1px solid #464647; }
        .data-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid #464647; }
        .data-table th { background: #2d2d30; color: var(--accent); }
        input[type="text"], input[type="number"] { padding: 10px; background: #2d2d30; border: 1px solid #464647; border-radius: 4px; color: #fff; width: 100%; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div><h1><i class="fas fa-flask"></i> Inquiry & Hypothesis Lab</h1><p style="color: #888;">Cross-curricular â€¢ Scientific Method</p></div>
            <div style="display: flex; gap: 15px;">
                <span><i class="fas fa-clock"></i> <span id="timer">00:00</span></span>
                <button class="btn" onclick="saveProgress()"><i class="fas fa-save"></i> Save</button>
                <button class="btn" style="background: #00b894;" onclick="complete()"><i class="fas fa-check"></i> Complete</button>
            </div>
        </div>
        
        <div class="workflow">
            <div class="workflow-step active" onclick="goToStep(0)"><i class="fas fa-lightbulb" style="font-size: 24px; margin-bottom: 8px;"></i><div>Question</div></div>
            <div class="workflow-step" onclick="goToStep(1)"><i class="fas fa-flask" style="font-size: 24px; margin-bottom: 8px;"></i><div>Hypothesis</div></div>
            <div class="workflow-step" onclick="goToStep(2)"><i class="fas fa-microscope" style="font-size: 24px; margin-bottom: 8px;"></i><div>Experiment</div></div>
            <div class="workflow-step" onclick="goToStep(3)"><i class="fas fa-chart-bar" style="font-size: 24px; margin-bottom: 8px;"></i><div>Data</div></div>
            <div class="workflow-step" onclick="goToStep(4)"><i class="fas fa-clipboard-check" style="font-size: 24px; margin-bottom: 8px;"></i><div>Conclusion</div></div>
        </div>
        
        <div id="step0" class="panel">
            <h2 style="margin-bottom: 15px;"><i class="fas fa-lightbulb"></i> Research Question</h2>
            <p style="color: #888; margin-bottom: 15px;">What do you want to investigate? Write a clear, testable question.</p>
            <textarea id="question" placeholder="Example: How does the amount of sunlight affect plant growth?"></textarea>
            <button class="btn" style="margin-top: 15px;" onclick="nextStep()"><i class="fas fa-arrow-right"></i> Next: Hypothesis</button>
        </div>
        
        <div id="step1" class="panel" style="display: none;">
            <h2 style="margin-bottom: 15px;"><i class="fas fa-flask"></i> Hypothesis</h2>
            <p style="color: #888; margin-bottom: 15px;">Make a prediction. If..., then... because...</p>
            <textarea id="hypothesis" placeholder="Example: If a plant receives more sunlight, then it will grow taller, because..."></textarea>
            
            <h3 style="margin: 20px 0 10px;">Identify Variables</h3>
            <div class="variable-list">
                <div class="variable-item">
                    <label style="color: #888; font-size: 13px;">Independent Variable</label>
                    <input type="text" id="independent" placeholder="What you change">
                </div>
                <div class="variable-item">
                    <label style="color: #888; font-size: 13px;">Dependent Variable</label>
                    <input type="text" id="dependent" placeholder="What you measure">
                </div>
                <div class="variable-item">
                    <label style="color: #888; font-size: 13px;">Control Variables</label>
                    <input type="text" id="control" placeholder="What stays same">
                </div>
            </div>
            <button class="btn" style="margin-top: 15px;" onclick="nextStep()"><i class="fas fa-arrow-right"></i> Next: Design Experiment</button>
        </div>
        
        <div id="step2" class="panel" style="display: none;">
            <h2 style="margin-bottom: 15px;"><i class="fas fa-microscope"></i> Experiment Design</h2>
            <p style="color: #888; margin-bottom: 15px;">Describe your procedure step-by-step.</p>
            <textarea id="procedure" placeholder="1. 
2. 
3. "></textarea>
            
            <h3 style="margin: 20px 0 10px;">Materials Needed</h3>
            <textarea id="materials" style="min-height: 80px;" placeholder="List all materials..."></textarea>
            <button class="btn" style="margin-top: 15px;" onclick="nextStep()"><i class="fas fa-arrow-right"></i> Next: Collect Data</button>
        </div>
        
        <div id="step3" class="panel" style="display: none;">
            <h2 style="margin-bottom: 15px;"><i class="fas fa-chart-bar"></i> Data Collection</h2>
            <p style="color: #888; margin-bottom: 15px;">Record your observations and measurements.</p>
            
            <table class="data-table" id="dataTable">
                <thead>
                    <tr>
                        <th>Trial #</th>
                        <th id="header1">Independent Variable</th>
                        <th id="header2">Dependent Variable</th>
                        <th>Observations</th>
                    </tr>
                </thead>
                <tbody id="dataBody"></tbody>
            </table>
            
            <button class="btn" onclick="addDataRow()"><i class="fas fa-plus"></i> Add Row</button>
            <button class="btn" style="margin-top: 15px; margin-left: 10px;" onclick="nextStep()"><i class="fas fa-arrow-right"></i> Next: Conclusion</button>
        </div>
        
        <div id="step4" class="panel" style="display: none;">
            <h2 style="margin-bottom: 15px;"><i class="fas fa-clipboard-check"></i> Analysis & Conclusion</h2>
            
            <h3 style="margin: 20px 0 10px;">Data Analysis</h3>
            <p style="color: #888; margin-bottom: 10px;">What patterns do you see in your data?</p>
            <textarea id="analysis" placeholder="Describe trends, patterns, or relationships..."></textarea>
            
            <h3 style="margin: 20px 0 10px;">Conclusion</h3>
            <p style="color: #888; margin-bottom: 10px;">Was your hypothesis supported? What did you learn?</p>
            <textarea id="conclusion" placeholder="Based on the data..."></textarea>
            
            <h3 style="margin: 20px 0 10px;">Further Questions</h3>
            <p style="color: #888; margin-bottom: 10px;">What new questions arose from this experiment?</p>
            <textarea id="further" placeholder="What would you investigate next?"></textarea>
            
            <button class="btn" style="margin-top: 15px; background: var(--success);" onclick="submitExperiment()"><i class="fas fa-check-circle"></i> Submit Experiment</button>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
            <div style="background: var(--panel); padding: 15px; border-radius: 6px; text-align: center;">
                <div style="font-size: 24px; color: var(--accent); font-weight: 600;" id="statExperiments">0</div>
                <div style="font-size: 12px; color: #888;">Experiments</div>
            </div>
            <div style="background: var(--panel); padding: 15px; border-radius: 6px; text-align: center;">
                <div style="font-size: 24px; color: var(--accent); font-weight: 600;" id="statHypotheses">0</div>
                <div style="font-size: 12px; color: #888;">Hypotheses</div>
            </div>
            <div style="background: var(--panel); padding: 15px; border-radius: 6px; text-align: center;">
                <div style="font-size: 24px; color: var(--accent); font-weight: 600;" id="statData">0</div>
                <div style="font-size: 12px; color: #888;">Data Points</div>
            </div>
            <div style="background: var(--panel); padding: 15px; border-radius: 6px; text-align: center;">
                <div style="font-size: 24px; color: var(--accent); font-weight: 600;" id="statSteps">0</div>
                <div style="font-size: 12px; color: #888;">Steps Completed</div>
            </div>
        </div>
    </div>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        const API_BASE_URL = '/api';
        const authToken = localStorage.getItem('authToken');
        let eventId = null, sessionStart = Date.now(), currentStep = 0, dataRows = 0;
        
        let interactionData = {
            actions_count: 0, time_seconds: 0, total_parameter_space: 100,
            tool_usage: {}, experiments_completed: 0, hypotheses_formed: 0, 
            data_points_collected: 0, steps_completed: 0
        };
        
        async function init() {
            if (authToken) {
                try {
                    const studentId = JSON.parse(atob(authToken.split('.')[1])).userId;
                    const res = await fetch(`${API_BASE_URL}/student/event`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ studentId, toolId: 'inquiry-hypothesis-lab', toolType: 'LAB', interactionData })
                    });
                    if (res.ok) eventId = (await res.json()).data._id;
                } catch (err) {}
            }
            
            setInterval(() => {
                const e = Math.floor((Date.now() - sessionStart) / 1000);
                document.getElementById('timer').textContent = `${Math.floor(e/60).toString().padStart(2,'0')}:${(e%60).toString().padStart(2,'0')}`;
            }, 1000);
            setInterval(saveProgress, 30000);
        }
        
        function goToStep(step) {
            for (let i = 0; i <= 4; i++) {
                document.getElementById(`step${i}`).style.display = i === step ? 'block' : 'none';
            }
            
            document.querySelectorAll('.workflow-step').forEach((el, i) => {
                el.classList.remove('active');
                if (i === step) el.classList.add('active');
                if (i < step) el.classList.add('completed');
            });
            
            currentStep = step;
            interactionData.actions_count++;
        }
        
        function nextStep() {
            if (currentStep === 1 && document.getElementById('hypothesis').value) {
                interactionData.hypotheses_formed++;
                interactionData.steps_completed++;
                
                // Update table headers
                const ind = document.getElementById('independent').value || 'Independent Variable';
                const dep = document.getElementById('dependent').value || 'Dependent Variable';
                document.getElementById('header1').textContent = ind;
                document.getElementById('header2').textContent = dep;
            }
            
            if (currentStep < 4) {
                interactionData.steps_completed++;
                goToStep(currentStep + 1);
                updateStats();
            }
        }
        
        function addDataRow() {
            dataRows++;
            const tbody = document.getElementById('dataBody');
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${dataRows}</td>
                <td><input type="text" style="width: 100%;" /></td>
                <td><input type="text" style="width: 100%;" /></td>
                <td><input type="text" style="width: 100%;" /></td>
            `;
            interactionData.data_points_collected++;
            interactionData.actions_count++;
            updateStats();
        }
        
        function submitExperiment() {
            interactionData.experiments_completed++;
            interactionData.steps_completed++;
            interactionData.tool_usage['submit'] = (interactionData.tool_usage['submit'] || 0) + 1;
            updateStats();
            alert('Experiment submitted successfully! Great scientific work!');
        }
        
        function updateStats() {
            document.getElementById('statExperiments').textContent = interactionData.experiments_completed;
            document.getElementById('statHypotheses').textContent = interactionData.hypotheses_formed;
            document.getElementById('statData').textContent = interactionData.data_points_collected;
            document.getElementById('statSteps').textContent = interactionData.steps_completed;
        }
        
        async function saveProgress() {
            if (!eventId) return;
            interactionData.time_seconds = Math.floor((Date.now() - sessionStart) / 1000);
            try {
                await fetch(`${API_BASE_URL}/student/event/${eventId}`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interactionData })
                });
            } catch (err) {}
        }
        
        async function complete() {
            await saveProgress();
            alert('Session completed!');
            window.location.href = '/dashboard';
        }
        
        window.addEventListener('load', init);
        window.addEventListener('beforeunload', saveProgress);
    </script>
</body>
</html>