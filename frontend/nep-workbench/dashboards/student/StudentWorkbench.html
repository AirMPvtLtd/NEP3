


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
        style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
        font-src 'self' https://cdnjs.cloudflare.com;
        img-src 'self' data: https:;
        connect-src 'self' ;
    ">
    <title>NEP Workbench - Student Dashboard</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #1e1e1e;
            color: #ffffff;
            overflow: hidden;
            height: 100vh;
        }

        .dashboard {
            display: grid;
            grid-template-rows: 60px 1fr 35px;
            grid-template-columns: 250px 1fr;
            height: 100vh;
        }

        /* ============================================================ */
        /* HEADER */
        /* ============================================================ */
        .header {
            grid-column: 1 / -1;
            background: #333337;
            border-bottom: 1px solid #464647;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 20px;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #007acc, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: #2d2d30;
            border: 1px solid #464647;
            border-radius: 4px;
            padding: 5px 10px;
            flex: 0 1 300px;
        }

        .search-box input {
            background: transparent;
            border: none;
            color: white;
            width: 100%;
            outline: none;
        }

        .header-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: background 0.3s;
        }

        .notification-bell:hover {
            background: #3e3e42;
        }

        .notification-count {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 4px;
            transition: background 0.3s;
        }

        .user-menu:hover {
            background: #3e3e42;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #007acc, #00d4ff);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* ============================================================ */
        /* SIDEBAR */
        /* ============================================================ */
        .sidebar {
            background: #252526;
            border-right: 1px solid #464647;
            padding: 20px;
            overflow-y: auto;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            padding: 12px 15px;
            margin-bottom: 5px;
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
            color: #cccccc;
        }

        .nav-item:hover {
            background: #333337;
            color: #00d4ff;
        }

        .nav-item.active {
            background: linear-gradient(135deg, #007acc, #00d4ff);
            color: white;
        }

        .nav-item i {
            width: 20px;
        }

        /* ============================================================ */
        /* MAIN CONTENT */
        /* ============================================================ */
        .main-content {
            background: #1e1e1e;
            padding: 30px;
            overflow-y: auto;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #2d2d30;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #464647;
            transition: all 0.3s;
        }

        .stat-card:hover {
            border-color: #007acc;
            transform: translateY(-2px);
        }

        .stat-icon {
            font-size: 2rem;
            color: #007acc;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
            background: linear-gradient(135deg, #007acc, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            color: #888;
            font-size: 0.85rem;
        }

        .panel {
            background: #2d2d30;
            border: 1px solid #464647;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .panel h2 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #007acc, #00d4ff);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 122, 204, 0.4);
        }

        .btn-secondary {
            background: #464647;
        }

        .btn-secondary:hover {
            background: #3e3e42;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid #464647;
            color: #cccccc;
        }

        .btn-outline:hover {
            border-color: #007acc;
            color: white;
        }

        .competency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .competency-card {
            background: #333337;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #464647;
        }

        .competency-name {
            font-size: 0.9rem;
            margin-bottom: 10px;
            color: #cccccc;
            text-transform: capitalize;
        }

        .competency-bar {
            background: #1e1e1e;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .competency-fill {
            height: 100%;
            background: linear-gradient(90deg, #007acc, #00d4ff);
            transition: width 0.5s ease;
        }

        .competency-value {
            font-size: 0.85rem;
            color: #888;
            margin-top: 5px;
            text-align: right;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #333337;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #464647;
        }

        th {
            font-weight: 600;
            color: #00d4ff;
        }

        tr:hover {
            background: #333337;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }

        .badge-warning {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .badge-info {
            background: rgba(23, 162, 184, 0.2);
            color: #17a2b8;
        }

        .badge-danger {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }

        .badge-secondary {
            background: rgba(108, 117, 125, 0.2);
            color: #6c757d;
        }

        /* ============================================================ */
        /* CHART CONTAINERS */
        /* ============================================================ */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-top: 20px;
        }

        .radar-chart-container {
            position: relative;
            height: 350px;
            width: 100%;
            margin-top: 20px;
        }

        .no-data-message {
            text-align: center;
            padding: 40px;
            color: #888;
            font-style: italic;
        }

        .no-data-message i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* ============================================================ */
        /* SIMULATIONS PAGE STYLES */
        /* ============================================================ */
        .subject-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            background: #333337;
            border: 1px solid #464647;
            border-radius: 20px;
            color: #cccccc;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            border-color: #007acc;
            color: white;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #007acc, #00d4ff);
            border-color: transparent;
            color: white;
        }

        .simulations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .simulation-card {
            background: #2d2d30;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #464647;
            transition: all 0.3s;
        }

        .simulation-card:hover {
            border-color: #007acc;
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0, 122, 204, 0.2);
        }

        .simulation-image {
            height: 150px;
            background: linear-gradient(135deg, var(--subject-color), #00d4ff);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
        }

        .simulation-content {
            padding: 20px;
        }

        .simulation-title {
            font-size: 1.1rem;
            margin-bottom: 10px;
            font-weight: 600;
            color: white;
        }

        .simulation-desc {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .simulation-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .simulation-tag {
            background: #333337;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .simulation-difficulty {
            font-size: 0.8rem;
            color: #aaa;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .difficulty-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .difficulty-easy { background: #28a745; }
        .difficulty-medium { background: #ffc107; }
        .difficulty-hard { background: #dc3545; }

        .simulation-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #464647;
            font-size: 0.8rem;
            color: #888;
        }

        .simulation-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .coming-soon-card {
            opacity: 0.7;
        }

        .coming-soon-card .simulation-image {
            background: linear-gradient(135deg, #6c757d, #adb5bd);
        }

        /* ============================================================ */
        /* SIMULATION MODAL */
        /* ============================================================ */
        .simulation-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .modal-content {
            background: #252526;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid #007acc;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #464647;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: white;
            font-size: 1.5rem;
        }

        .close-modal {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: #333337;
            color: white;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .modal-info-item {
            background: #2d2d30;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #464647;
        }

        .modal-info-label {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 5px;
        }

        .modal-info-value {
            font-size: 1.1rem;
            color: white;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid #464647;
        }

        /* ============================================================ */
        /* PROFILE PAGE SPECIFIC STYLES */
        /* ============================================================ */

        .profile-activity-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: #333337;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #007acc;
            transition: all 0.3s;
        }

        .profile-activity-item:hover {
            background: #3e3e42;
            transform: translateX(5px);
        }

        .profile-activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #007acc, #00d4ff);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .profile-activity-content {
            flex: 1;
        }

        .profile-activity-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: white;
        }

        .profile-activity-desc {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 5px;
        }

        .profile-activity-time {
            font-size: 0.75rem;
            color: #666;
        }

        .competency-badge {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: #333337;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #464647;
        }

        .competency-badge-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .competency-badge-icon.strong {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }

        .competency-badge-icon.weak {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .competency-badge-content {
            flex: 1;
        }

        .competency-badge-name {
            font-weight: 600;
            margin-bottom: 3px;
            text-transform: capitalize;
        }

        .competency-badge-score {
            font-size: 0.85rem;
            color: #888;
        }

        /* Profile Form Enhancements */
        #profileForm input:focus {
            outline: none;
            border-color: #007acc;
            box-shadow: 0 0 0 3px rgba(0, 122, 204, 0.1);
        }

        /* ============================================================ */
        /* STATUS BAR */
        /* ============================================================ */
        .status-bar {
            grid-column: 1 / -1;
            background: #007acc;
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-size: 0.8rem;
            gap: 20px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ============================================================ */
        /* LOADING */
        /* ============================================================ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #007acc;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ============================================================ */
        /* RATE LIMIT NOTIFICATION */
        /* ============================================================ */
        .rate-limit-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff4444;
            color: white;
            padding: 15px 20px;
            border-radius: 6px;
            z-index: 10000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            align-items: center;
            gap: 10px;
        }

        /* ============================================================ */
        /* RESPONSIVE */
        /* ============================================================ */
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 60px 1fr;
            }
            
            .sidebar {
                width: 60px;
                padding: 10px 5px;
            }
            
            .nav-item span {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
            
            .simulations-grid {
                grid-template-columns: 1fr;
            }
            
            .subject-filter {
                justify-content: center;
            }
            
            .modal-actions {
                flex-direction: column;
            }
        }

        /* ============================================================ */
        /* RESPONSIVE DESIGN                                             */
        /* ============================================================ */

        /* Hamburger button - hidden on desktop */
        .hamburger-btn {
            display: none;
            background: none;
            border: none;
            color: #ccc;
            font-size: 1.4rem;
            cursor: pointer;
            padding: 8px 10px;
            border-radius: 4px;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        .hamburger-btn:hover { background: #3e3e42; color: #00d4ff; }

        /* Dark overlay behind sidebar */
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.55);
            z-index: 99;
        }
        .sidebar-overlay.active { display: block; }

        /* Sidebar open state (toggled by JS) */
        .sidebar.open { transform: translateX(0) !important; }

        /* Tablet / small desktop */
        @media (max-width: 992px) {
            body { overflow: auto; }
            .dashboard {
                grid-template-columns: 1fr;
                grid-template-rows: 60px 1fr 35px;
            }
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                width: 260px;
                z-index: 100;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                padding-top: 70px;
            }
            .hamburger-btn { display: flex; align-items: center; justify-content: center; }
            .search-box { display: none; }
        }

        /* Large phone */
        @media (max-width: 768px) {
            .main-content { padding: 15px; overflow-y: auto; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
            .panel { padding: 15px; }
        }

        /* Small phone */
        @media (max-width: 576px) {
            .stats-grid { grid-template-columns: 1fr; }
            .header { padding: 0 10px; gap: 8px; }
            .logo { font-size: 1.15rem; }
            .user-menu { padding: 6px 8px; }
            .panel { padding: 12px; }
            .panel-title { font-size: 1rem; }
        }

        @media (max-width: 360px) {
            .stat-value { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <div class="rate-limit-notification" id="rateLimitNotification">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="rateLimitMessage">Too many requests. Please wait...</span>
    </div>

    <div class="dashboard">
        <!-- HEADER -->
        <header class="header">
            <button class="hamburger-btn" id="sidebarToggle" aria-label="Toggle menu">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo">
                <i class="fas fa-graduation-cap"></i>
                NEP Workbench
            </div>

            <div class="search-box">
                <i class="fas fa-search" style="color: #888; margin-right: 8px;"></i>
                <input type="text" placeholder="Search simulations..." id="searchInput">
            </div>
            
            <div class="header-right">
                <div class="notification-bell" id="notificationBell" style="position:relative;">
                    <i class="fas fa-bell"></i>
                    <span class="notification-count" id="notificationCount">0</span>
                    <!-- Notification Panel -->
                    <div id="studentNotifPanel" style="display:none;position:absolute;top:44px;right:0;width:340px;background:#2d2d30;border:1px solid #464647;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.5);z-index:1000;overflow:hidden;flex-direction:column;">
                        <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:#252526;border-bottom:1px solid #464647;">
                            <h3 style="margin:0;color:#00d4ff;font-size:0.9rem;"><i class="fas fa-bell" style="margin-right:8px;"></i>Recent Activity</h3>
                            <button onclick="closeStudentNotif()" style="background:none;border:none;color:#888;cursor:pointer;"><i class="fas fa-times"></i></button>
                        </div>
                        <div id="studentNotifList" style="overflow-y:auto;max-height:360px;padding:6px 0;">
                            <div style="padding:32px;text-align:center;color:#666;font-size:0.85rem;">Loading...</div>
                        </div>
                    </div>
                </div>
                
                <div class="user-menu" id="userMenu">
                    <div class="user-avatar" id="userAvatar">S</div>
                    <div>
                        <div id="userName" style="font-weight: 600;">Student</div>
                        <div style="font-size: 0.75rem; color: #888;" id="userClass">Class --</div>
                    </div>
                    <i class="fas fa-chevron-down" style="font-size: 0.8rem;"></i>
                </div>
            </div>
        </header>

        <!-- Sidebar overlay (mobile) -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <ul class="nav-menu">
                <li class="nav-item active" data-page="overview">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </li>
                <li class="nav-item" data-page="profile">
                    <i class="fas fa-user-circle"></i>
                    <span>Profile</span>
                </li>
                <li class="nav-item" data-page="simulations">
                    <i class="fas fa-flask"></i>
                    <span>Simulations</span>
                </li>
                <li class="nav-item" data-page="challenges">
                    <i class="fas fa-brain"></i>
                    <span>Challenges</span>
                </li>
                <li class="nav-item" data-page="performance">
                    <i class="fas fa-chart-line"></i>
                    <span>Performance</span>
                </li>
                <li class="nav-item" data-page="competencies">
                    <i class="fas fa-star"></i>
                    <span>Competencies</span>
                </li>
                <li class="nav-item" data-page="reports">
                    <i class="fas fa-file-alt"></i>
                    <span>Reports</span>
                </li>
                <li class="nav-item" onclick="openReasoningPad(event)">
                    <i class="fas fa-calculator"></i>
                    <span>Reasoning Pad</span>
                </li>
                <li class="nav-item" data-page="help">
                    <i class="fas fa-question-circle"></i>
                    <span>Help</span>
                </li>
                <li class="nav-item" data-page="logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </li>
            </ul>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <!-- OVERVIEW PAGE -->
            <div class="page active" id="overview">
                <h1>Welcome Back, <span id="welcomeName">Student</span>!</h1>
                <p style="color: #888; margin-bottom: 30px;">Here's your learning progress today</p>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-trophy"></i></div>
                        <div class="stat-value" id="completedCount">0</div>
                        <div class="stat-label">Challenges Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-fire"></i></div>
                        <div class="stat-value" id="streakCount">0</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                        <div class="stat-value" id="piValue">--</div>
                        <div class="stat-label">Performance Index</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-star"></i></div>
                        <div class="stat-value" id="avgScore">--</div>
                        <div class="stat-label">Avg Score</div>
                    </div>
                </div>

                <div class="panel">
                    <h2><i class="fas fa-brain"></i> Recent Challenges</h2>
                    <table id="recentChallengesTable">
                        <thead>
                            <tr>
                                <th>Challenge</th>
                                <th>Type</th>
                                <th>Score</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="recentChallengesBody">
                            <tr><td colspan="5" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="panel">
                    <h2><i class="fas fa-flask"></i> Quick Actions</h2>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn" onclick="showPage('simulations')">
                            <i class="fas fa-play"></i> Start Simulation
                        </button>
                        <button class="btn" onclick="window.open('/challenge', '_blank')">
                            <i class="fas fa-plus"></i> Generate New Challenge
                        </button>
                        <button class="btn btn-secondary" onclick="showPage('performance')">
                            <i class="fas fa-chart-bar"></i> View Progress
                        </button>
                    </div>
                </div>
            </div>

            <!-- SIMULATIONS PAGE -->
            <div class="page" id="simulations">
                <h1><i class="fas fa-flask"></i> Interactive Simulations</h1>
                <p style="color: #888; margin-bottom: 10px;">Explore 36+ simulations across Physics, Math, and more subjects</p>
                
                <!-- Subject Filter -->
                <div class="subject-filter" id="subjectFilter">
                    <button class="filter-btn active" data-subject="all">All Simulations</button>
                    <button class="filter-btn" data-subject="physics">Physics (19)</button>
                    <button class="filter-btn" data-subject="math">Mathematics (17)</button>
                    <button class="filter-btn" data-subject="chemistry">Chemistry (Coming Soon)</button>
                    <button class="filter-btn" data-subject="biology">Biology (Coming Soon)</button>
                    <button class="filter-btn" data-subject="computer">Computer Science (Coming Soon)</button>
                </div>
                
                <div id="simulationsGrid" class="simulations-grid">
                    <!-- Simulations will be loaded here -->
                </div>
            </div>

            <!-- CHALLENGES PAGE -->
            <div class="page" id="challenges">
                <h1><i class="fas fa-brain"></i> AI Challenges</h1>
                <p style="color: #888; margin-bottom: 30px;">Test your knowledge with AI-generated challenges</p>
                
                <div class="panel">
                    <h2>Challenge Limits</h2>
                    <p>Daily Remaining: <strong id="dailyLimit">--</strong></p>
                    <button class="btn" onclick="window.open('/challenge', '_blank')">
                        <i class="fas fa-brain"></i> Generate Challenge
                    </button>
                </div>

                <div class="panel">
                    <h2>Your Challenges</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Type</th>
                                <th>Difficulty</th>
                                <th>Score</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="allChallengesBody">
                            <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PERFORMANCE PAGE -->
            <div class="page" id="performance">
                <h1><i class="fas fa-chart-line"></i> Performance Analytics</h1>
                <p style="color: #888; margin-bottom: 30px;">Track your learning progress</p>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-graduation-cap"></i></div>
                        <div class="stat-value" id="perfPI">--</div>
                        <div class="stat-label">Performance Index</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-medal"></i></div>
                        <div class="stat-value" id="perfGrade">--</div>
                        <div class="stat-label">Current Grade</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-value" id="perfTotal">0</div>
                        <div class="stat-label">Total Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-percentage"></i></div>
                        <div class="stat-value" id="perfAvg">0%</div>
                        <div class="stat-label">Average Score</div>
                    </div>
                </div>

                <div class="panel">
                    <h2>SPI Timeline</h2>
                    <div class="chart-container">
                        <canvas id="spiTimelineChart"></canvas>
                        <div id="noSpiData" class="no-data-message" style="display: none;">
                            <i class="fas fa-chart-line"></i>
                            <p>No SPI data available yet. Complete challenges to see your progress!</p>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h2>Score Distribution</h2>
                    <div class="chart-container">
                        <canvas id="scoreDistributionChart"></canvas>
                        <div id="noScoreData" class="no-data-message" style="display: none;">
                            <i class="fas fa-chart-bar"></i>
                            <p>No score data available yet. Complete challenges to see your performance!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COMPETENCIES PAGE -->
            <div class="page" id="competencies">
                <h1><i class="fas fa-star"></i> NEP 2020 Competencies</h1>
                <p style="color: #888; margin-bottom: 30px;">12 core competencies tracked</p>
                
                <div class="panel">
                    <h2>Competency Radar</h2>
                    <div class="radar-chart-container">
                        <canvas id="competencyRadarChart"></canvas>
                        <div id="noCompetencyData" class="no-data-message" style="display: none;">
                            <i class="fas fa-star"></i>
                            <p>No competency data available yet. Complete challenges to see your competencies!</p>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h2>Detailed Scores</h2>
                    <div class="competency-grid" id="competencyGrid"></div>
                </div>
            </div>

            <!-- REPORTS PAGE -->
            <div class="page" id="reports">
                <h1><i class="fas fa-file-alt"></i> NEP Reports</h1>
                <p style="color: #888; margin-bottom: 30px;">Comprehensive performance reports aligned with NEP 2020</p>

                <div class="panel" style="margin-bottom: 20px;">
                    <h2>Generate New Report</h2>
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-top: 15px;">
                        <select id="reportTypeSelect" style="background: #333337; color: #fff; border: 1px solid #464647; padding: 10px 15px; border-radius: 6px; font-size: 0.9rem; cursor: pointer;">
                            <option value="weekly">Weekly</option>
                            <option value="monthly" selected>Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="annual">Annual</option>
                        </select>
                        <button class="btn" id="generateReportBtn" onclick="triggerGenerateReport()">
                            <i class="fas fa-plus"></i> Generate Report
                        </button>
                        <span id="generateReportMsg" style="font-size: 0.9rem;"></span>
                    </div>
                </div>

                <div class="panel">
                    <h2>Available Reports</h2>
                    <div id="reportsList"></div>
                </div>
            </div>

            <!-- HELP PAGE -->
            <div class="page" id="help">
                <h1><i class="fas fa-question-circle"></i> Help & Support</h1>
                <p style="color: #888; margin-bottom: 30px;">Get assistance with your learning</p>
                
                <div class="panel">
                    <h2>Create Help Ticket</h2>
                    <form id="helpTicketForm" onsubmit="createHelpTicket(event)">
                        <div style="margin-bottom: 15px;">
                            <input type="text" id="ticketSubject" placeholder="Subject" 
                                   style="width: 100%; padding: 10px; background: #333337; border: 1px solid #464647; color: white; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <textarea id="ticketDescription" placeholder="Describe your issue..." rows="5"
                                      style="width: 100%; padding: 10px; background: #333337; border: 1px solid #464647; color: white; border-radius: 4px;"></textarea>
                        </div>
                        <button type="submit" class="btn">
                            <i class="fas fa-paper-plane"></i> Submit Ticket
                        </button>
                    </form>
                </div>

                <div class="panel">
                    <h2>My Tickets</h2>
                    <div id="ticketsList"></div>
                </div>
            </div>

            <!-- PROFILE PAGE -->
            <div class="page" id="profile">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <div>
                        <h1><i class="fas fa-user-circle"></i> My Profile</h1>
                        <p style="color: #888; margin-top: 10px;">Manage your profile and track your learning journey</p>
                    </div>
                    <button class="btn btn-secondary" onclick="loadStudentOverview()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>

                <!-- Profile Header Card -->
                <div class="panel" style="background: linear-gradient(135deg, #007acc, #00d4ff); border: none; margin-bottom: 30px;">
                    <div style="display: flex; gap: 30px; align-items: center;">
                        <div style="width: 120px; height: 120px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-size: 3rem; font-weight: bold; color: #007acc; box-shadow: 0 4px 15px rgba(0,0,0,0.2);" id="profileAvatarLarge">
                            S
                        </div>
                        <div style="flex: 1; color: white;">
                            <h2 style="font-size: 2rem; margin-bottom: 10px;" id="profileDisplayName">Student Name</h2>
                            <div style="display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-id-card"></i>
                                    <span id="profileStudentId">STU-XXXXX</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-graduation-cap"></i>
                                    <span id="profileClassSection">Class -- Section --</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-school"></i>
                                    <span id="profileSchoolName">School Name</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 15px;">
                                <div style="background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 8px; backdrop-filter: blur(10px);">
                                    <div style="font-size: 1.5rem; font-weight: bold;" id="profileHeaderPI">--</div>
                                    <div style="font-size: 0.85rem; opacity: 0.9;">Performance Index</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 8px; backdrop-filter: blur(10px);">
                                    <div style="font-size: 1.5rem; font-weight: bold;" id="profileHeaderStreak">0</div>
                                    <div style="font-size: 0.85rem; opacity: 0.9;">Day Streak</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 8px; backdrop-filter: blur(10px);">
                                    <div style="font-size: 1.5rem; font-weight: bold;" id="profileHeaderTotal">0</div>
                                    <div style="font-size: 0.85rem; opacity: 0.9;">Challenges</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Two Column Layout -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 25px;">
                    
                    <!-- Left Column: Personal Information -->
                    <div class="panel">
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-user-edit"></i> Personal Information</h2>
                        <form id="profileForm" onsubmit="updateProfile(event)">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; color: #00d4ff; font-weight: 600;">
                                        <i class="fas fa-user"></i> Full Name <span style="color: #ff4444;">*</span>
                                    </label>
                                    <input 
                                        type="text" 
                                        id="profileName" 
                                        placeholder="Enter your name"
                                        style="width: 100%; padding: 12px; background: #333337; border: 1px solid #464647; color: white; border-radius: 4px;"
                                        required>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 8px; color: #00d4ff; font-weight: 600;">
                                        <i class="fas fa-envelope"></i> Email
                                    </label>
                                    <input 
                                        type="email" 
                                        id="profileEmail" 
                                        placeholder="Email address"
                                        style="width: 100%; padding: 12px; background: #1e1e1e; border: 1px solid #464647; color: #888; border-radius: 4px;"
                                        disabled>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 8px; color: #00d4ff; font-weight: 600;">
                                        <i class="fas fa-phone"></i> Phone Number
                                    </label>
                                    <input 
                                        type="tel" 
                                        id="profilePhone" 
                                        placeholder="Phone number"
                                        style="width: 100%; padding: 12px; background: #333337; border: 1px solid #464647; color: white; border-radius: 4px;">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 8px; color: #00d4ff; font-weight: 600;">
                                        <i class="fas fa-calendar"></i> Date of Birth
                                    </label>
                                    <input 
                                        type="date" 
                                        id="profileDOB" 
                                        style="width: 100%; padding: 12px; background: #333337; border: 1px solid #464647; color: white; border-radius: 4px;">
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; color: #00d4ff; font-weight: 600;">
                                    <i class="fas fa-image"></i> Profile Picture URL
                                </label>
                                <input 
                                    type="url" 
                                    id="profilePicture" 
                                    placeholder="Enter profile picture URL (optional)"
                                    style="width: 100%; padding: 12px; background: #333337; border: 1px solid #464647; color: white; border-radius: 4px;">
                                <small style="color: #888; font-size: 0.85rem; margin-top: 5px; display: block;">
                                    <i class="fas fa-info-circle"></i> Upload an image to Imgur or similar and paste the URL here
                                </small>
                            </div>
                            
                            <div style="display: flex; gap: 15px;">
                                <button type="submit" class="btn">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="loadStudentOverview()">
                                    <i class="fas fa-undo"></i> Reset
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Right Column: Quick Stats -->
                    <div>
                        <div class="panel" style="margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px;"><i class="fas fa-info-circle"></i> Account Details</h3>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="display: flex; justify-content: space-between; padding: 10px; background: #333337; border-radius: 4px;">
                                    <span style="color: #888;"><i class="fas fa-school"></i> School</span>
                                    <span id="profileSchoolDetail">Loading...</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 10px; background: #333337; border-radius: 4px;">
                                    <span style="color: #888;"><i class="fas fa-chalkboard-teacher"></i> Teacher</span>
                                    <span id="profileTeacherDetail">Loading...</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 10px; background: #333337; border-radius: 4px;">
                                    <span style="color: #888;"><i class="fas fa-graduation-cap"></i> Class</span>
                                    <span id="profileClassDetail">-- / --</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 10px; background: #333337; border-radius: 4px;">
                                    <span style="color: #888;"><i class="fas fa-calendar-check"></i> Member Since</span>
                                    <span id="profileJoinedDate">--</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 10px; background: #333337; border-radius: 4px;">
                                    <span style="color: #888;"><i class="fas fa-sign-in-alt"></i> Last Login</span>
                                    <span id="profileLastLogin">--</span>
                                </div>
                            </div>
                        </div>

                        <div class="panel">
                            <h3 style="margin-bottom: 15px;"><i class="fas fa-shield-alt"></i> Account Status</h3>
                            <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: rgba(40, 167, 69, 0.1); border: 1px solid #28a745; border-radius: 6px;">
                                <i class="fas fa-check-circle" style="color: #28a745; font-size: 1.5rem;"></i>
                                <div>
                                    <div style="font-weight: 600; color: #28a745;">Active</div>
                                    <div style="font-size: 0.85rem; color: #888;">Your account is in good standing</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Charts Section -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px;">
                    
                    <!-- Competency Radar Chart -->
                    <div class="panel">
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-star"></i> Competency Overview</h2>
                        <div class="radar-chart-container">
                            <canvas id="profileCompetencyRadarChart"></canvas>
                            <div id="noProfileCompetencyData" class="no-data-message" style="display: none;">
                                <i class="fas fa-star"></i>
                                <p>No competency data available yet. Complete challenges to see your competencies!</p>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Trend Chart -->
                    <div class="panel">
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-chart-line"></i> Performance Trend</h2>
                        <div class="chart-container">
                            <canvas id="profilePerformanceChart"></canvas>
                            <div id="noProfilePerformanceData" class="no-data-message" style="display: none;">
                                <i class="fas fa-chart-line"></i>
                                <p>No performance data available yet. Complete challenges to see your progress!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistics Grid -->
                <div class="panel">
                    <h2 style="margin-bottom: 20px;"><i class="fas fa-chart-bar"></i> Learning Statistics</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="background: #333337; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #464647;">
                            <i class="fas fa-trophy" style="font-size: 2.5rem; color: #ffd700; margin-bottom: 10px;"></i>
                            <div style="font-size: 1.8rem; font-weight: bold; color: #00d4ff; margin-bottom: 5px;" id="profileTotalChallenges">0</div>
                            <div style="color: #888; font-size: 0.9rem;">Total Challenges</div>
                        </div>
                        
                        <div style="background: #333337; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #464647;">
                            <i class="fas fa-check-circle" style="font-size: 2.5rem; color: #28a745; margin-bottom: 10px;"></i>
                            <div style="font-size: 1.8rem; font-weight: bold; color: #00d4ff; margin-bottom: 5px;" id="profileCompleted">0</div>
                            <div style="color: #888; font-size: 0.9rem;">Completed</div>
                        </div>
                        
                        <div style="background: #333337; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #464647;">
                            <i class="fas fa-percentage" style="font-size: 2.5rem; color: #007acc; margin-bottom: 10px;"></i>
                            <div style="font-size: 1.8rem; font-weight: bold; color: #00d4ff; margin-bottom: 5px;" id="profileAvgScore">0%</div>
                            <div style="color: #888; font-size: 0.9rem;">Average Score</div>
                        </div>
                        
                        <div style="background: #333337; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #464647;">
                            <i class="fas fa-fire" style="font-size: 2.5rem; color: #ff4444; margin-bottom: 10px;"></i>
                            <div style="font-size: 1.8rem; font-weight: bold; color: #00d4ff; margin-bottom: 5px;" id="profileStreakDays">0</div>
                            <div style="color: #888; font-size: 0.9rem;">Day Streak</div>
                        </div>
                        
                        <div style="background: #333337; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #464647;">
                            <i class="fas fa-chart-line" style="font-size: 2.5rem; color: #20c997; margin-bottom: 10px;"></i>
                            <div style="font-size: 1.8rem; font-weight: bold; color: #00d4ff; margin-bottom: 5px;" id="profilePI">--</div>
                            <div style="color: #888; font-size: 0.9rem;">Performance Index</div>
                        </div>
                    </div>
                </div>

                <!-- Strong & Weak Competencies -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                    
                    <!-- Strong Competencies -->
                    <div class="panel">
                        <h2 style="margin-bottom: 20px; color: #28a745;">
                            <i class="fas fa-thumbs-up"></i> Strong Competencies
                        </h2>
                        <div id="profileStrongCompetencies">
                            <!-- Strong competencies list will be generated here -->
                        </div>
                    </div>

                    <!-- Weak Competencies -->
                    <div class="panel">
                        <h2 style="margin-bottom: 20px; color: #ffc107;">
                            <i class="fas fa-exclamation-triangle"></i> Areas for Improvement
                        </h2>
                        <div id="profileWeakCompetencies">
                            <!-- Weak competencies list will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- STATUS BAR -->
        <footer class="status-bar">
            <div class="status-item">
                <i class="fas fa-clock"></i>
                <span id="sessionTime">Session: 0 min</span>
            </div>
            <div style="width: 1px; height: 16px; background: rgba(255,255,255,0.3);"></div>
            <div class="status-item">
                <i class="fas fa-calendar-day"></i>
                <span id="currentDate">--</span>
            </div>
            <div style="flex: 1;"></div>
            <div class="status-item">
                <i class="fas fa-signal"></i>
                <span>Connected</span>
            </div>
        </footer>
    </div>

    <!-- SIMULATION MODAL -->
    <div class="simulation-modal" id="simulationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalSimulationTitle">Simulation Details</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-info-grid">
                    <div class="modal-info-item">
                        <div class="modal-info-label">Subject</div>
                        <div class="modal-info-value" id="modalSubject">--</div>
                    </div>
                    <div class="modal-info-item">
                        <div class="modal-info-label">Difficulty</div>
                        <div class="modal-info-value" id="modalDifficulty">--</div>
                    </div>
                    <div class="modal-info-item">
                        <div class="modal-info-label">Duration</div>
                        <div class="modal-info-value" id="modalDuration">--</div>
                    </div>
                    <div class="modal-info-item">
                        <div class="modal-info-label">Concepts</div>
                        <div class="modal-info-value" id="modalConcepts">--</div>
                    </div>
                </div>
                <h3 style="margin-bottom: 10px;">Description</h3>
                <p id="modalDescription" style="color: #ccc; line-height: 1.6;"></p>
                <div class="modal-actions">
                    <button class="btn" onclick="launchSimulation()" id="launchBtn">
                        <i class="fas fa-rocket"></i> Launch Simulation
                    </button>
                    <button class="btn btn-secondary" onclick="generateChallengeForSimulation()" id="challengeBtn">
                        <i class="fas fa-brain"></i> Generate Challenge
                    </button>
                    <button class="btn btn-outline" onclick="closeModal()">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- LOADING OVERLAY -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>
    
    <script>
        // ================================================================
        // CONFIGURATION & GLOBAL STORE
        // ================================================================
        const API_BASE_URL = '/api';
        let authToken = localStorage.getItem('authToken');
        let STUDENT_OVERVIEW = null; // Global store for student data
        let isInitializing = false;
        let lastAPICallTime = 0;
        const API_CALL_DELAY = 1000; // Minimum 1 second between calls
        let pageCache = {};
        let currentSelectedSimulation = null;
        let chartInstances = {}; // Store Chart.js instances

        // ================================================================
        // RATE LIMIT HANDLING
        // ================================================================
        function showRateLimitNotification(message) {
            const notification = document.getElementById('rateLimitNotification');
            const messageEl = document.getElementById('rateLimitMessage');
            messageEl.textContent = message;
            notification.style.display = 'flex';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // ================================================================
        // THROTTLED API CALL
        // ================================================================
        async function throttledApiCall(endpoint, options = {}) {
            const now = Date.now();
            const timeSinceLastCall = now - lastAPICallTime;
            
            // If calls are too frequent, wait
            if (timeSinceLastCall < API_CALL_DELAY) {
                await new Promise(resolve => setTimeout(resolve, API_CALL_DELAY - timeSinceLastCall));
            }
            
            lastAPICallTime = Date.now();
            return await apiCall(endpoint, options);
        }

        // ================================================================
        // API HELPER (with improved error handling)
        // ================================================================
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`,
                        ...options.headers
                    }
                });
                
                // Handle rate limiting
                if (response.status === 429) {
                    const retryAfter = response.headers.get('Retry-After') || 5;
                    showRateLimitNotification(`Too many requests. Please try again in ${retryAfter} seconds.`);
                    
                    // Wait before retrying
                    await new Promise(resolve => setTimeout(resolve, retryAfter * 1000));
                    return apiCall(endpoint, options); // Retry once
                }
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || `API request failed with status ${response.status}`);
                }
                
                return data;
            } catch (error) {
                console.error('API Error:', error);
                
                // Handle specific errors
                if (error.message.includes('429')) {
                    showRateLimitNotification('Too many requests from this IP. Please try again later.');
                } else if (error.message.includes('401') || error.message.includes('token')) {
                    // Clear invalid token
                    localStorage.removeItem('authToken');
                    window.location.href = '/login';
                } else {
                    // Show generic error
                    showRateLimitNotification('Network error. Please check your connection.');
                }
                
                throw error;
            }
        }

        // ================================================================
        // MAIN DATA LOADING FUNCTION (SINGLE SOURCE OF TRUTH)
        // ================================================================
        async function loadStudentOverview() {
            console.log(' Loading student overview...');
            showLoading();
            
            try {
                const response = await throttledApiCall('/student/overview');
                
                if (response.success && response.data) {
                    STUDENT_OVERVIEW = response.data;
                    console.log(' Overview loaded:', STUDENT_OVERVIEW);
                    
                    // Update all pages with the loaded data
                    updateOverviewPage();
                    updateProfilePage();
                    updatePerformancePage();
                    updateCompetenciesPage();
                    
                    // Load recent challenges for overview page
                    await loadRecentChallenges();

                    // Load daily challenge limit for overview
                    loadChallengeLimits();

                    // Update session cache
                    sessionStorage.setItem('studentOverview', JSON.stringify(STUDENT_OVERVIEW));
                    
                    return STUDENT_OVERVIEW;
                } else {
                    throw new Error('Invalid response from server');
                }
            } catch (error) {
                console.error(' Error loading overview:', error);
                
                // Try to load from session storage as fallback
                const cached = sessionStorage.getItem('studentOverview');
                if (cached) {
                    STUDENT_OVERVIEW = JSON.parse(cached);
                    console.log(' Loaded from cache:', STUDENT_OVERVIEW);
                    updateOverviewPage();
                    updateProfilePage();
                    updatePerformancePage();
                    updateCompetenciesPage();
                    
                    // Try to load recent challenges even from cache
                    try {
                        await loadRecentChallenges();
                    } catch (recentError) {
                        console.error('Could not load recent challenges:', recentError);
                    }
                } else {
                    throw error;
                }
            } finally {
                hideLoading();
            }
        }

        // ================================================================
        // OVERVIEW PAGE FUNCTIONS
        // ================================================================
        function updateOverviewPage() {
            if (!STUDENT_OVERVIEW) return;
            
            const student = STUDENT_OVERVIEW.student;
            const stats = STUDENT_OVERVIEW.stats;
            const spi = STUDENT_OVERVIEW.spi;
            
            // Update user info
            document.getElementById('userName').textContent = student?.name || 'Student';
            document.getElementById('welcomeName').textContent = student?.name || 'Student';
            document.getElementById('userClass').textContent = `Class ${student?.class || '--'}${student?.section || ''}`;
            document.getElementById('userAvatar').textContent = (student?.name?.charAt(0) || 'S').toUpperCase();
            
            // Update stats
            document.getElementById('completedCount').textContent = stats?.completedChallenges || 0;
            document.getElementById('streakCount').textContent = stats?.dailyStreak || 0;
            document.getElementById('piValue').textContent = spi?.value ? spi.value.toFixed(1) : '--';
            document.getElementById('avgScore').textContent = stats?.averageScore ? stats.averageScore.toFixed(1) + '%' : '--';
            
            // Clear recent challenges table (we don't have this data in overview)
            const tbody = document.getElementById('recentChallengesBody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Complete challenges to see your history</td></tr>';
        }

        // ================================================================
        // PROFILE PAGE FUNCTIONS
        // ================================================================
        function updateProfilePage() {
            if (!STUDENT_OVERVIEW) return;
            
            const student = STUDENT_OVERVIEW.student;
            const stats = STUDENT_OVERVIEW.stats;
            const spi = STUDENT_OVERVIEW.spi;
            const cpi = STUDENT_OVERVIEW.cpi;
            
            // Update profile header
            document.getElementById('profileDisplayName').textContent = student?.name || 'Student';
            document.getElementById('profileStudentId').textContent = student?.studentId || 'STU-XXXXX';
            document.getElementById('profileClassSection').textContent = `Class ${student?.class || '--'} Section ${student?.section || '--'}`;
            document.getElementById('profileSchoolName').textContent = student?.schoolId || 'School';
            
            // Update header stats
            document.getElementById('profileHeaderPI').textContent = spi?.value ? spi.value.toFixed(1) : '--';
            document.getElementById('profileHeaderStreak').textContent = stats?.dailyStreak || 0;
            document.getElementById('profileHeaderTotal').textContent = stats?.totalChallenges || 0;
            
            // Update profile form
            document.getElementById('profileName').value = student?.name || '';
            document.getElementById('profileEmail').value = student?.email || '';
            document.getElementById('profilePhone').value = student?.phone || '';
            if (student?.dateOfBirth) {
                const d = new Date(student.dateOfBirth);
                if (!isNaN(d)) document.getElementById('profileDOB').value = d.toISOString().split('T')[0];
            }
            if (student?.profilePicture) document.getElementById('profilePicture').value = student.profilePicture || '';
            
            // Update account details
            document.getElementById('profileSchoolDetail').textContent = student?.schoolId || 'N/A';
            document.getElementById('profileTeacherDetail').textContent = student?.teacherId || 'N/A';
            document.getElementById('profileClassDetail').textContent = `${student?.class || '--'} / ${student?.section || '--'}`;
            
            // Update statistics
            document.getElementById('profileTotalChallenges').textContent = stats?.totalChallenges || 0;
            document.getElementById('profileCompleted').textContent = stats?.completedChallenges || 0;
            document.getElementById('profileAvgScore').textContent = stats?.averageScore ? stats.averageScore.toFixed(1) + '%' : '0%';
            document.getElementById('profileStreakDays').textContent = stats?.dailyStreak || 0;
            document.getElementById('profilePI').textContent = spi?.value ? spi.value.toFixed(1) : '--';
            
            // Create competency radar chart for profile
            if (cpi?.competencyScores) {
                createCompetencyRadarChart('profileCompetencyRadarChart', cpi.competencyScores, 'noProfileCompetencyData');
            }
            
            // Create SPI timeline chart for profile
            if (STUDENT_OVERVIEW.charts?.spiTimeline) {
                createSPITimelineChart('profilePerformanceChart', STUDENT_OVERVIEW.charts.spiTimeline, 'noProfilePerformanceData');
            }
            
            // Display strong/weak competencies
            displayCompetencyLists(cpi);
        }

        function displayCompetencyLists(cpi) {
            if (!cpi) return;
            
            // Strong competencies
            const strongContainer = document.getElementById('profileStrongCompetencies');
            if (cpi.strong && cpi.strong.length > 0) {
                strongContainer.innerHTML = cpi.strong.map(comp => {
                    const score = cpi.competencyScores?.[comp] || 0;
                    return `
                        <div class="competency-badge">
                            <div class="competency-badge-icon strong">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="competency-badge-content">
                                <div class="competency-badge-name">${comp.replace(/-/g, ' ')}</div>
                                <div class="competency-badge-score">Score: ${score.toFixed(1)}/100</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                strongContainer.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #888;">
                        <i class="fas fa-star" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>Complete more challenges to identify your strengths!</p>
                    </div>
                `;
            }
            
            // Weak competencies
            const weakContainer = document.getElementById('profileWeakCompetencies');
            if (cpi.weak && cpi.weak.length > 0) {
                weakContainer.innerHTML = cpi.weak.map(comp => {
                    const score = cpi.competencyScores?.[comp] || 0;
                    return `
                        <div class="competency-badge">
                            <div class="competency-badge-icon weak">
                                <i class="fas fa-exclamation"></i>
                            </div>
                            <div class="competency-badge-content">
                                <div class="competency-badge-name">${comp.replace(/-/g, ' ')}</div>
                                <div class="competency-badge-score">Score: ${score.toFixed(1)}/100 - Needs practice</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                weakContainer.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #888;">
                        <i class="fas fa-thumbs-up" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>Great job! No weak areas identified yet.</p>
                    </div>
                `;
            }
        }

        async function updateProfile(event) {
            if (event) event.preventDefault();

            const name = document.getElementById('profileName').value.trim();
            const phone = document.getElementById('profilePhone').value.trim();
            const dob = document.getElementById('profileDOB').value;
            const picture = document.getElementById('profilePicture').value.trim();

            if (!name) { showProfileMsg('Name is required.', 'error'); return; }

            const saveBtn = document.querySelector('#profileForm button[type="submit"]');
            if (saveBtn) { saveBtn.disabled = true; saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...'; }

            try {
                const result = await throttledApiCall('/student/profile', {
                    method: 'PUT',
                    body: JSON.stringify({ name, phone, dateOfBirth: dob || undefined, profilePicture: picture || undefined })
                });

                if (!result.success) throw new Error(result.message || 'Update failed');

                // Update local store
                if (STUDENT_OVERVIEW?.student) {
                    STUDENT_OVERVIEW.student.name = name;
                    STUDENT_OVERVIEW.student.phone = phone;
                    if (dob) STUDENT_OVERVIEW.student.dateOfBirth = dob;
                    if (picture) STUDENT_OVERVIEW.student.profilePicture = picture;
                }

                sessionStorage.setItem('studentOverview', JSON.stringify(STUDENT_OVERVIEW));
                showProfileMsg('Profile updated successfully!', 'success');
                updateProfilePage();
                updateOverviewPage();

            } catch (error) {
                console.error('Error updating profile:', error);
                showProfileMsg(error.message || 'Failed to update profile.', 'error');
            } finally {
                if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes'; }
            }
        }

        function showProfileMsg(msg, type) {
            let el = document.getElementById('profileStatusMsg');
            if (!el) {
                el = document.createElement('div');
                el.id = 'profileStatusMsg';
                el.style.cssText = 'margin-top:12px;padding:10px 14px;border-radius:8px;font-size:0.85rem;font-weight:500;';
                document.querySelector('#profileForm')?.appendChild(el);
            }
            el.textContent = msg;
            el.style.background = type === 'success' ? 'rgba(0,212,127,0.1)' : 'rgba(231,76,60,0.1)';
            el.style.color = type === 'success' ? '#00d47f' : '#e74c3c';
            el.style.border = `1px solid ${type === 'success' ? 'rgba(0,212,127,0.3)' : 'rgba(231,76,60,0.3)'}`;
            el.style.display = 'block';
            if (type === 'success') setTimeout(() => { el.style.display = 'none'; }, 4000);
        }

        // ================================================================
        // PERFORMANCE PAGE FUNCTIONS (WITH CHART.JS)
        // ================================================================
        function updatePerformancePage() {
            if (!STUDENT_OVERVIEW) return;
            
            const spi = STUDENT_OVERVIEW.spi;
            const stats = STUDENT_OVERVIEW.stats;
            
            // Update performance metrics
            document.getElementById('perfPI').textContent = spi?.value ? spi.value.toFixed(1) : '--';
            document.getElementById('perfGrade').textContent = spi?.grade || '--';
            document.getElementById('perfTotal').textContent = stats?.completedChallenges || 0;
            document.getElementById('perfAvg').textContent = stats?.averageScore ? stats.averageScore.toFixed(1) + '%' : '0%';
            
            // Create SPI timeline chart
            if (STUDENT_OVERVIEW.charts?.spiTimeline) {
                createSPITimelineChart('spiTimelineChart', STUDENT_OVERVIEW.charts.spiTimeline, 'noSpiData');
            }
            
            // Create score distribution chart
            createScoreDistributionChart();
        }

        function createSPITimelineChart(canvasId, timelineData, noDataElementId) {
            const canvas = document.getElementById(canvasId);
            const noDataElement = document.getElementById(noDataElementId);
            
            if (!timelineData || timelineData.length === 0) {
                if (noDataElement) noDataElement.style.display = 'block';
                if (canvas) canvas.style.display = 'none';
                return;
            }
            
            if (noDataElement) noDataElement.style.display = 'none';
            if (canvas) canvas.style.display = 'block';
            
            // Destroy existing chart instance
            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }
            
            // Format dates for display
            const labels = timelineData.map(item => {
                const date = new Date(item.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            const data = timelineData.map(item => item.value);
            
            // Create gradient for line
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(0, 122, 204, 0.8)');
            gradient.addColorStop(1, 'rgba(0, 122, 204, 0.1)');
            
            chartInstances[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'SPI Score',
                        data: data,
                        borderColor: '#007acc',
                        backgroundColor: gradient,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#00d4ff',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#cccccc',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 30, 30, 0.9)',
                            titleColor: '#00d4ff',
                            bodyColor: '#ffffff',
                            borderColor: '#007acc',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `SPI: ${context.parsed.y.toFixed(1)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(100, 100, 100, 0.2)'
                            },
                            ticks: {
                                color: '#888888'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(100, 100, 100, 0.2)'
                            },
                            ticks: {
                                color: '#888888',
                                callback: function(value) {
                                    return value + '';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createScoreDistributionChart() {
            const canvas = document.getElementById('scoreDistributionChart');
            const noDataElement = document.getElementById('noScoreData');
            
            // For now, we'll create a sample chart since we don't have score distribution data
            // In production, this should come from the backend
            if (noDataElement) noDataElement.style.display = 'block';
            if (canvas) canvas.style.display = 'none';
            
            // This would be replaced with real data when available
            /*
            const scoreData = STUDENT_OVERVIEW.scoreDistribution || [];
            if (!scoreData || scoreData.length === 0) {
                if (noDataElement) noDataElement.style.display = 'block';
                if (canvas) canvas.style.display = 'none';
                return;
            }
            */
        }

        // ================================================================
        // COMPETENCIES PAGE FUNCTIONS (WITH CHART.JS)
        // ================================================================
        function updateCompetenciesPage() {
            if (!STUDENT_OVERVIEW) return;
            
            const cpi = STUDENT_OVERVIEW.cpi;
            
            if (!cpi || !cpi.competencyScores) {
                // Show no data message
                document.getElementById('noCompetencyData').style.display = 'block';
                document.getElementById('competencyRadarChart').style.display = 'none';
                return;
            }
            
            // Create competency radar chart
            createCompetencyRadarChart('competencyRadarChart', cpi.competencyScores, 'noCompetencyData');
            
            // Update competency cards
            updateCompetencyCards(cpi.competencyScores);
        }

        function createCompetencyRadarChart(canvasId, competencyScores, noDataElementId) {
            const canvas = document.getElementById(canvasId);
            const noDataElement = document.getElementById(noDataElementId);
            
            if (!competencyScores || Object.keys(competencyScores).length === 0) {
                if (noDataElement) noDataElement.style.display = 'block';
                if (canvas) canvas.style.display = 'none';
                return;
            }
            
            if (noDataElement) noDataElement.style.display = 'none';
            if (canvas) canvas.style.display = 'block';
            
            // Destroy existing chart instance
            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }
            
            // Prepare data
            const labels = Object.keys(competencyScores).map(key => 
                key.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')
            );
            
            const data = Object.values(competencyScores);
            
            chartInstances[canvasId] = new Chart(canvas.getContext('2d'), {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Competency Score',
                        data: data,
                        backgroundColor: 'rgba(0, 122, 204, 0.2)',
                        borderColor: '#007acc',
                        pointBackgroundColor: '#00d4ff',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20,
                                color: '#888888',
                                backdropColor: 'transparent'
                            },
                            grid: {
                                color: 'rgba(100, 100, 100, 0.2)'
                            },
                            angleLines: {
                                color: 'rgba(100, 100, 100, 0.2)'
                            },
                            pointLabels: {
                                color: '#cccccc',
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#cccccc',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 30, 30, 0.9)',
                            titleColor: '#00d4ff',
                            bodyColor: '#ffffff',
                            borderColor: '#007acc',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw.toFixed(1)}/100`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateCompetencyCards(competencyScores) {
            const grid = document.getElementById('competencyGrid');
            
            if (!competencyScores || Object.keys(competencyScores).length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #888;">
                        <i class="fas fa-star" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <h3>No competency data yet</h3>
                        <p>Complete challenges to see your competency scores</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = Object.entries(competencyScores).map(([name, score]) => {
                const formattedName = name.split('-').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');
                
                // Determine color based on score
                let color = '#dc3545'; // Red for low scores
                if (score >= 80) color = '#28a745'; // Green for high scores
                else if (score >= 60) color = '#ffc107'; // Yellow for medium scores
                
                return `
                    <div class="competency-card">
                        <div class="competency-name">${formattedName}</div>
                        <div class="competency-bar">
                            <div class="competency-fill" style="width: ${score}%; background: linear-gradient(90deg, ${color}, ${adjustColor(color, 30)});"></div>
                        </div>
                        <div class="competency-value" style="color: ${color};">${score.toFixed(1)}/100</div>
                    </div>
                `;
            }).join('');
        }


        // ================================================================
        // REPORTS PAGE FUNCTIONS
        // ================================================================
        async function loadReports() {
            showLoading();
            try {
                const data = await throttledApiCall('/student/reports/nep');
                if (data.success && data.data) {
                    updateReportsPage(data.data);
                } else {
                    updateReportsPage(null);
                }
            } catch (error) {
                console.error('Error loading reports:', error);
                updateReportsPage(null);
            } finally {
                hideLoading();
            }
        }

        function updateReportsPage(data) {
            const list = document.getElementById('reportsList');
            
            if (!data || !data.reports || data.reports.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #888;">
                        <i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <h3>No reports available</h3>
                        <p>Your reports will appear here once generated</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = data.reports.map(report => {
                const date = new Date(report.generatedAt);
                const formattedDate = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                return `
                    <div style="padding: 15px; background: #333337; margin-bottom: 10px; border-radius: 6px; border: 1px solid #464647;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin-bottom: 5px; color: #00d4ff;">${report.reportId}</h3>
                                <div style="display: flex; gap: 15px; margin-bottom: 10px; flex-wrap: wrap;">
                                    <span style="background: rgba(0, 122, 204, 0.2); color: #00d4ff; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">
                                        <i class="fas fa-chart-bar"></i> ${report.reportType.charAt(0).toUpperCase() + report.reportType.slice(1)}
                                    </span>
                                    <span style="color: #888; font-size: 0.9rem;">
                                        <i class="fas fa-calendar"></i> ${formattedDate}
                                    </span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-secondary" onclick="downloadReport('${report.reportId}')">
                                    <i class="fas fa-download"></i> Download
                                </button>
                                <button class="btn" onclick="viewReport('${report.reportId}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add pagination if needed
            if (data.total > data.limit) {
                const totalPages = Math.ceil(data.total / data.limit);
                const pagination = document.createElement('div');
                pagination.style.display = 'flex';
                pagination.style.justifyContent = 'center';
                pagination.style.marginTop = '20px';
                pagination.style.gap = '10px';
                
                for (let i = 1; i <= totalPages; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = 'filter-btn';
                    pageBtn.textContent = i;
                    pageBtn.addEventListener('click', () => loadReportPage(i));
                    pagination.appendChild(pageBtn);
                }
                
                list.appendChild(pagination);
            }
        }

        async function loadReportPage(page) {
            showLoading();
            try {
                const data = await throttledApiCall(`/student/reports/nep?page=${page}&limit=5`);
                if (data.success && data.data) {
                    updateReportsPage(data.data);
                }
            } catch (error) {
                console.error('Error loading report page:', error);
            } finally {
                hideLoading();
            }
        }

        function _buildReportHTML(report, forPrint) {
            const fmt = key => key.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
            const fmtDate = d => d ? new Date(d).toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' }) : '';
            const s = report.summary || {};
            const comps = (report.competencies || []).filter(c => c.score > 0);
            const typeLabel = (report.reportType || 'monthly').charAt(0).toUpperCase() + (report.reportType || 'monthly').slice(1);

            const compRows = comps.map(c => `
                <tr>
                    <td style="padding:8px 12px;border-bottom:1px solid #dee2e6;">${fmt(c.name)}</td>
                    <td style="padding:8px 12px;border-bottom:1px solid #dee2e6;">
                        <div style="background:#e9ecef;border-radius:4px;height:12px;width:200px;display:inline-block;vertical-align:middle;">
                            <div style="background:#007bff;height:100%;border-radius:4px;width:${c.score}%;"></div>
                        </div>
                        <span style="margin-left:8px;font-weight:600;">${c.score}%</span>
                    </td>
                    <td style="padding:8px 12px;border-bottom:1px solid #dee2e6;color:${c.status==='improved'?'#28a745':c.status==='declined'?'#dc3545':'#6c757d'};">
                        ${c.status === 'improved' ? '' : c.status === 'declined' ? '' : ''}
                    </td>
                </tr>`).join('');

            const noCompsNote = comps.length === 0
                ? '<p style="color:#6c757d;font-style:italic;">No challenge data available for this period.</p>'
                : '';

            const recoList = (report.recommendations || []).length
                ? '<ul>' + report.recommendations.map(r => `<li>${r}</li>`).join('') + '</ul>'
                : '<p style="color:#6c757d;font-style:italic;">No recommendations at this time. Keep practising!</p>';

            const printScript = forPrint ? '<script>window.onload=function(){window.print();}<\/script>' : '';

            return `<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>NEP Report  ${report.reportId}</title>
${printScript}
<style>
  body{font-family:Arial,sans-serif;color:#212529;margin:0;padding:30px;background:#fff;}
  h1{color:#003087;font-size:1.6rem;margin-bottom:4px;}
  h2{color:#003087;font-size:1.1rem;border-bottom:2px solid #003087;padding-bottom:6px;margin-top:28px;}
  .badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:0.8rem;font-weight:600;background:#cce5ff;color:#004085;}
  .tiles{display:flex;gap:16px;flex-wrap:wrap;margin:16px 0;}
  .tile{background:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;padding:16px 20px;min-width:120px;text-align:center;}
  .tile .val{font-size:1.8rem;font-weight:700;color:#003087;}
  .tile .lbl{font-size:0.75rem;color:#6c757d;margin-top:4px;}
  table{width:100%;border-collapse:collapse;margin-top:12px;}
  th{background:#003087;color:#fff;padding:8px 12px;text-align:left;}
  @media print{body{padding:10px;}}
</style>
</head>
<body>
<h1>NEP 2020 Performance Report</h1>
<p style="color:#6c757d;margin:2px 0 4px;">
  <strong>${report.reportId}</strong> &nbsp;|&nbsp;
  <span class="badge">${typeLabel}</span> &nbsp;|&nbsp;
  ${fmtDate(report.periodStart)}  ${fmtDate(report.periodEnd)}
</p>
<p style="color:#6c757d;font-size:0.85rem;">Generated: ${fmtDate(report.generatedAt)}</p>

<h2>Summary</h2>
<div class="tiles">
  <div class="tile"><div class="val">${s.overallSPI || 0}</div><div class="lbl">SPI Score</div></div>
  <div class="tile"><div class="val">${s.grade || ''}</div><div class="lbl">Grade</div></div>
  <div class="tile"><div class="val">${s.totalChallenges || 0}</div><div class="lbl">Challenges</div></div>
  <div class="tile"><div class="val">${s.completedChallenges || 0}</div><div class="lbl">Completed</div></div>
  <div class="tile"><div class="val">${s.averageScore || 0}%</div><div class="lbl">Avg Score</div></div>
  <div class="tile"><div class="val">${s.streak || 0}</div><div class="lbl">Day Streak</div></div>
</div>

<h2>NEP Competency Scores</h2>
${noCompsNote}
${comps.length > 0 ? `<table><thead><tr><th>Competency</th><th>Score</th><th>Trend</th></tr></thead><tbody>${compRows}</tbody></table>` : ''}

<h2>Recommendations</h2>
${recoList}

<p style="margin-top:40px;font-size:0.75rem;color:#adb5bd;border-top:1px solid #dee2e6;padding-top:12px;">
  NEP Workbench  National Education Policy 2020  Generated on ${new Date().toLocaleDateString('en-IN')}
</p>
</body>
</html>`;
        }

        async function _fetchReportWithNarration(reportId) {
            const [nRes, rRes] = await Promise.allSettled([
                fetch(`${API_BASE_URL}/reports/nep/${reportId}/narration`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' }
                }).then(r => r.json()).catch(() => ({})),
                throttledApiCall(`/student/reports/nep/${reportId}`)
            ]);
            return {
                nData: nRes.status === 'fulfilled' ? nRes.value : {},
                report: (rRes.status === 'fulfilled' ? rRes.value?.data?.report : null) || null
            };
        }

        function _buildRichReportHTML(report, narration, blockchain, forPrint) {
            const fmt = k => k.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
            const fmtDate = d => d ? new Date(d).toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' }) : '';
            const s = report.summary || {};
            const comps = (report.competencies || []).filter(c => c.score > 0);
            const typeLabel = (report.reportType || 'monthly').charAt(0).toUpperCase() + (report.reportType || 'monthly').slice(1);

            const compLabels = JSON.stringify(comps.map(c => fmt(c.name)));
            const compScores = JSON.stringify(comps.map(c => c.score));
            const compColors = JSON.stringify(comps.map(c => c.score >= 70 ? '#00a65a' : c.score >= 50 ? '#f39c12' : '#e74c3c'));

            const total = s.totalChallenges || 0;
            const completed = s.completedChallenges || 0;
            const pending = Math.max(0, total - completed);
            const donutData = JSON.stringify([completed, pending]);

            const blockchainHtml = blockchain ? `
            <div style="margin:18px 0;padding:12px 18px;background:#f0fff4;border:1px solid #00a65a;border-radius:8px;display:flex;align-items:center;gap:12px;">
                <span style="font-size:1.5rem;"></span>
                <div>
                    <div style="font-weight:700;color:#00a65a;font-size:0.88rem;">Blockchain Verified Report</div>
                    <div style="font-size:0.73rem;color:#555;margin-top:3px;">
                        Merkle Root: <code style="background:#e8f5e9;padding:1px 5px;border-radius:3px;">${blockchain.merkleRoot || 'N/A'}</code>
                        &nbsp;|&nbsp; Status: <strong>${blockchain.verificationStatus || 'VERIFIED'}</strong>
                        ${blockchain.reportHash ? `&nbsp;|&nbsp; Hash: <code style="background:#e8f5e9;padding:1px 5px;border-radius:3px;">${blockchain.reportHash.substring(0, 16)}</code>` : ''}
                    </div>
                </div>
            </div>` : '';

            const narrationHtml = narration ? `
            <h2 style="color:#003087;font-size:1rem;border-bottom:2px solid #003087;padding-bottom:6px;margin:28px 0 14px;text-transform:uppercase;letter-spacing:0.5px;">Official NEP 2020 Narration</h2>
            <div style="background:#f8f9fa;border-left:4px solid #003087;padding:16px 20px;font-size:0.88rem;line-height:1.85;color:#333;white-space:pre-line;">${narration}</div>` : '';

            const recoItems = (report.recommendations || []).map(r =>
                `<li style="margin-bottom:6px;">${typeof r === 'object' ? (r.description || '') : r}</li>`
            ).join('');

            const initScript = `
function renderCharts() {
    var labels = ${compLabels};
    var scores = ${compScores};
    var colors = ${compColors};
    if (labels.length > 0 && document.getElementById('compChart')) {
        new Chart(document.getElementById('compChart'), {
            type: 'bar',
            data: { labels: labels, datasets: [{ label: 'Score (%)', data: scores, backgroundColor: colors, borderRadius: 5 }] },
            options: { indexAxis: 'y', responsive: true, scales: { x: { min: 0, max: 100, ticks: { callback: function(v){ return v+'%'; } } } }, plugins: { legend: { display: false } } }
        });
    }
    var d = ${donutData};
    if (document.getElementById('donutChart')) {
        new Chart(document.getElementById('donutChart'), {
            type: 'doughnut',
            data: { labels: ['Completed','Pending'], datasets: [{ data: d, backgroundColor: ['#00a65a','#dee2e6'], borderWidth: 0 }] },
            options: { cutout: '70%', plugins: { legend: { position: 'bottom' } } }
        });
    }
}
window.addEventListener('load', function() {
    if (typeof Chart !== 'undefined') renderCharts();
    ${forPrint ? 'setTimeout(function(){ window.print(); }, 900);' : ''}
});`;

            return `<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>NEP Report  ${report.reportId}</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"><\/script>
<style>
  *{box-sizing:border-box;} body{font-family:'Segoe UI',Arial,sans-serif;color:#212529;margin:0;padding:36px;background:#fff;}
  h1{color:#003087;font-size:1.5rem;margin-bottom:4px;}
  h2{color:#003087;font-size:0.92rem;border-bottom:2px solid #003087;padding-bottom:5px;margin:26px 0 12px;text-transform:uppercase;letter-spacing:0.5px;}
  .badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:0.78rem;font-weight:600;background:#cce5ff;color:#004085;}
  .tiles{display:flex;gap:12px;flex-wrap:wrap;margin:14px 0;}
  .tile{background:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;padding:14px 18px;min-width:100px;text-align:center;}
  .tile .val{font-size:1.7rem;font-weight:700;color:#003087;} .tile .lbl{font-size:0.7rem;color:#6c757d;margin-top:4px;text-transform:uppercase;}
  .charts-row{display:flex;gap:24px;flex-wrap:wrap;margin:14px 0;align-items:flex-start;}
  .chart-box{flex:1;min-width:260px;max-width:560px;}
  .donut-box{width:200px;}
  @media print{body{padding:16px;}.no-print{display:none;}}
</style></head>
<body>
<div class="no-print" style="text-align:right;margin-bottom:18px;">
  <button onclick="window.print()" style="background:#003087;color:#fff;border:none;padding:10px 22px;border-radius:5px;font-size:13px;cursor:pointer;"> Download / Print as PDF</button>
</div>
<h1>NEP 2020 Performance Report</h1>
<p style="color:#6c757d;margin:2px 0 4px;"><strong>${report.reportId}</strong> &nbsp;|&nbsp; <span class="badge">${typeLabel}</span> &nbsp;|&nbsp; ${fmtDate(report.periodStart)}  ${fmtDate(report.periodEnd)}</p>
<p style="color:#6c757d;font-size:0.8rem;">Generated: ${fmtDate(report.generatedAt)}</p>
${blockchainHtml}
<h2>Performance Summary</h2>
<div class="tiles">
  <div class="tile"><div class="val">${s.overallSPI || 0}</div><div class="lbl">SPI Score</div></div>
  <div class="tile"><div class="val">${s.grade || ''}</div><div class="lbl">Grade</div></div>
  <div class="tile"><div class="val">${s.totalChallenges || 0}</div><div class="lbl">Challenges</div></div>
  <div class="tile"><div class="val">${s.completedChallenges || 0}</div><div class="lbl">Completed</div></div>
  <div class="tile"><div class="val">${s.averageScore || 0}%</div><div class="lbl">Avg Score</div></div>
  <div class="tile"><div class="val">${s.streak || 0} </div><div class="lbl">Day Streak</div></div>
</div>
${narrationHtml}
<h2>NEP Competency Analysis</h2>
<div class="charts-row">
  ${comps.length > 0 ? `<div class="chart-box"><canvas id="compChart"></canvas></div>
  <div class="donut-box" style="text-align:center;">
    <canvas id="donutChart" width="180" height="180"></canvas>
    <div style="font-size:0.75rem;color:#6c757d;margin-top:6px;">Challenge Completion</div>
  </div>` : '<p style="color:#6c757d;font-style:italic;">No challenge data available for this period.</p>'}
</div>
<h2>Recommendations</h2>
${recoItems ? `<ul style="padding-left:20px;line-height:1.8;font-size:0.88rem;">${recoItems}</ul>` : '<p style="color:#6c757d;font-style:italic;">Keep practising to unlock recommendations!</p>'}
<p style="margin-top:36px;font-size:0.72rem;color:#adb5bd;border-top:1px solid #dee2e6;padding-top:10px;">NEP Workbench  National Education Policy 2020  Generated on ${new Date().toLocaleDateString('en-IN')}</p>
<script>${initScript}<\/script>
</body></html>`;
        }

        async function downloadReport(reportId) {
            showLoading();
            try {
                const { nData, report } = await _fetchReportWithNarration(reportId);
                if (!report) { alert('Could not fetch report. Please try again.'); return; }
                const html = _buildRichReportHTML(report, nData.narration || '', nData.blockchainVerification || null, true);
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `NEP-Report-${reportId}.html`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                setTimeout(() => URL.revokeObjectURL(url), 60000);
            } catch (error) {
                console.error('Error downloading report:', error);
                alert('Failed to download report. Please try again.');
            } finally { hideLoading(); }
        }

        async function viewReport(reportId) {
            showLoading();
            try {
                const { nData, report } = await _fetchReportWithNarration(reportId);
                if (!report) { alert('Could not load report. Please try again.'); return; }
                const html = _buildRichReportHTML(report, nData.narration || '', nData.blockchainVerification || null, false);
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                window.open(url, '_blank');
                setTimeout(() => URL.revokeObjectURL(url), 60000);
            } catch (error) {
                console.error('Error viewing report:', error);
                alert('Failed to view report. Please try again.');
            } finally { hideLoading(); }
        }

        async function triggerGenerateReport() {
            const btn = document.getElementById('generateReportBtn');
            const msg = document.getElementById('generateReportMsg');
            const reportType = document.getElementById('reportTypeSelect').value;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            msg.style.color = '#888';
            msg.textContent = 'Please wait';
            try {
                const response = await fetch(`${API_BASE_URL}/student/reports/generate`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reportType })
                });
                const data = await response.json();
                if (data.success) {
                    msg.style.color = '#888';
                    msg.textContent = 'Report generated. Generating narration';
                    const reportId = data.data?.report?.reportId;
                    if (reportId) {
                        await fetch(`${API_BASE_URL}/reports/nep/${reportId}/narration`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' }
                        }).catch(() => {});
                    }
                    msg.style.color = '#4ec9b0';
                    msg.textContent = 'Report generated with narration!';
                    loadReports();
                } else {
                    msg.style.color = '#f48771';
                    msg.textContent = data.message || 'Failed to generate report.';
                }
            } catch (error) {
                console.error('Generate report error:', error);
                msg.style.color = '#f48771';
                msg.textContent = 'Network error. Please try again.';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plus"></i> Generate Report';
                setTimeout(() => { msg.textContent = ''; }, 4000);
            }
        }


        // ================================================================
        // CHALLENGES PAGE FUNCTIONS
        // ================================================================
        // ================================================================
        // CHALLENGES PAGE FUNCTIONS
        // ================================================================
        async function loadChallenges() {
            console.log(' Loading challenges...');
            
            if (!STUDENT_OVERVIEW || !STUDENT_OVERVIEW.student) {
                console.error('Student overview not loaded');
                document.getElementById('allChallengesBody').innerHTML = 
                    '<tr><td colspan="6" style="text-align: center;">Please refresh the page</td></tr>';
                return;
            }

            showLoading();
            try {
                const studentId = STUDENT_OVERVIEW.student.studentId;
                console.log(' Calling challenges API for student:', studentId);
                
                const data = await throttledApiCall(`/challenges/student/${studentId}`);
                console.log(' Challenges API response:', data);
                
                if (data.success && data.data) {
                    updateChallengesPage(data.data);
                } else {
                    throw new Error('Invalid response from challenges API');
                }
            } catch (error) {
                console.error(' Error loading challenges:', error);
                document.getElementById('allChallengesBody').innerHTML = 
                    `<tr><td colspan="6" style="text-align: center; color: #ff4444;">Error loading challenges: ${error.message}</td></tr>`;
            } finally {
                hideLoading();
            }
        }

        function updateChallengesPage(data) {
            console.log(' Updating challenges page with data:', data);
            
            // Update challenges table
            const tbody = document.getElementById('allChallengesBody');
            
            if (!data || !data.challenges || data.challenges.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No challenges yet. Generate one to get started!</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.challenges.map(challenge => {
                const date = new Date(challenge.generatedAt);
                const formattedDate = date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Get score and status
                let score = 'N/A';
                let statusBadge = 'info';
                let statusText = challenge.status;
                
                if (challenge.status === 'evaluated' && challenge.results) {
                    score = challenge.results.percentage ? `${challenge.results.percentage.toFixed(1)}%` : 'N/A';
                    statusBadge = challenge.results.passed ? 'success' : 'danger';
                    statusText = challenge.results.passed ? 'Passed' : 'Failed';
                } else if (challenge.status === 'in-progress') {
                    statusBadge = 'warning';
                    statusText = 'In Progress';
                } else if (challenge.status === 'generated') {
                    statusBadge = 'secondary';
                    statusText = 'Not Started';
                }
                
                // Format simulation type
                const simulationType = challenge.simulationType
                    .replace(/-/g, ' ')
                    .replace(/\b\w/g, l => l.toUpperCase());
                
                // Get difficulty color
                const difficultyColor = getDifficultyColor(challenge.difficulty);
                const difficultyText = challenge.difficulty.charAt(0).toUpperCase() + challenge.difficulty.slice(1);
                
                return `
                    <tr>
                        <td>
                            <span style="font-family: monospace; color: #00d4ff; font-size: 0.85rem;">
                                ${challenge.challengeId}
                            </span>
                            <div style="font-size: 0.75rem; color: #888; margin-top: 3px;">
                                ${formattedDate}
                            </div>
                        </td>
                        <td>${simulationType}</td>
                        <td>
                            <span style="color: ${difficultyColor}; font-weight: 600;">
                                ${difficultyText}
                            </span>
                        </td>
                        <td><strong style="font-size: 1.1rem;">${score}</strong></td>
                        <td>
                            <span class="badge badge-${statusBadge}" style="font-size: 0.8rem;">
                                ${statusText}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-secondary" onclick="viewChallenge('${challenge.challengeId}')" style="padding: 6px 12px; font-size: 0.85rem;">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getDifficultyColor(difficulty) {
            const colors = {
                'easy': '#28a745',
                'medium': '#ffc107',
                'hard': '#dc3545'
            };
            return colors[difficulty] || '#6c757d';
        }

        function viewChallenge(challengeId) {
            console.log(' Viewing challenge:', challengeId);
            // Open challenge in new tab
            window.open(`/challenge?id=${challengeId}`, '_blank');
        }

        // Load challenge limits from backend
        async function loadChallengeLimits() {
            try {
                const limitsData = await throttledApiCall('/student/challenges/limits');
                const el = document.getElementById('dailyLimit');
                if (!el) return;
                if (limitsData.success && limitsData.data) {
                    const remaining = limitsData.data.daily?.remaining ?? '--';
                    const limit = limitsData.data.daily?.limit ?? 10;
                    el.textContent = remaining;
                    el.title = `${remaining} of ${limit} remaining today`;
                    // Colour-code: green 5, orange 1-4, red 0
                    el.style.color = remaining >= 5 ? '#00d47f' : remaining > 0 ? '#ffa500' : '#e74c3c';
                } else {
                    el.textContent = '--';
                }
            } catch (error) {
                const el = document.getElementById('dailyLimit');
                if (el) el.textContent = '--';
            }
        }

        // ================================================================
        // STUDENT NOTIFICATIONS (recent challenges as activity feed)
        // ================================================================
        function toggleStudentNotif() {
            const panel = document.getElementById('studentNotifPanel');
            if (panel.style.display === 'flex') {
                panel.style.display = 'none';
            } else {
                panel.style.display = 'flex';
                panel.style.flexDirection = 'column';
                renderStudentNotifications();
            }
        }

        function closeStudentNotif() {
            document.getElementById('studentNotifPanel').style.display = 'none';
        }

        async function renderStudentNotifications() {
            const listEl = document.getElementById('studentNotifList');
            listEl.innerHTML = '<div style="padding:32px;text-align:center;color:#666;font-size:0.85rem;"><i class="fas fa-spinner fa-spin"></i></div>';
            try {
                const data = await throttledApiCall('/student/challenges/recent');
                const challenges = data.data?.challenges || [];
                if (!challenges.length) {
                    listEl.innerHTML = '<div style="padding:32px;text-align:center;color:#666;font-size:0.85rem;"><i class="fas fa-inbox" style="display:block;font-size:1.5rem;margin-bottom:8px;"></i>No recent activity</div>';
                    return;
                }
                const statusIcon = { evaluated: 'fa-check-circle', 'in-progress': 'fa-spinner', generated: 'fa-circle', submitted: 'fa-paper-plane' };
                const statusColor = { evaluated: '#00d47f', 'in-progress': '#ffa500', generated: '#888', submitted: '#3498db' };
                listEl.innerHTML = challenges.slice(0, 10).map(c => {
                    const icon = statusIcon[c.status] || 'fa-brain';
                    const col = c.status === 'evaluated' ? (c.results?.passed ? '#00d47f' : '#e74c3c') : (statusColor[c.status] || '#888');
                    const title = (c.simulationType || 'Challenge').replace(/-/g, ' ').replace(/\b\w/g, x => x.toUpperCase());
                    const score = c.status === 'evaluated' && c.results ? `${Math.round(c.results.percentage || 0)}%` : c.status;
                    const timeAgo = notifTimeAgo(c.generatedAt);
                    return `<div style="display:flex;gap:12px;padding:12px 18px;border-bottom:1px solid #3a3a3c;align-items:flex-start;">
                        <div style="width:30px;height:30px;border-radius:50%;background:${col}22;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                            <i class="fas ${icon}" style="color:${col};font-size:0.75rem;"></i>
                        </div>
                        <div style="flex:1;min-width:0;">
                            <div style="font-size:0.82rem;color:#e0e0e0;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${title}</div>
                            <div style="font-size:0.75rem;color:#888;margin-top:2px;">${score} &nbsp;&nbsp; ${timeAgo}</div>
                        </div>
                    </div>`;
                }).join('');
                // Update badge count
                document.getElementById('notificationCount').textContent = Math.min(challenges.length, 9);
            } catch (e) {
                listEl.innerHTML = '<div style="padding:24px;text-align:center;color:#666;font-size:0.82rem;">Could not load activity</div>';
            }
        }

        function notifTimeAgo(ts) {
            if (!ts) return '';
            const diff = Math.floor((Date.now() - new Date(ts)) / 1000);
            if (diff < 60) return 'just now';
            if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
            return Math.floor(diff / 86400) + 'd ago';
        }

        // ================================================================
        // RECENT CHALLENGES FUNCTIONS (FOR OVERVIEW PAGE)
        // ================================================================
        async function loadRecentChallenges() {
            try {
                const data = await throttledApiCall('/student/challenges/recent');
                if (data.success && data.data) {
                    updateRecentChallengesTable(data.data);
                } else {
                    updateRecentChallengesTable(null);
                }
            } catch (error) {
                console.error('Error loading recent challenges:', error);
                updateRecentChallengesTable(null);
            }
        }

        function updateRecentChallengesTable(data) {
            const tbody = document.getElementById('recentChallengesBody');
            
            if (!data || !data.challenges || data.challenges.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Complete challenges to see your history</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.challenges.map(challenge => {
                const date = new Date(challenge.generatedAt);
                const formattedDate = date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Get score and status
                let score = 'N/A';
                let statusBadge = 'info';
                let statusText = challenge.status;
                
                if (challenge.status === 'evaluated' && challenge.results) {
                    score = challenge.results.percentage ? `${challenge.results.percentage.toFixed(1)}%` : 'N/A';
                    statusBadge = challenge.results.passed ? 'success' : 'danger';
                    statusText = challenge.results.passed ? 'Passed' : 'Failed';
                } else if (challenge.status === 'in-progress') {
                    statusBadge = 'warning';
                    statusText = 'In Progress';
                } else if (challenge.status === 'generated') {
                    statusBadge = 'secondary';
                    statusText = 'Not Started';
                }
                
                // Format simulation type
                const simulationType = challenge.simulationType
                    .replace(/-/g, ' ')
                    .replace(/\b\w/g, l => l.toUpperCase());
                
                // Get challenge title
                const challengeTitle = simulationType || `Challenge ${challenge.challengeId.substring(0, 8)}`;
                
                return `
                    <tr>
                        <td>
                            <div style="font-weight: 600; color: #00d4ff;">${challengeTitle}</div>
                            <div style="font-size: 0.75rem; color: #888; margin-top: 3px;">
                                ID: ${challenge.challengeId}
                            </div>
                        </td>
                        <td>${simulationType}</td>
                        <td><strong style="font-size: 1.1rem; color: ${score === 'N/A' ? '#888' : '#ffffff'}">${score}</strong></td>
                        <td>
                            <span class="badge badge-${statusBadge}" style="font-size: 0.8rem;">
                                ${statusText}
                            </span>
                        </td>
                        <td>
                            <div style="font-size: 0.85rem;">${formattedDate}</div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Add period info if available
            if (data.period) {
                const table = document.getElementById('recentChallengesTable');
                const caption = table.querySelector('caption') || document.createElement('caption');
                caption.innerHTML = `<div style="text-align: right; font-size: 0.8rem; color: #888; padding: 5px;">Showing: ${data.period}</div>`;
                if (!table.querySelector('caption')) {
                    table.appendChild(caption);
                }
            }
        }

// ================================================================
// LOGOUT FUNCTION - CLEAN VERSION
// ================================================================
function logoutStudent(event) {
    // Prevent any default behavior and stop propagation
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    // Confirm logout
    if (!confirm('Are you sure you want to logout?')) {
        return; // User cancelled
    }
    
    try {
        // Show loading indicator
        showLoading();
        
        // Clear authentication data
        localStorage.removeItem('authToken');
        sessionStorage.removeItem('studentOverview');
        
        // Clear global state
        STUDENT_OVERVIEW = null;
        authToken = null;
        
        // Clear any cached data
        pageCache = {};
        
        // Redirect to login
        window.location.href = '/login';
    } catch (error) {
        console.error('Logout error:', error);
        hideLoading();
        alert('Logout failed. Please try again.');
    }
}

        // ================================================================
        // NAVIGATION HANDLER - COMPLETE VERSION
        // ================================================================
        document.addEventListener('DOMContentLoaded', function() {
            // Remove any existing event listeners and add new ones
            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(item => {
                // Remove any existing click listeners (to avoid duplicates)
                item.removeEventListener('click', handleNavClick);
                // Add new listener
                item.addEventListener('click', handleNavClick);
            });
        });

        // Separate handler function for better organization
        function handleNavClick(event) {
            const pageId = this.getAttribute('data-page');
            
            // Log for debugging
            console.log('Navigation clicked:', pageId);
            
            switch(pageId) {
                case 'logout':
                    logoutStudent(event);
                    break;
                    
                case 'reasoning-pad':
                    openReasoningPad(event);
                    break;
                    
                case null:
                case undefined:
                    // Do nothing for items without data-page
                    break;
                    
                default:
                    // Regular page navigation
                    showPage(pageId);
                    break;
            }
        }
        // ================================================================
        // HELPER FUNCTIONS
        // ================================================================
        function adjustColor(color, amount) {
            const hex = color.replace('#', '');
            let r = parseInt(hex.substring(0, 2), 16);
            let g = parseInt(hex.substring(2, 4), 16);
            let b = parseInt(hex.substring(4, 6), 16);
            
            r = Math.min(255, Math.max(0, r + amount));
            g = Math.min(255, Math.max(0, g + amount));
            b = Math.min(255, Math.max(0, b + amount));
            
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // ================================================================
        // NAVIGATION
        // ================================================================
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate the clicked nav item
            const clickedItem = document.querySelector(`.nav-item[data-page="${pageId}"]`);
            if (clickedItem) {
                clickedItem.classList.add('active');
            }
            
                switch(pageId) {
                    case 'simulations':
                        loadSimulationsPage();
                        break;
                    case 'reports':
                        loadReports();
                        break;
                    case 'challenges':
                        console.log(' Loading challenges data...');
                        loadChallenges();
                        loadChallengeLimits();
                        break;
                    case 'help':
                        loadHelpTickets();
                        break;
                }
        }

        // ================================================================
        // SIMULATIONS PAGE (LOCAL DATA - NO API CALLS NEEDED)
        // ================================================================
        const SIMULATIONS_DATA = {
            physics: [
                { 
                    id: 'motion-classifier-sim',
                    name: 'Motion Classifier Simulation',
                    file: 'MOTIONCLASSIFIERSIM.html',
                    icon: 'fas fa-running',
                    color: '#007acc',
                    description: 'Classify different types of motion and understand kinematic principles',
                    difficulty: 'easy',
                    duration: '10-15 min',
                    concepts: ['Kinematics', 'Motion Types', 'Velocity', 'Acceleration'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'measurement-skills-sim',
                    name: 'Measurement Skills Simulator',
                    file: '', // Coming soon
                    icon: 'fas fa-ruler-combined',
                    color: '#007acc',
                    description: 'Practice precise measurement techniques with virtual instruments',
                    difficulty: 'easy',
                    duration: '8-12 min',
                    concepts: ['Measurement', 'Precision', 'Units', 'Instruments'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'motion-timer-sim',
                    name: 'Motion Timer Simulation',
                    file: 'Motiontimersim.html',
                    icon: 'fas fa-stopwatch',
                    color: '#007acc',
                    description: 'Analyze motion using virtual timers and position sensors',
                    difficulty: 'medium',
                    duration: '15-20 min',
                    concepts: ['Timing', 'Motion Analysis', 'Position', 'Time Measurement'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'projectile-motion-simulator',
                    name: 'Projectile Motion Simulator',
                    file: 'Projectilemotionsimulator.html',
                    icon: 'fas fa-basketball-ball',
                    color: '#007acc',
                    description: 'Explore projectile motion with adjustable parameters',
                    difficulty: 'medium',
                    duration: '15-20 min',
                    concepts: ['Projectile Motion', 'Trajectory', 'Velocity Components', 'Range'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'shadow-formation-simulator',
                    name: 'Shadow Formation Simulator',
                    file: 'ShadowFormationSimulator.html',
                    icon: 'fas fa-sun',
                    color: '#007acc',
                    description: 'Understand light properties and shadow formation principles',
                    difficulty: 'easy',
                    duration: '10-15 min',
                    concepts: ['Light', 'Shadows', 'Light Sources', 'Object Position'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'weather-system-model',
                    name: 'Weather System Model',
                    file: 'WeatherSystemModel.html',
                    icon: 'fas fa-cloud-sun',
                    color: '#007acc',
                    description: 'Simulate weather patterns and atmospheric conditions',
                    difficulty: 'hard',
                    duration: '20-25 min',
                    concepts: ['Atmosphere', 'Weather Patterns', 'Climate', 'Meteorology'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'sound-wave-generator',
                    name: 'Sound Wave Generator',
                    file: 'SoundWaveGenerator.html',
                    icon: 'fas fa-wave-square',
                    color: '#007acc',
                    description: 'Generate and analyze different sound wave patterns',
                    difficulty: 'medium',
                    duration: '12-18 min',
                    concepts: ['Sound Waves', 'Frequency', 'Amplitude', 'Wave Properties'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'heat-flow-simulator',
                    name: 'Heat Flow Simulator',
                    file: 'HeatFlowSimulator.html',
                    icon: 'fas fa-temperature-high',
                    color: '#007acc',
                    description: 'Visualize heat transfer through conduction, convection, and radiation',
                    difficulty: 'medium',
                    duration: '15-20 min',
                    concepts: ['Heat Transfer', 'Conduction', 'Convection', 'Radiation'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'light-path-visualizer',
                    name: 'Light Path Visualizer',
                    file: 'Lightpathvisualizer.html',
                    icon: 'fas fa-lightbulb',
                    color: '#007acc',
                    description: 'Trace light paths through different media and understand refraction',
                    difficulty: 'medium',
                    duration: '12-16 min',
                    concepts: ['Light Reflection', 'Refraction', 'Optics', 'Light Paths'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'newtons-laws-demonstrator',
                    name: 'Newton\'s Laws Demonstrator',
                    file: 'Newtonslawsdemonstrator.html',
                    icon: 'fas fa-car',
                    color: '#007acc',
                    description: 'Interactive demonstration of Newton\'s three laws of motion',
                    difficulty: 'medium',
                    duration: '15-20 min',
                    concepts: ['Newton\'s Laws', 'Force', 'Motion', 'Inertia'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'magnetic-field-visualizer',
                    name: 'Magnetic Field Visualizer',
                    file: 'Magneticfieldvisualizer.html',
                    icon: 'fas fa-magnet',
                    color: '#007acc',
                    description: 'Visualize magnetic fields around different magnet configurations',
                    difficulty: 'hard',
                    duration: '18-22 min',
                    concepts: ['Magnetism', 'Magnetic Fields', 'Poles', 'Field Lines'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'gas-properties-simulator',
                    name: 'Gas Properties Simulator',
                    file: 'Gaspropertiessimulator.html',
                    icon: 'fas fa-wind',
                    color: '#007acc',
                    description: 'Explore gas laws and properties with interactive controls',
                    difficulty: 'hard',
                    duration: '20-25 min',
                    concepts: ['Gas Laws', 'Pressure', 'Volume', 'Temperature'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'electrolysis-simulator',
                    name: 'Electrolysis Simulator',
                    file: 'Electrolysissimulator.html',
                    icon: 'fas fa-bolt',
                    color: '#007acc',
                    description: 'Simulate electrolysis process and understand chemical reactions',
                    difficulty: 'hard',
                    duration: '20-25 min',
                    concepts: ['Electrolysis', 'Chemical Reactions', 'Ions', 'Electrodes'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'force-visualizer',
                    name: 'Force Visualizer',
                    file: 'Force visualizer.html',
                    icon: 'fas fa-weight-hanging',
                    color: '#007acc',
                    description: 'Visualize forces acting on objects in different scenarios',
                    difficulty: 'medium',
                    duration: '15-20 min',
                    concepts: ['Forces', 'Vectors', 'Net Force', 'Equilibrium'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'gravity-simulator',
                    name: 'Gravity Simulator',
                    file: 'GravitySimulator.html',
                    icon: 'fas fa-globe',
                    color: '#007acc',
                    description: 'Simulate gravitational forces between celestial bodies',
                    difficulty: 'hard',
                    duration: '20-25 min',
                    concepts: ['Gravity', 'Orbits', 'Celestial Mechanics', 'Mass'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'electric-field-mapper',
                    name: 'Electric Field Mapper',
                    file: 'ElectricFieldMapper.html',
                    icon: 'fas fa-bolt',
                    color: '#007acc',
                    description: 'Map electric fields around different charge configurations',
                    difficulty: 'hard',
                    duration: '20-25 min',
                    concepts: ['Electric Fields', 'Charges', 'Field Lines', 'Potential'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'ray-diagram-builder',
                    name: 'Ray Diagram Builder',
                    file: 'Raydiagrambuilder.html',
                    icon: 'fas fa-draw-polygon',
                    color: '#007acc',
                    description: 'Construct ray diagrams for lenses and mirrors',
                    difficulty: 'medium',
                    duration: '15-20 min',
                    concepts: ['Ray Diagrams', 'Lenses', 'Mirrors', 'Optics'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'energy-transformation-visualizer',
                    name: 'Energy Transformation Visualizer',
                    file: 'EnergyTransformationVisualizer.html',
                    icon: 'fas fa-exchange-alt',
                    color: '#007acc',
                    description: 'Visualize energy transformations between different forms',
                    difficulty: 'medium',
                    duration: '15-20 min',
                    concepts: ['Energy Forms', 'Transformations', 'Conservation', 'Efficiency'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'advanced-circuit-simulator',
                    name: 'Advanced Circuit Simulator',
                    file: 'Simplecircuitbuilder.html',
                    icon: 'fas fa-microchip',
                    color: '#007acc',
                    description: 'Build and analyze complex electrical circuits',
                    difficulty: 'hard',
                    duration: '25-30 min',
                    concepts: ['Circuits', 'Resistance', 'Current', 'Voltage'],
                    completed: false,
                    score: null
                }
            ],
            math: [
                { 
                    id: 'shape-builder-measurer',
                    name: 'Shape Builder & Measurer',
                    file: 'shapebuilder.html',
                    icon: 'fas fa-shapes',
                    color: '#28a745',
                    description: 'Construct geometric shapes and measure their properties',
                    difficulty: 'easy',
                    duration: '10-15 min',
                    concepts: ['Geometry', 'Shapes', 'Measurement', 'Properties'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'fraction-pie-visualizer',
                    name: 'Fraction Pie Visualizer',
                    file: 'Fractionpievisualizer.html',
                    icon: 'fas fa-chart-pie',
                    color: '#28a745',
                    description: 'Visualize fractions using interactive pie charts',
                    difficulty: 'easy',
                    duration: '8-12 min',
                    concepts: ['Fractions', 'Pie Charts', 'Ratios', 'Percentages'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'equation-solver-with-steps',
                    name: 'Equation Solver with Steps',
                    file: 'Equationsolver.html',
                    icon: 'fas fa-equals',
                    color: '#28a745',
                    description: 'Solve equations step-by-step with visual explanations',
                    difficulty: 'medium',
                    duration: '15-20 min',
                    concepts: ['Algebra', 'Equations', 'Solving Steps', 'Variables'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'data-set-analyzer',
                    name: 'Data Set Analyzer',
                    file: 'Datasetanalyzer.html',
                    icon: 'fas fa-chart-bar',
                    color: '#28a745',
                    description: 'Analyze data sets and calculate statistical measures',
                    difficulty: 'medium',
                    duration: '15-20 min',
                    concepts: ['Statistics', 'Data Analysis', 'Mean', 'Median', 'Mode'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'unit-circle-simulator',
                    name: 'Unit Circle Simulator',
                    file: 'Unitcirclesimulator.html',
                    icon: 'fas fa-circle',
                    color: '#28a745',
                    description: 'Explore trigonometric functions using the unit circle',
                    difficulty: 'medium',
                    duration: '15-20 min',
                    concepts: ['Trigonometry', 'Unit Circle', 'Sine', 'Cosine', 'Tangent'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'three-d-vector-visualizer',
                    name: '3D Vector Visualizer',
                    file: '3DVectorVisualizer.html',
                    icon: 'fas fa-vector-square',
                    color: '#28a745',
                    description: 'Visualize 3D vectors and perform vector operations',
                    difficulty: 'hard',
                    duration: '20-25 min',
                    concepts: ['Vectors', '3D Geometry', 'Vector Operations', 'Coordinates'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'polynomial-grapher',
                    name: 'Polynomial Grapher',
                    file: 'polynomialgrapher.html',
                    icon: 'fas fa-chart-line',
                    color: '#28a745',
                    description: 'Graph polynomial functions and analyze their properties',
                    difficulty: 'medium',
                    duration: '15-20 min',
                    concepts: ['Polynomials', 'Graphing', 'Roots', 'Degree'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'quadratic-explorer',
                    name: 'Quadratic Explorer',
                    file: 'QuadraticExplorer.html',
                    icon: 'fas fa-parabola',
                    color: '#28a745',
                    description: 'Explore quadratic functions, roots, and parabolas',
                    difficulty: 'medium',
                    duration: '15-20 min',
                    concepts: ['Quadratic Equations', 'Parabolas', 'Vertex', 'Roots'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'coordinate-plotter',
                    name: 'Coordinate Plotter',
                    file: 'coordinateplotter.html',
                    icon: 'fas fa-map-marked-alt',
                    color: '#28a745',
                    description: 'Plot points and graphs on coordinate planes',
                    difficulty: 'easy',
                    duration: '10-15 min',
                    concepts: ['Coordinates', 'Plotting', 'Cartesian Plane', 'Points'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'equation-balancer',
                    name: 'Equation Balancer',
                    file: 'Equationbalancer.html',
                    icon: 'fas fa-balance-scale',
                    color: '#28a745',
                    description: 'Balance chemical and mathematical equations',
                    difficulty: 'medium',
                    duration: '15-20 min',
                    concepts: ['Equation Balancing', 'Stoichiometry', 'Coefficients', 'Equality'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'geometric-proof-builder',
                    name: 'Geometric Proof Builder',
                    file: 'Geometricproofbuilder.html',
                    icon: 'fas fa-drafting-compass',
                    color: '#28a745',
                    description: 'Construct geometric proofs step by step',
                    difficulty: 'hard',
                    duration: '20-25 min',
                    concepts: ['Geometry Proofs', 'Theorems', 'Deductive Reasoning', 'Logic'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'calculus-visualizer',
                    name: 'Calculus Visualizer',
                    file: 'CalculusVisualizer.html',
                    icon: 'fas fa-infinity',
                    color: '#28a745',
                    description: 'Visualize calculus concepts including derivatives and integrals',
                    difficulty: 'hard',
                    duration: '25-30 min',
                    concepts: ['Calculus', 'Derivatives', 'Integrals', 'Limits'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'trigonometry-visualizer',
                    name: 'Trigonometry Visualizer',
                    file: 'TrigonometryVisualizer.html',
                    icon: 'fas fa-triangle',
                    color: '#28a745',
                    description: 'Interactive visualization of trigonometric concepts',
                    difficulty: 'medium',
                    duration: '15-20 min',
                    concepts: ['Trigonometry', 'Triangles', 'Angles', 'Functions'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'probability-simulator',
                    name: 'Probability Simulator',
                    file: 'ProbabilitySimulator.html',
                    icon: 'fas fa-dice',
                    color: '#28a745',
                    description: 'Simulate probability experiments and analyze outcomes',
                    difficulty: 'medium',
                    duration: '15-20 min',
                    concepts: ['Probability', 'Experiments', 'Outcomes', 'Statistics'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'interactive-graph-maker',
                    name: 'Interactive Graph Maker',
                    file: 'InteractiveGraphMaker.html',
                    icon: 'fas fa-project-diagram',
                    color: '#28a745',
                    description: 'Create and manipulate various types of graphs',
                    difficulty: 'medium',
                    duration: '15-20 min',
                    concepts: ['Graphing', 'Functions', 'Relations', 'Visualization'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'ratio-visualizer',
                    name: 'Ratio Visualizer',
                    file: 'RatioVisualizer.html',
                    icon: 'fas fa-percentage',
                    color: '#28a745',
                    description: 'Visualize ratios and proportions in different contexts',
                    difficulty: 'easy',
                    duration: '10-15 min',
                    concepts: ['Ratios', 'Proportions', 'Scaling', 'Comparison'],
                    completed: false,
                    score: null
                },
                { 
                    id: 'symmetry-explorer',
                    name: 'Symmetry Explorer',
                    file: 'SymmetryExplorer.html',
                    icon: 'fas fa-sync-alt',
                    color: '#28a745',
                    description: 'Explore different types of symmetry in geometric shapes',
                    difficulty: 'easy',
                    duration: '10-15 min',
                    concepts: ['Symmetry', 'Reflection', 'Rotation', 'Geometric Shapes'],
                    completed: false,
                    score: null
                }
            ],
            chemistry: [
                { 
                    id: 'periodic-table-explorer',
                    name: 'Periodic Table Explorer',
                    file: '',
                    icon: 'fas fa-atom',
                    color: '#ff6b6b',
                    description: 'Explore the periodic table and element properties (Coming Soon)',
                    difficulty: 'easy',
                    duration: '10-15 min',
                    concepts: ['Elements', 'Periodic Table', 'Properties', 'Classification'],
                    completed: false,
                    score: null
                }
            ],
            biology: [
                { 
                    id: 'cell-structure-explorer',
                    name: 'Cell Structure Explorer',
                    file: '',
                    icon: 'fas fa-microscope',
                    color: '#20c997',
                    description: 'Explore cell structures and organelles (Coming Soon)',
                    difficulty: 'easy',
                    duration: '10-15 min',
                    concepts: ['Cells', 'Organelles', 'Biology', 'Microscopy'],
                    completed: false,
                    score: null
                }
            ],
            computer: [
                { 
                    id: 'coding-visualizer',
                    name: 'Coding Visualizer',
                    file: '',
                    icon: 'fas fa-code',
                    color: '#6f42c1',
                    description: 'Visualize code execution and algorithms (Coming Soon)',
                    difficulty: 'medium',
                    duration: '15-20 min',
                    concepts: ['Programming', 'Algorithms', 'Code Execution', 'Debugging'],
                    completed: false,
                    score: null
                }
            ]
        };
        function loadSimulationsPage() {
            const grid = document.getElementById('simulationsGrid');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const activeSubject = document.querySelector('.filter-btn.active')?.dataset.subject || 'all';
            
            // Clear existing content
            grid.innerHTML = '';
            
            // Prepare all simulations
            let allSimulations = [];
            
            // Add physics simulations
            SIMULATIONS_DATA.physics.forEach(sim => {
                sim.subject = 'physics';
                sim.subjectName = 'Physics';
                sim.available = sim.file !== '';
                allSimulations.push(sim);
            });
            
            // Add math simulations
            SIMULATIONS_DATA.math.forEach(sim => {
                sim.subject = 'math';
                sim.subjectName = 'Mathematics';
                sim.available = sim.file !== '';
                allSimulations.push(sim);
            });
            
            // Add coming soon subjects
            ['chemistry', 'biology', 'computer'].forEach(subject => {
                SIMULATIONS_DATA[subject].forEach(sim => {
                    sim.subject = subject;
                    sim.subjectName = subject.charAt(0).toUpperCase() + subject.slice(1);
                    sim.available = sim.file !== '';
                    allSimulations.push(sim);
                });
            });
            
            // Apply filters
            let filteredSimulations = allSimulations;
            
            // Apply subject filter
            if (activeSubject !== 'all') {
                filteredSimulations = filteredSimulations.filter(sim => sim.subject === activeSubject);
            }
            
            // Apply search filter
            if (searchTerm) {
                filteredSimulations = filteredSimulations.filter(sim => 
                    sim.name.toLowerCase().includes(searchTerm) ||
                    sim.description.toLowerCase().includes(searchTerm) ||
                    sim.concepts.some(concept => concept.toLowerCase().includes(searchTerm))
                );
            }
            
            // Display simulations
            if (filteredSimulations.length > 0) {
                filteredSimulations.forEach(simulation => {
                    const card = createSimulationCard(simulation);
                    grid.appendChild(card);
                });
            } else {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #888;">
                        <i class="fas fa-flask" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <h3>No simulations found</h3>
                        <p>Try a different search term or select another subject</p>
                    </div>
                `;
            }
        }

        function createSimulationCard(simulation) {
            const card = document.createElement('div');
            card.className = `simulation-card ${!simulation.available ? 'coming-soon-card' : ''}`;
            
            // Set CSS variable for subject color
            card.style.setProperty('--subject-color', simulation.color);
            
            // Get difficulty badge
            const difficultyBadge = getDifficultyBadge(simulation.difficulty);
            
            card.innerHTML = `
                <div class="simulation-image">
                    <i class="${simulation.icon}"></i>
                </div>
                <div class="simulation-content">
                    <div class="simulation-title">${simulation.name}</div>
                    <div class="simulation-desc">${simulation.description}</div>
                    <div class="simulation-meta">
                        <span class="simulation-tag">${simulation.subjectName}</span>
                        <span class="simulation-difficulty">
                            <span class="difficulty-dot ${difficultyBadge.class}"></span>
                            ${simulation.difficulty.charAt(0).toUpperCase() + simulation.difficulty.slice(1)}
                        </span>
                    </div>
                    <div class="simulation-stats">
                        <div class="simulation-stat">
                            <i class="fas fa-clock"></i>
                            ${simulation.duration}
                        </div>
                        <div class="simulation-stat">
                            <i class="fas fa-graduation-cap"></i>
                            ${simulation.concepts.length} concepts
                        </div>
                    </div>
                    <button class="btn ${!simulation.available ? 'btn-secondary' : ''}" 
                            onclick="${simulation.available ? `viewSimulationDetails('${simulation.id}', '${simulation.subject}')` : 'void(0)'}"
                            style="margin-top: 15px; width: 100%;"
                            ${!simulation.available ? 'disabled' : ''}>
                        <i class="fas fa-${simulation.available ? 'play' : 'clock'}"></i>
                        ${simulation.available ? 'Start Simulation' : 'Coming Soon'}
                    </button>
                </div>
            `;
            
            return card;
        }

        function getDifficultyBadge(difficulty) {
            const badges = {
                'easy': { class: 'difficulty-easy', color: '#28a745' },
                'medium': { class: 'difficulty-medium', color: '#ffc107' },
                'hard': { class: 'difficulty-hard', color: '#dc3545' }
            };
            return badges[difficulty] || badges.medium;
        }

        function viewSimulationDetails(simId, subject) {
            const simulation = SIMULATIONS_DATA[subject].find(s => s.id === simId);
            if (!simulation) return;
            
            currentSelectedSimulation = simulation;
            
            // Update modal content
            document.getElementById('modalSimulationTitle').textContent = simulation.name;
            document.getElementById('modalSubject').textContent = subject.charAt(0).toUpperCase() + subject.slice(1);
            document.getElementById('modalDifficulty').innerHTML = `
                <span class="difficulty-dot ${getDifficultyBadge(simulation.difficulty).class}"></span>
                ${simulation.difficulty.charAt(0).toUpperCase() + simulation.difficulty.slice(1)}
            `;
            document.getElementById('modalDuration').textContent = simulation.duration;
            document.getElementById('modalConcepts').textContent = simulation.concepts.join(', ');
            document.getElementById('modalDescription').textContent = simulation.description;
            
            // Update launch button
            const launchBtn = document.getElementById('launchBtn');
            launchBtn.onclick = () => launchSimulation();
            launchBtn.innerHTML = `<i class="fas fa-rocket"></i> Launch Simulation`;
            
            // Show modal
            document.getElementById('simulationModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('simulationModal').style.display = 'none';
            currentSelectedSimulation = null;
        }

        function launchSimulation() {
            if (!currentSelectedSimulation) return;
            
            const simulation = currentSelectedSimulation;
            
            if (!simulation.file) {
                alert('This simulation is not available yet. Coming soon!');
                return;
            }
            
            // Map simulator filenames  clean URLs (no .html in address bar)
            const SIM_URL = {
                // Physics
                'MOTIONCLASSIFIERSIM.html':             '/sim/physics/motion-classifier',
                'Motiontimersim.html':                  '/sim/physics/motion-timer',
                'Projectilemotionsimulator.html':       '/sim/physics/projectile',
                'ShadowFormationSimulator.html':        '/sim/physics/shadow-formation',
                'WeatherSystemModel.html':              '/sim/physics/weather',
                'SoundWaveGenerator.html':              '/sim/physics/sound-wave',
                'HeatFlowSimulator.html':               '/sim/physics/heat-flow',
                'Lightpathvisualizer.html':             '/sim/physics/light-path',
                'Newtonslawsdemonstrator.html':         '/sim/physics/newtons-laws',
                'Magneticfieldvisualizer.html':         '/sim/physics/magnetic-field',
                'Gaspropertiessimulator.html':          '/sim/physics/gas-properties',
                'Electrolysissimulator.html':           '/sim/physics/electrolysis',
                'Force visualizer.html':                '/sim/physics/force',
                'Forcevisualizer.html':                 '/sim/physics/force',
                'GravitySimulator.html':                '/sim/physics/gravity',
                'ElectricFieldMapper.html':             '/sim/physics/electric-field',
                'Raydiagrambuilder.html':               '/sim/physics/ray-diagram',
                'EnergyTransformationVisualizer.html':  '/sim/physics/energy-transform',
                'Simplecircuitbuilder.html':            '/sim/physics/circuit-builder',
                // Math
                'shapebuilder.html':                    '/sim/math/shapes',
                'Fractionpievisualizer.html':           '/sim/math/fraction-pie',
                'Equationsolver.html':                  '/sim/math/equation-sol',
                'Datasetanalyzer.html':                 '/sim/math/data-analyzer',
                'Unitcirclesimulator.html':             '/sim/math/unit-circle',
                '3DVectorVisualizer.html':              '/sim/math/vector',
                'polynomialgrapher.html':               '/sim/math/polynomial',
                'QuadraticExplorer.html':               '/sim/math/quadratic',
                'coordinateplotter.html':               '/sim/math/coordinates',
                'CoordinatePlotter.html':               '/sim/math/coordinates',
                'Equationbalancer.html':                '/sim/math/equation-bal',
                'Geometricproofbuilder.html':           '/sim/math/geometry-proof',
                'CalculusVisualizer.html':              '/sim/math/calculus',
                'TrigonometryVisualizer.html':          '/sim/math/trigonometry',
                'ProbabilitySimulator.html':            '/sim/math/probability',
                'InteractiveGraphMaker.html':           '/sim/math/graph-maker',
                'RatioVisualizer.html':                 '/sim/math/ratio',
                'SymmetryExplorer.html':                '/sim/math/symmetry',
            };

            const cleanUrl = SIM_URL[simulation.file];
            if (!cleanUrl) {
                alert('This simulation is not available yet. Coming soon!');
                return;
            }

            // Open simulation using clean URL
            window.open(cleanUrl, '_blank');
            
            // Close modal
            closeModal();
        }

        function generateChallengeForSimulation() {
            if (!currentSelectedSimulation) return;
            
            // Open challenge.html in new tab
            window.open('/challenge', '_blank');
            
            closeModal();
        }

        // ================================================================
        // SUBJECT FILTER FUNCTIONALITY
        // ================================================================
        function setupSubjectFilters() {
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all buttons
                    filterButtons.forEach(b => b.classList.remove('active'));
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Reload simulations with new filter
                    loadSimulationsPage();
                });
            });
        }

        // ================================================================
        // SEARCH FUNCTIONALITY
        // ================================================================
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    if (document.getElementById('simulations').classList.contains('active')) {
                        loadSimulationsPage();
                    }
                }, 300);
            });
        }

        // ================================================================
        // SESSION TIMER
        // ================================================================
        function startSessionTimer() {
            let sessionSeconds = 0;
            setInterval(() => {
                sessionSeconds++;
                const minutes = Math.floor(sessionSeconds / 60);
                document.getElementById('sessionTime').textContent = `Session: ${minutes} min`;
            }, 60000);
            
            document.getElementById('sessionTime').textContent = 'Session: 0 min';
        }

        // ================================================================
        // LOGOUT
        // ================================================================
        function logoutStudent(event) {
            event.stopPropagation();
            
            if (confirm('Are you sure you want to logout?')) {
                // Clear all stored data
                localStorage.removeItem('authToken');
                sessionStorage.removeItem('studentOverview');
                STUDENT_OVERVIEW = null;
                
                // Redirect to login page
                window.location.href = '/login';
            }
        }

        // ================================================================
        // REASONING PAD
        // ================================================================
        function openReasoningPad(event) {
            event.stopPropagation();
            window.open('/math-lab', 'ReasoningPad', 'width=1400,height=900,resizable=yes,scrollbars=yes');
        }

        // ================================================================
        // INITIALIZATION
        // ================================================================
        async function init() {
            if (isInitializing) return;
            isInitializing = true;
            
            // Check for token
            authToken = localStorage.getItem('authToken');
            if (!authToken) {
                window.location.href = '/login';
                return;
            }
            
            showLoading();
            
            try {
                // Update date
                document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                // Setup UI components
                setupSubjectFilters();
                setupSearch();
                startSessionTimer();
                
                // Load student data (SINGLE API CALL)
                await loadStudentOverview();
                
                console.log(' Dashboard initialized successfully');
                
            } catch (error) {
                console.error(' Initialization error:', error);
                if (error.message.includes('401')) {
                    window.location.href = '/login';
                }
            } finally {
                hideLoading();
                isInitializing = false;
            }
        }

        // ================================================================
        // EVENT LISTENERS
        // ================================================================
        document.addEventListener('DOMContentLoaded', () => {
            // Add click handler to nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(event) {
                    const pageId = this.getAttribute('data-page');
                    if (pageId) {
                        showPage(pageId);
                    }
                });
            });
            
            // Search functionality
            document.getElementById('searchInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const searchTerm = e.target.value.trim();
                    if (searchTerm) {
                        if (document.getElementById('simulations').classList.contains('active')) {
                            loadSimulationsPage();
                        } else {
                            showPage('simulations');
                            setTimeout(() => {
                                document.getElementById('searchInput').value = searchTerm;
                                loadSimulationsPage();
                            }, 100);
                        }
                    }
                }
            });
            
            // Notification bell click
            document.getElementById('notificationBell').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleStudentNotif();
            });

            // Close notif panel when clicking outside
            document.addEventListener('click', (e) => {
                const panel = document.getElementById('studentNotifPanel');
                const bell = document.getElementById('notificationBell');
                if (panel && panel.style.display !== 'none' && !bell.contains(e.target)) {
                    panel.style.display = 'none';
                }
            });
            
            // User menu click
            document.getElementById('userMenu').addEventListener('click', () => {
                alert('User menu options coming soon!');
            });
            
            // Start the app
            init();
        });

        // ================================================================
        // ERROR HANDLING
        // ================================================================
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            showRateLimitNotification('An unexpected error occurred. Please refresh the page.');
        });

        // Close modal on ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Close modal on click outside
        document.getElementById('simulationModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('simulationModal')) {
                closeModal();
            }
        });

        // ================================================================
        // RESPONSIVE SIDEBAR TOGGLE
        // ================================================================
        (function() {
            const sidebar  = document.getElementById('sidebar');
            const toggle   = document.getElementById('sidebarToggle');
            const overlay  = document.getElementById('sidebarOverlay');
            if (!sidebar || !toggle) return;
            function openSidebar()  { sidebar.classList.add('open');    overlay.classList.add('active'); }
            function closeSidebar() { sidebar.classList.remove('open'); overlay.classList.remove('active'); }
            toggle.addEventListener('click', () => sidebar.classList.contains('open') ? closeSidebar() : openSidebar());
            overlay.addEventListener('click', closeSidebar);
            sidebar.querySelectorAll('.nav-item').forEach(el => {
                el.addEventListener('click', () => { if (window.innerWidth <= 992) closeSidebar(); });
            });
        })();
    </script>
</body>
</html>