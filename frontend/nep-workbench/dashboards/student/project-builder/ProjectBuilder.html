<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Builder - NEP Workbench</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        :root { --bg: #1e1e1e; --panel: #252526; --accent: #007acc; --success: #00b894; }
        body { background: var(--bg); color: #fff; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: #333; border-radius: 8px; padding: 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { font-size: 24px; color: var(--accent); }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; background: var(--accent); color: white; transition: all 0.3s; }
        .main { display: grid; grid-template-columns: 250px 1fr; gap: 20px; }
        .panel { background: var(--panel); border-radius: 8px; padding: 20px; border: 1px solid #464647; }
        .stage { padding: 15px; background: #2d2d30; border-radius: 6px; margin: 10px 0; cursor: pointer; transition: all 0.3s; border-left: 4px solid #464647; }
        .stage.active { background: rgba(0, 122, 204, 0.2); border-left-color: var(--accent); }
        .stage.complete { border-left-color: var(--success); }
        .stage-title { font-weight: 600; margin-bottom: 5px; }
        .stage-desc { font-size: 12px; color: #888; }
        .content-area { background: var(--bg); border-radius: 6px; padding: 30px; border: 1px solid #464647; min-height: 500px; }
        textarea { background: #2d2d30; border: 2px solid #464647; padding: 15px; border-radius: 6px; color: #fff; width: 100%; min-height: 150px; font-family: inherit; resize: vertical; }
        textarea:focus { outline: none; border-color: var(--accent); }
        input[type="text"] { background: #2d2d30; border: 2px solid #464647; padding: 12px; border-radius: 6px; color: #fff; width: 100%; }
        input[type="text"]:focus { outline: none; border-color: var(--accent); }
        .milestone-item { background: #2d2d30; padding: 15px; border-radius: 6px; margin: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .checkbox { width: 20px; height: 20px; background: var(--bg); border: 2px solid #464647; border-radius: 4px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
        .checkbox.checked { background: var(--success); border-color: var(--success); }
        .add-btn { background: #2d2d30; border: 2px dashed #464647; padding: 15px; border-radius: 6px; text-align: center; cursor: pointer; color: #888; transition: all 0.3s; }
        .add-btn:hover { border-color: var(--accent); color: var(--accent); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div><h1><i class="fas fa-project-diagram"></i> Project Builder</h1><p style="color: #888;">Cross-curricular â€¢ Extended Inquiry</p></div>
            <div style="display: flex; gap: 15px;">
                <span><i class="fas fa-clock"></i> <span id="timer">00:00</span></span>
                <span><i class="fas fa-tasks"></i> <span id="progress">0</span>% Complete</span>
                <button class="btn" onclick="saveProgress()"><i class="fas fa-save"></i> Save</button>
                <button class="btn" style="background: #00b894;" onclick="complete()"><i class="fas fa-check"></i> Complete</button>
            </div>
        </div>
        
        <div class="main">
            <div class="panel">
                <h2 style="margin-bottom: 15px;">Project Stages</h2>
                
                <div class="stage active" onclick="goToStage(0)">
                    <div class="stage-title"><i class="fas fa-lightbulb"></i> Ideation</div>
                    <div class="stage-desc">Define your project</div>
                </div>
                
                <div class="stage" onclick="goToStage(1)">
                    <div class="stage-title"><i class="fas fa-search"></i> Research</div>
                    <div class="stage-desc">Gather information</div>
                </div>
                
                <div class="stage" onclick="goToStage(2)">
                    <div class="stage-title"><i class="fas fa-pencil-ruler"></i> Planning</div>
                    <div class="stage-desc">Create timeline</div>
                </div>
                
                <div class="stage" onclick="goToStage(3)">
                    <div class="stage-title"><i class="fas fa-tools"></i> Execution</div>
                    <div class="stage-desc">Build your project</div>
                </div>
                
                <div class="stage" onclick="goToStage(4)">
                    <div class="stage-title"><i class="fas fa-presentation"></i> Presentation</div>
                    <div class="stage-desc">Share your work</div>
                </div>
                
                <div style="background: #2d2d30; padding: 15px; border-radius: 6px; margin-top: 20px;">
                    <div style="color: #888; font-size: 12px; margin-bottom: 10px;">Overall Progress</div>
                    <div style="background: var(--bg); height: 12px; border-radius: 6px; overflow: hidden;">
                        <div id="overallProgress" style="height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); width: 0%; transition: width 0.3s;"></div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <div id="contentArea" class="content-area">
                    <!-- Stage content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        const API_BASE_URL = 'http://localhost:3000/api';
        const authToken = localStorage.getItem('authToken');
        let eventId = null, sessionStart = Date.now(), currentStage = 0;
        
        let projectData = {
            title: '',
            description: '',
            research: { sources: [], notes: '' },
            plan: { milestones: [], resources: '' },
            execution: { tasks: [], progress: 0 },
            presentation: { format: '', outline: '' }
        };
        
        let interactionData = {
            actions_count: 0, time_seconds: 0, total_parameter_space: 100,
            tool_usage: {}, stages_completed: new Set(), milestones_created: 0,
            tasks_completed: 0, words_written: 0
        };
        
        async function init() {
            if (authToken) {
                try {
                    const studentId = JSON.parse(atob(authToken.split('.')[1])).userId;
                    const res = await fetch(`${API_BASE_URL}/student/event`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ studentId, toolId: 'project-builder', toolType: 'PROJECT', interactionData })
                    });
                    if (res.ok) eventId = (await res.json()).data._id;
                } catch (err) {}
            }
            
            loadStage(0);
            setInterval(() => {
                const e = Math.floor((Date.now() - sessionStart) / 1000);
                document.getElementById('timer').textContent = `${Math.floor(e/60).toString().padStart(2,'0')}:${(e%60).toString().padStart(2,'0')}`;
            }, 1000);
            setInterval(saveProgress, 30000);
        }
        
        function goToStage(stage) {
            currentStage = stage;
            document.querySelectorAll('.stage').forEach((s, i) => {
                s.classList.remove('active');
                if (i === stage) s.classList.add('active');
            });
            loadStage(stage);
            interactionData.actions_count++;
        }
        
        function loadStage(stage) {
            const area = document.getElementById('contentArea');
            
            if (stage === 0) {
                area.innerHTML = `
                    <h2 style="margin-bottom: 20px;"><i class="fas fa-lightbulb"></i> Project Ideation</h2>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #888;">Project Title</label>
                        <input type="text" id="projectTitle" value="${projectData.title}" placeholder="Enter your project title...">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #888;">Project Description</label>
                        <textarea id="projectDesc" placeholder="Describe your project idea, goals, and expected outcomes...">${projectData.description}</textarea>
                    </div>
                    <button class="btn" onclick="saveStage0()"><i class="fas fa-arrow-right"></i> Next: Research</button>
                `;
            } else if (stage === 1) {
                area.innerHTML = `
                    <h2 style="margin-bottom: 20px;"><i class="fas fa-search"></i> Research Phase</h2>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #888;">Research Notes</label>
                        <textarea id="researchNotes" placeholder="Document your research findings, key facts, and important information...">${projectData.research.notes}</textarea>
                    </div>
                    <h3 style="margin: 20px 0 10px;">Sources</h3>
                    <div id="sourcesList">
                        ${projectData.research.sources.map((s, i) => `
                            <div class="milestone-item">
                                <span>${s}</span>
                                <i class="fas fa-times" style="cursor: pointer; color: #e74c3c;" onclick="removeSource(${i})"></i>
                            </div>
                        `).join('')}
                    </div>
                    <div class="add-btn" onclick="addSource()"><i class="fas fa-plus"></i> Add Source</div>
                    <button class="btn" style="margin-top: 20px;" onclick="saveStage1()"><i class="fas fa-arrow-right"></i> Next: Planning</button>
                `;
            } else if (stage === 2) {
                area.innerHTML = `
                    <h2 style="margin-bottom: 20px;"><i class="fas fa-pencil-ruler"></i> Project Planning</h2>
                    <h3 style="margin: 20px 0 10px;">Milestones</h3>
                    <div id="milestonesList">
                        ${projectData.plan.milestones.map((m, i) => `
                            <div class="milestone-item">
                                <div>
                                    <div style="font-weight: 600;">${m.title}</div>
                                    <div style="font-size: 12px; color: #888;">${m.deadline}</div>
                                </div>
                                <div class="checkbox ${m.done ? 'checked' : ''}" onclick="toggleMilestone(${i})">
                                    ${m.done ? '<i class="fas fa-check"></i>' : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="add-btn" onclick="addMilestone()"><i class="fas fa-plus"></i> Add Milestone</div>
                    <div style="margin-top: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #888;">Resources Needed</label>
                        <textarea id="resources" placeholder="List materials, tools, and resources required...">${projectData.plan.resources}</textarea>
                    </div>
                    <button class="btn" style="margin-top: 20px;" onclick="saveStage2()"><i class="fas fa-arrow-right"></i> Next: Execution</button>
                `;
            } else if (stage === 3) {
                area.innerHTML = `
                    <h2 style="margin-bottom: 20px;"><i class="fas fa-tools"></i> Project Execution</h2>
                    <h3 style="margin: 20px 0 10px;">Tasks</h3>
                    <div id="tasksList">
                        ${projectData.execution.tasks.map((t, i) => `
                            <div class="milestone-item">
                                <span>${t.name}</span>
                                <div class="checkbox ${t.done ? 'checked' : ''}" onclick="toggleTask(${i})">
                                    ${t.done ? '<i class="fas fa-check"></i>' : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="add-btn" onclick="addTask()"><i class="fas fa-plus"></i> Add Task</div>
                    <button class="btn" style="margin-top: 20px;" onclick="saveStage3()"><i class="fas fa-arrow-right"></i> Next: Presentation</button>
                `;
            } else if (stage === 4) {
                area.innerHTML = `
                    <h2 style="margin-bottom: 20px;"><i class="fas fa-presentation"></i> Presentation</h2>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #888;">Presentation Format</label>
                        <select id="presFormat" style="background: #2d2d30; border: 2px solid #464647; padding: 12px; border-radius: 6px; color: #fff; width: 100%;">
                            <option value="slides" ${projectData.presentation.format === 'slides' ? 'selected' : ''}>Slides</option>
                            <option value="poster" ${projectData.presentation.format === 'poster' ? 'selected' : ''}>Poster</option>
                            <option value="video" ${projectData.presentation.format === 'video' ? 'selected' : ''}>Video</option>
                            <option value="demo" ${projectData.presentation.format === 'demo' ? 'selected' : ''}>Live Demo</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #888;">Presentation Outline</label>
                        <textarea id="presOutline" placeholder="Outline your presentation structure and key points...">${projectData.presentation.outline}</textarea>
                    </div>
                    <button class="btn" onclick="saveStage4()"><i class="fas fa-check"></i> Finalize Project</button>
                `;
            }
        }
        
        function saveStage0() {
            projectData.title = document.getElementById('projectTitle').value;
            projectData.description = document.getElementById('projectDesc').value;
            interactionData.words_written += projectData.description.split(' ').length;
            interactionData.stages_completed.add(0);
            goToStage(1);
            updateProgress();
        }
        
        function saveStage1() {
            projectData.research.notes = document.getElementById('researchNotes').value;
            interactionData.words_written += projectData.research.notes.split(' ').length;
            interactionData.stages_completed.add(1);
            goToStage(2);
            updateProgress();
        }
        
        function saveStage2() {
            projectData.plan.resources = document.getElementById('resources').value;
            interactionData.stages_completed.add(2);
            goToStage(3);
            updateProgress();
        }
        
        function saveStage3() {
            interactionData.stages_completed.add(3);
            goToStage(4);
            updateProgress();
        }
        
        function saveStage4() {
            projectData.presentation.format = document.getElementById('presFormat').value;
            projectData.presentation.outline = document.getElementById('presOutline').value;
            interactionData.words_written += projectData.presentation.outline.split(' ').length;
            interactionData.stages_completed.add(4);
            updateProgress();
            alert('Project finalized! Great work!');
        }
        
        function addSource() {
            const source = prompt('Enter source (URL, book, article):');
            if (source) {
                projectData.research.sources.push(source);
                loadStage(1);
                interactionData.actions_count++;
            }
        }
        
        function removeSource(i) {
            projectData.research.sources.splice(i, 1);
            loadStage(1);
        }
        
        function addMilestone() {
            const title = prompt('Milestone title:');
            const deadline = prompt('Deadline (e.g., Week 2):');
            if (title && deadline) {
                projectData.plan.milestones.push({ title, deadline, done: false });
                interactionData.milestones_created++;
                loadStage(2);
                interactionData.actions_count++;
            }
        }
        
        function toggleMilestone(i) {
            projectData.plan.milestones[i].done = !projectData.plan.milestones[i].done;
            loadStage(2);
            updateProgress();
        }
        
        function addTask() {
            const name = prompt('Task name:');
            if (name) {
                projectData.execution.tasks.push({ name, done: false });
                loadStage(3);
                interactionData.actions_count++;
            }
        }
        
        function toggleTask(i) {
            projectData.execution.tasks[i].done = !projectData.execution.tasks[i].done;
            if (projectData.execution.tasks[i].done) {
                interactionData.tasks_completed++;
            }
            loadStage(3);
            updateProgress();
        }
        
        function updateProgress() {
            const stages = interactionData.stages_completed.size;
            const progress = Math.round((stages / 5) * 100);
            
            document.getElementById('progress').textContent = progress;
            document.getElementById('overallProgress').style.width = progress + '%';
            
            document.querySelectorAll('.stage').forEach((s, i) => {
                if (interactionData.stages_completed.has(i)) {
                    s.classList.add('complete');
                }
            });
        }
        
        async function saveProgress() {
            if (!eventId) return;
            interactionData.time_seconds = Math.floor((Date.now() - sessionStart) / 1000);
            interactionData.stages_completed = Array.from(interactionData.stages_completed);
            interactionData.project_data = projectData;
            try {
                await fetch(`${API_BASE_URL}/student/event/${eventId}`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interactionData })
                });
            } catch (err) {}
        }
        
        async function complete() {
            await saveProgress();
            alert('Project saved successfully!');
            window.location.href = '/dashboard';
        }
        
        window.addEventListener('load', init);
        window.addEventListener('beforeunload', saveProgress);
    </script>
</body>
</html>