<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard - NEP Workbench</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        
        :root {
            --bg-dark: #1e1e1e;
            --panel-dark: #252526;
            --border-color: #464647;
            --accent-blue: #007acc;
            --accent-cyan: #00d4ff;
            --success-green: #27ae60;
            --warning-yellow: #f39c12;
            --danger-red: #e74c3c;
            --text-primary: #ffffff;
            --text-secondary: #888888;
        }
        
        body { 
            background: var(--bg-dark); 
            color: var(--text-primary); 
            overflow-x: hidden; 
        }
        
        /* DASHBOARD LAYOUT */
        .dashboard {
            display: grid;
            grid-template-rows: 60px 1fr;
            grid-template-columns: 250px 1fr;
            height: 100vh;
        }
        
        /* HEADER */
        .header {
            grid-column: 1 / -1;
            background: #333337;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 30px;
            gap: 20px;
            z-index: 100;
        }
        
        .logo {
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-left: auto;
        }
        
        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .notification-bell:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--danger-red);
            color: white;
            font-size: 0.65rem;
            padding: 2px 5px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 8px;
            transition: background 0.3s;
        }
        
        .user-info:hover { 
            background: #3e3e42; 
        }
        
        .avatar {
            width: 38px;
            height: 38px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
        }
        
        .user-name {
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .user-role {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        /* SIDEBAR */
        .sidebar {
            background: var(--panel-dark);
            border-right: 1px solid var(--border-color);
            padding: 20px 0;
            overflow-y: auto;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 14px 25px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-secondary);
            font-size: 0.95rem;
            position: relative;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }
        
        .nav-item.active {
            background: rgba(0, 122, 204, 0.15);
            color: var(--accent-cyan);
            border-left: 3px solid var(--accent-cyan);
        }
        
        .nav-item i {
            width: 20px;
            text-align: center;
        }
        
        .badge-notification {
            position: absolute;
            right: 20px;
            background: var(--danger-red);
            color: white;
            font-size: 0.7rem;
            padding: 2px 7px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        /* MAIN CONTENT */
        .main-content {
            background: var(--bg-dark);
            overflow-y: auto;
            padding: 30px;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* HEADER SECTION */
        .page-header {
            margin-bottom: 25px;
        }
        
        .page-header h1 {
            font-size: 2rem;
            margin-bottom: 8px;
        }
        
        .page-header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }
        
        /* STATISTICS CARDS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--panel-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--accent-blue), var(--accent-cyan));
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 212, 255, 0.1);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, rgba(0, 122, 204, 0.2), rgba(0, 212, 255, 0.2));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--accent-cyan);
        }
        
        .stat-details {
            flex: 1;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .stat-change {
            font-size: 0.75rem;
            margin-top: 5px;
        }
        
        .stat-change.positive {
            color: var(--success-green);
        }
        
        .stat-change.negative {
            color: var(--danger-red);
        }
        
        /* PANELS */
        .panel {
            background: var(--panel-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .panel-header h2 {
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-actions {
            display: flex;
            gap: 10px;
        }
        
        /* CHARTS GRID */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .chart-container {
            background: var(--panel-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            height: 350px;
        }
        
        .chart-container.full-width {
            grid-column: 1 / -1;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .chart-filters {
            display: flex;
            gap: 8px;
        }
        
        .filter-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }
        
        .filter-btn:hover,
        .filter-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }
        
        .chart-canvas {
            height: 260px;
        }
        
        /* TABLES */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: rgba(255, 255, 255, 0.02);
        }
        
        th {
            text-align: left;
            padding: 15px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border-color);
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        tbody tr {
            transition: background 0.2s;
        }
        
        tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        
        /* BUTTONS */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.3);
        }
        
        .btn-secondary {
            background: var(--panel-dark);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .btn-success {
            background: var(--success-green);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning-yellow);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger-red);
            color: white;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }
        
        /* BADGES */
        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .badge-success {
            background: rgba(39, 174, 96, 0.2);
            color: var(--success-green);
        }
        
        .badge-warning {
            background: rgba(243, 156, 18, 0.2);
            color: var(--warning-yellow);
        }
        
        .badge-danger {
            background: rgba(231, 76, 60, 0.2);
            color: var(--danger-red);
        }
        
        .badge-info {
            background: rgba(0, 122, 204, 0.2);
            color: var(--accent-cyan);
        }
        
        /* PROGRESS BAR */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
            border-radius: 10px;
            transition: width 0.3s;
        }
        
        /* STUDENT CARDS */
        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .student-card {
            background: var(--panel-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .student-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .student-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .student-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        .student-info h3 {
            font-size: 1rem;
            margin-bottom: 3px;
        }
        
        .student-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .student-stats {
            margin-top: 15px;
        }
        
        .student-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.85rem;
        }
        
        .student-stat label {
            color: var(--text-secondary);
        }
        
        .student-stat value {
            font-weight: 600;
        }
        
        /* ALERT CARDS */
        .alert-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .alert-card {
            background: var(--panel-dark);
            border-left: 4px solid var(--danger-red);
            border-radius: 8px;
            padding: 20px;
        }
        
        .alert-card.warning {
            border-left-color: var(--warning-yellow);
        }
        
        .alert-card.info {
            border-left-color: var(--accent-cyan);
        }
        
        .alert-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }
        
        .alert-icon {
            width: 40px;
            height: 40px;
            background: rgba(231, 76, 60, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--danger-red);
        }
        
        .alert-card.warning .alert-icon {
            background: rgba(243, 156, 18, 0.2);
            color: var(--warning-yellow);
        }
        
        /* MODAL */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: var(--panel-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            transition: color 0.3s;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: 25px;
        }
        
        /* SEARCH & FILTERS */
        .filters-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        
        /* DARK THEME DROPDOWN STYLES */
        select, .select-style {
            padding: 12px 15px;
            background: var(--panel-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
            padding-right: 40px;
        }
        
        select:hover, .select-style:hover {
            border-color: var(--accent-blue);
        }
        
        select:focus, .select-style:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
        }
        
        select option, .select-style option {
            background: var(--panel-dark);
            color: var(--text-primary);
            padding: 10px;
        }
        
        /* FORM CONTROLS */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        
        /* SWITCH TOGGLE */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--accent-blue);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* PROFILE PAGE */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 2.5rem;
        }
        
        .profile-info h2 {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .profile-meta {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }
        
        .profile-card {
            background: var(--panel-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
        }
        
        .profile-card h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }
        
        /* LOADING STATE */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* RESPONSIVE */
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 200px 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- HEADER -->
        <div class="header">
            <div class="logo">
                <i class="fas fa-graduation-cap"></i>
                NEP Workbench
            </div>
            
            <div class="header-actions">
                <div class="notification-bell">
                    <i class="fas fa-bell" style="font-size: 1.2rem;"></i>
                    <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
                </div>
                
                <div class="user-info" onclick="toggleUserMenu()">
                    <div class="avatar" id="userAvatar">T</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Teacher Name</div>
                        <div class="user-role">Teacher</div>
                    </div>
                    <i class="fas fa-chevron-down" style="font-size: 0.8rem;"></i>
                </div>
            </div>
        </div>
        
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="nav-item active" onclick="showPage('overview')">
                <i class="fas fa-home"></i>
                <span>Overview</span>
            </div>
            <div class="nav-item" onclick="showPage('students')">
                <i class="fas fa-users"></i>
                <span>My Students</span>
            </div>
            <div class="nav-item" onclick="showPage('validations')">
                <i class="fas fa-check-circle"></i>
                <span>Validation Queue</span>
                <span class="badge-notification" id="pendingCount" style="display:none;">0</span>
            </div>
            <div class="nav-item" onclick="showPage('classes')">
                <i class="fas fa-chalkboard"></i>
                <span>Classes</span>
            </div>
            <div class="nav-item" onclick="showPage('analytics')">
                <i class="fas fa-chart-line"></i>
                <span>Analytics</span>
            </div>
            <div class="nav-item" onclick="showPage('reports')">
                <i class="fas fa-file-alt"></i>
                <span>Reports</span>
            </div>
            <div class="nav-item" onclick="showPage('profile')">
                <i class="fas fa-user"></i>
                <span>My Profile</span>
            </div>
            <div class="nav-item" onclick="showPage('help')">
                <i class="fas fa-question-circle"></i>
                <span>Help Tickets</span>
            </div>
            <div class="nav-item" style="margin-top: auto; border-top: 1px solid var(--border-color); padding-top: 20px;" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </div>
        </div>
        
        <!-- MAIN CONTENT -->
        <div class="main-content">
            
            <!-- OVERVIEW PAGE -->
            <div class="page active" id="overview">
                <div class="page-header">
                    <h1>Welcome back, <span id="teacherNameDisplay">Teacher</span>! ðŸ‘‹</h1>
                    <p>Here's your classroom overview for today</p>
                </div>
                
                <!-- STATISTICS CARDS -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="totalStudents">0</div>
                            <div class="stat-label">Total Students</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i> Active
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="avgPerformance">0%</div>
                            <div class="stat-label">Average Performance</div>
                            <div class="stat-change" id="performanceChange">
                                <i class="fas fa-minus"></i> No change
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="totalChallenges">0</div>
                            <div class="stat-label">Total Challenges</div>
                            <div class="stat-change positive">
                                <i class="fas fa-check"></i> Evaluated
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="pendingReviews">0</div>
                            <div class="stat-label">Pending Reviews</div>
                            <div class="stat-change warning">
                                <i class="fas fa-hourglass-half"></i> Awaiting
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="totalClasses">0</div>
                            <div class="stat-label">Active Classes</div>
                            <div class="stat-change positive">
                                <i class="fas fa-check"></i> Running
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-life-ring"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="openTickets">0</div>
                            <div class="stat-label">Open Tickets</div>
                            <div class="stat-change" id="ticketChange">
                                <i class="fas fa-minus"></i> Support
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- CHARTS SECTION -->
                <div class="charts-grid">
                    <!-- PERFORMANCE TREND CHART -->
                    <div class="chart-container full-width">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-line"></i> Student Performance Trend</h3>
                            <div class="chart-filters">
                                <button class="filter-btn active" data-period="7">7 Days</button>
                                <button class="filter-btn" data-period="30">30 Days</button>
                                <button class="filter-btn" data-period="90">3 Months</button>
                            </div>
                        </div>
                        <div class="chart-canvas">
                            <canvas id="performanceTrendChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- COMPETENCY RADAR CHART -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3><i class="fas fa-brain"></i> NEP Competencies</h3>
                        </div>
                        <div class="chart-canvas">
                            <canvas id="competencyRadarChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- CHALLENGE STATUS PIE CHART -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3><i class="fas fa-tasks"></i> Challenge Status</h3>
                        </div>
                        <div class="chart-canvas">
                            <canvas id="challengeStatusChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- PERFORMANCE DISTRIBUTION -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-bar"></i> Performance Distribution</h3>
                        </div>
                        <div class="chart-canvas">
                            <canvas id="performanceDistributionChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- SIMULATION USAGE -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3><i class="fas fa-flask"></i> Top Simulations</h3>
                        </div>
                        <div class="chart-canvas">
                            <canvas id="simulationUsageChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- STUDENTS NEEDING ATTENTION -->
                <div class="panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-exclamation-triangle"></i> Students Needing Attention</h2>
                        <button class="btn btn-secondary btn-sm">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                    </div>
                    
                    <div class="alert-grid" id="studentsNeedingAttention">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading students...</p>
                        </div>
                    </div>
                </div>
                
                <!-- TOP PERFORMERS -->
                <div class="panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-trophy"></i> Top Performers</h2>
                        <button class="btn btn-secondary btn-sm">
                            <i class="fas fa-crown"></i> View All
                        </button>
                    </div>
                    
                    <div class="student-grid" id="topPerformers">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading students...</p>
                        </div>
                    </div>
                </div>
                
                <!-- RECENT CHALLENGES -->
                <div class="panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-history"></i> Recent Challenges</h2>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Challenge ID</th>
                                <th>Student</th>
                                <th>Simulation</th>
                                <th>Difficulty</th>
                                <th>Status</th>
                                <th>Score</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentChallenges">
                            <tr>
                                <td colspan="8" style="text-align: center; color: var(--text-secondary);">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                        <p>Loading challenges...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- STUDENTS PAGE -->
            <div class="page" id="students">
                <div class="page-header">
                    <h1>My Students</h1>
                    <p>Manage and track your students' progress</p>
                </div>
                
                <div class="filters-bar">
                    <input type="text" class="search-input" placeholder="Search students by name or ID..." id="studentSearch">
                    <select id="classFilter">
                        <option value="">All Classes</option>
                        <option value="6">Class 6</option>
                        <option value="7">Class 7</option>
                        <option value="8">Class 8</option>
                        <option value="9">Class 9</option>
                        <option value="10">Class 10</option>
                        <option value="11">Class 11</option>
                        <option value="12">Class 12</option>
                    </select>
                    <select id="sectionFilter">
                        <option value="">All Sections</option>
                        <option value="A">Section A</option>
                        <option value="B">Section B</option>
                        <option value="C">Section C</option>
                    </select>
                    <button class="btn btn-primary" onclick="openAddStudentModal()">
                        <i class="fas fa-plus"></i> Add Student
                    </button>
                </div>
                
                <div class="panel">
                    <table>
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Name</th>
                                <th>Class</th>
                                <th>Section</th>
                                <th>Performance Index</th>
                                <th>Grade</th>
                                <th>Total Challenges</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentsList">
                            <tr>
                                <td colspan="8">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                        <p>Loading students...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- VALIDATIONS PAGE -->
            <div class="page" id="validations">
                <div class="page-header">
                    <h1>Validation Queue</h1>
                    <p>Review and validate AI-generated challenges</p>
                </div>
                
                <div class="panel">
                    <table>
                        <thead>
                            <tr>
                                <th>Challenge ID</th>
                                <th>Student</th>
                                <th>Simulation Type</th>
                                <th>Difficulty</th>
                                <th>Status</th>
                                <th>Submitted</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="validationsList">
                            <tr>
                                <td colspan="7">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                        <p>Loading pending challenges...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- CLASSES PAGE -->
            <div class="page" id="classes">
                <div class="page-header">
                    <h1>My Classes</h1>
                    <p>View and manage your class sections</p>
                </div>
                
                <div class="student-grid" id="classesList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading classes...</p>
                    </div>
                </div>
            </div>
            
            <!-- ANALYTICS PAGE -->
            <div class="page" id="analytics">
                <div class="page-header">
                    <h1>Analytics & Insights</h1>
                    <p>Detailed performance analytics and trends</p>
                </div>
                
                <div class="charts-grid">
                    <div class="chart-container full-width">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-area"></i> Weekly Engagement Trend</h3>
                        </div>
                        <div class="chart-canvas">
                            <canvas id="engagementTrendChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3><i class="fas fa-graduation-cap"></i> Subject-wise Performance</h3>
                        </div>
                        <div class="chart-canvas">
                            <canvas id="subjectPerformanceChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3><i class="fas fa-tasks"></i> Challenge Difficulty vs Success</h3>
                        </div>
                        <div class="chart-canvas">
                            <canvas id="difficultySuccessChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- REPORTS PAGE -->
            <div class="page" id="reports">
                <div class="page-header">
                    <h1>Reports</h1>
                    <p>Generate and download performance reports</p>
                </div>
                
                <div class="panel">
                    <h3>Generate Class Report</h3>
                    <div class="filters-bar">
                        <select id="reportClass">
                            <option value="">Select Class</option>
                        </select>
                        <select id="reportSection">
                            <option value="">Select Section</option>
                        </select>
                        <button class="btn btn-primary" onclick="generateClassReport()">
                            <i class="fas fa-file-pdf"></i> Generate Report
                        </button>
                    </div>
                </div>
                
                <div class="panel">
                    <h3>Student Individual Report</h3>
                    <div class="filters-bar">
                        <input type="text" class="search-input" placeholder="Enter Student ID" id="reportStudentId">
                        <button class="btn btn-primary" onclick="generateStudentReport()">
                            <i class="fas fa-file-pdf"></i> Generate Report
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- PROFILE PAGE -->
            <div class="page" id="profile">
                <div class="page-header">
                    <h1>My Profile</h1>
                    <p>Manage your account settings and preferences</p>
                </div>
                
                <div class="profile-header">
                    <div class="profile-avatar" id="profileAvatar">T</div>
                    <div class="profile-info">
                        <h2 id="profileName">Teacher Name</h2>
                        <div class="profile-meta">
                            <div><i class="fas fa-id-card"></i> Teacher ID: <span id="profileTeacherId">TCH-XXXXX</span></div>
                            <div><i class="fas fa-school"></i> School: <span id="profileSchool">School Name</span></div>
                            <div><i class="fas fa-envelope"></i> Email: <span id="profileEmail">teacher@email.com</span></div>
                            <div><i class="fas fa-phone"></i> Phone: <span id="profilePhone">+91 00000 00000</span></div>
                        </div>
                    </div>
                </div>
                
                <div class="profile-grid">
                    <!-- PERSONAL INFORMATION -->
                    <div class="profile-card">
                        <h3><i class="fas fa-user-edit"></i> Personal Information</h3>
                        <form id="profileForm">
                            <div class="form-group">
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="editName" placeholder="Enter your full name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="editPhone" placeholder="Enter phone number">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Subjects</label>
                                <select class="form-control" id="editSubjects" multiple style="height: 100px;">
                                    <option value="Physics">Physics</option>
                                    <option value="Chemistry">Chemistry</option>
                                    <option value="Mathematics">Mathematics</option>
                                    <option value="Biology">Biology</option>
                                    <option value="Computer Science">Computer Science</option>
                                    <option value="English">English</option>
                                    <option value="Hindi">Hindi</option>
                                    <option value="Social Studies">Social Studies</option>
                                </select>
                                <small style="color: #888; font-size: 0.8rem;">Hold Ctrl/Cmd to select multiple subjects</small>
                            </div>
                            <button type="submit" class="btn btn-primary" style="margin-top: 10px;">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </form>
                    </div>
                    
                    <!-- NOTIFICATION PREFERENCES -->
                    <div class="profile-card">
                        <h3><i class="fas fa-bell"></i> Notification Preferences</h3>
                        <form id="preferencesForm">
                            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <label class="form-label" style="margin-bottom: 0;">Email Notifications</label>
                                    <small style="display: block; color: #888; font-size: 0.8rem;">Receive updates via email</small>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="emailNotifications" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            
                            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <label class="form-label" style="margin-bottom: 0;">Challenge Notifications</label>
                                    <small style="display: block; color: #888; font-size: 0.8rem;">Get notified about new challenges</small>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="challengeNotifications" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            
                            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <label class="form-label" style="margin-bottom: 0;">Weekly Reports</label>
                                    <small style="display: block; color: #888; font-size: 0.8rem;">Receive weekly performance reports</small>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="weeklyReport" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            
                            <button type="button" class="btn btn-primary" onclick="savePreferences()" style="margin-top: 10px;">
                                <i class="fas fa-save"></i> Save Preferences
                            </button>
                        </form>
                    </div>
                    
                    <!-- ACCOUNT STATISTICS -->
                    <div class="profile-card">
                        <h3><i class="fas fa-chart-bar"></i> Account Statistics</h3>
                        <div id="profileStats">
                            <div class="student-stat">
                                <label>Total Students</label>
                                <value id="statTotalStudents">0</value>
                            </div>
                            <div class="student-stat">
                                <label>Total Classes</label>
                                <value id="statTotalClasses">0</value>
                            </div>
                            <div class="student-stat">
                                <label>Challenges Created</label>
                                <value id="statChallengesCreated">0</value>
                            </div>
                            <div class="student-stat">
                                <label>Challenges Evaluated</label>
                                <value id="statChallengesEvaluated">0</value>
                            </div>
                            <div class="student-stat">
                                <label>Account Status</label>
                                <value><span class="badge badge-success" id="statStatus">Active</span></value>
                            </div>
                            <div class="student-stat">
                                <label>Member Since</label>
                                <value id="statCreatedAt">-</value>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PASSWORD CHANGE -->
                    <div class="profile-card">
                        <h3><i class="fas fa-key"></i> Change Password</h3>
                        <form id="passwordForm">
                            <div class="form-group">
                                <label class="form-label">Current Password</label>
                                <input type="password" class="form-control" id="currentPassword" placeholder="Enter current password">
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Password</label>
                                <input type="password" class="form-control" id="newPassword" placeholder="Enter new password">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Confirm New Password</label>
                                <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm new password">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-key"></i> Change Password
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- HELP TICKETS PAGE -->
            <div class="page" id="help">
                <div class="page-header">
                    <h1>Help Tickets</h1>
                    <p>Manage student help requests</p>
                </div>
                
                <div class="panel">
                    <table>
                        <thead>
                            <tr>
                                <th>Ticket ID</th>
                                <th>Student</th>
                                <th>Subject</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ticketsList">
                            <tr>
                                <td colspan="6">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                        <p>Loading tickets...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- MODALS -->
    <div id="studentDetailsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-graduate"></i> Student Details</h2>
                <button class="modal-close" onclick="closeModal('studentDetailsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="studentDetailsBody">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
    
    <div id="addStudentModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> Add New Student</h2>
                <button class="modal-close" onclick="closeModal('addStudentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="addStudentForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" placeholder="Student Name" id="studentName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" placeholder="student@email.com" id="studentEmail" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" placeholder="Password" id="studentPassword" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" placeholder="Confirm Password" id="studentConfirmPassword" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Class</label>
                            <select id="studentClass" class="form-control" required>
                                <option value="6">Class 6</option>
                                <option value="7">Class 7</option>
                                <option value="8">Class 8</option>
                                <option value="9">Class 9</option>
                                <option value="10" selected>Class 10</option>
                                <option value="11">Class 11</option>
                                <option value="12">Class 12</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Section</label>
                            <select id="studentSection" class="form-control" required>
                                <option value="A" selected>Section A</option>
                                <option value="B">Section B</option>
                                <option value="C">Section C</option>
                                <option value="D">Section D</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Roll Number</label>
                            <input type="number" class="form-control" placeholder="Roll Number" id="studentRollNumber" required>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addStudentModal')">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add Student
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        // TeacherDashboard.js
        // Backend Controller Integration for Teacher Dashboard

        const API_BASE_URL = 'http://localhost:3000/api';

        // ============================================================================
        // AUTHENTICATION & INITIALIZATION
        // ============================================================================

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            initializeDashboard();
        });

        function checkAuth() {
            const token = localStorage.getItem('authToken');
            const userType = localStorage.getItem('userType');
            
            if (!token || userType !== 'teacher') {
                window.location.href = '../login.html';
                return;
            }
        }

        async function initializeDashboard() {
            try {
                await loadTeacherProfile();
                await loadDashboardData();
                initializeCharts();
                initializeFilterListeners();
                
                // Auto-refresh every 5 minutes
                setInterval(() => {
                    loadDashboardData();
                }, 300000);
            } catch (error) {
                console.error('Dashboard initialization error:', error);
                showError('Failed to load dashboard');
            }
        }

        // ============================================================================
        // API HELPER FUNCTIONS
        // ============================================================================

        async function apiCall(endpoint, options = {}) {
            const token = localStorage.getItem('authToken');
            
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };
            
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                ...defaultOptions,
                ...options,
                headers: { ...defaultOptions.headers, ...options.headers }
            });
            
            if (response.status === 401) {
                localStorage.clear();
                window.location.href = '../login.html';
                return;
            }
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || 'API request failed');
            }
            
            return data.data;
        }

        // ============================================================================
        // PROFILE & DASHBOARD DATA
        // ============================================================================

        async function loadTeacherProfile() {
            try {
                // Mapped to: GET /api/teacher/profile
                const data = await apiCall('/teacher/profile');
                const teacher = data.teacher;
                
                // Update UI with teacher info
                document.getElementById('userName').textContent = teacher.name;
                document.getElementById('teacherNameDisplay').textContent = teacher.name;
                document.getElementById('userAvatar').textContent = teacher.name.charAt(0).toUpperCase();
                
                // Update profile page
                document.getElementById('profileName').textContent = teacher.name;
                document.getElementById('profileAvatar').textContent = teacher.name.charAt(0).toUpperCase();
                document.getElementById('profileTeacherId').textContent = teacher.teacherId;
                document.getElementById('profileEmail').textContent = teacher.email;
                document.getElementById('profilePhone').textContent = teacher.phone;
                document.getElementById('profileSchool').textContent = data.school?.schoolName || 'Unknown School';
                
                // Populate edit form
                document.getElementById('editName').value = teacher.name;
                document.getElementById('editPhone').value = teacher.phone;
                
                // Populate subjects
                if (teacher.subjects && teacher.subjects.length > 0) {
                    const subjectSelect = document.getElementById('editSubjects');
                    Array.from(subjectSelect.options).forEach(option => {
                        if (teacher.subjects.includes(option.value)) {
                            option.selected = true;
                        }
                    });
                }
                
                // Populate preferences
                document.getElementById('emailNotifications').checked = teacher.preferences?.emailNotifications || true;
                document.getElementById('challengeNotifications').checked = teacher.preferences?.challengeNotifications || true;
                document.getElementById('weeklyReport').checked = teacher.preferences?.weeklyReport || true;
                
                // Update statistics
                if (teacher.stats) {
                    document.getElementById('statTotalStudents').textContent = teacher.stats.totalStudents || 0;
                    document.getElementById('statTotalClasses').textContent = teacher.stats.totalClasses || 0;
                    document.getElementById('statChallengesCreated').textContent = teacher.stats.totalChallengesCreated || 0;
                    document.getElementById('statChallengesEvaluated').textContent = teacher.stats.totalChallengesEvaluated || 0;
                }
                
                document.getElementById('statStatus').textContent = teacher.status || 'Active';
                document.getElementById('statCreatedAt').textContent = formatDate(teacher.createdAt, true);
                
                // Store teacher data
                window.teacherData = teacher;
            } catch (error) {
                console.error('Load profile error:', error);
            }
        }

        // Save profile updates
        async function updateProfile(profileData) {
            try {
                // Mapped to: PUT /api/teacher/profile
                await apiCall('/teacher/profile', {
                    method: 'PUT',
                    body: JSON.stringify(profileData)
                });
                
                // Reload profile data
                await loadTeacherProfile();
                
                return true;
            } catch (error) {
                console.error('Update profile error:', error);
                throw error;
            }
        }

        async function loadDashboardData() {
            try {
                // Mapped to: GET /api/teacher/dashboard
                const data = await apiCall('/teacher/dashboard');
                
                // Update statistics cards
                document.getElementById('totalStudents').textContent = data.statistics.totalStudents || 0;
                document.getElementById('totalChallenges').textContent = data.statistics.totalChallenges || 0;
                document.getElementById('pendingReviews').textContent = data.statistics.pendingReviews || 0;
                document.getElementById('totalClasses').textContent = data.statistics.totalClasses || 0;
                document.getElementById('openTickets').textContent = data.statistics.openTickets || 0;
                
                // Update notification badge
                if (data.statistics.pendingReviews > 0) {
                    document.getElementById('pendingCount').textContent = data.statistics.pendingReviews;
                    document.getElementById('pendingCount').style.display = 'inline-block';
                    document.getElementById('notificationCount').textContent = data.statistics.pendingReviews;
                    document.getElementById('notificationCount').style.display = 'inline-block';
                }
                
                // Calculate and display average performance
                if (data.statistics.totalStudents > 0) {
                    const avgPerf = await calculateAveragePerformance();
                    document.getElementById('avgPerformance').textContent = avgPerf.toFixed(1) + '%';
                }
                
                // Load recent challenges
                displayRecentChallenges(data.recentChallenges);
                
                // Load students needing attention
                displayStudentsNeedingAttention(data.studentsNeedingAttention);
                
                // Load top performers
                displayTopPerformers(data.topPerformers);
                
            } catch (error) {
                console.error('Load dashboard error:', error);
                showError('Failed to load dashboard data');
            }
        }

        async function calculateAveragePerformance() {
            try {
                const data = await apiCall('/teacher/analytics/overview');
                return data.overview.averagePerformance || 0;
            } catch (error) {
                return 0;
            }
        }

        // ============================================================================
        // PROFILE PAGE FUNCTIONS
        // ============================================================================

        // Handle profile form submission
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const profileData = {
                name: document.getElementById('editName').value,
                phone: document.getElementById('editPhone').value,
                subjects: Array.from(document.getElementById('editSubjects').selectedOptions).map(opt => opt.value)
            };
            
            try {
                await updateProfile(profileData);
                showSuccess('Profile updated successfully!');
            } catch (error) {
                showError('Failed to update profile: ' + error.message);
            }
        });

        // Save preferences
        async function savePreferences() {
            const preferences = {
                emailNotifications: document.getElementById('emailNotifications').checked,
                challengeNotifications: document.getElementById('challengeNotifications').checked,
                weeklyReport: document.getElementById('weeklyReport').checked
            };
            
            try {
                await updateProfile({ preferences });
                showSuccess('Preferences saved successfully!');
            } catch (error) {
                showError('Failed to save preferences: ' + error.message);
            }
        }

        // Handle password change
        document.getElementById('passwordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showError('New passwords do not match!');
                return;
            }
            
            if (newPassword.length < 6) {
                showError('Password must be at least 6 characters long');
                return;
            }
            
            try {
                // Mapped to: PUT /api/teacher/change-password
                await apiCall('/teacher/change-password', {
                    method: 'PUT',
                    body: JSON.stringify({
                        currentPassword,
                        newPassword
                    })
                });
                
                showSuccess('Password changed successfully!');
                document.getElementById('passwordForm').reset();
            } catch (error) {
                showError('Failed to change password: ' + error.message);
            }
        });

        // ============================================================================
        // CHARTS INITIALIZATION
        // ============================================================================

        let charts = {};

        function initializeCharts() {
            initializePerformanceTrendChart();
            initializeCompetencyRadarChart();
            initializeChallengeStatusChart();
            initializePerformanceDistributionChart();
            initializeSimulationUsageChart();
        }

        async function initializePerformanceTrendChart() {
            try {
                const data = await apiCall('/teacher/analytics/overview');
                
                const ctx = document.getElementById('performanceTrendChart').getContext('2d');
                
                // Format recent activity data for chart
                const labels = data.recentActivity?.map(item => item._id) || [];
                const values = data.recentActivity?.map(item => item.count) || [];
                
                charts.performanceTrend = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels.length > 0 ? labels : ['No Data'],
                        datasets: [{
                            label: 'Class Average Performance',
                            data: values.length > 0 ? values : [0],
                            borderColor: '#00d4ff',
                            backgroundColor: 'rgba(0, 212, 255, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: { color: '#fff' }
                            },
                            tooltip: {
                                backgroundColor: '#252526',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#464647',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: { color: '#888' },
                                grid: { color: '#464647' }
                            },
                            x: {
                                ticks: { color: '#888' },
                                grid: { color: '#464647' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Performance trend chart error:', error);
            }
        }

        async function initializeCompetencyRadarChart() {
            try {
                // Mapped to: GET /api/teacher/analytics/competencies
                const data = await apiCall('/teacher/analytics/competencies');
                
                const ctx = document.getElementById('competencyRadarChart').getContext('2d');
                
                const competencyLabels = Object.keys(data.competencies || {}).map(comp => 
                    comp.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                );
                
                const competencyValues = Object.values(data.competencies || {}).map(comp => 
                    comp.average || 0
                );
                
                charts.competencyRadar = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: competencyLabels.length > 0 ? competencyLabels : ['No Data'],
                        datasets: [{
                            label: 'Class Average',
                            data: competencyValues.length > 0 ? competencyValues : [0],
                            backgroundColor: 'rgba(0, 212, 255, 0.2)',
                            borderColor: '#00d4ff',
                            pointBackgroundColor: '#00d4ff',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: '#00d4ff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: { color: '#fff' }
                            }
                        },
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100,
                                ticks: { 
                                    color: '#888',
                                    backdropColor: 'transparent'
                                },
                                grid: { color: '#464647' },
                                pointLabels: { color: '#fff' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Competency radar chart error:', error);
            }
        }

        async function initializeChallengeStatusChart() {
            try {
                const data = await apiCall('/teacher/analytics/overview');
                
                const ctx = document.getElementById('challengeStatusChart').getContext('2d');
                
                const statusData = data.challengesByStatus || {};
                
                charts.challengeStatus = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Evaluated', 'Submitted', 'Generated', 'In Progress'],
                        datasets: [{
                            data: [
                                statusData.evaluated || 0,
                                statusData.submitted || 0,
                                statusData.generated || 0,
                                statusData.inProgress || 0
                            ],
                            backgroundColor: [
                                '#27ae60',
                                '#f39c12',
                                '#00d4ff',
                                '#888888'
                            ],
                            borderWidth: 2,
                            borderColor: '#252526'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#fff' }
                            },
                            tooltip: {
                                backgroundColor: '#252526',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#464647',
                                borderWidth: 1
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Challenge status chart error:', error);
            }
        }

        async function initializePerformanceDistributionChart() {
            try {
                // Get all students and calculate distribution
                const studentsData = await apiCall('/teacher/students?limit=1000');
                const students = studentsData.students || [];
                
                const distribution = {
                    excellent: students.filter(s => s.performanceIndex >= 90).length,
                    good: students.filter(s => s.performanceIndex >= 70 && s.performanceIndex < 90).length,
                    average: students.filter(s => s.performanceIndex >= 50 && s.performanceIndex < 70).length,
                    needsImprovement: students.filter(s => s.performanceIndex < 50).length
                };
                
                const ctx = document.getElementById('performanceDistributionChart').getContext('2d');
                
                charts.performanceDistribution = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['90-100\nExcellent', '70-89\nGood', '50-69\nAverage', '0-49\nNeeds Help'],
                        datasets: [{
                            label: 'Number of Students',
                            data: [
                                distribution.excellent,
                                distribution.good,
                                distribution.average,
                                distribution.needsImprovement
                            ],
                            backgroundColor: [
                                '#27ae60',
                                '#2ecc71',
                                '#f39c12',
                                '#e74c3c'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#252526',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#464647',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { 
                                    color: '#888',
                                    stepSize: 1
                                },
                                grid: { color: '#464647' }
                            },
                            x: {
                                ticks: { color: '#888' },
                                grid: { display: false }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Performance distribution chart error:', error);
            }
        }

        async function initializeSimulationUsageChart() {
            try {
                // Mock data for simulation usage (you can add API endpoint for this)
                const simulationData = {
                    'Force Visualizer': 45,
                    'Circuit Builder': 38,
                    'Chemical Reactions': 32,
                    'Math Grapher': 28,
                    'Cell Explorer': 25,
                    'Wave Simulator': 22,
                    'Periodic Table': 20,
                    'Motion Classifier': 18
                };
                
                const ctx = document.getElementById('simulationUsageChart').getContext('2d');
                
                charts.simulationUsage = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(simulationData),
                        datasets: [{
                            label: 'Usage Count',
                            data: Object.values(simulationData),
                            backgroundColor: '#00d4ff',
                            borderWidth: 0
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#252526',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#464647',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: { color: '#888' },
                                grid: { color: '#464647' }
                            },
                            y: {
                                ticks: { color: '#888' },
                                grid: { display: false }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Simulation usage chart error:', error);
            }
        }

        // ============================================================================
        // DISPLAY FUNCTIONS
        // ============================================================================

        function displayRecentChallenges(challenges) {
            const tbody = document.getElementById('recentChallenges');
            
            if (!challenges || challenges.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #888;">No recent challenges</td></tr>';
                return;
            }
            
            tbody.innerHTML = challenges.map(challenge => `
                <tr>
                    <td>${challenge.challengeId}</td>
                    <td>${challenge.studentId}</td>
                    <td>
                        <span class="badge badge-info">${challenge.simulationType}</span>
                    </td>
                    <td>
                        <span class="badge ${getDifficultyBadgeClass(challenge.difficulty)}">
                            ${challenge.difficulty}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${getStatusBadgeClass(challenge.status)}">
                            ${challenge.status}
                        </span>
                    </td>
                    <td>${challenge.results?.totalScore ? challenge.results.totalScore.toFixed(1) : '-'}</td>
                    <td>${formatDate(challenge.generatedAt)}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="viewChallengeDetails('${challenge.challengeId}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function displayStudentsNeedingAttention(students) {
            const container = document.getElementById('studentsNeedingAttention');
            
            if (!students || students.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888;">No students need attention at this time</p>';
                return;
            }
            
            container.innerHTML = students.map(student => `
                <div class="alert-card">
                    <div class="alert-header">
                        <div class="alert-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div>
                            <h4>${student.name}</h4>
                            <p style="font-size: 0.85rem; color: #888; margin-top: 3px;">
                                ${student.studentId} | Class ${student.class}-${student.section}
                            </p>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #888;">Performance Index:</span>
                            <strong style="color: #e74c3c;">${student.performanceIndex.toFixed(1)}%</strong>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${student.performanceIndex}%; background: #e74c3c;"></div>
                        </div>
                        <button class="btn btn-secondary btn-sm" style="margin-top: 12px; width: 100%;" 
                                onclick="viewStudentDetails('${student.studentId}')">
                            <i class="fas fa-eye"></i> View Details
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function displayTopPerformers(students) {
            const container = document.getElementById('topPerformers');
            
            if (!students || students.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888;">No performance data available</p>';
                return;
            }
            
            container.innerHTML = students.map((student, index) => `
                <div class="student-card">
                    <div class="student-header">
                        <div class="student-avatar">${student.name.charAt(0).toUpperCase()}</div>
                        <div class="student-info">
                            <h3>${student.name}</h3>
                            <div class="student-meta">
                                ${student.studentId} | Class ${student.class}-${student.section}
                            </div>
                        </div>
                        ${index === 0 ? '<i class="fas fa-crown" style="color: #f39c12; font-size: 1.2rem;"></i>' : ''}
                    </div>
                    <div class="student-stats">
                        <div class="student-stat">
                            <label>Performance Index:</label>
                            <value style="color: #27ae60;">${student.performanceIndex.toFixed(1)}%</value>
                        </div>
                        <div class="progress-bar" style="margin-bottom: 10px;">
                            <div class="progress-fill" style="width: ${student.performanceIndex}%;"></div>
                        </div>
                        <div class="student-stat">
                            <label>Grade:</label>
                            <value>${student.grade || 'N/A'}</value>
                        </div>
                        <button class="btn btn-primary btn-sm" style="margin-top: 12px; width: 100%;" 
                                onclick="viewStudentDetails('${student.studentId}')">
                            <i class="fas fa-eye"></i> View Profile
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ============================================================================
        // STUDENTS PAGE
        // ============================================================================

        async function loadStudents(filters = {}) {
            try {
                const queryParams = new URLSearchParams();
                
                if (filters.search) queryParams.append('search', filters.search);
                if (filters.class) queryParams.append('class', filters.class);
                if (filters.section) queryParams.append('section', filters.section);
                
                const endpoint = `/teacher/students?${queryParams.toString()}`;
                const data = await apiCall(endpoint);
                
                displayStudentsList(data.students);
            } catch (error) {
                console.error('Load students error:', error);
                showError('Failed to load students');
            }
        }

        function displayStudentsList(students) {
            const tbody = document.getElementById('studentsList');
            
            if (!students || students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #888;">No students found</td></tr>';
                return;
            }
            
            tbody.innerHTML = students.map(student => `
                <tr>
                    <td>${student.studentId}</td>
                    <td>${student.name}</td>
                    <td>${student.class}</td>
                    <td>${student.section}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span>${student.performanceIndex.toFixed(1)}%</span>
                            <div class="progress-bar" style="width: 100px;">
                                <div class="progress-fill" style="width: ${student.performanceIndex}%;"></div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge ${getGradeBadgeClass(student.grade)}">
                            ${student.grade || 'N/A'}
                        </span>
                    </td>
                    <td>${student.stats?.totalChallengesCompleted || 0}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="viewStudentDetails('${student.studentId}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="editStudent('${student.studentId}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Handle Add Student form submission
        document.getElementById('addStudentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const studentData = {
                name: document.getElementById('studentName').value,
                email: document.getElementById('studentEmail').value,
                password: document.getElementById('studentPassword').value,
                class: parseInt(document.getElementById('studentClass').value),
                section: document.getElementById('studentSection').value,
                rollNumber: parseInt(document.getElementById('studentRollNumber').value)
            };
            
            // Validate passwords match
            if (studentData.password !== document.getElementById('studentConfirmPassword').value) {
                showError('Passwords do not match!');
                return;
            }
            
            try {
                // Mapped to: POST /api/teacher/students
                await apiCall('/teacher/students', {
                    method: 'POST',
                    body: JSON.stringify(studentData)
                });
                
                showSuccess('Student added successfully!');
                closeModal('addStudentModal');
                
                // Reload the students list
                await loadStudents();
                
                // Also reload dashboard stats
                await loadDashboardData();
                
            } catch (error) {
                console.error('Add student error:', error);
                showError('Failed to add student: ' + (error.message || 'Unknown error'));
            }
        });

        function openAddStudentModal() {
            const modal = document.getElementById('addStudentModal');
            
            // Reset form
            document.getElementById('addStudentForm').reset();
            
            // Set default values
            document.getElementById('studentClass').value = '10';
            document.getElementById('studentSection').value = 'A';
            
            // Show modal
            modal.style.display = 'flex';
        }

        function initializeFilterListeners() {
            document.getElementById('studentSearch')?.addEventListener('input', (e) => {
                loadStudents({ search: e.target.value });
            });
            
            document.getElementById('classFilter')?.addEventListener('change', (e) => {
                loadStudents({ class: e.target.value });
            });
            
            document.getElementById('sectionFilter')?.addEventListener('change', (e) => {
                loadStudents({ section: e.target.value });
            });
        }

        // ============================================================================
        // VALIDATION QUEUE
        // ============================================================================

        async function loadPendingValidations() {
            try {
                // Mapped to: GET /api/teacher/challenges/pending-review
                const data = await apiCall('/teacher/challenges/pending-review');
                displayValidationsList(data.challenges);
            } catch (error) {
                console.error('Load validations error:', error);
            }
        }

        function displayValidationsList(challenges) {
            const tbody = document.getElementById('validationsList');
            
            if (!challenges || challenges.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #888;">No pending validations</td></tr>';
                return;
            }
            
            tbody.innerHTML = challenges.map(challenge => `
                <tr>
                    <td>${challenge.challengeId}</td>
                    <td>${challenge.student?.name || challenge.studentId}</td>
                    <td>${challenge.simulationType}</td>
                    <td>
                        <span class="badge ${getDifficultyBadgeClass(challenge.difficulty)}">
                            ${challenge.difficulty}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-warning">${challenge.status}</span>
                    </td>
                    <td>${formatDate(challenge.submittedAt)}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="validateChallenge('${challenge.challengeId}')">
                            <i class="fas fa-check"></i> Review
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // ============================================================================
        // CLASSES PAGE
        // ============================================================================

        async function loadClasses() {
            try {
                const data = await apiCall('/teacher/classes');
                displayClassesList(data.classes);
            } catch (error) {
                console.error('Load classes error:', error);
            }
        }

        function displayClassesList(classes) {
            const container = document.getElementById('classesList');
            
            if (!classes || classes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888;">No classes assigned</p>';
                return;
            }
            
            container.innerHTML = classes.map(cls => `
                <div class="student-card">
                    <div class="student-header">
                        <div class="student-avatar">
                            <i class="fas fa-chalkboard"></i>
                        </div>
                        <div class="student-info">
                            <h3>Class ${cls.class}-${cls.section}</h3>
                            <div class="student-meta">${cls.subject}</div>
                        </div>
                    </div>
                    <div class="student-stats">
                        <div class="student-stat">
                            <label>Total Students:</label>
                            <value>${cls.studentCount || 0}</value>
                        </div>
                        <div class="student-stat">
                            <label>Class Section ID:</label>
                            <value style="font-size: 0.75rem;">${cls.classSectionId}</value>
                        </div>
                        <button class="btn btn-primary btn-sm" style="margin-top: 12px; width: 100%;" 
                                onclick="viewClassDetails('${cls.classSectionId}')">
                            <i class="fas fa-eye"></i> View Details
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ============================================================================
        // HELP TICKETS
        // ============================================================================

        async function loadHelpTickets() {
            try {
                const data = await apiCall('/teacher/help-tickets');
                displayTicketsList(data.tickets);
            } catch (error) {
                console.error('Load tickets error:', error);
            }
        }

        function displayTicketsList(tickets) {
            const tbody = document.getElementById('ticketsList');
            
            if (!tickets || tickets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #888;">No help tickets</td></tr>';
                return;
            }
            
            tbody.innerHTML = tickets.map(ticket => `
                <tr>
                    <td>${ticket.ticketId}</td>
                    <td>${ticket.studentId}</td>
                    <td>${ticket.subject || 'General Help'}</td>
                    <td>
                        <span class="badge ${ticket.status === 'open' ? 'badge-warning' : 'badge-success'}">
                            ${ticket.status}
                        </span>
                    </td>
                    <td>${formatDate(ticket.createdAt)}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="viewTicket('${ticket.ticketId}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${ticket.status === 'open' ? `
                            <button class="btn btn-success btn-sm" onclick="resolveTicket('${ticket.ticketId}')">
                                <i class="fas fa-check"></i>
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        // ============================================================================
        // NAVIGATION & UI
        // ============================================================================

        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Add active to clicked nav item
            event.target.closest('.nav-item').classList.add('active');
            
            // Load page-specific data
            switch(pageId) {
                case 'students':
                    loadStudents();
                    break;
                case 'validations':
                    loadPendingValidations();
                    break;
                case 'classes':
                    loadClasses();
                    break;
                case 'profile':
                    // Already loaded in loadTeacherProfile()
                    break;
                case 'help':
                    loadHelpTickets();
                    break;
            }
        }

        async function viewStudentDetails(studentId) {
            try {
                const data = await apiCall(`/teacher/students/${studentId}`);
                // Show modal with student details
                showStudentModal(data.student, data.recentChallenges);
            } catch (error) {
                console.error('View student error:', error);
                showError('Failed to load student details');
            }
        }

        async function viewChallengeDetails(challengeId) {
            try {
                const data = await apiCall(`/teacher/challenges/${challengeId}`);
                alert(`Challenge: ${data.challenge.challengeId}\nStatus: ${data.challenge.status}\nDifficulty: ${data.challenge.difficulty}`);
            } catch (error) {
                console.error('View challenge error:', error);
            }
        }

        function showStudentModal(student, challenges) {
            const modal = document.getElementById('studentDetailsModal');
            const body = document.getElementById('studentDetailsBody');
            
            body.innerHTML = `
                <h3>${student.name}</h3>
                <p><strong>Student ID:</strong> ${student.studentId}</p>
                <p><strong>Class:</strong> ${student.class}-${student.section}</p>
                <p><strong>Performance Index:</strong> ${student.performanceIndex.toFixed(1)}%</p>
                <p><strong>Grade:</strong> ${student.grade || 'N/A'}</p>
                
                <h4 style="margin-top: 20px;">Recent Challenges</h4>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${challenges.map(ch => `
                        <div style="padding: 10px; background: rgba(255,255,255,0.03); margin-bottom: 10px; border-radius: 6px;">
                            <strong>${ch.challengeId}</strong> - ${ch.simulationType}<br>
                            <small>Score: ${ch.results?.totalScore || 'N/A'} | Status: ${ch.status}</small>
                        </div>
                    `).join('')}
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================

        function formatDate(dateString, dateOnly = false) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (dateOnly) {
                return date.toLocaleDateString();
            }
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function getDifficultyBadgeClass(difficulty) {
            const classes = {
                'easy': 'badge-success',
                'medium': 'badge-warning',
                'hard': 'badge-danger'
            };
            return classes[difficulty?.toLowerCase()] || 'badge-info';
        }

        function getStatusBadgeClass(status) {
            const classes = {
                'evaluated': 'badge-success',
                'submitted': 'badge-warning',
                'generated': 'badge-info',
                'inProgress': 'badge-info'
            };
            return classes[status] || 'badge-info';
        }

        function getGradeBadgeClass(grade) {
            if (!grade) return 'badge-info';
            if (grade.startsWith('A')) return 'badge-success';
            if (grade.startsWith('B')) return 'badge-info';
            if (grade.startsWith('C')) return 'badge-warning';
            return 'badge-danger';
        }

        function showError(message) {
            alert('Error: ' + message);
        }

        function showSuccess(message) {
            alert('Success: ' + message);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.clear();
                window.location.href = '/login.html';
            }
        }

        // ============================================================================
        // ADDITIONAL UI FUNCTIONS
        // ============================================================================

        // ============================================================================
        // USER MENU FUNCTION
        // ============================================================================

        function toggleUserMenu() {
            const userMenu = document.getElementById('userMenu');
            
            if (!userMenu) {
                // Create user dropdown menu
                const menuHTML = `
                    <div id="userMenu" class="user-menu" style="
                        position: absolute;
                        top: 70px;
                        right: 30px;
                        background: var(--panel-dark);
                        border: 1px solid var(--border-color);
                        border-radius: 8px;
                        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
                        z-index: 1000;
                        min-width: 200px;
                        display: none;
                    ">
                        <div style="padding: 15px; border-bottom: 1px solid var(--border-color);">
                            <div style="font-weight: 600; margin-bottom: 5px;">${window.teacherData?.name || 'Teacher'}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">${window.teacherData?.email || ''}</div>
                        </div>
                        <div>
                            <div class="menu-item" onclick="showPage('profile')" style="
                                padding: 12px 15px;
                                display: flex;
                                align-items: center;
                                gap: 10px;
                                cursor: pointer;
                                transition: background 0.3s;
                            ">
                                <i class="fas fa-user"></i>
                                <span>My Profile</span>
                            </div>
                            <div class="menu-item" onclick="logout()" style="
                                padding: 12px 15px;
                                display: flex;
                                align-items: center;
                                gap: 10px;
                                cursor: pointer;
                                transition: background 0.3s;
                                border-top: 1px solid var(--border-color);
                                color: var(--danger-red);
                            ">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', menuHTML);
                
                // Add hover effects
                const menuItems = document.querySelectorAll('.menu-item');
                menuItems.forEach(item => {
                    item.addEventListener('mouseenter', function() {
                        this.style.background = 'rgba(255, 255, 255, 0.05)';
                    });
                    item.addEventListener('mouseleave', function() {
                        this.style.background = 'transparent';
                    });
                });
            }
            
            const menu = document.getElementById('userMenu');
            if (menu.style.display === 'block') {
                menu.style.display = 'none';
            } else {
                menu.style.display = 'block';
                
                // Close menu when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', function closeMenu(e) {
                        if (!e.target.closest('.user-info') && !e.target.closest('#userMenu')) {
                            menu.style.display = 'none';
                            document.removeEventListener('click', closeMenu);
                        }
                    });
                }, 100);
            }
        }

        // ============================================================================
        // EDIT STUDENT FUNCTION
        // ============================================================================

        async function editStudent(studentId) {
            try {
                // First, get current student data
                const data = await apiCall(`/teacher/students/${studentId}`);
                const student = data.student;
                
                // Create edit modal
                const modalHTML = `
                    <div id="editStudentModal" class="modal" style="display: flex;">
                        <div class="modal-content" style="max-width: 600px;">
                            <div class="modal-header">
                                <h2><i class="fas fa-edit"></i> Edit Student: ${student.name}</h2>
                                <button class="modal-close" onclick="closeModal('editStudentModal')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="editStudentForm">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                        <div class="form-group">
                                            <label class="form-label">Full Name</label>
                                            <input type="text" class="form-control" id="editStudentName" 
                                                   value="${student.name}" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Email</label>
                                            <input type="email" class="form-control" id="editStudentEmail" 
                                                   value="${student.email || ''}" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Class</label>
                                            <select id="editStudentClass" class="form-control" required>
                                                ${[6,7,8,9,10,11,12].map(cls => 
                                                    `<option value="${cls}" ${student.class == cls ? 'selected' : ''}>
                                                        Class ${cls}
                                                    </option>`
                                                ).join('')}
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Section</label>
                                            <select id="editStudentSection" class="form-control" required>
                                                ${['A','B','C','D'].map(sec => 
                                                    `<option value="${sec}" ${student.section == sec ? 'selected' : ''}>
                                                        Section ${sec}
                                                    </option>`
                                                ).join('')}
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Roll Number</label>
                                            <input type="number" class="form-control" id="editStudentRollNumber" 
                                                   value="${student.rollNumber}" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Active Status</label>
                                            <select id="editStudentActive" class="form-control">
                                                <option value="true" ${student.active ? 'selected' : ''}>Active</option>
                                                <option value="false" ${!student.active ? 'selected' : ''}>Inactive</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                                        <button type="button" class="btn btn-secondary" onclick="closeModal('editStudentModal')">
                                            Cancel
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> Save Changes
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('editStudentModal');
                if (existingModal) existingModal.remove();
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Handle form submission
                document.getElementById('editStudentForm').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const updateData = {
                        name: document.getElementById('editStudentName').value,
                        email: document.getElementById('editStudentEmail').value,
                        class: parseInt(document.getElementById('editStudentClass').value),
                        section: document.getElementById('editStudentSection').value,
                        rollNumber: parseInt(document.getElementById('editStudentRollNumber').value),
                        active: document.getElementById('editStudentActive').value === 'true'
                    };
                    
                    try {
                        // Mapped to: PUT /api/teacher/students/:studentId
                        await apiCall(`/teacher/students/${studentId}`, {
                            method: 'PUT',
                            body: JSON.stringify(updateData)
                        });
                        
                        showSuccess('Student updated successfully!');
                        closeModal('editStudentModal');
                        
                        // Reload students list
                        await loadStudents();
                        
                    } catch (error) {
                        showError('Failed to update student: ' + error.message);
                    }
                });
                
            } catch (error) {
                console.error('Edit student error:', error);
                showError('Failed to load student data');
            }
        }

        // ============================================================================
        // VALIDATE CHALLENGE FUNCTION
        // ============================================================================

        async function validateChallenge(challengeId) {
            try {
                // First get challenge details
                const data = await apiCall(`/teacher/challenges/${challengeId}`);
                const challenge = data.challenge;
                
                // Create validation modal
                const modalHTML = `
                    <div id="validateChallengeModal" class="modal" style="display: flex;">
                        <div class="modal-content" style="max-width: 700px;">
                            <div class="modal-header">
                                <h2><i class="fas fa-check-circle"></i> Validate Challenge</h2>
                                <button class="modal-close" onclick="closeModal('validateChallengeModal')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div style="margin-bottom: 25px;">
                                    <h4>Challenge Details</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                                        <div>
                                            <label style="color: #888; font-size: 0.85rem;">Challenge ID</label>
                                            <div>${challenge.challengeId}</div>
                                        </div>
                                        <div>
                                            <label style="color: #888; font-size: 0.85rem;">Student</label>
                                            <div>${challenge.studentId}</div>
                                        </div>
                                        <div>
                                            <label style="color: #888; font-size: 0.85rem;">Simulation</label>
                                            <div>${challenge.simulationType}</div>
                                        </div>
                                        <div>
                                            <label style="color: #888; font-size: 0.85rem;">Difficulty</label>
                                            <div><span class="badge ${getDifficultyBadgeClass(challenge.difficulty)}">
                                                ${challenge.difficulty}
                                            </span></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <form id="validateChallengeForm">
                                    <div class="form-group">
                                        <label class="form-label">Validation Status</label>
                                        <select id="validationStatus" class="form-control" required>
                                            <option value="approved">Approve</option>
                                            <option value="rejected">Reject</option>
                                            <option value="needs_revision">Needs Revision</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Score (0-100)</label>
                                        <input type="number" class="form-control" id="validationScore" 
                                               min="0" max="100" step="0.1" value="0">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Teacher's Feedback</label>
                                        <textarea class="form-control" id="validationFeedback" 
                                                  rows="4" placeholder="Provide feedback for the student..."></textarea>
                                    </div>
                                    
                                    <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                                        <button type="button" class="btn btn-secondary" onclick="closeModal('validateChallengeModal')">
                                            Cancel
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-check"></i> Submit Validation
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('validateChallengeModal');
                if (existingModal) existingModal.remove();
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Handle form submission
                document.getElementById('validateChallengeForm').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const validationData = {
                        status: document.getElementById('validationStatus').value,
                        score: parseFloat(document.getElementById('validationScore').value) || 0,
                        teacherFeedback: document.getElementById('validationFeedback').value
                    };
                    
                    try {
                        // Mapped to: PUT /api/teacher/challenges/:challengeId/validate
                        await apiCall(`/teacher/challenges/${challengeId}/validate`, {
                            method: 'PUT',
                            body: JSON.stringify(validationData)
                        });
                        
                        showSuccess('Challenge validated successfully!');
                        closeModal('validateChallengeModal');
                        
                        // Reload validation queue and dashboard
                        await loadPendingValidations();
                        await loadDashboardData();
                        
                    } catch (error) {
                        showError('Failed to validate challenge: ' + error.message);
                    }
                });
                
            } catch (error) {
                console.error('Validate challenge error:', error);
                showError('Failed to load challenge details');
            }
        }

        // ============================================================================
        // VIEW CLASS DETAILS FUNCTION
        // ============================================================================

        async function viewClassDetails(classSectionId) {
            try {
                // Parse class and section from ID (format: CLASS-SECTION)
                const [cls, section] = classSectionId.split('-');
                
                if (!cls || !section) {
                    showError('Invalid class section ID');
                    return;
                }
                
                // Mapped to: GET /api/teacher/reports/class-performance?class=X&section=Y
                const data = await apiCall(`/teacher/reports/class-performance?class=${cls}&section=${section}`);
                const classData = data;
                
                // Create class details modal
                const modalHTML = `
                    <div id="classDetailsModal" class="modal" style="display: flex;">
                        <div class="modal-content" style="max-width: 900px;">
                            <div class="modal-header">
                                <h2><i class="fas fa-chalkboard"></i> Class ${cls}-${section} Details</h2>
                                <button class="modal-close" onclick="closeModal('classDetailsModal')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <!-- Class Statistics -->
                                <div style="margin-bottom: 30px;">
                                    <h4>Class Statistics</h4>
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 15px;">
                                        <div style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 8px;">
                                            <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">Total Students</div>
                                            <div style="font-size: 2rem; font-weight: 700;">${classData.class.totalStudents || 0}</div>
                                        </div>
                                        <div style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 8px;">
                                            <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">Average Performance</div>
                                            <div style="font-size: 2rem; font-weight: 700;">${(classData.statistics.averagePerformance || 0).toFixed(1)}%</div>
                                        </div>
                                        <div style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 8px;">
                                            <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">Avg Challenges</div>
                                            <div style="font-size: 2rem; font-weight: 700;">${(classData.statistics.averageChallengesCompleted || 0).toFixed(1)}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Performance Distribution -->
                                <div style="margin-bottom: 30px;">
                                    <h4>Performance Distribution</h4>
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 15px;">
                                        <div style="text-align: center; padding: 15px; background: rgba(39, 174, 96, 0.1); border-radius: 8px;">
                                            <div style="color: #27ae60; font-size: 1.5rem; font-weight: 700;">${classData.statistics.distribution.excellent || 0}</div>
                                            <div style="color: #888; font-size: 0.85rem;">Excellent (90-100)</div>
                                        </div>
                                        <div style="text-align: center; padding: 15px; background: rgba(46, 204, 113, 0.1); border-radius: 8px;">
                                            <div style="color: #2ecc71; font-size: 1.5rem; font-weight: 700;">${classData.statistics.distribution.good || 0}</div>
                                            <div style="color: #888; font-size: 0.85rem;">Good (70-89)</div>
                                        </div>
                                        <div style="text-align: center; padding: 15px; background: rgba(243, 156, 18, 0.1); border-radius: 8px;">
                                            <div style="color: #f39c12; font-size: 1.5rem; font-weight: 700;">${classData.statistics.distribution.average || 0}</div>
                                            <div style="color: #888; font-size: 0.85rem;">Average (50-69)</div>
                                        </div>
                                        <div style="text-align: center; padding: 15px; background: rgba(231, 76, 60, 0.1); border-radius: 8px;">
                                            <div style="color: #e74c3c; font-size: 1.5rem; font-weight: 700;">${classData.statistics.distribution.needsImprovement || 0}</div>
                                            <div style="color: #888; font-size: 0.85rem;">Needs Help (0-49)</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Students List -->
                                <div>
                                    <h4>Students (${classData.students.length})</h4>
                                    <div style="max-height: 300px; overflow-y: auto; margin-top: 15px;">
                                        <table style="width: 100%;">
                                            <thead>
                                                <tr>
                                                    <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color);">Name</th>
                                                    <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color);">Student ID</th>
                                                    <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color);">Performance</th>
                                                    <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color);">Grade</th>
                                                    <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color);">Challenges</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${classData.students.map(student => `
                                                    <tr>
                                                        <td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                                            ${student.name}
                                                        </td>
                                                        <td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                                            ${student.studentId}
                                                        </td>
                                                        <td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                                <span>${student.performanceIndex.toFixed(1)}%</span>
                                                                <div class="progress-bar" style="width: 80px;">
                                                                    <div class="progress-fill" style="width: ${student.performanceIndex}%;"></div>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                                            <span class="badge ${getGradeBadgeClass(student.grade)}">
                                                                ${student.grade || 'N/A'}
                                                            </span>
                                                        </td>
                                                        <td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                                            ${student.totalChallenges || 0}
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('classDetailsModal');
                if (existingModal) existingModal.remove();
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
            } catch (error) {
                console.error('View class details error:', error);
                showError('Failed to load class details');
            }
        }

        // ============================================================================
        // VIEW TICKET FUNCTION
        // ============================================================================

        async function viewTicket(ticketId) {
            try {
                // Mapped to: GET /api/teacher/help-tickets/:ticketId
                const data = await apiCall(`/teacher/help-tickets/${ticketId}`);
                const ticket = data.ticket;
                
                // Create ticket view modal
                const modalHTML = `
                    <div id="viewTicketModal" class="modal" style="display: flex;">
                        <div class="modal-content" style="max-width: 700px;">
                            <div class="modal-header">
                                <h2><i class="fas fa-ticket-alt"></i> Help Ticket: ${ticketId}</h2>
                                <button class="modal-close" onclick="closeModal('viewTicketModal')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div style="margin-bottom: 25px;">
                                    <h4>Ticket Information</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                        <div>
                                            <label style="color: #888; font-size: 0.85rem;">Student ID</label>
                                            <div>${ticket.studentId}</div>
                                        </div>
                                        <div>
                                            <label style="color: #888; font-size: 0.85rem;">Status</label>
                                            <div>
                                                <span class="badge ${ticket.status === 'open' ? 'badge-warning' : 'badge-success'}">
                                                    ${ticket.status}
                                                </span>
                                            </div>
                                        </div>
                                        <div>
                                            <label style="color: #888; font-size: 0.85rem;">Created</label>
                                            <div>${formatDate(ticket.createdAt)}</div>
                                        </div>
                                        <div>
                                            <label style="color: #888; font-size: 0.85rem;">Priority</label>
                                            <div>
                                                <span class="badge ${ticket.priority === 'high' ? 'badge-danger' : ticket.priority === 'medium' ? 'badge-warning' : 'badge-info'}">
                                                    ${ticket.priority || 'normal'}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 25px;">
                                    <h4>Subject</h4>
                                    <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; margin-top: 10px;">
                                        ${ticket.subject || 'General Help Request'}
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 25px;">
                                    <h4>Description</h4>
                                    <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; margin-top: 10px; white-space: pre-wrap;">
                                        ${ticket.description || 'No description provided'}
                                    </div>
                                </div>
                                
                                ${ticket.response ? `
                                    <div style="margin-bottom: 25px;">
                                        <h4>Your Response</h4>
                                        <div style="background: rgba(0, 212, 255, 0.1); padding: 15px; border-radius: 8px; margin-top: 10px; white-space: pre-wrap;">
                                            ${ticket.response}
                                        </div>
                                        <div style="color: #888; font-size: 0.85rem; margin-top: 5px;">
                                            Responded on: ${formatDate(ticket.respondedAt)}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${ticket.resolution ? `
                                    <div style="margin-bottom: 25px;">
                                        <h4>Resolution</h4>
                                        <div style="background: rgba(39, 174, 96, 0.1); padding: 15px; border-radius: 8px; margin-top: 10px; white-space: pre-wrap;">
                                            ${ticket.resolution}
                                        </div>
                                        <div style="color: #888; font-size: 0.85rem; margin-top: 5px;">
                                            Resolved on: ${formatDate(ticket.resolvedAt)}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${ticket.status === 'open' ? `
                                    <div style="border-top: 1px solid var(--border-color); padding-top: 20px;">
                                        <h4>Respond to Ticket</h4>
                                        <form id="respondTicketForm">
                                            <div class="form-group">
                                                <label class="form-label">Your Response</label>
                                                <textarea class="form-control" id="ticketResponse" 
                                                          rows="4" placeholder="Type your response to the student..."></textarea>
                                            </div>
                                            
                                            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                                                <button type="button" class="btn btn-success" onclick="resolveTicket('${ticketId}', true)">
                                                    <i class="fas fa-check"></i> Respond & Resolve
                                                </button>
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fas fa-reply"></i> Respond Only
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('viewTicketModal');
                if (existingModal) existingModal.remove();
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Handle respond form submission if ticket is open
                if (ticket.status === 'open') {
                    document.getElementById('respondTicketForm')?.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        
                        const response = document.getElementById('ticketResponse').value.trim();
                        if (!response) {
                            showError('Please enter a response');
                            return;
                        }
                        
                        try {
                            // Mapped to: PUT /api/teacher/help-tickets/:ticketId/respond
                            await apiCall(`/teacher/help-tickets/${ticketId}/respond`, {
                                method: 'PUT',
                                body: JSON.stringify({ response })
                            });
                            
                            showSuccess('Response sent successfully!');
                            closeModal('viewTicketModal');
                            
                            // Reload tickets list
                            await loadHelpTickets();
                            
                        } catch (error) {
                            showError('Failed to respond to ticket: ' + error.message);
                        }
                    });
                }
                
            } catch (error) {
                console.error('View ticket error:', error);
                showError('Failed to load ticket details');
            }
        }

        // ============================================================================
        // RESOLVE TICKET FUNCTION
        // ============================================================================

        async function resolveTicket(ticketId, fromViewModal = false) {
            if (!fromViewModal) {
                // Called from tickets list - need to get resolution from user
                const resolution = prompt('Enter resolution for this ticket:');
                if (!resolution || !resolution.trim()) {
                    showError('Resolution is required');
                    return;
                }
                
                await submitResolution(ticketId, resolution.trim());
            } else {
                // Called from view modal - already has response
                const response = document.getElementById('ticketResponse')?.value.trim();
                if (!response) {
                    showError('Please enter a response before resolving');
                    return;
                }
                
                const resolution = prompt('Enter final resolution summary (optional):', response);
                await submitResolution(ticketId, resolution || response);
            }
        }

        async function submitResolution(ticketId, resolution) {
            try {
                // Mapped to: PUT /api/teacher/help-tickets/:ticketId/resolve
                await apiCall(`/teacher/help-tickets/${ticketId}/resolve`, {
                    method: 'PUT',
                    body: JSON.stringify({ resolution })
                });
                
                showSuccess('Ticket resolved successfully!');
                
                // Close modals and reload data
                closeModal('viewTicketModal');
                await loadHelpTickets();
                
            } catch (error) {
                showError('Failed to resolve ticket: ' + error.message);
            }
        }

        // ============================================================================
        // GENERATE CLASS REPORT FUNCTION
        // ============================================================================

        async function generateClassReport() {
            const selectedClass = document.getElementById('reportClass').value;
            const selectedSection = document.getElementById('reportSection').value;
            
            if (!selectedClass || !selectedSection) {
                showError('Please select both class and section');
                return;
            }
            
            try {
                // Show loading
                showLoading('Generating class report...');
                
                // Mapped to: GET /api/teacher/reports/class-performance?class=X&section=Y
                const data = await apiCall(`/teacher/reports/class-performance?class=${selectedClass}&section=${selectedSection}`);
                
                // Create report modal
                const modalHTML = `
                    <div id="classReportModal" class="modal" style="display: flex;">
                        <div class="modal-content" style="max-width: 1000px; max-height: 90vh;">
                            <div class="modal-header">
                                <h2><i class="fas fa-file-pdf"></i> Class ${selectedClass}-${selectedSection} Report</h2>
                                <div>
                                    <button class="btn btn-secondary btn-sm" onclick="downloadReport('class', ${selectedClass}, '${selectedSection}')">
                                        <i class="fas fa-download"></i> Download PDF
                                    </button>
                                    <button class="modal-close" onclick="closeModal('classReportModal')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="modal-body">
                                <!-- Report Header -->
                                <div style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
                                    <h3>Class Performance Report</h3>
                                    <div style="color: #888; margin-top: 10px;">
                                        Class ${selectedClass}-${selectedSection} | Generated: ${new Date().toLocaleDateString()}
                                    </div>
                                </div>
                                
                                <!-- Summary Statistics -->
                                <div style="margin-bottom: 30px;">
                                    <h4>Summary Statistics</h4>
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 15px;">
                                        <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                                            <div style="font-size: 2rem; font-weight: 700; color: #00d4ff;">${data.class.totalStudents || 0}</div>
                                            <div style="color: #888; font-size: 0.85rem;">Total Students</div>
                                        </div>
                                        <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                                            <div style="font-size: 2rem; font-weight: 700; color: #27ae60;">${(data.statistics.averagePerformance || 0).toFixed(1)}%</div>
                                            <div style="color: #888; font-size: 0.85rem;">Avg Performance</div>
                                        </div>
                                        <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                                            <div style="font-size: 2rem; font-weight: 700; color: #f39c12;">${(data.statistics.averageChallengesCompleted || 0).toFixed(1)}</div>
                                            <div style="color: #888; font-size: 0.85rem;">Avg Challenges</div>
                                        </div>
                                        <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                                            <div style="font-size: 2rem; font-weight: 700; color: #e74c3c;">${data.statistics.distribution.needsImprovement || 0}</div>
                                            <div style="color: #888; font-size: 0.85rem;">Need Attention</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Competencies Overview -->
                                <div style="margin-bottom: 30px;">
                                    <h4>NEP Competencies Overview</h4>
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                                        ${Object.entries(data.competencies || {}).map(([competency, score]) => `
                                            <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px;">
                                                <div style="font-weight: 600; margin-bottom: 10px;">
                                                    ${competency.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 10px;">
                                                    <div class="progress-bar" style="flex: 1;">
                                                        <div class="progress-fill" style="width: ${score}%;"></div>
                                                    </div>
                                                    <div style="font-weight: 700;">${score.toFixed(1)}%</div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <!-- Student Performance Table -->
                                <div>
                                    <h4>Student Performance Details</h4>
                                    <div style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
                                        <table style="width: 100%; border-collapse: collapse;">
                                            <thead>
                                                <tr>
                                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">Student</th>
                                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">ID</th>
                                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">Performance</th>
                                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">Grade</th>
                                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">Challenges</th>
                                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${data.students.map(student => `
                                                    <tr>
                                                        <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                                            ${student.name}
                                                        </td>
                                                        <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                                            ${student.studentId}
                                                        </td>
                                                        <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                                <span>${student.performanceIndex.toFixed(1)}%</span>
                                                                <div class="progress-bar" style="width: 80px;">
                                                                    <div class="progress-fill" style="width: ${student.performanceIndex}%;"></div>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                                            <span class="badge ${getGradeBadgeClass(student.grade)}">
                                                                ${student.grade || 'N/A'}
                                                            </span>
                                                        </td>
                                                        <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                                            ${student.totalChallenges || 0}
                                                        </td>
                                                        <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                                            ${student.performanceIndex >= 70 ? 
                                                                '<span style="color: #27ae60;">âœ“ Excellent</span>' : 
                                                                student.performanceIndex >= 50 ? 
                                                                '<span style="color: #f39c12;">â—‹ Average</span>' : 
                                                                '<span style="color: #e74c3c;">âš  Needs Help</span>'
                                                            }
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Recommendations -->
                                <div style="margin-top: 30px; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                                    <h4>Recommendations</h4>
                                    <ul style="margin-top: 10px; padding-left: 20px;">
                                        ${data.statistics.distribution.needsImprovement > 0 ? `
                                            <li style="margin-bottom: 8px;">
                                                <strong>Attention Needed:</strong> ${data.statistics.distribution.needsImprovement} students require immediate intervention.
                                                Consider arranging remedial sessions or one-on-one guidance.
                                            </li>
                                        ` : ''}
                                        <li style="margin-bottom: 8px;">
                                            <strong>Focus Areas:</strong> 
                                            ${Object.entries(data.competencies || {})
                                                .filter(([_, score]) => score < 60)
                                                .map(([comp, _]) => comp.replace(/-/g, ' '))
                                                .join(', ') || 'All competencies are performing well'}
                                        </li>
                                        <li style="margin-bottom: 8px;">
                                            <strong>Next Steps:</strong> Review individual student reports for detailed analysis and personalized learning paths.
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('classReportModal');
                if (existingModal) existingModal.remove();
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
            } catch (error) {
                console.error('Generate class report error:', error);
                showError('Failed to generate class report: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ============================================================================
        // GENERATE STUDENT REPORT FUNCTION
        // ============================================================================

        async function generateStudentReport() {
            const studentId = document.getElementById('reportStudentId').value.trim();
            
            if (!studentId) {
                showError('Please enter a Student ID');
                return;
            }
            
            try {
                // Show loading
                showLoading('Generating student report...');
                
                // Mapped to: GET /api/teacher/reports/student/:studentId
                const data = await apiCall(`/teacher/reports/student/${studentId}`);
                const student = data.student;
                const performance = data.performance;
                const competencies = data.competencies;
                const nepReports = data.nepReports || [];
                
                // Create student report modal
                const modalHTML = `
                    <div id="studentReportModal" class="modal" style="display: flex;">
                        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
                            <div class="modal-header">
                                <h2><i class="fas fa-file-pdf"></i> Student Report: ${student.name}</h2>
                                <div>
                                    <button class="btn btn-secondary btn-sm" onclick="downloadReport('student', '${studentId}')">
                                        <i class="fas fa-download"></i> Download PDF
                                    </button>
                                    <button class="modal-close" onclick="closeModal('studentReportModal')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="modal-body">
                                <!-- Student Header -->
                                <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
                                    <div class="student-avatar" style="width: 80px; height: 80px; font-size: 2rem;">
                                        ${student.name.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <h3>${student.name}</h3>
                                        <div style="color: #888; margin-top: 5px;">
                                            ${student.studentId} | Class ${student.class}-${student.section} | Roll: ${student.rollNumber || 'N/A'}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Performance Overview -->
                                <div style="margin-bottom: 30px;">
                                    <h4>Performance Overview</h4>
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 15px;">
                                        <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                                            <div style="font-size: 2rem; font-weight: 700; color: #00d4ff;">${(student.performanceIndex || 0).toFixed(1)}%</div>
                                            <div style="color: #888; font-size: 0.85rem;">Performance Index</div>
                                            <div style="margin-top: 10px;">
                                                <span class="badge ${getGradeBadgeClass(student.grade)}">
                                                    ${student.grade || 'N/A'}
                                                </span>
                                            </div>
                                        </div>
                                        <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                                            <div style="font-size: 2rem; font-weight: 700; color: #27ae60;">${performance.totalChallenges || 0}</div>
                                            <div style="color: #888; font-size: 0.85rem;">Total Challenges</div>
                                            <div style="margin-top: 10px; font-size: 0.9rem;">
                                                ${performance.passedChallenges || 0} passed (${((performance.passRate || 0) * 100).toFixed(1)}%)
                                            </div>
                                        </div>
                                        <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                                            <div style="font-size: 2rem; font-weight: 700; color: #f39c12;">${performance.currentStreak || 0}</div>
                                            <div style="color: #888; font-size: 0.85rem;">Current Streak</div>
                                            <div style="margin-top: 10px; font-size: 0.9rem;">
                                                Daily active days
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Competencies Radar -->
                                <div style="margin-bottom: 30px;">
                                    <h4>NEP Competencies Assessment</h4>
                                    <div style="height: 300px; margin-top: 15px;">
                                        <canvas id="studentCompetencyChart"></canvas>
                                    </div>
                                </div>
                                
                                <!-- NEP Reports -->
                                ${nepReports.length > 0 ? `
                                    <div style="margin-bottom: 30px;">
                                        <h4>NEP Performance Reports</h4>
                                        <div style="max-height: 300px; overflow-y: auto; margin-top: 15px;">
                                            ${nepReports.map(report => `
                                                <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                                    <div style="font-weight: 600; margin-bottom: 5px;">
                                                        ${report.title || 'Performance Report'}
                                                    </div>
                                                    <div style="color: #888; font-size: 0.85rem; margin-bottom: 10px;">
                                                        Generated: ${formatDate(report.generatedAt)} | 
                                                        Score: ${(report.score || 0).toFixed(1)}%
                                                    </div>
                                                    <div style="white-space: pre-wrap; font-size: 0.9rem;">
                                                        ${report.summary || 'No summary available'}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <!-- Recommendations -->
                                <div style="margin-top: 30px; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                                    <h4>Recommendations & Action Plan</h4>
                                    <div style="margin-top: 15px;">
                                        ${student.performanceIndex >= 70 ? `
                                            <p><strong>Status:</strong> <span style="color: #27ae60;">Performing well âœ“</span></p>
                                            <p><strong>Action:</strong> Encourage participation in advanced challenges. Focus on developing leadership skills through peer mentoring.</p>
                                        ` : student.performanceIndex >= 50 ? `
                                            <p><strong>Status:</strong> <span style="color: #f39c12;">Average performance â—‹</span></p>
                                            <p><strong>Action:</strong> Provide additional practice challenges. Schedule weekly progress reviews.</p>
                                        ` : `
                                            <p><strong>Status:</strong> <span style="color: #e74c3c;">Needs immediate attention âš </span></p>
                                            <p><strong>Action:</strong> Arrange one-on-one remedial sessions. Focus on foundational concepts.</p>
                                        `}
                                        
                                        <!-- Weak competencies -->
                                        ${Object.entries(competencies || {}).filter(([_, score]) => score < 50).length > 0 ? `
                                            <div style="margin-top: 15px;">
                                                <p><strong>Focus Areas:</strong></p>
                                                <ul style="padding-left: 20px; margin-top: 8px;">
                                                    ${Object.entries(competencies || {})
                                                        .filter(([_, score]) => score < 50)
                                                        .map(([comp, score]) => `
                                                            <li style="margin-bottom: 5px;">
                                                                ${comp.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())} 
                                                                (${score.toFixed(1)}%)
                                                            </li>
                                                        `).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('studentReportModal');
                if (existingModal) existingModal.remove();
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Initialize competency chart
                setTimeout(() => {
                    initializeStudentCompetencyChart(competencies);
                }, 100);
                
            } catch (error) {
                console.error('Generate student report error:', error);
                showError('Failed to generate student report: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ============================================================================
        // HELPER FUNCTIONS
        // ============================================================================

        function initializeStudentCompetencyChart(competencies) {
            const ctx = document.getElementById('studentCompetencyChart').getContext('2d');
            
            const labels = Object.keys(competencies || {}).map(comp => 
                comp.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
            );
            
            const values = Object.values(competencies || {}).map(score => score || 0);
            
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Competency Score',
                        data: values,
                        backgroundColor: 'rgba(0, 212, 255, 0.2)',
                        borderColor: '#00d4ff',
                        pointBackgroundColor: '#00d4ff',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#00d4ff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#fff' }
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { 
                                color: '#888',
                                backdropColor: 'transparent'
                            },
                            grid: { color: '#464647' },
                            pointLabels: { color: '#fff' }
                        }
                    }
                }
            });
        }

        function showLoading(message = 'Loading...') {
            // Create loading overlay if it doesn't exist
            if (!document.getElementById('loadingOverlay')) {
                const overlayHTML = `
                    <div id="loadingOverlay" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.7);
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                        z-index: 2000;
                    ">
                        <div class="spinner"></div>
                        <div style="color: white; margin-top: 20px; font-size: 1.1rem;">${message}</div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', overlayHTML);
            } else {
                document.getElementById('loadingOverlay').style.display = 'flex';
                document.querySelector('#loadingOverlay > div:last-child').textContent = message;
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        function downloadReport(type, param1, param2 = null) {
            showLoading('Preparing download...');
            
            // Simulate download (you would implement actual PDF generation here)
            setTimeout(() => {
                hideLoading();
                
                if (type === 'class') {
                    alert(`PDF report for Class ${param1}-${param2} would be downloaded.\n\nIn production, this would generate a PDF using libraries like jsPDF or send a request to your backend.`);
                } else if (type === 'student') {
                    alert(`PDF report for Student ${param1} would be downloaded.\n\nIn production, this would generate a PDF using libraries like jsPDF or send a request to your backend.`);
                }
            }, 1500);
        }

        // Initialize the filter listeners when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeFilterListeners();
        });
    </script>
</body>
</html>