<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gravity Simulator - NEP Workbench</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        :root { --bg: #0a0a0a; --panel: #1a1a1a; --accent: #007acc; --sun: #ffa500; --planet: #4ecdc4; }
        body { background: var(--bg); color: #fff; }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        .header { background: #1a1a1a; border-radius: 8px; padding: 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { font-size: 24px; color: var(--accent); }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; background: var(--accent); color: white; }
        .main { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        .panel { background: var(--panel); border-radius: 8px; padding: 20px; border: 1px solid #333; }
        .space-area { background: #000; border-radius: 6px; height: 550px; border: 1px solid #333; position: relative; overflow: hidden; }
        canvas { width: 100%; height: 100%; }
        input[type="range"] { width: 100%; height: 8px; background: #2d2d30; border-radius: 4px; }
        input[type="range"]::-webkit-slider-thumb { width: 20px; height: 20px; background: var(--accent); border-radius: 50%; cursor: pointer; }
        .preset-btn { padding: 10px; background: #2d2d30; border: 1px solid #464647; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.3s; margin: 5px 0; }
        .preset-btn:hover { background: var(--accent); }
        .info-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .info-card { background: #2d2d30; padding: 12px; border-radius: 6px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div><h1><i class="fas fa-globe"></i> Gravity Simulator</h1><p style="color: #888;">Physics Lab • Grade 9-10</p></div>
            <div style="display: flex; gap: 15px;">
                <span><i class="fas fa-clock"></i> <span id="timer">00:00</span></span>
                <button class="btn" onclick="saveProgress()"><i class="fas fa-save"></i> Save</button>
                <button class="btn" style="background: #00b894;" onclick="complete()"><i class="fas fa-check"></i> Complete</button>
            </div>
        </div>
        
        <div class="main">
            <div class="panel">
                <h2 style="margin-bottom: 15px;">Orbital Mechanics</h2>
                
                <div class="space-area">
                    <canvas id="canvas"></canvas>
                </div>
                
                <div style="margin-top: 20px;">
                    <label style="display: block; margin-bottom: 10px; color: #888;">Orbital Velocity: <span id="velocityDisplay">30</span> km/s</label>
                    <input type="range" id="velocitySlider" min="10" max="100" value="30" oninput="updateOrbit()">
                </div>
                
                <div style="margin-top: 15px;">
                    <label style="display: block; margin-bottom: 10px; color: #888;">Distance: <span id="distanceDisplay">150</span> million km</label>
                    <input type="range" id="distanceSlider" min="50" max="400" value="150" oninput="updateOrbit()">
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px;">
                    <button class="btn" onclick="startSim()"><i class="fas fa-play"></i> Start</button>
                    <button class="btn" style="background: #e74c3c;" onclick="pauseSim()"><i class="fas fa-pause"></i> Pause</button>
                    <button class="btn" onclick="resetSim()"><i class="fas fa-redo"></i> Reset</button>
                </div>
            </div>
            
            <div class="panel">
                <h2 style="margin-bottom: 15px;"><i class="fas fa-calculator"></i> Orbital Data</h2>
                
                <div class="info-grid">
                    <div class="info-card">
                        <div style="color: #888; font-size: 12px;">Orbital Period</div>
                        <div style="font-size: 18px; font-weight: 600;" id="period">-- days</div>
                    </div>
                    <div class="info-card">
                        <div style="color: #888; font-size: 12px;">Orbital Speed</div>
                        <div style="font-size: 18px; font-weight: 600;" id="speed">-- km/s</div>
                    </div>
                    <div class="info-card">
                        <div style="color: #888; font-size: 12px;">Centripetal Force</div>
                        <div style="font-size: 18px; font-weight: 600;" id="force">-- N</div>
                    </div>
                    <div class="info-card">
                        <div style="color: #888; font-size: 12px;">Gravitational Potential</div>
                        <div style="font-size: 18px; font-weight: 600;" id="potential">-- J/kg</div>
                    </div>
                </div>
                
                <h3 style="margin: 20px 0 10px;">Preset Scenarios</h3>
                <div class="preset-btn" onclick="setPreset('earth')">
                    <strong>Earth Orbit</strong><br>
                    <small style="color: #888;">150M km, 30 km/s</small>
                </div>
                <div class="preset-btn" onclick="setPreset('mercury')">
                    <strong>Mercury Orbit</strong><br>
                    <small style="color: #888;">58M km, 48 km/s</small>
                </div>
                <div class="preset-btn" onclick="setPreset('mars')">
                    <strong>Mars Orbit</strong><br>
                    <small style="color: #888;">228M km, 24 km/s</small>
                </div>
                
                <div style="background: rgba(0, 122, 204, 0.1); border: 1px solid var(--accent); border-radius: 6px; padding: 15px; margin-top: 20px; font-size: 12px; line-height: 1.8;">
                    <strong style="color: var(--accent);">Kepler's Laws:</strong><br>
                    F = GMm/r²<br>
                    v = √(GM/r)<br>
                    T² ∝ r³
                </div>
                
                <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div style="background: #2d2d30; padding: 15px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 24px; color: var(--accent); font-weight: 600;" id="statOrbits">0</div>
                        <div style="font-size: 12px; color: #888;">Orbits</div>
                    </div>
                    <div style="background: #2d2d30; padding: 15px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 24px; color: var(--accent); font-weight: 600;" id="statPresets">0</div>
                        <div style="font-size: 12px; color: #888;">Presets</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        const API_BASE_URL = 'http://localhost:3000/api';
        const authToken = localStorage.getItem('authToken');
        let eventId = null, sessionStart = Date.now();
        
        // Physics constants
        const G = 6.674e-11;  // Gravitational constant
        const M_sun = 1.989e30;  // Mass of the Sun
        const AU = 1.496e11;  // Astronomical unit in meters
        
        // Simulation variables
        let velocity = 30000;  // Initial velocity in m/s
        let distance = 150e9;  // Initial distance in meters
        let running = false;
        let animationId = null;
        let angle = 0;
        let planetX = 0;
        let planetY = 0;
        let lastTime = 0;
        
        // Canvas references
        let canvas;
        let ctx;
        
        // Interaction tracking
        let interactionData = {
            actions_count: 0,
            time_seconds: 0,
            total_parameter_space: 200,
            tool_usage: {},
            orbits_simulated: 0,
            presets_used: new Set(),
            velocities_tested: new Set(),
            distances_tested: new Set()
        };
        
        async function init() {
            // Initialize canvas
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            
            // Set canvas dimensions properly
            function resizeCanvas() {
                if (canvas && canvas.parentElement) {
                    canvas.width = canvas.parentElement.clientWidth;
                    canvas.height = canvas.parentElement.clientHeight;
                    draw();
                }
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Initialize event tracking if authenticated
            if (authToken) {
                try {
                    const studentId = JSON.parse(atob(authToken.split('.')[1])).userId;
                    const res = await fetch(`${API_BASE_URL}/student/event`, {
                        method: 'POST',
                        headers: { 
                            'Authorization': `Bearer ${authToken}`, 
                            'Content-Type': 'application/json' 
                        },
                        body: JSON.stringify({ 
                            studentId, 
                            toolId: 'gravity-simulator', 
                            toolType: 'LAB', 
                            interactionData 
                        })
                    });
                    if (res.ok) {
                        const data = await res.json();
                        eventId = data.data._id;
                    }
                } catch (err) {
                    console.log('Event tracking not available:', err);
                }
            }
            
            // Initialize simulation
            updateOrbit();
            
            // Update timer every second
            setInterval(() => {
                const e = Math.floor((Date.now() - sessionStart) / 1000);
                document.getElementById('timer').textContent = 
                    `${Math.floor(e/60).toString().padStart(2,'0')}:${(e%60).toString().padStart(2,'0')}`;
            }, 1000);
            
            // Auto-save progress every 30 seconds
            setInterval(saveProgress, 30000);
        }
        
        function updateOrbit() {
            // Update values from sliders
            velocity = parseFloat(document.getElementById('velocitySlider').value) * 1000;
            distance = parseFloat(document.getElementById('distanceSlider').value) * 1e9;
            
            // Update display
            document.getElementById('velocityDisplay').textContent = (velocity / 1000).toFixed(0);
            document.getElementById('distanceDisplay').textContent = (distance / 1e9).toFixed(0);
            
            // Track interaction
            interactionData.velocities_tested.add(Math.floor(velocity / 1000));
            interactionData.distances_tested.add(Math.floor(distance / 1e9));
            interactionData.actions_count++;
            
            // Update physics calculations
            calculateOrbitalData();
            draw();
        }
        
        function calculateOrbitalData() {
            // Calculate actual orbital parameters based on physics
            const orbitalSpeed = Math.sqrt(G * M_sun / distance);
            const period = (2 * Math.PI * distance) / orbitalSpeed;
            const force = (G * M_sun) / (distance * distance);
            const potential = -G * M_sun / distance;
            
            // Update display
            document.getElementById('period').textContent = (period / (24 * 3600)).toFixed(1) + ' days';
            document.getElementById('speed').textContent = (orbitalSpeed / 1000).toFixed(1) + ' km/s';
            document.getElementById('force').textContent = force.toExponential(2) + ' N';
            document.getElementById('potential').textContent = potential.toExponential(2) + ' J/kg';
        }
        
        function setPreset(type) {
            // Set preset values
            if (type === 'earth') {
                document.getElementById('velocitySlider').value = 30;
                document.getElementById('distanceSlider').value = 150;
            } else if (type === 'mercury') {
                document.getElementById('velocitySlider').value = 48;
                document.getElementById('distanceSlider').value = 58;
            } else if (type === 'mars') {
                document.getElementById('velocitySlider').value = 24;
                document.getElementById('distanceSlider').value = 228;
            }
            
            // Update simulation
            updateOrbit();
            
            // Track usage
            interactionData.presets_used.add(type);
            interactionData.actions_count++;
            updateStats();
        }
        
        function startSim() {
            if (!running) {
                running = true;
                lastTime = Date.now();
                if (animationId) cancelAnimationFrame(animationId);
                animate();
                interactionData.orbits_simulated++;
                updateStats();
            }
        }
        
        function pauseSim() {
            running = false;
        }
        
        function resetSim() {
            pauseSim();
            angle = 0;
            draw();
            interactionData.actions_count++;
        }
        
        function animate() {
            if (!running) return;
            
            // Calculate time delta for smooth animation
            const now = Date.now();
            const deltaTime = (now - lastTime) / 1000; // Convert to seconds
            lastTime = now;
            
            // Update angle based on orbital period
            const orbitalPeriod = (2 * Math.PI * distance) / Math.sqrt(G * M_sun / distance);
            const angularSpeed = (2 * Math.PI) / orbitalPeriod;
            
            // Adjust animation speed for visual effect
            angle += angularSpeed * deltaTime * 365; // Speed up by factor of 365
            
            // Keep angle within 0 to 2π
            if (angle > 2 * Math.PI) {
                angle -= 2 * Math.PI;
            }
            
            // Redraw
            draw();
            
            // Continue animation
            animationId = requestAnimationFrame(animate);
        }
        
        function draw() {
            // Safety check
            if (!canvas || !ctx) return;
            
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            
            // Clear canvas
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, width, height);
            
            // Draw stars background
            ctx.fillStyle = '#fff';
            for (let i = 0; i < 100; i++) {
                const x = (i * 137) % width;
                const y = (i * 197) % height;
                ctx.fillRect(x, y, 1, 1);
            }
            
            // Draw Sun
            const sunRadius = 30;
            const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, sunRadius);
            gradient.addColorStop(0, '#ffff00');
            gradient.addColorStop(1, '#ff6600');
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(centerX, centerY, sunRadius, 0, Math.PI * 2);
            ctx.fill();
            
            // Calculate scale for orbit
            const maxOrbitRadius = Math.min(width, height) * 0.4;
            const orbitRadius = Math.min((distance / AU) * (maxOrbitRadius / 5), maxOrbitRadius);
            
            // Draw orbit path
            ctx.strokeStyle = 'rgba(100, 100, 100, 0.3)';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.arc(centerX, centerY, orbitRadius, 0, Math.PI * 2);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Calculate planet position
            planetX = centerX + orbitRadius * Math.cos(angle);
            planetY = centerY + orbitRadius * Math.sin(angle);
            
            // Draw planet
            const planetRadius = 10;
            ctx.fillStyle = '#4ecdc4';
            ctx.beginPath();
            ctx.arc(planetX, planetY, planetRadius, 0, Math.PI * 2);
            ctx.fill();
            
            // Add highlight to planet
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.beginPath();
            ctx.arc(planetX - planetRadius/3, planetY - planetRadius/3, planetRadius/2, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw velocity vector (tangent to orbit)
            const vecLen = 40;
            const vecX = -Math.sin(angle) * vecLen;
            const vecY = Math.cos(angle) * vecLen;
            
            ctx.strokeStyle = '#ff6b6b';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(planetX, planetY);
            ctx.lineTo(planetX + vecX, planetY + vecY);
            ctx.stroke();
            
            // Draw arrowhead for velocity
            ctx.fillStyle = '#ff6b6b';
            drawArrowhead(ctx, planetX + vecX, planetY + vecY, Math.atan2(vecY, vecX));
            
            // Draw gravity force vector (towards sun)
            const forceX = (centerX - planetX) * 0.3;
            const forceY = (centerY - planetY) * 0.3;
            
            ctx.strokeStyle = '#ffa500';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(planetX, planetY);
            ctx.lineTo(planetX + forceX, planetY + forceY);
            ctx.stroke();
            
            // Draw arrowhead for gravity
            ctx.fillStyle = '#ffa500';
            drawArrowhead(ctx, planetX + forceX, planetY + forceY, Math.atan2(forceY, forceX));
            
            // Draw labels
            ctx.fillStyle = '#fff';
            ctx.font = '12px Arial';
            ctx.fillText('Velocity', planetX + vecX + 5, planetY + vecY);
            ctx.fillText('Gravity', planetX + forceX + 5, planetY + forceY);
        }
        
        function drawArrowhead(ctx, x, y, angle) {
            const size = 6;
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(angle);
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(-size, -size/2);
            ctx.lineTo(-size, size/2);
            ctx.closePath();
            ctx.fill();
            ctx.restore();
        }
        
        function updateStats() {
            document.getElementById('statOrbits').textContent = interactionData.orbits_simulated;
            document.getElementById('statPresets').textContent = interactionData.presets_used.size;
        }
        
        async function saveProgress() {
            if (!eventId) return;
            
            interactionData.time_seconds = Math.floor((Date.now() - sessionStart) / 1000);
            interactionData.presets_used = Array.from(interactionData.presets_used);
            interactionData.velocities_tested = Array.from(interactionData.velocities_tested);
            interactionData.distances_tested = Array.from(interactionData.distances_tested);
            
            try {
                await fetch(`${API_BASE_URL}/student/event/${eventId}`, {
                    method: 'PATCH',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`, 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ interactionData })
                });
            } catch (err) {
                console.log('Save failed:', err);
            }
        }
        
        async function complete() {
            pauseSim();
            await saveProgress();
            alert('Session completed!');
            window.location.href = '/dashboard';
        }
        
        // Initialize on load
        window.addEventListener('load', init);
        window.addEventListener('beforeunload', saveProgress);
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (canvas && canvas.parentElement) {
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = canvas.parentElement.clientHeight;
                draw();
            }
        });
    </script>
</body>
</html>