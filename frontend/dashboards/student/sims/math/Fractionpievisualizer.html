<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fraction Pie Visualizer - NEP Workbench</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        :root { --bg: #1e1e1e; --panel: #252526; --accent: #007acc; --success: #00b894; }
        body { background: var(--bg); color: #fff; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: #333; border-radius: 8px; padding: 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        h1 { font-size: 24px; color: var(--accent); }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; background: var(--accent); color: white; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); }
        .main { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .panel { background: var(--panel); border-radius: 8px; padding: 20px; border: 1px solid #464647; }
        .canvas-area { background: var(--bg); border-radius: 6px; height: 400px; display: flex; justify-content: center; align-items: center; border: 1px solid #464647; }
        canvas { max-width: 100%; max-height: 100%; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .input-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-size: 13px; color: #888; }
        input, select { padding: 12px; background: #2d2d30; border: 1px solid #464647; border-radius: 4px; color: #fff; font-size: 16px; }
        input:focus { outline: none; border-color: var(--accent); }
        .operation-btns { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0; }
        .op-btn { padding: 15px; background: #2d2d30; border: 2px solid #464647; border-radius: 6px; cursor: pointer; text-align: center; transition: all 0.3s; font-size: 18px; }
        .op-btn:hover { border-color: var(--accent); background: var(--accent); }
        .result { background: #2d2d30; padding: 20px; border-radius: 6px; margin-top: 20px; text-align: center; }
        .result-value { font-size: 36px; color: var(--accent); font-weight: 600; }
        @media (max-width: 1024px) { .main { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div><h1><i class="fas fa-chart-pie"></i> Fraction Pie Visualizer</h1><p style="color: #888;">Math Lab • Grade 6-7</p></div>
            <div style="display: flex; gap: 15px;">
                <span><i class="fas fa-clock"></i> <span id="timer">00:00</span></span>
                <button class="btn" onclick="saveProgress()"><i class="fas fa-save"></i> Save</button>
                <button class="btn" style="background: #00b894;" onclick="complete()"><i class="fas fa-check"></i> Complete</button>
            </div>
        </div>
        
        <div class="main">
            <div class="panel">
                <h2 style="margin-bottom: 20px;">Fraction 1</h2>
                <div class="canvas-area">
                    <canvas id="canvas1" width="350" height="350"></canvas>
                </div>
                <div class="controls">
                    <div class="input-group">
                        <label>Numerator</label>
                        <input type="number" id="num1" value="1" min="1" max="20" oninput="update()">
                    </div>
                    <div class="input-group">
                        <label>Denominator</label>
                        <input type="number" id="den1" value="4" min="1" max="20" oninput="update()">
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h2 style="margin-bottom: 20px;">Fraction 2</h2>
                <div class="canvas-area">
                    <canvas id="canvas2" width="350" height="350"></canvas>
                </div>
                <div class="controls">
                    <div class="input-group">
                        <label>Numerator</label>
                        <input type="number" id="num2" value="1" min="1" max="20" oninput="update()">
                    </div>
                    <div class="input-group">
                        <label>Denominator</label>
                        <input type="number" id="den2" value="2" min="1" max="20" oninput="update()">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="panel" style="margin-top: 20px;">
            <h2 style="margin-bottom: 15px;">Operations</h2>
            <div class="operation-btns">
                <div class="op-btn" onclick="calculate('add')">+ Add</div>
                <div class="op-btn" onclick="calculate('sub')">− Subtract</div>
                <div class="op-btn" onclick="calculate('mul')">× Multiply</div>
                <div class="op-btn" onclick="calculate('div')">÷ Divide</div>
            </div>
            
            <div class="result">
                <div style="color: #888; font-size: 14px; margin-bottom: 10px;">Result</div>
                <div class="result-value" id="result">?</div>
                <div style="color: #888; font-size: 14px; margin-top: 10px;">
                    Decimal: <span id="decimal">?</span> | Percentage: <span id="percent">?</span>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 20px;">
                <div style="background: #2d2d30; padding: 15px; border-radius: 6px; text-align: center;">
                    <div style="font-size: 24px; color: var(--accent); font-weight: 600;" id="statOps">0</div>
                    <div style="font-size: 12px; color: #888;">Operations</div>
                </div>
                <div style="background: #2d2d30; padding: 15px; border-radius: 6px; text-align: center;">
                    <div style="font-size: 24px; color: var(--accent); font-weight: 600;" id="statCompare">0</div>
                    <div style="font-size: 12px; color: #888;">Comparisons</div>
                </div>
                <div style="background: #2d2d30; padding: 15px; border-radius: 6px; text-align: center;">
                    <div style="font-size: 24px; color: var(--accent); font-weight: 600;" id="statSimplify">0</div>
                    <div style="font-size: 12px; color: #888;">Simplifications</div>
                </div>
                <div style="background: #2d2d30; padding: 15px; border-radius: 6px; text-align: center;">
                    <div style="font-size: 24px; color: var(--accent); font-weight: 600;" id="statConvert">0</div>
                    <div style="font-size: 12px; color: #888;">Conversions</div>
                </div>
            </div>
        </div>
    </div>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        const API_BASE_URL = 'http://localhost:3000/api';
        const authToken = localStorage.getItem('authToken');
        let eventId = null, sessionStart = Date.now();
        
        let interactionData = {
            actions_count: 0, time_seconds: 0, total_parameter_space: 400,
            tool_usage: {}, operations_performed: 0, comparisons_made: 0, 
            simplifications: 0, conversions: 0, unique_fractions: []
        };
        
        async function init() {
            if (authToken) {
                try {
                    const studentId = JSON.parse(atob(authToken.split('.')[1])).userId;
                    const res = await fetch(`${API_BASE_URL}/student/event`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ studentId, toolId: 'fraction-pie-visualizer', toolType: 'LAB', interactionData })
                    });
                    if (res.ok) eventId = (await res.json()).data._id;
                } catch (err) {}
            }
            
            update();
            setInterval(() => {
                const e = Math.floor((Date.now() - sessionStart) / 1000);
                document.getElementById('timer').textContent = `${Math.floor(e/60).toString().padStart(2,'0')}:${(e%60).toString().padStart(2,'0')}`;
            }, 1000);
            setInterval(saveProgress, 30000);
        }
        
        function update() {
            drawPie('canvas1', parseInt(document.getElementById('num1').value), parseInt(document.getElementById('den1').value));
            drawPie('canvas2', parseInt(document.getElementById('num2').value), parseInt(document.getElementById('den2').value));
            interactionData.actions_count++;
            
            const frac = `${document.getElementById('num1').value}/${document.getElementById('den1').value}`;
            if (!interactionData.unique_fractions.includes(frac)) interactionData.unique_fractions.push(frac);
        }
        
        function drawPie(canvasId, num, den) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 150;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Full circle
            ctx.fillStyle = '#2d2d30';
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#464647';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Filled portion
            const angle = (num / den) * 2 * Math.PI;
            ctx.fillStyle = '#007acc';
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, -Math.PI / 2, -Math.PI / 2 + angle);
            ctx.closePath();
            ctx.fill();
            
            // Draw segments
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            for (let i = 0; i < den; i++) {
                const segAngle = -Math.PI / 2 + (i / den) * 2 * Math.PI;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(
                    centerX + radius * Math.cos(segAngle),
                    centerY + radius * Math.sin(segAngle)
                );
                ctx.stroke();
            }
            
            // Label
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 32px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`${num}/${den}`, centerX, centerY + 10);
        }
        
        function gcd(a, b) { return b === 0 ? a : gcd(b, a % b); }
        
        function simplify(num, den) {
            const g = gcd(num, den);
            return [num / g, den / g];
        }
        
        function calculate(op) {
            const n1 = parseInt(document.getElementById('num1').value);
            const d1 = parseInt(document.getElementById('den1').value);
            const n2 = parseInt(document.getElementById('num2').value);
            const d2 = parseInt(document.getElementById('den2').value);
            
            let num, den;
            
            if (op === 'add') {
                num = n1 * d2 + n2 * d1;
                den = d1 * d2;
            } else if (op === 'sub') {
                num = n1 * d2 - n2 * d1;
                den = d1 * d2;
            } else if (op === 'mul') {
                num = n1 * n2;
                den = d1 * d2;
            } else if (op === 'div') {
                num = n1 * d2;
                den = d1 * n2;
            }
            
            const [sNum, sDen] = simplify(num, den);
            const decimal = (sNum / sDen).toFixed(4);
            const percent = ((sNum / sDen) * 100).toFixed(2) + '%';
            
            document.getElementById('result').textContent = `${sNum}/${sDen}`;
            document.getElementById('decimal').textContent = decimal;
            document.getElementById('percent').textContent = percent;
            
            interactionData.operations_performed++;
            interactionData.simplifications++;
            interactionData.conversions += 2;
            interactionData.tool_usage[op] = (interactionData.tool_usage[op] || 0) + 1;
            updateStats();
        }
        
        function updateStats() {
            document.getElementById('statOps').textContent = interactionData.operations_performed;
            document.getElementById('statCompare').textContent = interactionData.comparisons_made;
            document.getElementById('statSimplify').textContent = interactionData.simplifications;
            document.getElementById('statConvert').textContent = interactionData.conversions;
        }
        
        async function saveProgress() {
            if (!eventId) return;
            interactionData.time_seconds = Math.floor((Date.now() - sessionStart) / 1000);
            try {
                await fetch(`${API_BASE_URL}/student/event/${eventId}`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interactionData })
                });
            } catch (err) {}
        }
        
        async function complete() {
            await saveProgress();
            alert('Session completed!');
            window.location.href = '/dashboard';
        }
        
        window.addEventListener('load', init);
        window.addEventListener('beforeunload', saveProgress);
    </script>
</body>
</html>