<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equation Balancer - NEP Workbench</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        :root { --bg: #1e1e1e; --panel: #252526; --accent: #007acc; --success: #00b894; --error: #e74c3c; }
        body { background: var(--bg); color: #fff; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: #333; border-radius: 8px; padding: 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { font-size: 24px; color: var(--accent); }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; background: var(--accent); color: white; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); }
        .main { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .panel { background: var(--panel); border-radius: 8px; padding: 20px; border: 1px solid #464647; }
        .equation-display { background: var(--bg); border-radius: 6px; padding: 40px; text-align: center; font-size: 32px; font-family: 'Courier New', monospace; border: 1px solid #464647; margin: 20px 0; min-height: 120px; display: flex; align-items: center; justify-content: center; }
        .steps-container { max-height: 400px; overflow-y: auto; }
        .step { background: #2d2d30; padding: 15px; margin: 10px 0; border-radius: 6px; border-left: 4px solid var(--accent); }
        .step-number { color: var(--accent); font-weight: 600; margin-bottom: 8px; }
        .step-equation { font-family: 'Courier New', monospace; font-size: 18px; margin: 10px 0; }
        .step-explanation { color: #888; font-size: 13px; margin-top: 8px; }
        .operation-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 20px 0; }
        .op-btn { padding: 15px; background: #2d2d30; border: 2px solid #464647; border-radius: 6px; cursor: pointer; text-align: center; font-size: 16px; transition: all 0.3s; }
        .op-btn:hover { border-color: var(--accent); background: var(--accent); }
        .input-group { display: flex; gap: 10px; margin: 15px 0; }
        .input-group input { flex: 1; padding: 12px; background: #2d2d30; border: 1px solid #464647; border-radius: 4px; color: #fff; font-size: 16px; }
        .feedback { padding: 15px; border-radius: 6px; margin: 15px 0; display: none; }
        .feedback.success { background: rgba(0, 184, 148, 0.1); border: 1px solid var(--success); color: var(--success); }
        .feedback.error { background: rgba(231, 76, 60, 0.1); border: 1px solid var(--error); color: var(--error); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div><h1><i class="fas fa-balance-scale"></i> Equation Balancer</h1><p style="color: #888;">Math Lab • Grade 7-8</p></div>
            <div style="display: flex; gap: 15px;">
                <span><i class="fas fa-clock"></i> <span id="timer">00:00</span></span>
                <button class="btn" onclick="saveProgress()"><i class="fas fa-save"></i> Save</button>
                <button class="btn" style="background: #00b894;" onclick="complete()"><i class="fas fa-check"></i> Complete</button>
            </div>
        </div>
        
        <div class="main">
            <div class="panel">
                <h2 style="margin-bottom: 15px;">Solve the Equation</h2>
                
                <div class="equation-display" id="equation">
                    2x + 5 = 13
                </div>
                
                <div style="background: #2d2d30; padding: 15px; border-radius: 6px; text-align: center; margin-bottom: 20px;">
                    <div style="color: #888; font-size: 13px; margin-bottom: 8px;">Goal: Isolate x</div>
                    <div style="font-size: 20px; color: var(--accent); font-weight: 600;" id="solution">x = ?</div>
                </div>
                
                <h3 style="margin: 20px 0 10px;">Apply Operation</h3>
                <div class="operation-grid">
                    <div class="op-btn" onclick="applyOperation('add')">+ Add</div>
                    <div class="op-btn" onclick="applyOperation('subtract')">− Subtract</div>
                    <div class="op-btn" onclick="applyOperation('multiply')">× Multiply</div>
                    <div class="op-btn" onclick="applyOperation('divide')">÷ Divide</div>
                </div>
                
                <div class="input-group">
                    <input type="number" id="operationValue" placeholder="Enter value..." step="0.1">
                    <button class="btn" onclick="submitOperation()"><i class="fas fa-arrow-right"></i> Apply</button>
                </div>
                
                <div class="feedback" id="feedback"></div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                    <button class="btn" onclick="checkAnswer()"><i class="fas fa-check-circle"></i> Check Answer</button>
                    <button class="btn" style="background: #e74c3c;" onclick="newProblem()"><i class="fas fa-sync"></i> New Problem</button>
                </div>
            </div>
            
            <div class="panel">
                <h2 style="margin-bottom: 15px;"><i class="fas fa-list-ol"></i> Solution Steps</h2>
                
                <div class="steps-container" id="steps">
                    <div class="step">
                        <div class="step-number">Step 0 (Original)</div>
                        <div class="step-equation">2x + 5 = 13</div>
                    </div>
                </div>
                
                <div style="background: rgba(0, 122, 204, 0.1); border: 1px solid var(--accent); border-radius: 6px; padding: 15px; margin-top: 20px; font-size: 13px; line-height: 1.8;">
                    <strong style="color: var(--accent);">Balance Rules:</strong><br>
                    • What you do to one side, do to the other<br>
                    • Inverse operations undo each other<br>
                    • Goal: Isolate the variable
                </div>
                
                <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div style="background: #2d2d30; padding: 15px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 24px; color: var(--accent); font-weight: 600;" id="statSolved">0</div>
                        <div style="font-size: 12px; color: #888;">Solved</div>
                    </div>
                    <div style="background: #2d2d30; padding: 15px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 24px; color: var(--accent); font-weight: 600;" id="statSteps">0</div>
                        <div style="font-size: 12px; color: #888;">Steps</div>
                    </div>
                    <div style="background: #2d2d30; padding: 15px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 24px; color: var(--accent); font-weight: 600;" id="statCorrect">0</div>
                        <div style="font-size: 12px; color: #888;">Correct</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        const API_BASE_URL = 'http://localhost:3000/api';
        const authToken = localStorage.getItem('authToken');
        let eventId = null, sessionStart = Date.now();
        
        let currentProblem = { a: 2, b: 5, c: 13 }, steps = [], selectedOp = null;
        let interactionData = {
            actions_count: 0, time_seconds: 0, total_parameter_space: 200,
            tool_usage: {}, problems_solved: 0, total_steps: 0, correct_attempts: 0, incorrect_attempts: 0
        };
        
        async function init() {
            if (authToken) {
                try {
                    const studentId = JSON.parse(atob(authToken.split('.')[1])).userId;
                    const res = await fetch(`${API_BASE_URL}/student/event`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ studentId, toolId: 'equation-balancer', toolType: 'LAB', interactionData })
                    });
                    if (res.ok) eventId = (await res.json()).data._id;
                } catch (err) {}
            }
            
            newProblem();
            setInterval(() => {
                const e = Math.floor((Date.now() - sessionStart) / 1000);
                document.getElementById('timer').textContent = `${Math.floor(e/60).toString().padStart(2,'0')}:${(e%60).toString().padStart(2,'0')}`;
            }, 1000);
            setInterval(saveProgress, 30000);
        }
        
        function newProblem() {
            currentProblem = {
                a: Math.floor(Math.random() * 5) + 1,
                b: Math.floor(Math.random() * 10) + 1,
                c: Math.floor(Math.random() * 20) + 10
            };
            
            steps = [{ equation: `${currentProblem.a}x + ${currentProblem.b} = ${currentProblem.c}`, explanation: 'Original equation' }];
            displayEquation();
            displaySteps();
            document.getElementById('feedback').style.display = 'none';
            document.getElementById('operationValue').value = '';
            interactionData.actions_count++;
        }
        
        function displayEquation() {
            const step = steps[steps.length - 1];
            document.getElementById('equation').textContent = step.equation;
        }
        
        function displaySteps() {
            const container = document.getElementById('steps');
            container.innerHTML = steps.map((step, i) => `
                <div class="step">
                    <div class="step-number">Step ${i}${i === 0 ? ' (Original)' : ''}</div>
                    <div class="step-equation">${step.equation}</div>
                    <div class="step-explanation">${step.explanation}</div>
                </div>
            `).join('');
            container.scrollTop = container.scrollHeight;
        }
        
        function applyOperation(op) {
            selectedOp = op;
            interactionData.actions_count++;
            interactionData.tool_usage[op] = (interactionData.tool_usage[op] || 0) + 1;
        }
        
        function submitOperation() {
            if (!selectedOp) {
                showFeedback('Please select an operation first', 'error');
                return;
            }
            
            const value = parseFloat(document.getElementById('operationValue').value);
            if (isNaN(value)) {
                showFeedback('Please enter a valid number', 'error');
                return;
            }
            
            // Parse current equation
            const eq = steps[steps.length - 1].equation;
            const parts = eq.split('=');
            let left = parts[0].trim();
            let right = parseFloat(parts[1].trim());
            
            // Apply operation
            let newLeft, newRight, explanation;
            
            if (selectedOp === 'add') {
                right += value;
                explanation = `Added ${value} to both sides`;
                left = left.includes('+') ? left : left + ' + ' + value;
            } else if (selectedOp === 'subtract') {
                right -= value;
                explanation = `Subtracted ${value} from both sides`;
                if (left.includes('+')) {
                    const num = parseFloat(left.split('+')[1]);
                    if (value === num) left = left.split('+')[0].trim();
                }
            } else if (selectedOp === 'multiply') {
                right *= value;
                explanation = `Multiplied both sides by ${value}`;
            } else if (selectedOp === 'divide') {
                right /= value;
                explanation = `Divided both sides by ${value}`;
                if (left.includes('x') && left.startsWith(value + 'x')) {
                    left = 'x';
                }
            }
            
            newLeft = left;
            newRight = right;
            
            steps.push({ 
                equation: `${newLeft} = ${newRight.toFixed(2)}`,
                explanation 
            });
            
            interactionData.total_steps++;
            displayEquation();
            displaySteps();
            updateStats();
            
            document.getElementById('operationValue').value = '';
            selectedOp = null;
            
            // Check if solved
            if (left === 'x' || left.trim() === 'x') {
                document.getElementById('solution').textContent = `x = ${newRight.toFixed(2)}`;
                showFeedback('Equation solved! Check your answer.', 'success');
            }
        }
        
        function checkAnswer() {
            const correctAnswer = (currentProblem.c - currentProblem.b) / currentProblem.a;
            const lastStep = steps[steps.length - 1].equation;
            
            if (lastStep.includes('x =') || lastStep.includes('= x')) {
                const studentAnswer = parseFloat(lastStep.split('=')[1].trim());
                
                if (Math.abs(studentAnswer - correctAnswer) < 0.01) {
                    showFeedback('✓ Correct! Well done!', 'success');
                    interactionData.problems_solved++;
                    interactionData.correct_attempts++;
                } else {
                    showFeedback(`✗ Not quite. The answer should be ${correctAnswer.toFixed(2)}`, 'error');
                    interactionData.incorrect_attempts++;
                }
                updateStats();
            } else {
                showFeedback('Keep solving! The variable is not isolated yet.', 'error');
            }
        }
        
        function showFeedback(message, type) {
            const feedback = document.getElementById('feedback');
            feedback.textContent = message;
            feedback.className = `feedback ${type}`;
            feedback.style.display = 'block';
        }
        
        function updateStats() {
            document.getElementById('statSolved').textContent = interactionData.problems_solved;
            document.getElementById('statSteps').textContent = interactionData.total_steps;
            document.getElementById('statCorrect').textContent = interactionData.correct_attempts;
        }
        
        async function saveProgress() {
            if (!eventId) return;
            interactionData.time_seconds = Math.floor((Date.now() - sessionStart) / 1000);
            try {
                await fetch(`${API_BASE_URL}/student/event/${eventId}`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interactionData })
                });
            } catch (err) {}
        }
        
        async function complete() {
            await saveProgress();
            alert('Session completed!');
            window.location.href = '/dashboard';
        }
        
        window.addEventListener('load', init);
        window.addEventListener('beforeunload', saveProgress);
    </script>
</body>
</html>